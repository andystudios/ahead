
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="26f25445-4f0e-5c4e-b88c-455db4b87ddd")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,184300,e=>{"use strict";e.s(["imageLoader",()=>t]);var t=e.i(483396)},504019,e=>{"use strict";e.s(["metaData",()=>t]);var t=e.i(88560)},98276,e=>{"use strict";e.s(["RenderingEngine",()=>I],98276);var t=e.i(467418),n=e.i(271094),i=e.i(405569),o=e.i(831188);let a=class{getContextByIndex(e){return e>=0&&e<this.contexts.length?{context:this.contexts[e],container:this.offScreenCanvasContainers[e]}:null}assignViewportToContext(e,t){this.viewportToContext.set(e,t)}getContextIndexForViewport(e){return this.viewportToContext.get(e)}getAllContexts(){return this.contexts}getContextCount(){return this.contexts.length}updateViewportSize(e,t,n){let i=this.viewportToContext.get(e);if(void 0===i)return!1;this.viewportSizes.set(e,{width:t,height:n});let o=this.contextMaxSizes.get(i),a=this.calculateMaxSizeForContext(i);return this.contextMaxSizes.set(i,a),!o||o.width!==a.width||o.height!==a.height}getMaxSizeForContext(e){return this.contextMaxSizes.get(e)}calculateMaxSizeForContext(e){let t=0,n=0;return this.viewportToContext.forEach((i,o)=>{if(i===e){let e=this.viewportSizes.get(o);e&&(t=Math.max(t,e.width),n=Math.max(n,e.height))}}),{width:t,height:n}}removeViewport(e){let t=this.viewportToContext.get(e);if(this.viewportToContext.delete(e),this.viewportSizes.delete(e),void 0!==t){let e=this.calculateMaxSizeForContext(t);this.contextMaxSizes.set(t,e)}}destroy(){this.contexts.forEach(e=>{e.delete()}),this.contexts=[],this.offScreenCanvasContainers=[],this.viewportToContext.clear(),this.viewportSizes.clear(),this.contextMaxSizes.clear()}constructor(e){this.contexts=[],this.offScreenCanvasContainers=[],this.viewportToContext=new Map,this.viewportSizes=new Map,this.contextMaxSizes=new Map;for(let t=0;t<e;t++){let e=o.vtkOffscreenMultiRenderWindow.newInstance(),t=document.createElement("div");e.setContainer(t),this.contexts.push(e),this.offScreenCanvasContainers.push(t)}}};var r=e.i(118978),l=e.i(701779),s=e.i(627353),d=e.i(323447),c=e.i(446210),u=e.i(212403),h=e.i(28902),g=e.i(894204),f=e.i(407072);class m extends i.default{enableVTKjsDrivenViewport(e){let t=this._getViewportsAsArray().filter(e=>!1===(0,g.default)(e.type)).map(e=>e.canvas),n=(0,f.default)(e.element);t.push(n);let i={...e,canvas:n};this.addVtkjsDrivenViewport(i)}addVtkjsDrivenViewport(e){let t,{element:n,canvas:i,viewportId:o,type:a,defaultOptions:g}=e;n.tabIndex=-1;let f=0;if(a===d.default.STACK){let e=this.contextPool.getAllContexts();f=this._viewports.size%e.length}this.contextPool.assignViewportToContext(o,f),this.contextPool.updateViewportSize(o,i.width,i.height);let{context:m,container:v}=this.contextPool.getContextByIndex(f),p=this.contextPool.getMaxSizeForContext(f);v.width=p.width,v.height=p.height,m.resize(),m.addRenderer({viewport:[0,0,1,1],id:o,background:g.background?g.background:[0,0,0]});let I={id:o,element:n,renderingEngineId:this.id,type:a,canvas:i,sx:0,sy:0,sWidth:i.width,sHeight:i.height,defaultOptions:g||{}};if(a===d.default.STACK)t=new u.default(I);else if(a===d.default.ORTHOGRAPHIC||a===d.default.PERSPECTIVE)t=new c.default(I);else if(a===d.default.VOLUME_3D)t=new h.default(I);else throw Error("Viewport Type ".concat(a," is not supported"));this._viewports.set(o,t);let E={element:n,viewportId:o,renderingEngineId:this.id};t.suppressEvents||(0,s.default)(l.default,r.default.ELEMENT_ENABLED,E)}setVtkjsDrivenViewports(e){if(e.length){let t=e.map(e=>(0,f.default)(e.element));t.forEach(e=>{let t=window.devicePixelRatio||1,n=e.getBoundingClientRect();e.width=n.width*t,e.height=n.height*t});for(let n=0;n<e.length;n++){let i=e[n],o=t[n],a={...i,canvas:o};this.addVtkjsDrivenViewport(a)}}}_resizeVTKViewports(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],n=!(arguments.length>2)||void 0===arguments[2]||arguments[2],i=e.map(e=>(0,f.default)(e.element));i.forEach(e=>{let t=window.devicePixelRatio||1;e.width=e.clientWidth*t,e.height=e.clientHeight*t}),i.length&&this._resize(e),e.forEach(e=>{let n=e.getCamera(),i=e.getRotation(),{flipHorizontal:o}=n;e.resetCameraForResize();let a=e.getDisplayArea();t&&(a?(o&&e.setCamera({flipHorizontal:o}),i&&e.setViewPresentation({rotation:i})):e.setCamera(n))}),n&&this.render()}renderViewportUsingCustomOrVtkPipeline(e){if((0,g.default)(e.type))return e.customRenderViewportToCanvas();if(this.useCPURendering)throw Error("GPU not available, and using a viewport with no custom render pipeline.");let t=this.contextPool.getContextIndexForViewport(e.id),{context:n,container:i}=this.contextPool.getContextByIndex(t);return this._renderViewportWithContext(e,n,i)}_renderViewportWithContext(e,t,n){if(e.sWidth<i.VIEWPORT_MIN_SIZE||e.sHeight<i.VIEWPORT_MIN_SIZE)return void console.warn("Viewport is too small",e.sWidth,e.sHeight);if((0,g.default)(e.type))return e.customRenderViewportToCanvas();if(this.useCPURendering)throw Error("GPU not available, and using a viewport with no custom render pipeline.");if(!t.getRenderer(e.id)){var o;t.addRenderer({viewport:[0,0,1,1],id:e.id,background:(null==(o=e.defaultOptions)?void 0:o.background)||[0,0,0]})}let a=t.getRenderWindow(),r=a.getViews()[0],l=r.getRenderPasses(),s=this.getViewportRenderPasses(e.id);s&&r.setRenderPasses(s),this._resizeOffScreenCanvasForViewport(e,n,t);let d=t.getRenderer(e.id),c=this.contextPool.getContextIndexForViewport(e.id),u=this.contextPool.getMaxSizeForContext(c),h=e.canvas.width,f=e.canvas.height,m=Math.min(1,h/u.width),v=Math.min(1,f/u.height);d.setViewport(0,0,m,v);let p=t.getRenderers();p.forEach(t=>{let{renderer:n,id:i}=t;n.setDraw(i===e.id)});let I=this.getWidgetRenderers();I.forEach((t,n)=>{n.setDraw(t===e.id)}),a.render(),p.forEach(e=>{let{renderer:t}=e;return t.setDraw(!1)}),I.forEach((e,t)=>{t.setDraw(!1)}),l&&r.setRenderPasses(l);let E=t.getOpenGLRenderWindow().get3DContext().canvas;return this._copyToOnscreenCanvas(e,E)}_renderViewportFromVtkCanvasToOnscreenCanvas(e,t){return this._copyToOnscreenCanvas(e,t)}_resizeOffScreenCanvasForViewport(e,t,n){let i=this.contextPool.getContextIndexForViewport(e.id);if(void 0===i||!this.contextPool.updateViewportSize(e.id,e.canvas.width,e.canvas.height))return;let o=this.contextPool.getMaxSizeForContext(i);(t.width!==o.width||t.height!==o.height)&&(t.width=o.width,t.height=o.height,n.resize())}_copyToOnscreenCanvas(e,t){let{element:n,canvas:i,id:o,renderingEngineId:a,suppressEvents:r}=e,{width:l,height:s}=i,d=i.getContext("2d"),c=this.contextPool.getContextIndexForViewport(o),u=this.contextPool.getMaxSizeForContext(c).height-s;return d.drawImage(t,0,u,l,s,0,0,l,s),{element:n,suppressEvents:r,viewportId:o,renderingEngineId:a,viewportStatus:e.viewportStatus}}_resize(e){let t=new Set;for(let n of e){n.sx=0,n.sy=0,n.sWidth=n.canvas.width,n.sHeight=n.canvas.height;let e=this.contextPool.getContextIndexForViewport(n.id);this.contextPool.updateViewportSize(n.id,n.canvas.width,n.canvas.height)&&t.add(e);let{context:i}=this.contextPool.getContextByIndex(e),o=i.getRenderer(n.id),a=this.contextPool.getMaxSizeForContext(e),r=Math.min(1,n.canvas.width/a.width),l=Math.min(1,n.canvas.height/a.height);o.setViewport(0,0,r,l)}t.forEach(e=>{let t=this.contextPool.getContextByIndex(e);if(t){let{context:n,container:i}=t,o=this.contextPool.getMaxSizeForContext(e);i.width=o.width,i.height=o.height,n.resize()}})}getWidgetRenderers(){let e=this._getViewportsAsArray(),t=new Map;return e.forEach(e=>{(e.getWidgets?e.getWidgets():[]).forEach(n=>{let i=n.getRenderer?n.getRenderer():null;i&&t.set(i,e.id)})}),t}getViewportRenderPasses(e){let t=this.getViewport(e);return(null==t?void 0:t.getRenderPasses)?t.getRenderPasses():null}getRenderer(e){var t;let n=null==(t=this.contextPool)?void 0:t.getContextIndexForViewport(e),{context:i}=this.contextPool.getContextByIndex(n);return i.getRenderer(e)}disableElement(e){let t=this.getViewport(e);if(t&&(super.disableElement(e),!(0,g.default)(t.type)&&!this.useCPURendering)){let t=this.contextPool.getContextIndexForViewport(e);if(void 0!==t){let n=this.contextPool.getContextByIndex(t);if(n){let{context:t}=n;t.removeRenderer(e)}}this.contextPool.removeViewport(e)}}destroy(){this.contextPool&&this.contextPool.destroy(),super.destroy()}getOffscreenMultiRenderWindow(e){if(this.useCPURendering)throw Error("Offscreen multi render window is not available when using CPU rendering.");let t=this.contextPool.getContextIndexForViewport(e);return this.contextPool.getContextByIndex(t).context}constructor(e){super(e),this._renderFlaggedViewports=()=>{this._throwIfDestroyed();let e=this._getViewportsAsArray().filter(e=>this._needsRender.has(e.id));if(0===e.length){this._animationFrameSet=!1,this._animationFrameHandle=null;return}let t=e.map(e=>{let t=this.renderViewportUsingCustomOrVtkPipeline(e);return e.setRendered(),this._needsRender.delete(e.id),t});this._animationFrameSet=!1,this._animationFrameHandle=null,t.forEach(e=>{(null==e?void 0:e.element)&&(0,s.default)(e.element,r.default.IMAGE_RENDERED,e)})};let{rendering:n}=(0,t.getConfiguration)(),{webGlContextCount:i}=n;this.useCPURendering||(this.contextPool=new a(i))}}var v=e.i(646320);let p=class{get id(){return this._implementation.id}enableElement(e){return this._implementation.enableElement(e)}disableElement(e){return this._implementation.disableElement(e)}setViewports(e){return this._implementation.setViewports(e)}resize(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return this._implementation.resize(e,t)}getViewport(e){return this._implementation.getViewport(e)}getViewports(){return this._implementation.getViewports()}getStackViewport(e){return this._implementation.getStackViewport(e)}getStackViewports(){return this._implementation.getStackViewports()}getVolumeViewports(){return this._implementation.getVolumeViewports()}getRenderer(e){return this._implementation.getRenderer(e)}fillCanvasWithBackgroundColor(e,t){return this._implementation.fillCanvasWithBackgroundColor(e,t)}render(){return this._implementation.render()}renderViewports(e){return this._implementation.renderViewports(e)}renderViewport(e){return this._implementation.renderViewport(e)}destroy(){return this._implementation.destroy()}getOffscreenMultiRenderWindow(e){return this._implementation.getOffscreenMultiRenderWindow(e)}constructor(e){var i;let o=(0,t.getConfiguration)(),a=null==o||null==(i=o.rendering)?void 0:i.renderingEngineMode;switch(a){case v.RenderingEngineModeEnum.Tiled:this._implementation=new n.default(e);break;case v.RenderingEngineModeEnum.ContextPool:this._implementation=new m(e);break;default:console.warn('RenderingEngine: Unknown rendering engine mode "'.concat(a,'". Defaulting to Next rendering engine.')),this._implementation=new m(e)}}};e.i(23529);let I=p},163370,e=>{"use strict";e.s(["imageToWorldCoords",()=>t.default]);var t=e.i(178767)},290081,(e,t,n)=>{"use strict";var i={},o={};o.default=function(e,t,n,o,a){var r=new Worker(i[t]||(i[t]=URL.createObjectURL(new Blob([e+';addEventListener("error",function(e){e=e.error;postMessage({$e$:[e.message,e.code,e.stack]})})'],{type:"text/javascript"}))));return r.onmessage=function(e){var t=e.data,n=t.$e$;if(n){var i=Error(n[0]);i.code=n[1],i.stack=n[2],a(i,null)}else a(null,t)},r.postMessage(n,o),r};var a=Uint8Array,r=Uint16Array,l=Int32Array,s=new a([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),d=new a([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),c=new a([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),u=function(e,t){for(var n=new r(31),i=0;i<31;++i)n[i]=t+=1<<e[i-1];for(var o=new l(n[30]),i=1;i<30;++i)for(var a=n[i];a<n[i+1];++a)o[a]=a-n[i]<<5|i;return{b:n,r:o}},h=u(s,2),g=h.b,f=h.r;g[28]=258,f[258]=28;for(var m=u(d,0),v=m.b,p=m.r,I=new r(32768),E=0;E<32768;++E){var w=(43690&E)>>1|(21845&E)<<1;w=(61680&(w=(52428&w)>>2|(13107&w)<<2))>>4|(3855&w)<<4,I[E]=((65280&w)>>8|(255&w)<<8)>>1}for(var _=function(e,t,n){for(var i,o=e.length,a=0,l=new r(t);a<o;++a)e[a]&&++l[e[a]-1];var s=new r(t);for(a=1;a<t;++a)s[a]=s[a-1]+l[a-1]<<1;if(n){i=new r(1<<t);var d=15-t;for(a=0;a<o;++a)if(e[a])for(var c=a<<4|e[a],u=t-e[a],h=s[e[a]-1]++<<u,g=h|(1<<u)-1;h<=g;++h)i[I[h]>>d]=c}else for(a=0,i=new r(o);a<o;++a)e[a]&&(i[a]=I[s[e[a]-1]++]>>15-e[a]);return i},S=new a(288),E=0;E<144;++E)S[E]=8;for(var E=144;E<256;++E)S[E]=9;for(var E=256;E<280;++E)S[E]=7;for(var E=280;E<288;++E)S[E]=8;for(var y=new a(32),E=0;E<32;++E)y[E]=5;var T=_(S,9,0),C=_(S,9,1),b=_(y,5,0),A=_(y,5,1),x=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},D=function(e,t,n){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&n},M=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},O=function(e){return(e+7)/8|0},P=function(e,t,n){return(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length),new a(e.subarray(t,n))};n.FlateErrorCode={UnexpectedEOF:0,InvalidBlockType:1,InvalidLengthLiteral:2,InvalidDistance:3,StreamFinished:4,NoStreamHandler:5,InvalidHeader:6,NoCallback:7,InvalidUTF8:8,ExtraFieldTooLong:9,InvalidDate:10,FilenameTooLong:11,StreamFinishing:12,InvalidZipData:13,UnknownCompressionMethod:14};var N=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],R=function(e,t,n){var i=Error(t||N[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,R),!n)throw i;return i},L=function(e,t,n,i){var o=e.length,r=i?i.length:0;if(!o||t.f&&!t.l)return n||new a(0);var l=!n,u=l||2!=t.i,h=t.i;l&&(n=new a(3*o));var f=function(e){var t=n.length;if(e>t){var i=new a(Math.max(2*t,e));i.set(n),n=i}},m=t.f||0,p=t.p||0,I=t.b||0,E=t.l,w=t.d,S=t.m,y=t.n,T=8*o;do{if(!E){m=D(e,p,1);var b=D(e,p+1,3);if(p+=3,b)if(1==b)E=C,w=A,S=9,y=5;else if(2==b){var N=D(e,p,31)+257,L=D(e,p+10,15)+4,U=N+D(e,p+5,31)+1;p+=14;for(var k=new a(U),V=new a(19),F=0;F<L;++F)V[c[F]]=D(e,p+3*F,7);p+=3*L;for(var B=x(V),G=(1<<B)-1,W=_(V,B,1),F=0;F<U;){var z=W[D(e,p,G)];p+=15&z;var q=z>>4;if(q<16)k[F++]=q;else{var H=0,j=0;for(16==q?(j=3+D(e,p,3),p+=2,H=k[F-1]):17==q?(j=3+D(e,p,7),p+=3):18==q&&(j=11+D(e,p,127),p+=7);j--;)k[F++]=H}}var K=k.subarray(0,N),Y=k.subarray(N);S=x(K),y=x(Y),E=_(K,S,1),w=_(Y,y,1)}else R(1);else{var q=O(p)+4,X=e[q-4]|e[q-3]<<8,Z=q+X;if(Z>o){h&&R(0);break}u&&f(I+X),n.set(e.subarray(q,Z),I),t.b=I+=X,t.p=p=8*Z,t.f=m;continue}if(p>T){h&&R(0);break}}u&&f(I+131072);for(var J=(1<<S)-1,Q=(1<<y)-1,$=p;;$=p){var H=E[M(e,p)&J],ee=H>>4;if((p+=15&H)>T){h&&R(0);break}if(H||R(2),ee<256)n[I++]=ee;else if(256==ee){$=p,E=null;break}else{var et=ee-254;if(ee>264){var F=ee-257,en=s[F];et=D(e,p,(1<<en)-1)+g[F],p+=en}var ei=w[M(e,p)&Q],eo=ei>>4;ei||R(3),p+=15&ei;var Y=v[eo];if(eo>3){var en=d[eo];Y+=M(e,p)&(1<<en)-1,p+=en}if(p>T){h&&R(0);break}u&&f(I+131072);var ea=I+et;if(I<Y){var er=r-Y,el=Math.min(Y,ea);for(er+I<0&&R(3);I<el;++I)n[I]=i[er+I]}for(;I<ea;++I)n[I]=n[I-Y]}}t.l=E,t.p=$,t.b=I,t.f=m,E&&(m=1,t.m=S,t.d=w,t.n=y)}while(!m)return I!=n.length&&l?P(n,0,I):n.subarray(0,I)},U=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8},k=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8,e[i+2]|=n>>16},V=function(e,t){for(var n=[],i=0;i<e.length;++i)e[i]&&n.push({s:i,f:e[i]});var o=n.length,l=n.slice();if(!o)return{t:H,l:0};if(1==o){var s=new a(n[0].s+1);return s[n[0].s]=1,{t:s,l:1}}n.sort(function(e,t){return e.f-t.f}),n.push({s:-1,f:25001});var d=n[0],c=n[1],u=0,h=1,g=2;for(n[0]={s:-1,f:d.f+c.f,l:d,r:c};h!=o-1;)d=n[n[u].f<n[g].f?u++:g++],c=n[u!=h&&n[u].f<n[g].f?u++:g++],n[h++]={s:-1,f:d.f+c.f,l:d,r:c};for(var f=l[0].s,i=1;i<o;++i)l[i].s>f&&(f=l[i].s);var m=new r(f+1),v=F(n[h-1],m,0);if(v>t){var i=0,p=0,I=v-t,E=1<<I;for(l.sort(function(e,t){return m[t.s]-m[e.s]||e.f-t.f});i<o;++i){var w=l[i].s;if(m[w]>t)p+=E-(1<<v-m[w]),m[w]=t;else break}for(p>>=I;p>0;){var _=l[i].s;m[_]<t?p-=1<<t-m[_]++-1:++i}for(;i>=0&&p;--i){var S=l[i].s;m[S]==t&&(--m[S],++p)}v=t}return{t:new a(m),l:v}},F=function(e,t,n){return -1==e.s?Math.max(F(e.l,t,n+1),F(e.r,t,n+1)):t[e.s]=n},B=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new r(++t),i=0,o=e[0],a=1,l=function(e){n[i++]=e},s=1;s<=t;++s)if(e[s]==o&&s!=t)++a;else{if(!o&&a>2){for(;a>138;a-=138)l(32754);a>2&&(l(a>10?a-11<<5|28690:a-3<<5|12305),a=0)}else if(a>3){for(l(o),--a;a>6;a-=6)l(8304);a>2&&(l(a-3<<5|8208),a=0)}for(;a--;)l(o);a=1,o=e[s]}return{c:n.subarray(0,i),n:t}},G=function(e,t){for(var n=0,i=0;i<t.length;++i)n+=e[i]*t[i];return n},W=function(e,t,n){var i=n.length,o=O(t+2);e[o]=255&i,e[o+1]=i>>8,e[o+2]=255^e[o],e[o+3]=255^e[o+1];for(var a=0;a<i;++a)e[o+a+4]=n[a];return(o+4+i)*8},z=function(e,t,n,i,o,a,l,u,h,g,f){U(t,f++,n),++o[256];for(var m,v,p,I,E=V(o,15),w=E.t,C=E.l,A=V(a,15),x=A.t,D=A.l,M=B(w),O=M.c,P=M.n,N=B(x),R=N.c,L=N.n,F=new r(19),z=0;z<O.length;++z)++F[31&O[z]];for(var z=0;z<R.length;++z)++F[31&R[z]];for(var q=V(F,7),H=q.t,j=q.l,K=19;K>4&&!H[c[K-1]];--K);var Y=g+5<<3,X=G(o,S)+G(a,y)+l,Z=G(o,w)+G(a,x)+l+14+3*K+G(F,H)+2*F[16]+3*F[17]+7*F[18];if(h>=0&&Y<=X&&Y<=Z)return W(t,f,e.subarray(h,h+g));if(U(t,f,1+(Z<X)),f+=2,Z<X){m=_(w,C,0),v=w,p=_(x,D,0),I=x;var J=_(H,j,0);U(t,f,P-257),U(t,f+5,L-1),U(t,f+10,K-4),f+=14;for(var z=0;z<K;++z)U(t,f+3*z,H[c[z]]);f+=3*K;for(var Q=[O,R],$=0;$<2;++$)for(var ee=Q[$],z=0;z<ee.length;++z){var et=31&ee[z];U(t,f,J[et]),f+=H[et],et>15&&(U(t,f,ee[z]>>5&127),f+=ee[z]>>12)}}else m=T,v=S,p=b,I=y;for(var z=0;z<u;++z){var en=i[z];if(en>255){var et=en>>18&31;k(t,f,m[et+257]),f+=v[et+257],et>7&&(U(t,f,en>>23&31),f+=s[et]);var ei=31&en;k(t,f,p[ei]),f+=I[ei],ei>3&&(k(t,f,en>>5&8191),f+=d[ei])}else k(t,f,m[en]),f+=v[en]}return k(t,f,m[256]),f+v[256]},q=new l([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),H=new a(0),j=function(e,t,n,i,o,c){var u=c.z||e.length,h=new a(i+u+5*(1+Math.ceil(u/7e3))+o),g=h.subarray(i,h.length-o),m=c.l,v=7&(c.r||0);if(t){v&&(g[0]=c.r>>3);for(var I=q[t-1],E=I>>13,w=8191&I,_=(1<<n)-1,S=c.p||new r(32768),y=c.h||new r(_+1),T=Math.ceil(n/3),C=2*T,b=function(t){return(e[t]^e[t+1]<<T^e[t+2]<<C)&_},A=new l(25e3),x=new r(288),D=new r(32),M=0,N=0,R=c.i||0,L=0,U=c.w||0,k=0;R+2<u;++R){var V=b(R),F=32767&R,B=y[V];if(S[F]=B,y[V]=F,U<=R){var G=u-R;if((M>7e3||L>24576)&&(G>423||!m)){v=z(e,g,0,A,x,D,N,L,k,R-k,v),L=M=N=0,k=R;for(var H=0;H<286;++H)x[H]=0;for(var H=0;H<30;++H)D[H]=0}var j=2,K=0,Y=w,X=F-B&32767;if(G>2&&V==b(R-X))for(var Z=Math.min(E,G)-1,J=Math.min(32767,R),Q=Math.min(258,G);X<=J&&--Y&&F!=B;){if(e[R+j]==e[R+j-X]){for(var $=0;$<Q&&e[R+$]==e[R+$-X];++$);if($>j){if(j=$,K=X,$>Z)break;for(var ee=Math.min(X,$-2),et=0,H=0;H<ee;++H){var en=R-X+H&32767,ei=S[en],eo=en-ei&32767;eo>et&&(et=eo,B=en)}}}B=S[F=B],X+=F-B&32767}if(K){A[L++]=0x10000000|f[j]<<18|p[K];var ea=31&f[j],er=31&p[K];N+=s[ea]+d[er],++x[257+ea],++D[er],U=R+j,++M}else A[L++]=e[R],++x[e[R]]}}for(R=Math.max(R,U);R<u;++R)A[L++]=e[R],++x[e[R]];v=z(e,g,m,A,x,D,N,L,k,R-k,v),m||(c.r=7&v|g[v/8|0]<<3,v-=7,c.h=y,c.p=S,c.i=R,c.w=U)}else{for(var R=c.w||0;R<u+m;R+=65535){var el=R+65535;el>=u&&(g[v/8|0]=m,el=u),v=W(g,v+1,e.subarray(R,el))}c.i=u}return P(h,0,i+O(v)+o)},K=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var n=t,i=9;--i;)n=(1&n&&-0x12477ce0)^n>>>1;e[t]=n}return e}(),Y=function(){var e=-1;return{p:function(t){for(var n=e,i=0;i<t.length;++i)n=K[255&n^t[i]]^n>>>8;e=n},d:function(){return~e}}},X=function(){var e=1,t=0;return{p:function(n){for(var i=e,o=t,a=0|n.length,r=0;r!=a;){for(var l=Math.min(r+2655,a);r<l;++r)o+=i+=n[r];i=(65535&i)+15*(i>>16),o=(65535&o)+15*(o>>16)}e=i,t=o},d:function(){return e%=65521,t%=65521,(255&e)<<24|(65280&e)<<8|(255&t)<<8|t>>8}}},Z=function(e,t,n,i,o){if(!o&&(o={l:1},t.dictionary)){var r=t.dictionary.subarray(-32768),l=new a(r.length+e.length);l.set(r),l.set(e,r.length),e=l,o.w=r.length}return j(e,null==t.level?6:t.level,null==t.mem?o.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,n,i,o)},J=function(e,t){var n={};for(var i in e)n[i]=e[i];for(var i in t)n[i]=t[i];return n},Q=function(e,t,n){for(var i=e(),o=e.toString(),a=o.slice(o.indexOf("[")+1,o.lastIndexOf("]")).replace(/\s+/g,"").split(","),r=0;r<i.length;++r){var l=i[r],s=a[r];if("function"==typeof l){t+=";"+s+"=";var d=l.toString();if(l.prototype)if(-1!=d.indexOf("[native code]")){var c=d.indexOf(" ",8)+1;t+=d.slice(c,d.indexOf("(",c))}else for(var u in t+=d,l.prototype)t+=";"+s+".prototype."+u+"="+l.prototype[u].toString();else t+=d}else n[s]=l}return t},$=[],ee=function(e){var t=[];for(var n in e)e[n].buffer&&t.push((e[n]=new e[n].constructor(e[n])).buffer);return t},et=function(e,t,n,i){if(!$[n]){for(var a="",r={},l=e.length-1,s=0;s<l;++s)a=Q(e[s],a,r);$[n]={c:Q(e[l],a,r),e:r}}var d=J({},$[n].e);return(0,o.default)($[n].c+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+t.toString()+"}",n,d,ee(d),i)},en=function(){return[a,r,l,s,d,c,g,v,C,A,I,N,_,x,D,M,O,P,R,L,eO,es,ed]},ei=function(){return[a,r,l,s,d,c,f,p,T,S,b,y,I,q,H,_,U,k,V,F,B,G,W,z,O,P,j,Z,eA,es]},eo=function(){return[ep,ew,ev,Y,K]},ea=function(){return[eI,eE]},er=function(){return[e_,ev,X]},el=function(){return[eS]},es=function(e){return postMessage(e,[e.buffer])},ed=function(e){return e&&{out:e.size&&new a(e.size),dictionary:e.dictionary}},ec=function(e,t,n,i,o,a){var r=et(n,i,o,function(e,t){r.terminate(),a(e,t)});return r.postMessage([e,t],t.consume?[e.buffer]:[]),function(){r.terminate()}},eu=function(e){return e.ondata=function(e,t){return postMessage([e,t],[e.buffer])},function(t){t.data.length?(e.push(t.data[0],t.data[1]),postMessage([t.data[0].length])):e.flush()}},eh=function(e,t,n,i,o,a,r){var l,s=et(e,i,o,function(e,n){e?(s.terminate(),t.ondata.call(t,e)):Array.isArray(n)?1==n.length?(t.queuedSize-=n[0],t.ondrain&&t.ondrain(n[0])):(n[1]&&s.terminate(),t.ondata.call(t,e,n[0],n[1])):r(n)});s.postMessage(n),t.queuedSize=0,t.push=function(e,n){t.ondata||R(5),l&&t.ondata(R(4,0,1),null,!!n),t.queuedSize+=e.length,s.postMessage([e,l=n],[e.buffer])},t.terminate=function(){s.terminate()},a&&(t.flush=function(){s.postMessage([])})},eg=function(e,t){return e[t]|e[t+1]<<8},ef=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},em=function(e,t){return ef(e,t)+0x100000000*ef(e,t+4)},ev=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8},ep=function(e,t){var n=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:2*(9==t.level),e[9]=3,0!=t.mtime&&ev(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),n){e[3]=8;for(var i=0;i<=n.length;++i)e[i+10]=n.charCodeAt(i)}},eI=function(e){(31!=e[0]||139!=e[1]||8!=e[2])&&R(6,"invalid gzip data");var t=e[3],n=10;4&t&&(n+=(e[10]|e[11]<<8)+2);for(var i=(t>>3&1)+(t>>4&1);i>0;i-=!e[n++]);return n+(2&t)},eE=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},ew=function(e){return 10+(e.filename?e.filename.length+1:0)},e_=function(e,t){var n=t.level;if(e[0]=120,e[1]=(0==n?0:n<6?1:9==n?3:2)<<6|(t.dictionary&&32),e[1]|=31-(e[0]<<8|e[1])%31,t.dictionary){var i=X();i.p(t.dictionary),ev(e,2,i.d())}},eS=function(e,t){return((15&e[0])!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&R(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&R(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2};function ey(e,t){return"function"==typeof e&&(t=e,e={}),this.ondata=t,e}var eT=function(){function e(e,t){if("function"==typeof e&&(t=e,e={}),this.ondata=t,this.o=e||{},this.s={l:0,i:32768,w:32768,z:32768},this.b=new a(98304),this.o.dictionary){var n=this.o.dictionary.subarray(-32768);this.b.set(n,32768-n.length),this.s.i=32768-n.length}}return e.prototype.p=function(e,t){this.ondata(Z(e,this.o,0,0,this.s),t)},e.prototype.push=function(e,t){this.ondata||R(5),this.s.l&&R(4);var n=e.length+this.s.z;if(n>this.b.length){if(n>2*this.b.length-32768){var i=new a(-32768&n);i.set(this.b.subarray(0,this.s.z)),this.b=i}var o=this.b.length-this.s.z;this.b.set(e.subarray(0,o),this.s.z),this.s.z=this.b.length,this.p(this.b,!1),this.b.set(this.b.subarray(-32768)),this.b.set(e.subarray(o),32768),this.s.z=e.length-o+32768,this.s.i=32766,this.s.w=32768}else this.b.set(e,this.s.z),this.s.z+=e.length;this.s.l=1&t,(this.s.z>this.s.w+8191||t)&&(this.p(this.b,t||!1),this.s.w=this.s.i,this.s.i-=2)},e.prototype.flush=function(){this.ondata||R(5),this.s.l&&R(4),this.p(this.b,!1),this.s.w=this.s.i,this.s.i-=2},e}();n.Deflate=eT;var eC=function(e,t){eh([ei,function(){return[eu,eT]}],this,ey.call(this,e,t),function(e){onmessage=eu(new eT(e.data))},6,1)};function eb(e,t,n){return n||(n=t,t={}),"function"!=typeof n&&R(7),ec(e,t,[ei],function(e){return es(eA(e.data[0],e.data[1]))},0,n)}function eA(e,t){return Z(e,t||{},0,0)}n.AsyncDeflate=eC,n.deflate=eb,n.deflateSync=eA;var ex=function(){function e(e,t){"function"==typeof e&&(t=e,e={}),this.ondata=t;var n=e&&e.dictionary&&e.dictionary.subarray(-32768);this.s={i:0,b:n?n.length:0},this.o=new a(32768),this.p=new a(0),n&&this.o.set(n)}return e.prototype.e=function(e){if(this.ondata||R(5),this.d&&R(4),this.p.length){if(e.length){var t=new a(this.p.length+e.length);t.set(this.p),t.set(e,this.p.length),this.p=t}}else this.p=e},e.prototype.c=function(e){this.s.i=+(this.d=e||!1);var t=this.s.b,n=L(this.p,this.s,this.o);this.ondata(P(n,t,this.s.b),this.d),this.o=P(n,this.s.b-32768),this.s.b=this.o.length,this.p=P(this.p,this.s.p/8|0),this.s.p&=7},e.prototype.push=function(e,t){this.e(e),this.c(t)},e}();n.Inflate=ex;var eD=function(e,t){eh([en,function(){return[eu,ex]}],this,ey.call(this,e,t),function(e){onmessage=eu(new ex(e.data))},7,0)};function eM(e,t,n){return n||(n=t,t={}),"function"!=typeof n&&R(7),ec(e,t,[en],function(e){return es(eO(e.data[0],ed(e.data[1])))},1,n)}function eO(e,t){return L(e,{i:2},t&&t.out,t&&t.dictionary)}n.AsyncInflate=eD,n.inflate=eM,n.inflateSync=eO;var eP=function(){function e(e,t){this.c=Y(),this.l=0,this.v=1,eT.call(this,e,t)}return e.prototype.push=function(e,t){this.c.p(e),this.l+=e.length,eT.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){var n=Z(e,this.o,this.v&&ew(this.o),t&&8,this.s);this.v&&(ep(n,this.o),this.v=0),t&&(ev(n,n.length-8,this.c.d()),ev(n,n.length-4,this.l)),this.ondata(n,t)},e.prototype.flush=function(){eT.prototype.flush.call(this)},e}();n.Gzip=eP,n.Compress=eP;var eN=function(e,t){eh([ei,eo,function(){return[eu,eT,eP]}],this,ey.call(this,e,t),function(e){onmessage=eu(new eP(e.data))},8,1)};function eR(e,t,n){return n||(n=t,t={}),"function"!=typeof n&&R(7),ec(e,t,[ei,eo,function(){return[eL]}],function(e){return es(eL(e.data[0],e.data[1]))},2,n)}function eL(e,t){t||(t={});var n=Y(),i=e.length;n.p(e);var o=Z(e,t,ew(t),8),a=o.length;return ep(o,t),ev(o,a-8,n.d()),ev(o,a-4,i),o}n.AsyncGzip=eN,n.AsyncCompress=eN,n.gzip=eR,n.compress=eR,n.gzipSync=eL,n.compressSync=eL;var eU=function(){function e(e,t){this.v=1,this.r=0,ex.call(this,e,t)}return e.prototype.push=function(e,t){if(ex.prototype.e.call(this,e),this.r+=e.length,this.v){var n=this.p.subarray(this.v-1),i=n.length>3?eI(n):4;if(i>n.length){if(!t)return}else this.v>1&&this.onmember&&this.onmember(this.r-n.length);this.p=n.subarray(i),this.v=0}ex.prototype.c.call(this,t),!this.s.f||this.s.l||t||(this.v=O(this.s.p)+9,this.s={i:0},this.o=new a(0),this.push(new a(0),t))},e}();n.Gunzip=eU;var ek=function(e,t){var n=this;eh([en,ea,function(){return[eu,ex,eU]}],this,ey.call(this,e,t),function(e){var t=new eU(e.data);t.onmember=function(e){return postMessage(e)},onmessage=eu(t)},9,0,function(e){return n.onmember&&n.onmember(e)})};function eV(e,t,n){return n||(n=t,t={}),"function"!=typeof n&&R(7),ec(e,t,[en,ea,function(){return[eF]}],function(e){return es(eF(e.data[0],e.data[1]))},3,n)}function eF(e,t){var n=eI(e);return n+8>e.length&&R(6,"invalid gzip data"),L(e.subarray(n,-8),{i:2},t&&t.out||new a(eE(e)),t&&t.dictionary)}n.AsyncGunzip=ek,n.gunzip=eV,n.gunzipSync=eF;var eB=function(){function e(e,t){this.c=X(),this.v=1,eT.call(this,e,t)}return e.prototype.push=function(e,t){this.c.p(e),eT.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){var n=Z(e,this.o,this.v&&(this.o.dictionary?6:2),t&&4,this.s);this.v&&(e_(n,this.o),this.v=0),t&&ev(n,n.length-4,this.c.d()),this.ondata(n,t)},e.prototype.flush=function(){eT.prototype.flush.call(this)},e}();function eG(e,t){t||(t={});var n=X();n.p(e);var i=Z(e,t,t.dictionary?6:2,4);return e_(i,t),ev(i,i.length-4,n.d()),i}n.Zlib=eB,n.AsyncZlib=function(e,t){eh([ei,er,function(){return[eu,eT,eB]}],this,ey.call(this,e,t),function(e){onmessage=eu(new eB(e.data))},10,1)},n.zlib=function(e,t,n){return n||(n=t,t={}),"function"!=typeof n&&R(7),ec(e,t,[ei,er,function(){return[eG]}],function(e){return es(eG(e.data[0],e.data[1]))},4,n)},n.zlibSync=eG;var eW=function(){function e(e,t){ex.call(this,e,t),this.v=e&&e.dictionary?2:1}return e.prototype.push=function(e,t){if(ex.prototype.e.call(this,e),this.v){if(this.p.length<6&&!t)return;this.p=this.p.subarray(eS(this.p,this.v-1)),this.v=0}t&&(this.p.length<4&&R(6,"invalid zlib data"),this.p=this.p.subarray(0,-4)),ex.prototype.c.call(this,t)},e}();n.Unzlib=eW;var ez=function(e,t){eh([en,el,function(){return[eu,ex,eW]}],this,ey.call(this,e,t),function(e){onmessage=eu(new eW(e.data))},11,0)};function eq(e,t,n){return n||(n=t,t={}),"function"!=typeof n&&R(7),ec(e,t,[en,el,function(){return[eH]}],function(e){return es(eH(e.data[0],ed(e.data[1])))},5,n)}function eH(e,t){return L(e.subarray(eS(e,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}n.AsyncUnzlib=ez,n.unzlib=eq,n.unzlibSync=eH;var ej=function(){function e(e,t){this.o=ey.call(this,e,t)||{},this.G=eU,this.I=ex,this.Z=eW}return e.prototype.i=function(){var e=this;this.s.ondata=function(t,n){e.ondata(t,n)}},e.prototype.push=function(e,t){if(this.ondata||R(5),this.s)this.s.push(e,t);else{if(this.p&&this.p.length){var n=new a(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length)}else this.p=e;this.p.length>2&&(this.s=31==this.p[0]&&139==this.p[1]&&8==this.p[2]?new this.G(this.o):(15&this.p[0])!=8||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(this.o):new this.Z(this.o),this.i(),this.s.push(this.p,t),this.p=null)}},e}();n.Decompress=ej,n.AsyncDecompress=function(){function e(e,t){ej.call(this,e,t),this.queuedSize=0,this.G=ek,this.I=eD,this.Z=ez}return e.prototype.i=function(){var e=this;this.s.ondata=function(t,n,i){e.ondata(t,n,i)},this.s.ondrain=function(t){e.queuedSize-=t,e.ondrain&&e.ondrain(t)}},e.prototype.push=function(e,t){this.queuedSize+=e.length,ej.prototype.push.call(this,e,t)},e}(),n.decompress=function(e,t,n){return n||(n=t,t={}),"function"!=typeof n&&R(7),31==e[0]&&139==e[1]&&8==e[2]?eV(e,t,n):(15&e[0])!=8||e[0]>>4>7||(e[0]<<8|e[1])%31?eM(e,t,n):eq(e,t,n)},n.decompressSync=function(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?eF(e,t):(15&e[0])!=8||e[0]>>4>7||(e[0]<<8|e[1])%31?eO(e,t):eH(e,t)};var eK=function(e,t,n,i){for(var o in e){var r=e[o],l=t+o,s=i;Array.isArray(r)&&(s=J(i,r[1]),r=r[0]),r instanceof a?n[l]=[r,s]:(n[l+="/"]=[new a(0),s],eK(r,l,n,i))}},eY="undefined"!=typeof TextEncoder&&new TextEncoder,eX="undefined"!=typeof TextDecoder&&new TextDecoder,eZ=0;try{eX.decode(H,{stream:!0}),eZ=1}catch(e){}var eJ=function(e){for(var t="",n=0;;){var i=e[n++],o=(i>127)+(i>223)+(i>239);if(n+o>e.length)return{s:t,r:P(e,n-1)};o?3==o?t+=String.fromCharCode(55296|(i=((15&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536)>>10,56320|1023&i):1&o?t+=String.fromCharCode((31&i)<<6|63&e[n++]):t+=String.fromCharCode((15&i)<<12|(63&e[n++])<<6|63&e[n++]):t+=String.fromCharCode(i)}};function eQ(e,t){if(t){for(var n=new a(e.length),i=0;i<e.length;++i)n[i]=e.charCodeAt(i);return n}if(eY)return eY.encode(e);for(var o=e.length,r=new a(e.length+(e.length>>1)),l=0,s=function(e){r[l++]=e},i=0;i<o;++i){if(l+5>r.length){var d=new a(l+8+(o-i<<1));d.set(r),r=d}var c=e.charCodeAt(i);c<128||t?s(c):(c<2048?s(192|c>>6):(c>55295&&c<57344?(s(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++i))>>18),s(128|c>>12&63)):s(224|c>>12),s(128|c>>6&63)),s(128|63&c))}return P(r,0,l)}function e$(e,t){if(t){for(var n="",i=0;i<e.length;i+=16384)n+=String.fromCharCode.apply(null,e.subarray(i,i+16384));return n}if(eX)return eX.decode(e);var o=eJ(e),a=o.s,n=o.r;return n.length&&R(8),a}n.DecodeUTF8=function(){function e(e){this.ondata=e,eZ?this.t=new TextDecoder:this.p=H}return e.prototype.push=function(e,t){if(this.ondata||R(5),t=!!t,this.t){this.ondata(this.t.decode(e,{stream:!0}),t),t&&(this.t.decode().length&&R(8),this.t=null);return}this.p||R(4);var n=new a(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length);var i=eJ(n),o=i.s,r=i.r;t?(r.length&&R(8),this.p=null):this.p=r,this.ondata(o,t)},e}(),n.EncodeUTF8=function(){function e(e){this.ondata=e}return e.prototype.push=function(e,t){this.ondata||R(5),this.d&&R(4),this.ondata(eQ(e),this.d=t||!1)},e}(),n.strToU8=eQ,n.strFromU8=e$;var e0=function(e){return 1==e?3:e<6?2:+(9==e)},e1=function(e,t){return t+30+eg(e,t+26)+eg(e,t+28)},e2=function(e,t,n){var i=eg(e,t+28),o=e$(e.subarray(t+46,t+46+i),!(2048&eg(e,t+8))),a=t+46+i,r=ef(e,t+20),l=n&&0xffffffff==r?e3(e,a):[r,ef(e,t+24),ef(e,t+42)],s=l[0],d=l[1],c=l[2];return[eg(e,t+10),s,d,o,a+eg(e,t+30)+eg(e,t+32),c]},e3=function(e,t){for(;1!=eg(e,t);t+=4+eg(e,t+2));return[em(e,t+12),em(e,t+4),em(e,t+20)]},e5=function(e){var t=0;if(e)for(var n in e){var i=e[n].length;i>65535&&R(9),t+=i+4}return t},e4=function(e,t,n,i,o,a,r,l){var s=i.length,d=n.extra,c=l&&l.length,u=e5(d);ev(e,t,null!=r?0x2014b50:0x4034b50),t+=4,null!=r&&(e[t++]=20,e[t++]=n.os),e[t]=20,t+=2,e[t++]=n.flag<<1|(a<0&&8),e[t++]=o&&8,e[t++]=255&n.compression,e[t++]=n.compression>>8;var h=new Date(null==n.mtime?Date.now():n.mtime),g=h.getFullYear()-1980;if((g<0||g>119)&&R(10),ev(e,t,g<<25|h.getMonth()+1<<21|h.getDate()<<16|h.getHours()<<11|h.getMinutes()<<5|h.getSeconds()>>1),t+=4,-1!=a&&(ev(e,t,n.crc),ev(e,t+4,a<0?-a-2:a),ev(e,t+8,n.size)),ev(e,t+12,s),ev(e,t+14,u),t+=16,null!=r&&(ev(e,t,c),ev(e,t+6,n.attrs),ev(e,t+10,r),t+=14),e.set(i,t),t+=s,u)for(var f in d){var m=d[f],v=m.length;ev(e,t,+f),ev(e,t+2,v),e.set(m,t+4),t+=4+v}return c&&(e.set(l,t),t+=c),t},e8=function(e,t,n,i,o){ev(e,t,0x6054b50),ev(e,t+8,n),ev(e,t+10,n),ev(e,t+12,i),ev(e,t+16,o)},e6=function(){function e(e){this.filename=e,this.c=Y(),this.size=0,this.compression=0}return e.prototype.process=function(e,t){this.ondata(null,e,t)},e.prototype.push=function(e,t){this.ondata||R(5),this.c.p(e),this.size+=e.length,t&&(this.crc=this.c.d()),this.process(e,t||!1)},e}();n.ZipPassThrough=e6,n.ZipDeflate=function(){function e(e,t){var n=this;t||(t={}),e6.call(this,e),this.d=new eT(t,function(e,t){n.ondata(null,e,t)}),this.compression=8,this.flag=e0(t.level)}return e.prototype.process=function(e,t){try{this.d.push(e,t)}catch(e){this.ondata(e,null,t)}},e.prototype.push=function(e,t){e6.prototype.push.call(this,e,t)},e}(),n.AsyncZipDeflate=function(){function e(e,t){var n=this;t||(t={}),e6.call(this,e),this.d=new eC(t,function(e,t,i){n.ondata(e,t,i)}),this.compression=8,this.flag=e0(t.level),this.terminate=this.d.terminate}return e.prototype.process=function(e,t){this.d.push(e,t)},e.prototype.push=function(e,t){e6.prototype.push.call(this,e,t)},e}(),n.Zip=function(){function e(e){this.ondata=e,this.u=[],this.d=1}return e.prototype.add=function(e){var t=this;if(this.ondata||R(5),2&this.d)this.ondata(R(4+(1&this.d)*8,0,1),null,!1);else{var n=eQ(e.filename),i=n.length,o=e.comment,r=o&&eQ(o),l=i!=e.filename.length||r&&o.length!=r.length,s=i+e5(e.extra)+30;i>65535&&this.ondata(R(11,0,1),null,!1);var d=new a(s);e4(d,0,e,n,l,-1);var c=[d],u=function(){for(var e=0,n=c;e<n.length;e++){var i=n[e];t.ondata(null,i,!1)}c=[]},h=this.d;this.d=0;var g=this.u.length,f=J(e,{f:n,u:l,o:r,t:function(){e.terminate&&e.terminate()},r:function(){if(u(),h){var e=t.u[g+1];e?e.r():t.d=1}h=1}}),m=0;e.ondata=function(n,i,o){if(n)t.ondata(n,i,o),t.terminate();else if(m+=i.length,c.push(i),o){var r=new a(16);ev(r,0,0x8074b50),ev(r,4,e.crc),ev(r,8,m),ev(r,12,e.size),c.push(r),f.c=m,f.b=s+m+16,f.crc=e.crc,f.size=e.size,h&&f.r(),h=1}else h&&u()},this.u.push(f)}},e.prototype.end=function(){var e=this;if(2&this.d)return void this.ondata(R(4+(1&this.d)*8,0,1),null,!0);this.d?this.e():this.u.push({r:function(){1&e.d&&(e.u.splice(-1,1),e.e())},t:function(){}}),this.d=3},e.prototype.e=function(){for(var e=0,t=0,n=0,i=0,o=this.u;i<o.length;i++){var r=o[i];n+=46+r.f.length+e5(r.extra)+(r.o?r.o.length:0)}for(var l=new a(n+22),s=0,d=this.u;s<d.length;s++){var r=d[s];e4(l,e,r,r.f,r.u,-r.c-2,t,r.o),e+=46+r.f.length+e5(r.extra)+(r.o?r.o.length:0),t+=r.b}e8(l,e,this.u.length,n,t),this.ondata(null,l,!0),this.d=2},e.prototype.terminate=function(){for(var e=0,t=this.u;e<t.length;e++)t[e].t();this.d=2},e}(),n.zip=function(e,t,n){n||(n=t,t={}),"function"!=typeof n&&R(7);var i={};eK(e,"",i,t);var o=Object.keys(i),r=o.length,l=0,s=0,d=r,c=Array(r),u=[],h=function(){for(var e=0;e<u.length;++e)u[e]()},g=function(e,t){e9(function(){n(e,t)})};e9(function(){g=n});var f=function(){var e=new a(s+22),t=l,n=s-l;s=0;for(var i=0;i<d;++i){var o=c[i];try{var r=o.c.length;e4(e,s,o,o.f,o.u,r);var u=30+o.f.length+e5(o.extra),h=s+u;e.set(o.c,h),e4(e,l,o,o.f,o.u,r,s,o.m),l+=16+u+(o.m?o.m.length:0),s=h+r}catch(e){return g(e,null)}}e8(e,l,c.length,n,t),g(null,e)};r||f();for(var m=function(e){var t=o[e],n=i[t],a=n[0],d=n[1],m=Y(),v=a.length;m.p(a);var p=eQ(t),I=p.length,E=d.comment,w=E&&eQ(E),_=w&&w.length,S=e5(d.extra),y=8*(0!=d.level),T=function(n,i){if(n)h(),g(n,null);else{var o=i.length;c[e]=J(d,{size:v,crc:m.d(),c:i,f:p,m:w,u:I!=t.length||w&&E.length!=_,compression:y}),l+=30+I+S+o,s+=76+2*(I+S)+(_||0)+o,--r||f()}};if(I>65535&&T(R(11,0,1),null),y)if(v<16e4)try{T(null,eA(a,d))}catch(e){T(e,null)}else u.push(eb(a,d,T));else T(null,a)},v=0;v<d;++v)m(v);return h},n.zipSync=function(e,t){t||(t={});var n={},i=[];eK(e,"",n,t);var o=0,r=0;for(var l in n){var s=n[l],d=s[0],c=s[1],u=8*(0!=c.level),h=eQ(l),g=h.length,f=c.comment,m=f&&eQ(f),v=m&&m.length,p=e5(c.extra);g>65535&&R(11);var I=u?eA(d,c):d,E=I.length,w=Y();w.p(d),i.push(J(c,{size:d.length,crc:w.d(),c:I,f:h,m:m,u:g!=l.length||m&&f.length!=v,o:o,compression:u})),o+=30+g+p+E,r+=76+2*(g+p)+(v||0)+E}for(var _=new a(r+22),S=o,y=r-o,T=0;T<i.length;++T){var h=i[T];e4(_,h.o,h,h.f,h.u,h.c.length);var C=30+h.f.length+e5(h.extra);_.set(h.c,h.o+C),e4(_,o,h,h.f,h.u,h.c.length,h.o,h.m),o+=16+C+(h.m?h.m.length:0)}return e8(_,o,i.length,y,S),_};var e7=function(){function e(){}return e.prototype.push=function(e,t){this.ondata(null,e,t)},e.compression=0,e}();n.UnzipPassThrough=e7,n.UnzipInflate=function(){function e(){var e=this;this.i=new ex(function(t,n){e.ondata(null,t,n)})}return e.prototype.push=function(e,t){try{this.i.push(e,t)}catch(e){this.ondata(e,null,t)}},e.compression=8,e}(),n.AsyncUnzipInflate=function(){function e(e,t){var n=this;t<32e4?this.i=new ex(function(e,t){n.ondata(null,e,t)}):(this.i=new eD(function(e,t,i){n.ondata(e,t,i)}),this.terminate=this.i.terminate)}return e.prototype.push=function(e,t){this.i.terminate&&(e=P(e,0)),this.i.push(e,t)},e.compression=8,e}(),n.Unzip=function(){function e(e){this.onfile=e,this.k=[],this.o={0:e7},this.p=H}return e.prototype.push=function(e,t){var n=this;if(this.onfile||R(5),this.p||R(4),this.c>0){var i=Math.min(this.c,e.length),o=e.subarray(0,i);if(this.c-=i,this.d?this.d.push(o,!this.c):this.k[0].push(o),(e=e.subarray(i)).length)return this.push(e,t)}else{var r=0,l=0,s=void 0,d=void 0;this.p.length?e.length?((d=new a(this.p.length+e.length)).set(this.p),d.set(e,this.p.length)):d=this.p:d=e;for(var c=d.length,u=this.c,h=u&&this.d,g=this;l<c-4&&"break"!==function(){var e=ef(d,l);if(0x4034b50==e){r=1,s=l,g.d=null,g.c=0;var t=eg(d,l+6),i=eg(d,l+8),o=8&t,a=eg(d,l+26),h=eg(d,l+28);if(c>l+30+a+h){var f,m,v=[];g.k.unshift(v),r=2;var p=ef(d,l+18),I=ef(d,l+22),E=e$(d.subarray(l+30,l+=30+a),!(2048&t));0xffffffff==p?(p=(f=o?[-2]:e3(d,l))[0],I=f[1]):o&&(p=-1),l+=h,g.c=p;var w={name:E,compression:i,start:function(){if(w.ondata||R(5),p){var e=n.o[i];e||w.ondata(R(14,"unknown compression type "+i,1),null,!1),(m=p<0?new e(E):new e(E,p,I)).ondata=function(e,t,n){w.ondata(e,t,n)};for(var t=0;t<v.length;t++){var o=v[t];m.push(o,!1)}n.k[0]==v&&n.c?n.d=m:m.push(H,!0)}else w.ondata(null,H,!0)},terminate:function(){m&&m.terminate&&m.terminate()}};p>=0&&(w.size=p,w.originalSize=I),g.onfile(w)}return"break"}if(u){if(0x8074b50==e)return s=l+=12+(-2==u&&8),r=3,g.c=0,"break";else if(0x2014b50==e)return s=l-=4,r=3,g.c=0,"break"}}();++l);if(this.p=H,u<0){var f=r?d.subarray(0,s-12-(-2==u&&8)-(0x8074b50==ef(d,s-16)&&4)):d.subarray(0,l);h?h.push(f,!!r):this.k[+(2==r)].push(f)}if(2&r)return this.push(d.subarray(l),t);this.p=d.subarray(l)}t&&(this.c&&R(13),this.p=null)},e.prototype.register=function(e){this.o[e.compression]=e},e}();var e9="function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout?setTimeout:function(e){e()};n.unzip=function(e,t,n){n||(n=t,t={}),"function"!=typeof n&&R(7);var i=[],o=function(){for(var e=0;e<i.length;++e)i[e]()},r={},l=function(e,t){e9(function(){n(e,t)})};e9(function(){l=n});for(var s=e.length-22;0x6054b50!=ef(e,s);--s)if(!s||e.length-s>65558)return l(R(13,0,1),null),o;var d=eg(e,s+8);if(d){var c=d,u=ef(e,s+16),h=0xffffffff==u||65535==c;if(h){var g=ef(e,s-12);(h=0x6064b50==ef(e,g))&&(c=d=ef(e,g+32),u=ef(e,g+48))}for(var f=t&&t.filter,m=0;m<c;++m)!function(t){var n=e2(e,u,h),s=n[0],c=n[1],g=n[2],m=n[3],v=n[4],p=e1(e,n[5]);u=v;var I=function(e,t){e?(o(),l(e,null)):(t&&(r[m]=t),--d||l(null,r))};if(!f||f({name:m,size:c,originalSize:g,compression:s}))if(s)if(8==s){var E=e.subarray(p,p+c);if(g<524288||c>.8*g)try{I(null,eO(E,{out:new a(g)}))}catch(e){I(e,null)}else i.push(eM(E,{size:g},I))}else I(R(14,"unknown compression type "+s,1),null);else I(null,P(e,p,p+c));else I(null,null)}(0)}else l(null,{});return o},n.unzipSync=function(e,t){for(var n={},i=e.length-22;0x6054b50!=ef(e,i);--i)(!i||e.length-i>65558)&&R(13);var o=eg(e,i+8);if(!o)return{};var r=ef(e,i+16),l=0xffffffff==r||65535==o;if(l){var s=ef(e,i-12);(l=0x6064b50==ef(e,s))&&(o=ef(e,s+32),r=ef(e,s+48))}for(var d=t&&t.filter,c=0;c<o;++c){var u=e2(e,r,l),h=u[0],g=u[1],f=u[2],m=u[3],v=u[4],p=e1(e,u[5]);r=v,(!d||d({name:m,size:g,originalSize:f,compression:h}))&&(h?8==h?n[m]=eO(e.subarray(p,p+g),{out:new a(f)}):R(14,"unknown compression type "+h):n[m]=P(e,p,p+g))}return n}},589686,(e,t,n)=>{"use strict";n._=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},975400,(e,t,n)=>{"use strict";var i=e.r(589686);Object.defineProperty(n,"__esModule",{value:!0}),n.NIFTIEXTENSION=void 0,n.NIFTIEXTENSION=class{toArrayBuffer(){let e=new Uint8Array(this.esize),t=new Uint8Array(this.edata);e.set(t,8);let n=new DataView(e.buffer);return n.setInt32(0,this.esize,this.littleEndian),n.setInt32(4,this.ecode,this.littleEndian),e.buffer}constructor(e,t,n,o){if(i._(this,"esize",void 0),i._(this,"ecode",void 0),i._(this,"edata",void 0),i._(this,"littleEndian",void 0),e%16!=0)throw Error("This does not appear to be a NIFTI extension");this.esize=e,this.ecode=t,this.edata=n,this.littleEndian=o}}},817862,(e,t,n)=>{"use strict";var i=e.r(589686);Object.defineProperty(n,"__esModule",{value:!0}),n.Utils=void 0;let o=e.r(975400);class a{static getStringAt(e,t,n){var i,o,a="";for(i=t;i<n;i+=1)0!==(o=e.getUint8(i))&&(a+=String.fromCharCode(o));return a}static getIntAt(e,t,n){return e.getInt32(t,n)}static getFloatAt(e,t,n){return e.getFloat32(t,n)}static getDoubleAt(e,t,n){return e.getFloat64(t,n)}static getInt64At(e,t,n){let i,o=e.getUint32(t,n),a=e.getInt32(t+4,n);return i=n?0x100000000*a+o:0x100000000*o+a,a<0&&(i+=-1*0x100000000*0x100000000),i}static getExtensionsAt(e,t,n,i){let r=[],l=t;for(;l<i;){let t=n,s=a.getIntAt(e,l,n);if(!s)break;if(s+l>i&&(t=!t,(s=a.getIntAt(e,l,t))+l>i))throw Error("This does not appear to be a valid NIFTI extension");if(s%16!=0)throw Error("This does not appear to be a NIFTI extension");let d=a.getIntAt(e,l+4,t),c=e.buffer.slice(l+8,l+s);console.log("extensionByteIndex: "+(l+8)+" esize: "+s),console.log(c);let u=new o.NIFTIEXTENSION(s,d,c,t);r.push(u),l+=s}return r}static toArrayBuffer(e){var t,n,i;for(i=0,n=new Uint8Array(t=new ArrayBuffer(e.length));i<e.length;i+=1)n[i]=e[i];return t}static isString(e){return"string"==typeof e||e instanceof String}static formatNumber(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return t=a.isString(e)?Number(e):e,parseFloat(t=n?t.toPrecision(5):t.toPrecision(7))}static makeCRCTable(){let e,t=[];for(var n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?0xedb88320^e>>>1:e>>>1;t[n]=e}return t}static crc32(e){a.crcTable||(a.crcTable=a.makeCRCTable());let t=a.crcTable,n=-1;for(var i=0;i<e.byteLength;i++)n=n>>>8^t[(n^e.getUint8(i))&255];return(-1^n)>>>0}}i._(a,"crcTable",null),i._(a,"GUNZIP_MAGIC_COOKIE1",31),i._(a,"GUNZIP_MAGIC_COOKIE2",139),i._(a,"getByteAt",function(e,t){return e.getUint8(t)}),i._(a,"getShortAt",function(e,t,n){return e.getInt16(t,n)}),n.Utils=a},857853,(e,t,n)=>{"use strict";var i=e.i(467034),o=e.r(589686);Object.defineProperty(n,"__esModule",{value:!0}),n.NIFTI1=void 0;let a=e.r(817862);class r{readHeader(e){var t,n,i,o,l=new DataView(e),s=a.Utils.getIntAt(l,0,this.littleEndian);if(s!==r.MAGIC_COOKIE&&(this.littleEndian=!0,s=a.Utils.getIntAt(l,0,this.littleEndian)),s!==r.MAGIC_COOKIE)throw Error("This does not appear to be a NIFTI file!");for(t=0,this.dim_info=a.Utils.getByteAt(l,39);t<8;t+=1)o=40+2*t,this.dims[t]=a.Utils.getShortAt(l,o,this.littleEndian);for(t=0,this.intent_p1=a.Utils.getFloatAt(l,56,this.littleEndian),this.intent_p2=a.Utils.getFloatAt(l,60,this.littleEndian),this.intent_p3=a.Utils.getFloatAt(l,64,this.littleEndian),this.intent_code=a.Utils.getShortAt(l,68,this.littleEndian),this.datatypeCode=a.Utils.getShortAt(l,70,this.littleEndian),this.numBitsPerVoxel=a.Utils.getShortAt(l,72,this.littleEndian),this.slice_start=a.Utils.getShortAt(l,74,this.littleEndian);t<8;t+=1)o=76+4*t,this.pixDims[t]=a.Utils.getFloatAt(l,o,this.littleEndian);if(this.vox_offset=a.Utils.getFloatAt(l,108,this.littleEndian),this.scl_slope=a.Utils.getFloatAt(l,112,this.littleEndian),this.scl_inter=a.Utils.getFloatAt(l,116,this.littleEndian),this.slice_end=a.Utils.getShortAt(l,120,this.littleEndian),this.slice_code=a.Utils.getByteAt(l,122),this.xyzt_units=a.Utils.getByteAt(l,123),this.cal_max=a.Utils.getFloatAt(l,124,this.littleEndian),this.cal_min=a.Utils.getFloatAt(l,128,this.littleEndian),this.slice_duration=a.Utils.getFloatAt(l,132,this.littleEndian),this.toffset=a.Utils.getFloatAt(l,136,this.littleEndian),this.description=a.Utils.getStringAt(l,148,228),this.aux_file=a.Utils.getStringAt(l,228,252),this.qform_code=a.Utils.getShortAt(l,252,this.littleEndian),this.sform_code=a.Utils.getShortAt(l,254,this.littleEndian),this.quatern_b=a.Utils.getFloatAt(l,256,this.littleEndian),this.quatern_c=a.Utils.getFloatAt(l,260,this.littleEndian),this.quatern_d=a.Utils.getFloatAt(l,264,this.littleEndian),this.quatern_a=Math.sqrt(1-(Math.pow(this.quatern_b,2)+Math.pow(this.quatern_c,2)+Math.pow(this.quatern_d,2))),this.qoffset_x=a.Utils.getFloatAt(l,268,this.littleEndian),this.qoffset_y=a.Utils.getFloatAt(l,272,this.littleEndian),this.qoffset_z=a.Utils.getFloatAt(l,276,this.littleEndian),this.qform_code<1&&this.sform_code<1&&(this.affine[0][0]=this.pixDims[1],this.affine[1][1]=this.pixDims[2],this.affine[2][2]=this.pixDims[3]),this.qform_code>0&&this.sform_code<this.qform_code){let e=this.quatern_a,t=this.quatern_b,o=this.quatern_c,a=this.quatern_d;for(n=0,this.qfac=0===this.pixDims[0]?1:this.pixDims[0],this.quatern_R=[[e*e+t*t-o*o-a*a,2*t*o-2*e*a,2*t*a+2*e*o],[2*t*o+2*e*a,e*e+o*o-t*t-a*a,2*o*a-2*e*t],[2*t*a-2*e*o,2*o*a+2*e*t,e*e+a*a-o*o-t*t]];n<3;n+=1)for(i=0;i<3;i+=1)this.affine[n][i]=this.quatern_R[n][i]*this.pixDims[i+1],2===i&&(this.affine[n][i]*=this.qfac);this.affine[0][3]=this.qoffset_x,this.affine[1][3]=this.qoffset_y,this.affine[2][3]=this.qoffset_z}else if(this.sform_code>0)for(n=0;n<3;n+=1)for(i=0;i<4;i+=1)o=280+(4*n+i)*4,this.affine[n][i]=a.Utils.getFloatAt(l,o,this.littleEndian);if(this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.intent_name=a.Utils.getStringAt(l,328,344),this.magic=a.Utils.getStringAt(l,344,348),this.isHDR=this.magic===String.fromCharCode.apply(null,r.MAGIC_NUMBER2),l.byteLength>r.MAGIC_COOKIE){this.extensionFlag[0]=a.Utils.getByteAt(l,348),this.extensionFlag[1]=a.Utils.getByteAt(l,349),this.extensionFlag[2]=a.Utils.getByteAt(l,350),this.extensionFlag[3]=a.Utils.getByteAt(l,351);let e=!0;!this.isHDR&&this.vox_offset<=352&&(e=!1),l.byteLength<=368&&(e=!1),e&&this.extensionFlag[0]&&(this.extensions=a.Utils.getExtensionsAt(l,this.getExtensionLocation(),this.littleEndian,this.vox_offset),this.extensionSize=this.extensions[0].esize,this.extensionCode=this.extensions[0].ecode)}}toFormattedString(){var e=a.Utils.formatNumber,t="";return t+="Dim Info = "+this.dim_info+"\n"+("Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7])+"\n"+("Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3)+"\n"+("Intent Code = "+this.intent_code)+"\n"+("Datatype = "+this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode))+")\n"+("Bits Per Voxel = "+this.numBitsPerVoxel)+"\n"+("Slice Start = "+this.slice_start)+"\n"+("Voxel Dimensions (1-8): "+e(this.pixDims[0])+", "+e(this.pixDims[1])+", "+e(this.pixDims[2])+", "+e(this.pixDims[3])+", "+e(this.pixDims[4])+", "+e(this.pixDims[5])+", "+e(this.pixDims[6])+", "+e(this.pixDims[7]))+"\n"+("Image Offset = "+this.vox_offset)+"\n"+("Data Scale:  Slope = "+e(this.scl_slope)+"  Intercept = "+e(this.scl_inter))+"\n"+("Slice End = "+this.slice_end)+"\n"+("Slice Code = "+this.slice_code)+"\n"+("Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(r.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(r.TEMPORAL_UNITS_MASK&this.xyzt_units))+")\n"+("Display Range:  Max = "+e(this.cal_max)+"  Min = "+e(this.cal_min))+"\n"+("Slice Duration = "+this.slice_duration)+"\n"+("Time Axis Shift = "+this.toffset)+"\n"+('Description: "'+this.description)+'"\n'+('Auxiliary File: "'+this.aux_file)+'"\n'+("Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code))+")\n"+("S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code))+")\n"+("Quaternion Parameters:  b = "+e(this.quatern_b)+"  c = "+e(this.quatern_c)+"  d = "+e(this.quatern_d))+"\n"+("Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z)+"\n"+("S-Form Parameters X: "+e(this.affine[0][0])+", "+e(this.affine[0][1])+", "+e(this.affine[0][2])+", "+e(this.affine[0][3]))+"\n"+("S-Form Parameters Y: "+e(this.affine[1][0])+", "+e(this.affine[1][1])+", "+e(this.affine[1][2])+", "+e(this.affine[1][3]))+"\n"+("S-Form Parameters Z: "+e(this.affine[2][0])+", "+e(this.affine[2][1])+", "+e(this.affine[2][2])+", "+e(this.affine[2][3]))+"\n"+('Intent Name: "'+this.intent_name)+'"\n',this.extensionFlag[0]&&(t+="Extension: Size = "+this.extensionSize+"  Code = "+this.extensionCode+"\n"),t}getQformMat(){return this.convertNiftiQFormToNiftiSForm(this.quatern_b,this.quatern_c,this.quatern_d,this.qoffset_x,this.qoffset_y,this.qoffset_z,this.pixDims[1],this.pixDims[2],this.pixDims[3],this.pixDims[0])}convertNiftiQFormToNiftiSForm(e,t,n,i,o,a,r,l,s,d){var c,u,h,g,f=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],m=e,v=t,p=n;return f[3][0]=f[3][1]=f[3][2]=0,f[3][3]=1,(c=1-(m*m+v*v+p*p))<1e-7?(c=1/Math.sqrt(m*m+v*v+p*p),m*=c,v*=c,p*=c,c=0):c=Math.sqrt(c),u=r>0?r:1,h=l>0?l:1,g=s>0?s:1,d<0&&(g=-g),f[0][0]=(c*c+m*m-v*v-p*p)*u,f[0][1]=2*(m*v-c*p)*h,f[0][2]=2*(m*p+c*v)*g,f[1][0]=2*(m*v+c*p)*u,f[1][1]=(c*c+v*v-m*m-p*p)*h,f[1][2]=2*(v*p-c*m)*g,f[2][0]=2*(m*p-c*v)*u,f[2][1]=2*(v*p+c*m)*h,f[2][2]=(c*c+p*p-v*v-m*m)*g,f[0][3]=i,f[1][3]=o,f[2][3]=a,f}convertNiftiSFormToNEMA(e){var t,n,i,o,a,r,l,s,d,c,u,h,g,f,m,v,p,I,E,w,_,S,y,T,C,b,A,x,D,M,O,P,N;if(f=0,b=[[0,0,0],[0,0,0],[0,0,0]],A=[[0,0,0],[0,0,0],[0,0,0]],t=e[0][0],n=e[0][1],i=e[0][2],o=e[1][0],a=e[1][1],r=e[1][2],l=e[2][0],s=e[2][1],d=e[2][2],0===(c=Math.sqrt(t*t+o*o+l*l))||(t/=c,o/=c,l/=c,0===(c=Math.sqrt(n*n+a*a+s*s))))return null;if(n/=c,a/=c,s/=c,Math.abs(c=t*n+o*a+l*s)>1e-4){if(n-=c*t,a-=c*o,s-=c*l,0===(c=Math.sqrt(n*n+a*a+s*s)))return null;n/=c,a/=c,s/=c}if(0===(c=Math.sqrt(i*i+r*r+d*d))?(i=o*s-l*a,r=l*n-s*t,d=t*a-o*n):(i/=c,r/=c,d/=c),Math.abs(c=t*i+o*r+l*d)>1e-4){if(i-=c*t,r-=c*o,d-=c*l,0===(c=Math.sqrt(i*i+r*r+d*d)))return null;i/=c,r/=c,d/=c}if(Math.abs(c=n*i+a*r+s*d)>1e-4){if(i-=c*n,r-=c*a,d-=c*s,0===(c=Math.sqrt(i*i+r*r+d*d)))return null;i/=c,r/=c,d/=c}if(b[0][0]=t,b[0][1]=n,b[0][2]=i,b[1][0]=o,b[1][1]=a,b[1][2]=r,b[2][0]=l,b[2][1]=s,b[2][2]=d,0===(u=this.nifti_mat33_determ(b)))return null;for(h=1,C=-666,I=_=S=y=1,E=2,w=3;h<=3;h+=1)for(g=1;g<=3;g+=1)if(h!==g){for(f=1;f<=3;f+=1)if(h!==f&&g!==f)for(m=-1,A[0][0]=A[0][1]=A[0][2]=A[1][0]=A[1][1]=A[1][2]=A[2][0]=A[2][1]=A[2][2]=0;m<=1;m+=2)for(v=-1;v<=1;v+=2)for(p=-1;p<=1;p+=2)A[0][h-1]=m,A[1][g-1]=v,A[2][f-1]=p,this.nifti_mat33_determ(A)*u>0&&(c=(T=this.nifti_mat33_mul(A,b))[0][0]+T[1][1]+T[2][2])>C&&(C=c,I=h,E=g,w=f,_=m,S=v,y=p)}switch(x=D=M=O=P=N="",I*_){case 1:x="X",O="+";break;case -1:x="X",O="-";break;case 2:x="Y",O="+";break;case -2:x="Y",O="-";break;case 3:x="Z",O="+";break;case -3:x="Z",O="-"}switch(E*S){case 1:D="X",P="+";break;case -1:D="X",P="-";break;case 2:D="Y",P="+";break;case -2:D="Y",P="-";break;case 3:D="Z",P="+";break;case -3:D="Z",P="-"}switch(w*y){case 1:M="X",N="+";break;case -1:M="X",N="-";break;case 2:M="Y",N="+";break;case -2:M="Y",N="-";break;case 3:M="Z",N="+";break;case -3:M="Z",N="-"}return x+D+M+O+P+N}getExtensionLocation(){return r.MAGIC_COOKIE+4}getExtensionSize(e){return a.Utils.getIntAt(e,this.getExtensionLocation(),this.littleEndian)}getExtensionCode(e){return a.Utils.getIntAt(e,this.getExtensionLocation()+4,this.littleEndian)}addExtension(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==t?this.extensions.push(e):this.extensions.splice(t,0,e),this.vox_offset+=e.esize}removeExtension(e){let t=this.extensions[e];t&&(this.vox_offset-=t.esize),this.extensions.splice(e,1)}toArrayBuffer(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=352;if(e)for(let e of this.extensions)t+=e.esize;let n=new Uint8Array(t),o=new DataView(n.buffer);o.setInt32(0,348,this.littleEndian),o.setUint8(39,this.dim_info);for(let e=0;e<8;e++)o.setUint16(40+2*e,this.dims[e],this.littleEndian);o.setFloat32(56,this.intent_p1,this.littleEndian),o.setFloat32(60,this.intent_p2,this.littleEndian),o.setFloat32(64,this.intent_p3,this.littleEndian),o.setInt16(68,this.intent_code,this.littleEndian),o.setInt16(70,this.datatypeCode,this.littleEndian),o.setInt16(72,this.numBitsPerVoxel,this.littleEndian),o.setInt16(74,this.slice_start,this.littleEndian);for(let e=0;e<8;e++)o.setFloat32(76+4*e,this.pixDims[e],this.littleEndian);o.setFloat32(108,this.vox_offset,this.littleEndian),o.setFloat32(112,this.scl_slope,this.littleEndian),o.setFloat32(116,this.scl_inter,this.littleEndian),o.setInt16(120,this.slice_end,this.littleEndian),o.setUint8(122,this.slice_code),o.setUint8(123,this.xyzt_units),o.setFloat32(124,this.cal_max,this.littleEndian),o.setFloat32(128,this.cal_min,this.littleEndian),o.setFloat32(132,this.slice_duration,this.littleEndian),o.setFloat32(136,this.toffset,this.littleEndian),n.set(i.Buffer.from(this.description),148),n.set(i.Buffer.from(this.aux_file),228),o.setInt16(252,this.qform_code,this.littleEndian),o.setInt16(254,this.sform_code,this.littleEndian),o.setFloat32(256,this.quatern_b,this.littleEndian),o.setFloat32(260,this.quatern_c,this.littleEndian),o.setFloat32(264,this.quatern_d,this.littleEndian),o.setFloat32(268,this.qoffset_x,this.littleEndian),o.setFloat32(272,this.qoffset_y,this.littleEndian),o.setFloat32(276,this.qoffset_z,this.littleEndian);let a=this.affine.flat();for(let e=0;e<12;e++)o.setFloat32(280+4*e,a[e],this.littleEndian);if(n.set(i.Buffer.from(this.intent_name),328),n.set(i.Buffer.from(this.magic),344),e){n.set(Uint8Array.from([1,0,0,0]),348);let e=this.getExtensionLocation();for(let t of this.extensions)o.setInt32(e,t.esize,t.littleEndian),o.setInt32(e+4,t.ecode,t.littleEndian),n.set(new Uint8Array(t.edata),e+8),e+=t.esize}else n.set(new Uint8Array(4).fill(0),348);return n.buffer}constructor(){o._(this,"littleEndian",!1),o._(this,"dim_info",0),o._(this,"dims",[]),o._(this,"intent_p1",0),o._(this,"intent_p2",0),o._(this,"intent_p3",0),o._(this,"intent_code",0),o._(this,"datatypeCode",0),o._(this,"numBitsPerVoxel",0),o._(this,"slice_start",0),o._(this,"slice_end",0),o._(this,"slice_code",0),o._(this,"pixDims",[]),o._(this,"vox_offset",0),o._(this,"scl_slope",1),o._(this,"scl_inter",0),o._(this,"xyzt_units",0),o._(this,"cal_max",0),o._(this,"cal_min",0),o._(this,"slice_duration",0),o._(this,"toffset",0),o._(this,"description",""),o._(this,"aux_file",""),o._(this,"intent_name",""),o._(this,"qform_code",0),o._(this,"sform_code",0),o._(this,"quatern_a",0),o._(this,"quatern_b",0),o._(this,"quatern_c",0),o._(this,"quatern_d",0),o._(this,"qoffset_x",0),o._(this,"qoffset_y",0),o._(this,"qoffset_z",0),o._(this,"affine",[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]),o._(this,"qfac",1),o._(this,"quatern_R",void 0),o._(this,"magic","0"),o._(this,"isHDR",!1),o._(this,"extensionFlag",[0,0,0,0]),o._(this,"extensionSize",0),o._(this,"extensionCode",0),o._(this,"extensions",[]),o._(this,"getDatatypeCodeString",function(e){if(e===r.TYPE_UINT8)return"1-Byte Unsigned Integer";if(e===r.TYPE_INT16)return"2-Byte Signed Integer";if(e===r.TYPE_INT32)return"4-Byte Signed Integer";if(e===r.TYPE_FLOAT32)return"4-Byte Float";if(e===r.TYPE_FLOAT64)return"8-Byte Float";else if(e===r.TYPE_RGB24)return"RGB";else if(e===r.TYPE_INT8)return"1-Byte Signed Integer";else if(e===r.TYPE_UINT16)return"2-Byte Unsigned Integer";else if(e===r.TYPE_UINT32)return"4-Byte Unsigned Integer";else if(e===r.TYPE_INT64)return"8-Byte Signed Integer";else if(e===r.TYPE_UINT64)return"8-Byte Unsigned Integer";else return"Unknown"}),o._(this,"getTransformCodeString",function(e){return e===r.XFORM_SCANNER_ANAT?"Scanner":e===r.XFORM_ALIGNED_ANAT?"Aligned":e===r.XFORM_TALAIRACH?"Talairach":e===r.XFORM_MNI_152?"MNI":"Unknown"}),o._(this,"getUnitsCodeString",function(e){if(e===r.UNITS_METER)return"Meters";if(e===r.UNITS_MM)return"Millimeters";if(e===r.UNITS_MICRON)return"Microns";if(e===r.UNITS_SEC)return"Seconds";if(e===r.UNITS_MSEC)return"Milliseconds";else if(e===r.UNITS_USEC)return"Microseconds";else if(e===r.UNITS_HZ)return"Hz";else if(e===r.UNITS_PPM)return"PPM";else if(e===r.UNITS_RADS)return"Rads";else return"Unknown"}),o._(this,"nifti_mat33_mul",function(e,t){var n,i,o=[[0,0,0],[0,0,0],[0,0,0]];for(n=0;n<3;n+=1)for(i=0;i<3;i+=1)o[n][i]=e[n][0]*t[0][i]+e[n][1]*t[1][i]+e[n][2]*t[2][i];return o}),o._(this,"nifti_mat33_determ",function(e){var t,n,i,o,a,r,l,s,d;return t=e[0][0],n=e[0][1],i=e[0][2],o=e[1][0],a=e[1][1],r=e[1][2],l=e[2][0],s=e[2][1],t*a*(d=e[2][2])-t*s*r-o*n*d+o*s*i+l*n*r-l*a*i})}}o._(r,"TYPE_NONE",0),o._(r,"TYPE_BINARY",1),o._(r,"TYPE_UINT8",2),o._(r,"TYPE_INT16",4),o._(r,"TYPE_INT32",8),o._(r,"TYPE_FLOAT32",16),o._(r,"TYPE_COMPLEX64",32),o._(r,"TYPE_FLOAT64",64),o._(r,"TYPE_RGB24",128),o._(r,"TYPE_INT8",256),o._(r,"TYPE_UINT16",512),o._(r,"TYPE_UINT32",768),o._(r,"TYPE_INT64",1024),o._(r,"TYPE_UINT64",1280),o._(r,"TYPE_FLOAT128",1536),o._(r,"TYPE_COMPLEX128",1792),o._(r,"TYPE_COMPLEX256",2048),o._(r,"XFORM_UNKNOWN",0),o._(r,"XFORM_SCANNER_ANAT",1),o._(r,"XFORM_ALIGNED_ANAT",2),o._(r,"XFORM_TALAIRACH",3),o._(r,"XFORM_MNI_152",4),o._(r,"SPATIAL_UNITS_MASK",7),o._(r,"TEMPORAL_UNITS_MASK",56),o._(r,"UNITS_UNKNOWN",0),o._(r,"UNITS_METER",1),o._(r,"UNITS_MM",2),o._(r,"UNITS_MICRON",3),o._(r,"UNITS_SEC",8),o._(r,"UNITS_MSEC",16),o._(r,"UNITS_USEC",24),o._(r,"UNITS_HZ",32),o._(r,"UNITS_PPM",40),o._(r,"UNITS_RADS",48),o._(r,"MAGIC_COOKIE",348),o._(r,"STANDARD_HEADER_SIZE",348),o._(r,"MAGIC_NUMBER_LOCATION",344),o._(r,"MAGIC_NUMBER",[110,43,49]),o._(r,"MAGIC_NUMBER2",[110,105,49]),o._(r,"EXTENSION_HEADER_SIZE",8),n.NIFTI1=r},869756,(e,t,n)=>{"use strict";var i=e.i(467034),o=e.r(589686);Object.defineProperty(n,"__esModule",{value:!0}),n.NIFTI2=void 0;let a=e.r(857853),r=e.r(817862);class l{readHeader(e){var t,n,i,o,a=new DataView(e),s=r.Utils.getIntAt(a,0,this.littleEndian);if(s!==l.MAGIC_COOKIE&&(this.littleEndian=!0,s=r.Utils.getIntAt(a,0,this.littleEndian)),s!==l.MAGIC_COOKIE)throw Error("This does not appear to be a NIFTI file!");for(t=0,this.magic=r.Utils.getStringAt(a,4,12),this.datatypeCode=r.Utils.getShortAt(a,12,this.littleEndian),this.numBitsPerVoxel=r.Utils.getShortAt(a,14,this.littleEndian);t<8;t+=1)o=16+8*t,this.dims[t]=r.Utils.getInt64At(a,o,this.littleEndian);for(t=0,this.intent_p1=r.Utils.getDoubleAt(a,80,this.littleEndian),this.intent_p2=r.Utils.getDoubleAt(a,88,this.littleEndian),this.intent_p3=r.Utils.getDoubleAt(a,96,this.littleEndian);t<8;t+=1)o=104+8*t,this.pixDims[t]=r.Utils.getDoubleAt(a,o,this.littleEndian);for(n=0,this.vox_offset=r.Utils.getInt64At(a,168,this.littleEndian),this.scl_slope=r.Utils.getDoubleAt(a,176,this.littleEndian),this.scl_inter=r.Utils.getDoubleAt(a,184,this.littleEndian),this.cal_max=r.Utils.getDoubleAt(a,192,this.littleEndian),this.cal_min=r.Utils.getDoubleAt(a,200,this.littleEndian),this.slice_duration=r.Utils.getDoubleAt(a,208,this.littleEndian),this.toffset=r.Utils.getDoubleAt(a,216,this.littleEndian),this.slice_start=r.Utils.getInt64At(a,224,this.littleEndian),this.slice_end=r.Utils.getInt64At(a,232,this.littleEndian),this.description=r.Utils.getStringAt(a,240,320),this.aux_file=r.Utils.getStringAt(a,320,344),this.qform_code=r.Utils.getIntAt(a,344,this.littleEndian),this.sform_code=r.Utils.getIntAt(a,348,this.littleEndian),this.quatern_b=r.Utils.getDoubleAt(a,352,this.littleEndian),this.quatern_c=r.Utils.getDoubleAt(a,360,this.littleEndian),this.quatern_d=r.Utils.getDoubleAt(a,368,this.littleEndian),this.qoffset_x=r.Utils.getDoubleAt(a,376,this.littleEndian),this.qoffset_y=r.Utils.getDoubleAt(a,384,this.littleEndian),this.qoffset_z=r.Utils.getDoubleAt(a,392,this.littleEndian);n<3;n+=1)for(i=0;i<4;i+=1)o=400+(4*n+i)*8,this.affine[n][i]=r.Utils.getDoubleAt(a,o,this.littleEndian);this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.slice_code=r.Utils.getIntAt(a,496,this.littleEndian),this.xyzt_units=r.Utils.getIntAt(a,500,this.littleEndian),this.intent_code=r.Utils.getIntAt(a,504,this.littleEndian),this.intent_name=r.Utils.getStringAt(a,508,524),this.dim_info=r.Utils.getByteAt(a,524),a.byteLength>l.MAGIC_COOKIE&&(this.extensionFlag[0]=r.Utils.getByteAt(a,540),this.extensionFlag[1]=r.Utils.getByteAt(a,541),this.extensionFlag[2]=r.Utils.getByteAt(a,542),this.extensionFlag[3]=r.Utils.getByteAt(a,543),this.extensionFlag[0]&&(this.extensions=r.Utils.getExtensionsAt(a,this.getExtensionLocation(),this.littleEndian,this.vox_offset),this.extensionSize=this.extensions[0].esize,this.extensionCode=this.extensions[0].ecode))}toFormattedString(){var e=r.Utils.formatNumber,t="";return t+("Datatype = "+ +this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode)+")\n"+("Bits Per Voxel =  = "+this.numBitsPerVoxel)+"\n"+("Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7])+"\n"+("Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3)+"\n"+("Voxel Dimensions (1-8): "+e(this.pixDims[0])+", "+e(this.pixDims[1])+", "+e(this.pixDims[2])+", "+e(this.pixDims[3])+", "+e(this.pixDims[4])+", "+e(this.pixDims[5])+", "+e(this.pixDims[6])+", "+e(this.pixDims[7]))+"\n"+("Image Offset = "+this.vox_offset)+"\n"+("Data Scale:  Slope = "+e(this.scl_slope)+"  Intercept = "+e(this.scl_inter))+"\n"+("Display Range:  Max = "+e(this.cal_max)+"  Min = "+e(this.cal_min))+"\n"+("Slice Duration = "+this.slice_duration)+"\n"+("Time Axis Shift = "+this.toffset)+"\n"+("Slice Start = "+this.slice_start)+"\n"+("Slice End = "+this.slice_end)+"\n"+('Description: "'+this.description)+'"\n'+('Auxiliary File: "'+this.aux_file)+'"\n'+("Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code))+")\n"+("S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code))+")\n"+("Quaternion Parameters:  b = "+e(this.quatern_b)+"  c = "+e(this.quatern_c)+"  d = "+e(this.quatern_d))+"\n"+("Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z)+"\n"+("S-Form Parameters X: "+e(this.affine[0][0])+", "+e(this.affine[0][1])+", "+e(this.affine[0][2])+", "+e(this.affine[0][3]))+"\n"+("S-Form Parameters Y: "+e(this.affine[1][0])+", "+e(this.affine[1][1])+", "+e(this.affine[1][2])+", "+e(this.affine[1][3]))+"\n"+("S-Form Parameters Z: "+e(this.affine[2][0])+", "+e(this.affine[2][1])+", "+e(this.affine[2][2])+", "+e(this.affine[2][3]))+"\n"+("Slice Code = "+this.slice_code)+"\n"+("Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(a.NIFTI1.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(a.NIFTI1.TEMPORAL_UNITS_MASK&this.xyzt_units))+")\n"+("Intent Code = "+this.intent_code)+"\n"+('Intent Name: "'+this.intent_name)+'"\n'+("Dim Info = "+this.dim_info)+"\n")}toArrayBuffer(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=544;if(e)for(let e of this.extensions)t+=e.esize;let n=new Uint8Array(t),o=new DataView(n.buffer);o.setInt32(0,540,this.littleEndian),n.set(i.Buffer.from(this.magic),4),o.setInt16(12,this.datatypeCode,this.littleEndian),o.setInt16(14,this.numBitsPerVoxel,this.littleEndian);for(let e=0;e<8;e++)o.setBigInt64(16+8*e,BigInt(this.dims[e]),this.littleEndian);o.setFloat64(80,this.intent_p1,this.littleEndian),o.setFloat64(88,this.intent_p2,this.littleEndian),o.setFloat64(96,this.intent_p3,this.littleEndian);for(let e=0;e<8;e++)o.setFloat64(104+8*e,this.pixDims[e],this.littleEndian);o.setBigInt64(168,BigInt(this.vox_offset),this.littleEndian),o.setFloat64(176,this.scl_slope,this.littleEndian),o.setFloat64(184,this.scl_inter,this.littleEndian),o.setFloat64(192,this.cal_max,this.littleEndian),o.setFloat64(200,this.cal_min,this.littleEndian),o.setFloat64(208,this.slice_duration,this.littleEndian),o.setFloat64(216,this.toffset,this.littleEndian),o.setBigInt64(224,BigInt(this.slice_start),this.littleEndian),o.setBigInt64(232,BigInt(this.slice_end),this.littleEndian),n.set(i.Buffer.from(this.description),240),n.set(i.Buffer.from(this.aux_file),320),o.setInt32(344,this.qform_code,this.littleEndian),o.setInt32(348,this.sform_code,this.littleEndian),o.setFloat64(352,this.quatern_b,this.littleEndian),o.setFloat64(360,this.quatern_c,this.littleEndian),o.setFloat64(368,this.quatern_d,this.littleEndian),o.setFloat64(376,this.qoffset_x,this.littleEndian),o.setFloat64(384,this.qoffset_y,this.littleEndian),o.setFloat64(392,this.qoffset_z,this.littleEndian);let a=this.affine.flat();for(let e=0;e<12;e++)o.setFloat64(400+8*e,a[e],this.littleEndian);if(o.setInt32(496,this.slice_code,this.littleEndian),o.setInt32(500,this.xyzt_units,this.littleEndian),o.setInt32(504,this.intent_code,this.littleEndian),n.set(i.Buffer.from(this.intent_name),508),o.setUint8(524,this.dim_info),e){n.set(Uint8Array.from([1,0,0,0]),540);let e=this.getExtensionLocation();for(let t of this.extensions)o.setInt32(e,t.esize,t.littleEndian),o.setInt32(e+4,t.ecode,t.littleEndian),n.set(new Uint8Array(t.edata),e+8),e+=t.esize}else n.set(new Uint8Array(4).fill(0),540);return n.buffer}constructor(){o._(this,"littleEndian",!1),o._(this,"dim_info",0),o._(this,"dims",[]),o._(this,"intent_p1",0),o._(this,"intent_p2",0),o._(this,"intent_p3",0),o._(this,"intent_code",0),o._(this,"datatypeCode",0),o._(this,"numBitsPerVoxel",0),o._(this,"slice_start",0),o._(this,"slice_end",0),o._(this,"slice_code",0),o._(this,"pixDims",[]),o._(this,"vox_offset",0),o._(this,"scl_slope",1),o._(this,"scl_inter",0),o._(this,"xyzt_units",0),o._(this,"cal_max",0),o._(this,"cal_min",0),o._(this,"slice_duration",0),o._(this,"toffset",0),o._(this,"description",""),o._(this,"aux_file",""),o._(this,"intent_name",""),o._(this,"qform_code",0),o._(this,"sform_code",0),o._(this,"quatern_b",0),o._(this,"quatern_c",0),o._(this,"quatern_d",0),o._(this,"qoffset_x",0),o._(this,"qoffset_y",0),o._(this,"qoffset_z",0),o._(this,"affine",[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]),o._(this,"magic","0"),o._(this,"extensionFlag",[0,0,0,0]),o._(this,"extensions",[]),o._(this,"extensionSize",0),o._(this,"extensionCode",0),o._(this,"getExtensionLocation",function(){return l.MAGIC_COOKIE+4}),o._(this,"getExtensionSize",a.NIFTI1.prototype.getExtensionSize),o._(this,"getExtensionCode",a.NIFTI1.prototype.getExtensionCode),o._(this,"addExtension",a.NIFTI1.prototype.addExtension),o._(this,"removeExtension",a.NIFTI1.prototype.removeExtension),o._(this,"getDatatypeCodeString",a.NIFTI1.prototype.getDatatypeCodeString),o._(this,"getTransformCodeString",a.NIFTI1.prototype.getTransformCodeString),o._(this,"getUnitsCodeString",a.NIFTI1.prototype.getUnitsCodeString),o._(this,"getQformMat",a.NIFTI1.prototype.getQformMat),o._(this,"convertNiftiQFormToNiftiSForm",a.NIFTI1.prototype.convertNiftiQFormToNiftiSForm),o._(this,"convertNiftiSFormToNEMA",a.NIFTI1.prototype.convertNiftiSFormToNEMA),o._(this,"nifti_mat33_mul",a.NIFTI1.prototype.nifti_mat33_mul),o._(this,"nifti_mat33_determ",a.NIFTI1.prototype.nifti_mat33_determ)}}o._(l,"MAGIC_COOKIE",540),o._(l,"MAGIC_NUMBER_LOCATION",4),o._(l,"MAGIC_NUMBER",[110,43,50,0,13,10,26,10]),o._(l,"MAGIC_NUMBER2",[110,105,50,0,13,10,26,10]),n.NIFTI2=l},477888,(e,t,n)=>{"use strict";var i=e.e&&e.e.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var o=Object.getOwnPropertyDescriptor(t,n);(!o||("get"in o?!t.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,o)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),o=e.e&&e.e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=e.e&&e.e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return o(t,e),t};Object.defineProperty(n,"__esModule",{value:!0}),n.readExtensionData=n.readExtension=n.readImage=n.hasExtension=n.readHeader=n.decompress=n.isCompressed=n.isNIFTI=n.isNIFTI2=n.isNIFTI1=n.NIFTIEXTENSION=n.Utils=n.NIFTI2=n.NIFTI1=void 0;let r=a(e.r(290081)),l=e.r(857853),s=e.r(869756),d=e.r(817862);var c=e.r(857853);Object.defineProperty(n,"NIFTI1",{enumerable:!0,get:function(){return c.NIFTI1}});var u=e.r(869756);Object.defineProperty(n,"NIFTI2",{enumerable:!0,get:function(){return u.NIFTI2}});var h=e.r(817862);Object.defineProperty(n,"Utils",{enumerable:!0,get:function(){return h.Utils}});var g=e.r(975400);function f(e){var t,n,i,o;let a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return!(e.byteLength<l.NIFTI1.STANDARD_HEADER_SIZE)&&(n=(t=new DataView(e)).getUint8(l.NIFTI1.MAGIC_NUMBER_LOCATION),i=t.getUint8(l.NIFTI1.MAGIC_NUMBER_LOCATION+1),o=t.getUint8(l.NIFTI1.MAGIC_NUMBER_LOCATION+2),!!a&&n===l.NIFTI1.MAGIC_NUMBER2[0]&&i===l.NIFTI1.MAGIC_NUMBER2[1]&&o===l.NIFTI1.MAGIC_NUMBER2[2]||n===l.NIFTI1.MAGIC_NUMBER[0]&&i===l.NIFTI1.MAGIC_NUMBER[1]&&o===l.NIFTI1.MAGIC_NUMBER[2])}function m(e){var t,n,i,o;let a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return!(e.byteLength<l.NIFTI1.STANDARD_HEADER_SIZE)&&(n=(t=new DataView(e)).getUint8(s.NIFTI2.MAGIC_NUMBER_LOCATION),i=t.getUint8(s.NIFTI2.MAGIC_NUMBER_LOCATION+1),o=t.getUint8(s.NIFTI2.MAGIC_NUMBER_LOCATION+2),!!a&&n===s.NIFTI2.MAGIC_NUMBER2[0]&&i===s.NIFTI2.MAGIC_NUMBER2[1]&&o===s.NIFTI2.MAGIC_NUMBER2[2]||n===s.NIFTI2.MAGIC_NUMBER[0]&&i===s.NIFTI2.MAGIC_NUMBER[1]&&o===s.NIFTI2.MAGIC_NUMBER[2])}function v(e){var t,n,i;return!!e&&(n=(t=new DataView(e)).getUint8(0),i=t.getUint8(1),n===d.Utils.GUNZIP_MAGIC_COOKIE1||i===d.Utils.GUNZIP_MAGIC_COOKIE2)||!1}function p(e){return r.decompressSync(new Uint8Array(e)).buffer}Object.defineProperty(n,"NIFTIEXTENSION",{enumerable:!0,get:function(){return g.NIFTIEXTENSION}}),n.isNIFTI1=f,n.isNIFTI2=m,n.isNIFTI=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return f(e,t)||m(e,t)},n.isCompressed=v,n.decompress=p,n.readHeader=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var n=null;return v(e)&&(e=p(e)),f(e,t)?n=new l.NIFTI1:m(e,t)&&(n=new s.NIFTI2),n?n.readHeader(e):console.error("That file does not appear to be NIFTI!"),n},n.hasExtension=function(e){return 0!=e.extensionFlag[0]},n.readImage=function(e,t){var n=e.vox_offset,i=1,o=1;e.dims[4]&&(i=e.dims[4]),e.dims[5]&&(o=e.dims[5]);var a=e.dims[1]*e.dims[2]*e.dims[3]*i*o*(e.numBitsPerVoxel/8);return t.slice(n,n+a)},n.readExtension=function(e,t){var n=e.getExtensionLocation(),i=e.extensionSize;return t.slice(n,n+i)},n.readExtensionData=function(e,t){var n=e.getExtensionLocation(),i=e.extensionSize;return t.slice(n+8,n+i)}},356202,378588,736260,559688,312154,809166,513336,823467,783224,727044,563922,518792,412974,273965,239078,162923,344962,916821,650658,477210,183169,655809,100563,166956,265526,150761,238064,815926,478411,557141,493158,853939,498597,518519,275864,392511,950004,519318,731937,e=>{"use strict";let t;e.s(["createNiftiImageIdsAndCacheMetadata",()=>A],356202);var n,i,o,a,r=e.i(477888);e.s(["eventTarget",()=>l.default],378588);var l=e.i(701779),l=l;e.s(["triggerEvent",()=>s.default],736260);var s=e.i(627353),s=s,d=e.i(581632);e.s(["default",()=>c],559688),function(e){e.NIFTI_VOLUME_LOADED="CORNERSTONE_NIFTI_VOLUME_LOADED",e.NIFTI_VOLUME_PROGRESS="CORNERSTONE_NIFTI_VOLUME_PROGRESS"}(n||(n={}));let c=n;var u=e.i(399021);let{windowLevel:h}=d.utilities;e.s(["NIFTI_TYPE_FLOAT32",()=>v,"NIFTI_TYPE_FLOAT64",()=>p,"NIFTI_TYPE_INT16",()=>f,"NIFTI_TYPE_INT32",()=>m,"NIFTI_TYPE_INT8",()=>I,"NIFTI_TYPE_UINT16",()=>E,"NIFTI_TYPE_UINT32",()=>w,"NIFTI_TYPE_UINT8",()=>g],312154);let g=2,f=4,m=8,v=16,p=64,I=256,E=512,w=768;e.s(["getOptions",()=>S],809166);let _={beforeSend(){}};function S(){return _}let y=new Map;async function T(e){var t;let n,{url:i,onProgress:o,controller:a,onLoad:l,onHeader:s,loadFullVolume:d=!1,isCompressedOverride:c=!1}=e,h=new URL(i).pathname.endsWith(".gz")||c,S=new Uint8Array(0),y=null,T=a.signal,b={},A=await (null==(t=_.beforeSend)?void 0:t.call(_,null,b,i)),x=Object.assign({},b,A);Object.keys(x).forEach(function(e){null===x[e]&&(x[e]=void 0)});try{let e=await fetch(i,{signal:T,headers:x});if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));n=e.headers.get("Content-Length");let t=e.body.getReader(),o=h?new DecompressionStream("gzip"):null,r=o?o.writable.getWriter():null;if(C(t,r,h,0,D,a).catch(console.error),h){let e=o.readable.getReader();for(;;){let{done:t,value:n}=await e.read();if(t)break;if(D(n),y&&!d){a.abort();break}}}return l&&"function"==typeof l&&l(),{data:S,headerInfo:y,sliceInfo:null}}catch(e){throw"AbortError"===e.name?console.log("Fetch aborted"):console.error("Fetch error:",e),e}function D(e){(function(e){let t=new Uint8Array(S.length+e.length);t.set(S),t.set(e,S.length),S=t,d||y||!(S.length>=540)||((y=function(e){if(e.length<540)return{isValid:!1,message:"Not enough data to check header"};try{let t=e.slice(0,540).buffer,n=r.readHeader(t),i=540===n.sizeof_hdr?2:1,{orientation:o,origin:a,spacing:l}=function(e){let{affine:t}=e,{orientation:n,origin:i,spacing:o}=function(e){let t=[e[0][3],e[1][3],e[2][3]],n=[Math.sqrt(e[0][0]**2+e[1][0]**2+e[2][0]**2),Math.sqrt(e[0][1]**2+e[1][1]**2+e[2][1]**2),Math.sqrt(e[0][2]**2+e[1][2]**2+e[2][2]**2)];return{origin:t,orientation:[e[0][0]/n[0],e[0][1]/n[1],e[0][2]/n[2],e[1][0]/n[0],e[1][1]/n[1],e[1][2]/n[2],e[2][0]/n[0],e[2][1]/n[1],e[2][2]/n[2]],spacing:n}}(t);return{origin:[-i[0],-i[1],i[2]],orientation:[-n[0],-n[3],n[6],-n[1],-n[4],n[7],-n[2],-n[5],n[8]],spacing:o}}(n),{dimensions:s,direction:d}=function(e,t,n){let{numBitsPerVoxel:i,littleEndian:o,pixDims:a,dims:r}=e;r[1],r[2],r[3];let{windowWidth:l,windowCenter:s}={windowWidth:400,windowCenter:40},d=u.vec3.create(),c=u.vec3.create(),h=u.vec3.create();return u.vec3.set(d,t[0],t[1],t[2]),u.vec3.set(c,t[3],t[4],t[5]),u.vec3.set(h,t[6],t[7],t[8]),{volumeMetadata:{BitsAllocated:i,BitsStored:i,SamplesPerPixel:1,HighBit:o?i-1:1,PhotometricInterpretation:"MONOCHROME2",PixelRepresentation:1,ImageOrientationPatient:[d[0],d[1],d[2],c[0],c[1],c[2]],PixelSpacing:[a[1],a[2]],Columns:r[1],Rows:r[2],voiLut:[{windowCenter:s,windowWidth:l}],FrameOfReferenceUID:"1.2.3",Modality:"MR",VOILUTFunction:"LINEAR"},dimensions:[r[1],r[2],r[3]],direction:new Float32Array([d[0],d[1],d[2],c[0],c[1],c[2],h[0],h[1],h[2]])}}(n,o,0),c=function(e){switch(e){case g:return Uint8Array;case f:return Int16Array;case m:return Int32Array;case v:return Float32Array;case I:return Int8Array;case E:return Uint16Array;case w:return Uint32Array;case p:return Float64Array;default:throw Error("NIFTI datatypeCode ".concat(e," is not yet supported"))}}(n.datatypeCode);return{dimensions:s,direction:d,isValid:!0,message:"Valid Nifti-".concat(i," header detected"),origin:a,version:i,orientation:o,spacing:l,header:n,arrayConstructor:c}}catch(e){return console.error("Error reading Nifti header:",e),{isValid:!1,message:"Error reading Nifti header"}}}(S))&&y.isValid&&a.abort(),null==s||s(y))})(e),o&&"function"==typeof o&&o(0,n)}}async function C(e,t,n,i,o,a){for(;;){let{done:i,value:r}=await e.read();if(i){n&&t.close();break}if(r.length,n?await t.write(r):o(r),a.signal.aborted)break}}async function b(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=(t,n)=>{(0,s.default)(l.default,c.NIFTI_VOLUME_PROGRESS,{data:{volumeId:e,loaded:t,total:n}})},i=()=>{(0,s.default)(l.default,c.NIFTI_VOLUME_LOADED,{data:{volumeId:e}})},o=new AbortController;y.set(e,{controller:o,loading:!0});let{dimensions:a,direction:r,isValid:u,message:h,origin:g,version:f,header:m,spacing:v,arrayConstructor:p}=await new Promise(a=>{T({url:e,onProgress:n,controller:o,onLoad:i,onHeader:a,isCompressedOverride:t})}),I=a[2];if(!u)return void console.error(h);let E=[];for(let t=0;t<I;t++){let n="nifti:".concat(e,"?frame=").concat(t),i=t;E.push(n);let o=[r[0],r[1],r[2],r[3],r[4],r[5]],l=[parseFloat((g[0]+i*r[6]*v[0]).toFixed(6)),parseFloat((g[1]+i*r[7]*v[1]).toFixed(6)),parseFloat((g[2]+i*r[8]*v[2]).toFixed(6))],s={frameOfReferenceUID:"1.2.840.10008.1.4",rows:a[1],columns:a[0],imageOrientationPatient:o,rowCosines:r.slice(0,3),columnCosines:r.slice(3,6),imagePositionPatient:l,sliceThickness:v[2],sliceLocation:g[2]+t*v[2],pixelSpacing:[v[0],v[1]],rowPixelSpacing:v[1],columnPixelSpacing:v[0]},c={samplesPerPixel:1,photometricInterpretation:"MONOCHROME2",rows:a[1],columns:a[0],bitsAllocated:8*p.BYTES_PER_ELEMENT,bitsStored:8*p.BYTES_PER_ELEMENT,highBit:8*p.BYTES_PER_ELEMENT-1,pixelRepresentation:1,planarConfiguration:0,pixelAspectRatio:"1\\1",redPaletteColorLookupTableDescriptor:[],greenPaletteColorLookupTableDescriptor:[],bluePaletteColorLookupTableDescriptor:[],redPaletteColorLookupTableData:[],greenPaletteColorLookupTableData:[],bluePaletteColorLookupTableData:[],smallestPixelValue:void 0,largestPixelValue:void 0},u={seriesDate:new Date,seriesTime:new Date};d.utilities.genericMetadataProvider.add(n,{type:"imagePixelModule",metadata:c}),d.utilities.genericMetadataProvider.add(n,{type:"imagePlaneModule",metadata:s}),d.utilities.genericMetadataProvider.add(n,{type:"generalSeriesModule",metadata:u}),d.utilities.genericMetadataProvider.add(n,{type:"niftiVersion",metadata:{version:f}}),d.utilities.genericMetadataProvider.addRaw(n,{type:"niftiHeader",metadata:{header:m}})}return y.delete(e),E}async function A(e){let{url:t,isCompressed:n=!1}=e;return await b(t,n)}e.s(["getAnnotationNearPoint",()=>ed,"getAnnotationNearPointOnEnabledElement",()=>ec],477210),e.s(["getEnabledElement",()=>x.default],513336);var x=e.i(573855),x=x;e.s(["addAnnotation",()=>en,"addChildAnnotation",()=>$,"clearParentAnnotation",()=>Q,"getAllAnnotations",()=>J,"getAnnotation",()=>Z,"getAnnotationManager",()=>K,"getAnnotations",()=>X,"getChildAnnotations",()=>et,"getNumberOfAnnotations",()=>ei,"getParentAnnotation",()=>ee,"invalidateAnnotation",()=>er,"removeAllAnnotations",()=>eo,"removeAnnotation",()=>function e(n){var i;if(!n)return;let o=t,a=o.getAnnotation(n);a&&(null==(i=a.childAnnotationUIDs)||i.forEach(t=>e(t)),o.removeAnnotation(n),W({annotation:a,annotationManagerUID:o.uid}))},"removeAnnotations",()=>ea,"setAnnotationManager",()=>Y],344962),e.s(["triggerAnnotationAddedForElement",()=>B,"triggerAnnotationAddedForFOR",()=>G,"triggerAnnotationCompleted",()=>q,"triggerAnnotationModified",()=>z,"triggerAnnotationRemoved",()=>W,"triggerContourAnnotationCompleted",()=>H],162923);var x=x,s=s,l=l,D=x;e.s(["Events",()=>M],783224),e.s(["default",()=>M],823467),function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOLGROUP_VIEWPORT_ADDED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_ADDED",e.TOOLGROUP_VIEWPORT_REMOVED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_REMOVED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.CROSSHAIR_TOOL_CENTER_CHANGED="CORNERSTONE_TOOLS_CROSSHAIR_TOOL_CENTER_CHANGED",e.VOLUMECROPPINGCONTROL_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPINGCONTROL_TOOL_CHANGED",e.VOLUMECROPPING_TOOL_CHANGED="CORNERSTONE_TOOLS_VOLUMECROPPING_TOOL_CHANGED",e.STACK_PREFETCH_COMPLETE="CORNERSTONE_TOOLS_STACK_PREFETCH_COMPLETE",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_CUT_MERGE_PROCESS_COMPLETED",e.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",e.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_ADDED",e.SEGMENTATION_ADDED="CORNERSTONE_TOOLS_SEGMENTATION_ADDED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.HISTORY_UNDO="CORNERSTONE_TOOLS_HISTORY_UNDO",e.HISTORY_REDO="CORNERSTONE_TOOLS_HISTORY_REDO",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(i||(i={}));let M=i;e.s(["ChangeTypes",()=>O],563922),e.s(["default",()=>O],727044),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated",e.History="History",e.MetadataReferenceModified="MetadataReferenceModified",e.LabelChange="LabelChange"}(o||(o={}));let O=o;e.s(["default",()=>F],239078),e.s(["resetCornerstoneToolsState",()=>U,"state",()=>L],518792);let P={},N=P,R={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:N,enabledElements:[],handleRadius:6},L={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:N,enabledElements:[],handleRadius:6};function U(){P={},L={...structuredClone({...R,svgNodeCache:{}}),svgNodeCache:{...R.svgNodeCache}}}e.s(["ToolModes",()=>k],273965),e.s(["default",()=>k],412974),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(a||(a={}));let k=a,V=[k.Active,k.Passive,k.Enabled],F=function(e){return L.toolGroups.filter(t=>{let{toolOptions:n}=t,i=Object.keys(n);for(let t=0;t<i.length;t++)if(e===i[t]&&n[e]&&V.includes(n[e].mode))return!0;return!1})};function B(e,t){let{renderingEngine:n,viewportId:i}=(0,x.default)(t),o=M.ANNOTATION_ADDED,a={annotation:e,viewportId:i,renderingEngineId:n.id};(0,s.default)(l.default,o,a)}function G(e){let{toolName:t}=e.metadata,n=F(t);if(!n.length)return;let i=[];n.forEach(t=>{t.viewportsInfo.forEach(t=>{let{renderingEngineId:n,viewportId:o}=t,{FrameOfReferenceUID:a}=(0,D.getEnabledElementByIds)(o,n);e.metadata.FrameOfReferenceUID===a&&i.push(t)})});let o=M.ANNOTATION_ADDED,a={annotation:e};if(!i.length)return void(0,s.default)(l.default,o,a);i.forEach(e=>{let{renderingEngineId:t,viewportId:n}=e;a.viewportId=n,a.renderingEngineId=t,(0,s.default)(l.default,o,a)})}function W(e){let t=M.ANNOTATION_REMOVED;(0,s.default)(l.default,t,e)}function z(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:O.HandlesUpdated,{viewportId:i,renderingEngineId:o}=t&&(0,x.default)(t)||{},a=M.ANNOTATION_MODIFIED;(0,s.default)(l.default,a,{annotation:e,viewportId:i,renderingEngineId:o,changeType:n})}function q(e){j({annotation:e})}function H(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];j({annotation:e,contourHoleProcessingEnabled:t})}function j(e){let t=M.ANNOTATION_COMPLETED;(0,s.default)(l.default,t,e)}function K(){return t}function Y(e){t=e}function X(e,n){let i=t,o=i.getGroupKey(n);return i.getAnnotations(o,e)}function Z(e){return t.getAnnotation(e)}function J(){return t.getAllAnnotations()}function Q(e){let{annotationUID:t,parentAnnotationUID:n}=e;if(!n)return;let i=Z(n),o=i.childAnnotationUIDs.indexOf(t);i.childAnnotationUIDs.splice(o,1),e.parentAnnotationUID=void 0}function $(e,t){let{annotationUID:n}=e,{annotationUID:i}=t;Q(t),e.childAnnotationUIDs||(e.childAnnotationUIDs=[]),e.childAnnotationUIDs.includes(i)||(e.childAnnotationUIDs.push(i),t.parentAnnotationUID=n)}function ee(e){return e.parentAnnotationUID?Z(e.parentAnnotationUID):void 0}function et(e){var t,n;return null!=(n=null==(t=e.childAnnotationUIDs)?void 0:t.map(e=>Z(e)))?n:[]}function en(e,n){e.annotationUID||(e.annotationUID=d.utilities.uuidv4());let i=t;if(n instanceof HTMLDivElement){let t=i.getGroupKey(n);i.addAnnotation(e,t),B(e,n)}else i.addAnnotation(e,void 0),G(e);return e.annotationUID}function ei(e,n){let i=t,o=i.getGroupKey(n);return i.getNumberOfAnnotations(o,e)}function eo(){let e=t;for(let t of e.removeAllAnnotations())W({annotation:t,annotationManagerUID:e.uid})}function ea(e,n){let i=t,o=i.getGroupKey(n);for(let t of i.removeAnnotations(o,e))W({annotation:t,annotationManagerUID:i.uid})}function er(e){let t=e;for(;t;)t.invalidated=!0,t=t.parentAnnotationUID?Z(t.parentAnnotationUID):void 0}e.s(["getToolGroupForViewport",()=>es],650658),e.s(["default",()=>es],916821);var el=e.i(23529);let es=function(e,t){if(!t){var n;t=null==(n=(0,el.getRenderingEngines)().find(t=>t.getViewports().find(t=>t.id===e)))?void 0:n.id}let i=L.toolGroups.filter(n=>n.viewportsInfo.some(n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)));if(i.length){if(i.length>1)throw Error("Multiple tool groups found for renderingEngineId: ".concat(t," and viewportId: ").concat(e,". You should only\n      have one tool group per viewport in a renderingEngine."));return i[0]}};function ed(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,i=(0,x.default)(e);if(!i)throw Error("getAnnotationNearPoint: enabledElement not found");return ec(i,t,n)}function ec(e,t,n){let{renderingEngineId:i,viewportId:o}=e,a=es(o,i);if(!a)return null;let{_toolInstances:r}=a;for(let i in r){let o=function(e,t,n,i){var o,a;let{viewport:r}=t,l=X(e.constructor.toolName,null==r?void 0:r.element),s=null==r||null==(o=r.getCurrentImageId)?void 0:o.call(r);if(null==l?void 0:l.length){let{element:o}=t.viewport;for(let t of l){let r=null==(a=t.metadata)?void 0:a.referencedImageId;if((!s||!r||s===r)&&e.isPointNearTool&&(e.isPointNearTool(o,t,n,i,"")||e.getHandleNearImagePoint(o,t,n,i)))return t}}return null}(r[i],e,t,n);if(o)return o}return null}e.s(["default",()=>eh],655809),e.s(["default",()=>eu],183169);let eu=function(e){let t=typeof e;return null!==e&&("object"===t||"function"===t)},eh=function(e,t,n){let i,o,a,r,l,s,d=0,c=!1,u=!1,h=!0,g=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw TypeError("Expected a function");function f(t){let n=i,a=o;return i=o=void 0,d=t,r=e.apply(a,n)}function m(e,t){return g?window.requestAnimationFrame(e):setTimeout(e,t)}function v(e){let n=e-s,i=e-d;return void 0===s||n>=t||n<0||u&&i>=a}function p(){let e=Date.now();if(v(e))return I(e);l=m(p,function(e){let n=e-s,i=e-d,o=t-n;return u?Math.min(o,a-i):o}(e))}function I(e){return(l=void 0,h&&i)?f(e):(i=o=void 0,r)}function E(){for(var e,n=arguments.length,a=Array(n),h=0;h<n;h++)a[h]=arguments[h];let g=Date.now(),I=v(g);if(i=a,o=this,s=g,I){if(void 0===l)return d=e=s,l=m(p,t),c?f(e):r;if(u)return l=m(p,t),f(s)}return void 0===l&&(l=m(p,t)),r}return t=Number(t)||0,eu(n)&&(c=!!n.leading,a=(u="maxWait"in n)?Math.max(Number(n.maxWait)||0,t):a,h="trailing"in n?!!n.trailing:h),E.cancel=function(){void 0!==l&&function(e){if(g)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),d=0,i=s=o=l=void 0},E.flush=function(){return void 0===l?r:I(Date.now())},E.pending=function(){return void 0!==l},E};e.s(["default",()=>eg],100563);let eg=function(e,t,n){let i=!0,o=!0;if("function"!=typeof e)throw TypeError("Expected a function");return eu(n)&&(i="leading"in n?!!n.leading:i,o="trailing"in n?!!n.trailing:o),eh(e,t,{leading:i,trailing:o,maxWait:t})};e.s(["default",()=>ev],166956);var ef=e.i(883035);let{calibratedPixelSpacingMetadataProvider:em}=d.utilities;function ev(e,t,n){"number"==typeof n&&(n={type:ef.Enums.CalibrationTypes.USER,scale:n}),em.add(e,n),t.getStackViewports().forEach(t=>{t.getImageIds().includes(e)&&t.calibrateSpacing(e)})}e.s(["default",()=>eO,"triggerAnnotationRenderForViewportIds",()=>eM],815926);var ep=x;e.s(["default",()=>eD],238064),e.s(["annotationRenderingEngine",()=>ex],150761);var x=x,s=s,x=x;function eI(e,t){if(L.svgNodeCache[e]&&L.svgNodeCache[e][t])return L.svgNodeCache[e][t].domRef}function eE(e,t,n,i){if(!L.svgNodeCache[t])return null;L.svgNodeCache[t][i]={touched:!0,domRef:n},e.appendChild(n)}function ew(e,t){L.svgNodeCache[e]&&L.svgNodeCache[e][t]&&(L.svgNodeCache[e][t].touched=!0)}function e_(e,t){L.svgNodeCache[t]&&Object.keys(L.svgNodeCache[t]).forEach(n=>{let i=L.svgNodeCache[t][n];!i.touched&&i.domRef&&(e.removeChild(i.domRef),delete L.svgNodeCache[t][n])})}let eS=function(e){let{viewportId:t,renderingEngineId:n}=(0,x.default)(e),i="".concat(t,":").concat(n),o=function(e){let t=e.querySelector(".".concat("viewport-element"));return null==t?void 0:t.querySelector(":scope > .svg-layer")}(e);return Object.keys(L.svgNodeCache[i]).forEach(e=>{L.svgNodeCache[i][e].touched=!1}),{svgLayerElement:o,svgNodeCacheForCanvas:L.svgNodeCache,getSvgNode:eI.bind(this,i),appendNode:eE.bind(this,o,i),setNodeTouched:ew.bind(this,i),clearUntouched:e_.bind(this,o,i)}},ey=function(e,t){let n=eS(e);t(n),n.clearUntouched()};e.s(["default",()=>eT],265526);var x=x;function eT(e,t){let{renderingEngineId:n,viewportId:i}=(0,x.default)(e),o=es(i,n);if(!o)return[];let a=[],r=Object.keys(o.toolOptions);for(let e=0;e<r.length;e++){let n=r[e],i=o.toolOptions[n];if(i&&t.includes(i.mode)){let e=o.getToolInstance(n);a.push(e)}}return a}let{Active:eC,Passive:eb,Enabled:eA}=k,ex=new class{addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach(e=>{this._needsRender.add(e)}),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){let t=[...this._viewportElements.values()];e.forEach(e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)}),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){let t=(0,x.default)(e);if(!t)return;if(!(0,el.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");let n=eT(e,[eC,eb,eA]),{renderingEngineId:i,viewportId:o}=t,a={element:e,renderingEngineId:i,viewportId:o};ey(e,i=>{let o=!1;n.forEach(e=>{if(e.renderAnnotation){let n=e.renderAnnotation(t,i);o=o||n}}),o&&(0,s.default)(e,M.ANNOTATION_RENDERED,{...a})})}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();let e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){let n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))break}this._animationFrameSet=!1,this._animationFrameHandle=null,this._render()},this._viewportElements=new Map}},eD=function(e){ex.renderViewport(e)};function eM(e){e.length&&e.forEach(e=>{let t=(0,ep.getEnabledElementByViewportId)(e);if(!t)return void console.warn("Viewport not available for ".concat(e));let{viewport:n}=t;if(!n)return void console.warn("Viewport not available for ".concat(e));eD(n.element)})}let eO=eM;e.s(["default",()=>eR,"triggerAnnotationRenderForToolGroupIds",()=>eN],493158),e.s(["getToolGroup",()=>eP],557141),e.s(["default",()=>eP],478411);let eP=function(e){return L.toolGroups.find(t=>t.id===e)};function eN(e){e.forEach(e=>{let t=eP(e);if(!t)return void console.warn("ToolGroup not available for ".concat(e));t.getViewportsInfo().forEach(e=>{let{renderingEngineId:t,viewportId:n}=e,i=(0,el.getRenderingEngine)(t);if(!i)return void console.warn("RenderingEngine not available for ".concat(t));eD(i.getViewport(n).element)})})}let eR=eN;e.s(["getSphereBoundsInfo",()=>eW,"getSphereBoundsInfoFromViewport",()=>ez],518519),e.s(["getBoundingBoxAroundShapeIJK",()=>eV,"getBoundingBoxAroundShapeWorld",()=>eF],498597),e.s(["CONSTANTS",()=>eL],853939);var eL=e.i(77751),eL=eL;let{EPSILON:eU}=eL;function ek(e,t){var n,i,o;let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=1/0,l=a?-1/0:0,s=1/0,d=a?-1/0:0,c=1/0,u=a?-1/0:0,h=(null==(n=e[0])?void 0:n.length)===3;for(let t=0;t<e.length;t++){let n=e[t];r=Math.min(n[0],r),l=Math.max(n[0],l),s=Math.min(n[1],s),d=Math.max(n[1],d),h&&(c=Math.min(null!=(i=n[2])?i:c,c),u=Math.max(null!=(o=n[2])?o:u,u))}return t?(r=Math.max(a?t[0]+eU:0,r),l=Math.min(a?t[0]-eU:t[0]-1,l),s=Math.max(a?t[1]+eU:0,s),d=Math.min(a?t[1]-eU:t[1]-1,d),h&&3===t.length&&(c=Math.max(a?t[2]+eU:0,c),u=Math.min(a?t[2]-eU:t[2]-1,u))):!a&&(r=Math.max(0,r),l=Math.min(1/0,l),s=Math.max(0,s),d=Math.min(1/0,d),h&&(c=Math.max(0,c),u=Math.min(1/0,u))),h?[[r,l],[s,d],[c,u]]:[[r,l],[s,d],null]}function eV(e,t){return ek(e,t,!1)}function eF(e,t){return ek(e,t,!0)}let{transformWorldToIndex:eB}=d.utilities;function eG(e,t,n){let[i,o]=e,a=u.vec3.fromValues((i[0]+o[0])/2,(i[1]+o[1])/2,(i[2]+o[2])/2),r=u.vec3.distance(i,o)/2,{boundsIJK:l,topLeftWorld:s,bottomRightWorld:d}=function(e,t,n,i,o){let a=e.getDimensions(),{row:r,column:l,normal:s}=t,d=u.vec3.create(),c=u.vec3.create();u.vec3.scaleAndAdd(d,i,s,o),u.vec3.scaleAndAdd(c,i,s,-o),u.vec3.scaleAndAdd(d,d,l,-o),u.vec3.scaleAndAdd(c,c,l,o),u.vec3.scaleAndAdd(d,d,r,-o),u.vec3.scaleAndAdd(c,c,r,o);let h=eB(e,d);return{boundsIJK:eV([h,eB(e,c),...n.map(t=>eB(e,t))],a),topLeftWorld:d,bottomRightWorld:c}}(t,n,e,a,r);return{boundsIJK:l,centerWorld:a,radiusWorld:r,topLeftWorld:s,bottomRightWorld:d}}function eW(e,t){let n=t.getDirection(),i=u.vec3.fromValues(n[0],n[1],n[2]),o=u.vec3.fromValues(n[3],n[4],n[5]),a=u.vec3.fromValues(n[6],n[7],n[8]);return eG(e,t,{row:i,column:o,normal:u.vec3.negate(u.vec3.create(),a)})}function ez(e,t,n){if(!n)throw Error("viewport is required in order to calculate the sphere bounds");let i=n.getCamera(),o=u.vec3.fromValues(i.viewUp[0],i.viewUp[1],i.viewUp[2]),a=u.vec3.fromValues(i.viewPlaneNormal[0],i.viewPlaneNormal[1],i.viewPlaneNormal[2]),r=u.vec3.create();return u.vec3.cross(r,o,a),eG(e,t,{row:r,normal:a,column:u.vec3.negate(u.vec3.create(),o)})}function eq(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}e.s(["pointToString",()=>eq],275864),e.s(["default",()=>eH],392511);var s=s,l=l;class eH{static setStartRange(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.getCurrentImageIdIndex();this.setRange(e,t,n)}static setEndRange(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.getCurrentImageIdIndex();this.setRange(e,t,void 0,n)}static setRange(e,t,n,i){var o;let{metadata:a}=t;void 0===n&&(n=a.sliceIndex<i?a.sliceIndex:0,void 0===i&&(i=e.getNumberOfSlices()-1));let r=e.getSliceIndexForImage(a.multiSliceReference);void 0===i&&(i=r>=n?r:e.getNumberOfSlices()-1),i=Math.max(n,i),a.sliceIndex=Math.min(n,i),a.referencedImageId=e.getCurrentImageId(a.sliceIndex),a.referencedImageURI=void 0,i===a.sliceIndex?a.multiSliceReference=void 0:i!==(null==(o=a.multiSliceReference)?void 0:o.sliceIndex)&&(a.multiSliceReference={referencedImageId:e.getCurrentImageId(i),sliceIndex:i});let d={viewportId:e.id,renderingEngineId:e.renderingEngineId,changeType:O.MetadataReferenceModified,annotation:t};(0,s.default)(l.default,M.ANNOTATION_MODIFIED,d),this.setViewportFrameRange(e,a)}static setSingle(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.getCurrentImageIdIndex();this.setRange(e,t,n,n)}static getFrameRange(e){let{metadata:t}=e,{sliceIndex:n,multiSliceReference:i}=t,o=null==i?void 0:i.sliceIndex;return o?[n+1,o+1]:n+1}static getFrameRangeStr(e){let t=this.getFrameRange(e);return Array.isArray(t)?"".concat(t[0],"-").concat(t[1]):String(t)}static setViewportFrameRange(e,t){var n;e.setFrameRange&&(null==(n=t.multiSliceReference)?void 0:n.sliceIndex)&&e.setFrameRange(t.sliceIndex+1,t.multiSliceReference.sliceIndex+1)}}e.s(["default",()=>eX],519318),e.s(["default",()=>eY],950004);var ej=x;let{isEqual:eK}=d.utilities;function eY(e){let{metadata:t}=e;return(0,ej.getEnabledElements)().filter(e=>{if(e.FrameOfReferenceUID===t.FrameOfReferenceUID){let{viewPlaneNormal:n,viewUp:i}=e.viewport.getCamera();return eK(n,t.viewPlaneNormal)&&(!t.viewUp||eK(i,t.viewUp))}}).map(e=>e.viewport)}function eX(e){let t=eY(e);if(!(null==t?void 0:t.length))return;let n=t.find(t=>t.getImageIds().some(t=>t===e.metadata.referencedImageId));return null!=n?n:t[0]}e.s(["BaseVolumeViewport",()=>eZ.default],731937);var eZ=e.i(854888)},560463,e=>{e.v(e.b(["static/chunks/8fb860f2dc18fa33.js","static/chunks/cb6572c1c39d3684.js","static/chunks/turbopack-b09a55184953be18.js"]))},761684,590625,436296,475307,29728,158817,544279,984029,708580,318701,391297,922538,585955,340354,824263,e=>{"use strict";e.s(["annotationHydration",()=>c,"getClosestImageIdForStackViewport",()=>u],761684);var t,n,i=e.i(581632),o=e.i(731937),a=e.i(209501),r=e.i(560031),l=e.i(504019),s=e.i(344962),d=e.i(399021);function c(e,t,n,l){let{viewPlaneNormal:d,FrameOfReferenceUID:c}=e.getViewReference(),h={annotationUID:(null==l?void 0:l.annotationUID)||i.utilities.uuidv4(),data:{handles:{points:n}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:t,viewPlaneNormal:d,FrameOfReferenceUID:c,referencedImageId:function(e,t,n){let l;if(e instanceof a.StackViewport)l=u(e,t,n);else if(e instanceof o.BaseVolumeViewport){let a=function(e){var t;let n=null==(t=e.getViewReferenceId)?void 0:t.call(e);if(n)return n;if(e instanceof o.BaseVolumeViewport)return"volumeId:".concat(function(e){var t;let n=e.getActors();if(n)return null==(t=n.find(e=>"vtkVolume"===e.actor.getClassName()))?void 0:t.uid}(e));throw Error("getTargetId: viewport must have a getTargetId method")}(e),s=i.utilities.getVolumeId(a),d=r.cache.getVolume(s);l=i.utilities.getClosestImageId(d,t,n)}else throw Error("getReferencedImageId: viewport must be a StackViewport or BaseVolumeViewport");return l}(e,n[0],d),...l}};return(0,s.addAnnotation)(h,e.element),h}function u(e,t,n){let i=e.getImageIds();if(!i||!i.length)return;let o=i.map(e=>{let{imagePositionPatient:i}=l.metaData.get("imagePlaneModule",e);return{imageId:e,distance:function(e,t,n){let i=d.vec3.create();return d.vec3.sub(i,e,t),Math.abs(d.vec3.dot(i,n))}(t,i,n)}});return o.sort((e,t)=>e.distance-t.distance),o[0].imageId}e.s(["default",()=>g],590625);var h=e.i(213918);function g(e,t){let{viewPlaneNormal:n}=e.metadata,{viewPlaneNormal:i}=t.metadata,o=d.vec3.dot(n,i);if(!h.glMatrix.equals(1,Math.abs(o)))return!1;let{polyline:a}=e.data.contour,{polyline:r}=t.data.contour,l=d.vec3.dot(n,a[0]),s=d.vec3.dot(n,r[0]);return h.glMatrix.equals(l,s)}e.s(["default",()=>f],436296);let f={processContourHoles:function(e,t){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2],i=e.filter(e=>"CLOSED_PLANAR"!==e.type),o=e.filter(e=>"CLOSED_PLANAR"===e.type),a=[],r=[];return o.forEach((e,n)=>{let i=[];o.forEach((o,a)=>{n!=a&&function(e,t,n){let i=[];e.contourPoints.forEach(e=>{i.push([n[e][0],n[e][1]])});let o=0;return t.contourPoints.forEach(e=>{!((e,t)=>{let n=e[0],i=e[1],o=!1;for(let e=0,a=t.length-1;e<t.length;a=e++){let r=t[e][0],l=t[e][1],s=t[a][0],d=t[a][1];l>i!=d>i&&n<(s-r)*(i-l)/(d-l)+r&&(o=!o)}return o})([n[e][0],n[e][1]],i)&&o++}),0===o}(e,o,t)&&i.push(a)}),i.length>0?a.push({contour:e,holes:i}):r.push(n)}),n&&(a.forEach(e=>{e.contour.type="CLOSEDPLANAR_XOR",i.push(e.contour),e.holes.forEach(e=>{o[e].type="CLOSEDPLANAR_XOR",i.push(o[e]),r=r.filter(t=>t!==e)})}),r.forEach(e=>{i.push(o[e])})),i}};function m(e){if(e.length<3)return 0;let t=e[0],n=0;for(let i=0,o=e.length;i<o;i++){let a=e[i],r=e[i===o-1?0:i+1],l=a[0]-t[0],s=a[1]-t[1],d=r[0]-t[0];n+=l*(r[1]-t[1])-s*d}return .5*n}function v(e,t){if(e.length!==t.length)throw Error("Both points should have the same dimensionality");let[n,i,o=0]=e,[a,r,l=0]=t,s=a-n,d=r-i,c=l-o;return s*s+d*d+c*c}function p(e){if(e.length<3)return!1;let t=e.length,n=v(e[0],e[t-1]);return h.glMatrix.equals(0,n)}function I(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{closed:void 0};if(e.length<3)return!1;let i=e.length,o=0,{closed:a,holes:r}=n;if(null==r?void 0:r.length){for(let e of r)if(I(e,t))return!1}let l=!(void 0===a?p(e):a),s=e.length-(l?1:2);for(let n=0;n<=s;n++){let a=e[n],r=e[n===i-1?0:n+1],l=a[0]>=r[0]?a[0]:r[0],s=a[1]>=r[1]?a[1]:r[1],d=a[1]<=r[1]?a[1]:r[1];if(t[0]<=l&&t[1]>=d&&t[1]<s){let e=a[0]===r[0];if(!e){let n=(t[1]-a[1])*(r[0]-a[0])/(r[1]-a[1])+a[0];e=t[0]<=n}o+=+!!e}}return!!(o%2)}function E(e,t){for(let n=0,i=t.length;n<i;n++)if(!I(e,t[n]))return!1;return!0}function w(e){let t=[],n=[];e.forEach((e,t)=>{p(e)&&n.push({polyline:e,originalIndex:t})});for(let e=0;e<n.length;e++){let o=n[e],a=Math.abs(m(o.polyline)),r=[];for(let t=0;t<n.length;t++){var i;if(e===t)continue;let l=n[t];Math.abs(m(l.polyline))<a&&(i=l.polyline,E(o.polyline,i))&&r.push(l.originalIndex)}r.length>0&&t.push({contourIndex:o.originalIndex,holeIndexes:r.sort((e,t)=>e-t)})}return t.sort((e,t)=>e.contourIndex-t.contourIndex)}e.s(["default",()=>w],318701),e.s(["default",()=>m],475307),e.s(["default",()=>E],708580),e.s(["default",()=>I],984029),e.s(["default",()=>p],544279),e.s(["distanceToPointSquared",()=>v],158817),e.s(["default",()=>v],29728),e.s(["default",()=>_],391297),function(e){e.Labelmap="Labelmap",e.Contour="Contour",e.Surface="Surface"}(t||(t={}));let _=t;e.s(["WorkerTypes",()=>S],585955),e.s(["default",()=>S],922538),function(e){e.POLYSEG_CONTOUR_TO_LABELMAP="Converting Contour to Labelmap",e.POLYSEG_SURFACE_TO_LABELMAP="Converting Surfaces to Labelmap",e.POLYSEG_CONTOUR_TO_SURFACE="Converting Contour to Surface",e.POLYSEG_LABELMAP_TO_SURFACE="Converting Labelmap to Surface",e.SURFACE_CLIPPING="Clipping Surfaces",e.COMPUTE_STATISTICS="Computing Statistics",e.INTERPOLATE_LABELMAP="Interpolating Labelmap",e.COMPUTE_LARGEST_BIDIRECTIONAL="Computing Largest Bidirectional",e.GENERATE_CONTOUR_SETS="Generating Contour Sets"}(n||(n={}));let S=n;e.s(["registerComputeWorker",()=>M],824263);var y=e.i(467418);e.s(["getConfig",()=>C,"getPolySeg",()=>x,"setConfig",()=>b],340354);let T={};function C(){return T}function b(e){T=e}let A=!1;function x(){var e;if(!(null==(e=T.addons)?void 0:e.polySeg))return console.warn("PolySeg add-on not configured. This will prevent automatic conversion between segmentation representations (labelmap, contour, surface). To enable these features, install @cornerstonejs/polymorphic-segmentation and register it during initialization: cornerstoneTools.init({ addons: { polySeg } })."),null;let t=T.addons.polySeg;return A||(t.init(),A=!0),t}let D=!1;function M(){var t;if(D)return;D=!0;let n=(0,y.getWebWorkerManager)(),i=T.computeWorker,o={maxWorkerInstances:1,autoTerminateOnIdle:null!=(t=null==i?void 0:i.autoTerminateOnIdle)?t:{enabled:!0,idleTimeThreshold:2e3}};n.registerWorker("compute",()=>new Worker(e.r(560463),{name:"compute",type:"module",type:void 0}),o)}},823940,e=>{"use strict";e.s(["volumeLoader",()=>t]);var t=e.i(385771)},806003,992831,629814,819485,13564,413612,920441,834367,945122,157060,723392,895623,10122,433460,936137,36489,997418,260154,72340,368043,379788,54120,894311,717824,797433,668441,665224,605509,144730,567483,62075,526630,515155,836714,473327,932057,98021,739775,91076,16297,49119,822659,455165,690335,665034,579126,935840,894794,649440,579816,460209,477621,753244,381711,309489,813416,273345,607623,402932,504761,335339,377752,111793,962393,671018,200932,e=>{"use strict";e.s(["AnnotationToPointData",()=>ev,"acceptAutogeneratedInterpolations",()=>nW,"areCoplanarContours",()=>nK.default,"calculatePerimeter",()=>nH,"contourFinder",()=>nY.default,"detectContourHoles",()=>nZ.default,"findContourHoles",()=>nJ.default,"findHandlePolylineIndex",()=>nq,"findIslands",()=>nj,"generateContourSetsFromLabelmap",()=>eg,"getContourHolesDataCanvas",()=>eE,"getContourHolesDataWorld",()=>eI,"getDeduplicatedVTKPolyDataPoints",()=>nX.getDeduplicatedVTKPolyDataPoints,"updateContourPolyline",()=>td],806003),e.s([],723383);var t,n,i,o,a,r,l,s,d,c,u,h,g=e.i(590625),f=e.i(422349),m=e.i(749525),v=e.i(436296),p=e.i(318701),I=e.i(560031),E=e.i(467418),w=e.i(581632),_=e.i(391297),S=e.i(585955),y=e.i(824263),T=e.i(378588),C=e.i(883035),b=e.i(736260),A=e.i(504019);e.s(["getSegmentation",()=>H],819485),e.s(["defaultSegmentationStateManager",()=>q,"internalComputeVolumeLabelmapFromStack",()=>W],629814);var x=e.i(731937),D=e.i(573855),M=e.i(823940);e.s(["SegmentationRepresentations",()=>O.default],992831);var O=_,P=e.i(687130),N=e.i(752246),R=e.i(783224);function L(e){(0,b.triggerEvent)(T.eventTarget,R.Events.SEGMENTATION_MODIFIED,{segmentationId:e})}function U(e,t,n){(0,b.triggerEvent)(T.eventTarget,R.Events.SEGMENTATION_REPRESENTATION_MODIFIED,{segmentationId:t,type:n,viewportId:e})}function k(e,t,n){(0,b.triggerEvent)(T.eventTarget,R.Events.SEGMENTATION_REPRESENTATION_REMOVED,{viewportId:e,segmentationId:t,type:n})}let V={renderOutline:!0,outlineWidthAutoGenerated:3,outlineWidth:1,outlineWidthInactive:1,outlineOpacity:1,outlineOpacityInactive:.85,outlineDash:void 0,outlineDashInactive:void 0,outlineDashAutoGenerated:"5,3",activeSegmentOutlineWidthDelta:0,renderFill:!0,fillAlpha:.5,fillAlphaInactive:.3,fillAlphaAutoGenerated:.3},F={renderOutline:!0,renderOutlineInactive:!0,outlineWidth:3,outlineWidthInactive:2,activeSegmentOutlineWidthDelta:0,renderFill:!0,renderFillInactive:!0,fillAlpha:.5,fillAlphaInactive:.4,outlineOpacity:1,outlineOpacityInactive:.85};var O=_;let B=new class{setStyle(e,t){let n,{viewportId:i,segmentationId:o,type:a,segmentIndex:r}=e,l=this.getStyle(e);if(n=i||o?this.copyActiveToInactiveIfNotProvided({...l,...t},a):{...l,...t},!a)throw Error("Type is required to set a style");if(i){this.config.viewportsStyle[i]||(this.config.viewportsStyle[i]={renderInactiveSegmentations:!1,representations:{}});let e=this.config.viewportsStyle[i].representations;if(o){e[o]||(e[o]={}),e[o][a]||(e[o][a]={});let t=e[o][a];void 0!==r?(t.perSegment||(t.perSegment={}),t.perSegment[r]=n):t.allSegments=n}else{let t="__allSegmentations__";e[t]||(e[t]={}),e[t][a]||(e[t][a]={}),e[t][a].allSegments=n}}else if(o){this.config.segmentations[o]||(this.config.segmentations[o]={}),this.config.segmentations[o][a]||(this.config.segmentations[o][a]={});let e=this.config.segmentations[o][a];void 0!==r?(e.perSegment||(e.perSegment={}),e.perSegment[r]=n):e.allSegments=n}else this.config.global[a]=n}copyActiveToInactiveIfNotProvided(e,t){let n={...e};return t===O.default.Labelmap?(null!=n.renderOutlineInactive||(n.renderOutlineInactive=n.renderOutline),null!=n.outlineWidthInactive||(n.outlineWidthInactive=n.outlineWidth),null!=n.renderFillInactive||(n.renderFillInactive=n.renderFill),null!=n.fillAlphaInactive||(n.fillAlphaInactive=n.fillAlpha),null!=n.outlineOpacityInactive||(n.outlineOpacityInactive=n.outlineOpacity)):t===O.default.Contour&&(null!=n.outlineWidthInactive||(n.outlineWidthInactive=n.outlineWidth),null!=n.outlineOpacityInactive||(n.outlineOpacityInactive=n.outlineOpacity),null!=n.outlineDashInactive||(n.outlineDashInactive=n.outlineDash),null!=n.renderOutlineInactive||(n.renderOutlineInactive=n.renderOutline),null!=n.renderFillInactive||(n.renderFillInactive=n.renderFill),null!=n.fillAlphaInactive||(n.fillAlphaInactive=n.fillAlpha)),n}getStyle(e){var t,n,i,o,a;let{viewportId:r,segmentationId:l,type:s,segmentIndex:d}=e,c=this.getDefaultStyle(s);if(this.config.global[s]&&(c={...c,...this.config.global[s]}),(null==(t=this.config.segmentations[l])?void 0:t[s])&&(c={...c,...this.config.segmentations[l][s].allSegments},void 0!==d&&(null==(n=this.config.segmentations[l][s].perSegment)?void 0:n[d])&&(c={...c,...this.config.segmentations[l][s].perSegment[d]})),r&&this.config.viewportsStyle[r]){this.config.viewportsStyle[r].renderInactiveSegmentations;let e="__allSegmentations__";(null==(i=this.config.viewportsStyle[r].representations[e])?void 0:i[s])&&(c={...c,...this.config.viewportsStyle[r].representations[e][s].allSegments}),l&&(null==(o=this.config.viewportsStyle[r].representations[l])?void 0:o[s])&&(c={...c,...this.config.viewportsStyle[r].representations[l][s].allSegments},void 0!==d&&(null==(a=this.config.viewportsStyle[r].representations[l][s].perSegment)?void 0:a[d])&&(c={...c,...this.config.viewportsStyle[r].representations[l][s].perSegment[d]}))}return c}getRenderInactiveSegmentations(e){var t;return null==(t=this.config.viewportsStyle[e])?void 0:t.renderInactiveSegmentations}setRenderInactiveSegmentations(e,t){this.config.viewportsStyle[e]||(this.config.viewportsStyle[e]={renderInactiveSegmentations:!1,representations:{}}),this.config.viewportsStyle[e].renderInactiveSegmentations=t}getDefaultStyle(e){switch(e){case O.default.Labelmap:return F;case O.default.Contour:return V;case O.default.Surface:return{};default:throw Error("Unknown representation type: ".concat(e))}}clearSegmentationStyle(e){this.config.segmentations[e]&&delete this.config.segmentations[e]}clearAllSegmentationStyles(){this.config.segmentations={}}clearViewportStyle(e){this.config.viewportsStyle[e]&&delete this.config.viewportsStyle[e]}clearAllViewportStyles(){for(let e in this.config.viewportsStyle){let t=this.config.viewportsStyle[e].renderInactiveSegmentations;this.config.viewportsStyle[e]={renderInactiveSegmentations:t,representations:{}}}}resetToGlobalStyle(){this.clearAllSegmentationStyles(),this.clearAllViewportStyles()}hasCustomStyle(e){let{type:t}=e,n=this.getStyle(e),i=this.getDefaultStyle(t);return!w.utilities.deepEqual(n,i)}constructor(){this.config={global:{},segmentations:{},viewportsStyle:{}}}},G={colorLUT:[],segmentations:[],viewportSegRepresentations:{}};async function W(e){let{imageIds:t,options:n}=e,i=(null==n?void 0:n.volumeId)||w.utilities.uuidv4();return await M.volumeLoader.createAndCacheVolumeFromImages(i,t),{volumeId:i}}function z(e){let t=P.default.newInstance(),n=N.default.newInstance();return(n.addPoint(0,0),e===O.default.Labelmap)?{cfun:t,ofun:n}:{}}let q=new class{getState(){return this.state}updateState(e){let t=w.utilities.deepClone(this.state);e(t),this.state=Object.freeze(t)}getColorLUT(e){return this.state.colorLUT[e]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this._stackLabelmapImageIdReferenceMap.clear(),this._labelmapImageIdReferenceMap.clear(),this.state=Object.freeze(w.utilities.deepClone(G))}getSegmentation(e){return this.state.segmentations.find(t=>t.segmentationId===e)}updateSegmentation(e,t){this.updateState(n=>{let i=n.segmentations.find(t=>t.segmentationId===e);if(!i)return void console.warn("Segmentation with id ".concat(e," not found. Update aborted."));Object.assign(i,t)}),L(e)}addSegmentation(e){var t;if(this.getSegmentation(e.segmentationId))throw Error("Segmentation with id ".concat(e.segmentationId," already exists"));this.updateState(t=>{let n=w.utilities.deepClone(e);if(n.representationData.Labelmap&&"volumeId"in n.representationData.Labelmap&&!("imageIds"in n.representationData.Labelmap)){let e=this.getLabelmapImageIds(n.representationData);n.representationData.Labelmap.imageIds=e}t.segmentations.push(n)}),t=e.segmentationId,(0,b.triggerEvent)(T.eventTarget,R.Events.SEGMENTATION_ADDED,{segmentationId:t})}removeSegmentation(e){this.updateState(t=>{let n=t.segmentations.filter(t=>t.segmentationId!==e);t.segmentations.splice(0,t.segmentations.length,...n)}),(0,b.triggerEvent)(T.eventTarget,R.Events.SEGMENTATION_REMOVED,{segmentationId:e})}addSegmentationRepresentation(e,t,n,i){if((0,D.getEnabledElementByViewportId)(e)){if(this.getSegmentationRepresentations(e,{type:n,segmentationId:t}).length>0)return void console.debug("A segmentation representation of type",n,"already exists in viewport",e,"for segmentation",t);this.updateState(o=>{o.viewportSegRepresentations[e]||(o.viewportSegRepresentations[e]=[],B.setRenderInactiveSegmentations(e,!0)),n!==O.default.Labelmap?this.addDefaultSegmentationRepresentation(o,e,t,n,i):this.addLabelmapRepresentation(o,e,t,i)}),U(e,t,n)}}addDefaultSegmentationRepresentation(e,t,n,i,o){let a=e.segmentations.find(e=>e.segmentationId===n);if(!a)return;let r={};Object.keys(a.segments).forEach(e=>{r[Number(e)]={visible:!0}}),e.viewportSegRepresentations[t].push({segmentationId:n,type:i,active:!0,visible:!0,colorLUTIndex:(null==o?void 0:o.colorLUTIndex)||0,segments:r,config:{...z(i),...o}}),this._setActiveSegmentation(e,t,n)}addLabelmapRepresentation(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:z(O.default.Labelmap);if(!(0,D.getEnabledElementByViewportId)(t))return;let o=this.getSegmentation(n);if(!o)return;let{representationData:a}=o;if(!a.Labelmap)return this.addDefaultSegmentationRepresentation(e,t,n,O.default.Labelmap,i);this.processLabelmapRepresentationAddition(t,n),this.addDefaultSegmentationRepresentation(e,t,n,O.default.Labelmap,i)}async processLabelmapRepresentationAddition(e,t){let n=(0,D.getEnabledElementByViewportId)(e);if(!n)return;let i=this.getSegmentation(t);if(!i)return;let o=n.viewport instanceof x.BaseVolumeViewport,{representationData:a}=i,r="volumeId"in a.Labelmap;n.viewport,o||r||this.updateLabelmapSegmentationImageReferences(e,i.segmentationId)}_updateLabelmapSegmentationReferences(e,t,n,i){let o=t.getCurrentImageId(),a=!1;for(let i of n)t.isReferenceViewable({referencedImageId:i},{asOverlay:!0})&&(a=!0,this._stackLabelmapImageIdReferenceMap.get(e).set(o,i),this._updateLabelmapImageIdReferenceMap({segmentationId:e,referenceImageId:o,labelmapImageId:i}));return i&&i(t,e,n),a?this._stackLabelmapImageIdReferenceMap.get(e).get(o):void 0}updateLabelmapSegmentationImageReferences(e,t){let n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);let{representationData:i}=n;if(!i.Labelmap)return;let o=this.getLabelmapImageIds(i),a=(0,D.getEnabledElementByViewportId)(e).viewport;return this._updateLabelmapSegmentationReferences(t,a,o,null)}_updateAllLabelmapSegmentationImageReferences(e,t){let n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);let{representationData:i}=n;if(!i.Labelmap)return;let o=this.getLabelmapImageIds(i),a=(0,D.getEnabledElementByViewportId)(e).viewport;this._updateLabelmapSegmentationReferences(t,a,o,(e,t,n)=>{e.getImageIds().forEach((i,o)=>{for(let a of n)e.isReferenceViewable({referencedImageId:a,sliceIndex:o},{asOverlay:!0,withNavigation:!0})&&(this._stackLabelmapImageIdReferenceMap.get(t).set(i,a),this._updateLabelmapImageIdReferenceMap({segmentationId:t,referenceImageId:i,labelmapImageId:a}))})})}getLabelmapImageIds(e){let t,n=e.Labelmap;if(n.imageIds)t=n.imageIds;else if(!t&&n.volumeId){let e=n.volumeId;t=I.cache.getVolume(e).imageIds}return t}getLabelmapImageIdsForImageId(e,t){let n=this._generateMapKey({segmentationId:t,referenceImageId:e});return this._labelmapImageIdReferenceMap.get(n)}getCurrentLabelmapImageIdsForViewport(e,t){let n=(0,D.getEnabledElementByViewportId)(e);if(!n)return;let i=n.viewport.getCurrentImageId();return this.getLabelmapImageIdsForImageId(i,t)}getCurrentLabelmapImageIdForViewport(e,t){let n=(0,D.getEnabledElementByViewportId)(e);if(!n||!this._stackLabelmapImageIdReferenceMap.has(t))return;let i=n.viewport.getCurrentImageId();return this._stackLabelmapImageIdReferenceMap.get(t).get(i)}getStackSegmentationImageIdsForViewport(e,t){if(!this.getSegmentation(t))return[];this._updateAllLabelmapSegmentationImageReferences(e,t);let{viewport:n}=(0,D.getEnabledElementByViewportId)(e),i=n.getImageIds(),o=this._stackLabelmapImageIdReferenceMap.get(t);return i.map(e=>o.get(e))}removeSegmentationRepresentationsInternal(e,t){let n=[];return this.updateState(i=>{if(!i.viewportSegRepresentations[e])return;let o=i.viewportSegRepresentations[e],a=!1;if(!t||Object.values(t).every(e=>void 0===e))n.push(...o),delete i.viewportSegRepresentations[e];else{let{segmentationId:r,type:l}=t;i.viewportSegRepresentations[e]=o.filter(e=>{let t=r&&l&&e.segmentationId===r&&e.type===l||r&&!l&&e.segmentationId===r||!r&&l&&e.type===l;return t&&(n.push(e),e.active&&(a=!0)),!t}),0===i.viewportSegRepresentations[e].length?delete i.viewportSegRepresentations[e]:a&&(i.viewportSegRepresentations[e][0].active=!0)}}),n}removeSegmentationRepresentations(e,t){let n=this.removeSegmentationRepresentationsInternal(e,t);n.forEach(t=>{k(e,t.segmentationId,t.type)});let i=this.getSegmentationRepresentations(e);return i.length>0&&i[0].active&&U(e,i[0].segmentationId,i[0].type),n}removeSegmentationRepresentation(e,t,n){let i=this.removeSegmentationRepresentationsInternal(e,t);return n||i.forEach(t=>{let{segmentationId:n,type:i}=t;k(e,n,i)}),i}_updateLabelmapImageIdReferenceMap(e){let{segmentationId:t,referenceImageId:n,labelmapImageId:i}=e,o=this._generateMapKey({segmentationId:t,referenceImageId:n});if(!this._labelmapImageIdReferenceMap.has(o))return void this._labelmapImageIdReferenceMap.set(o,[i]);let a=Array.from(new Set([...this._labelmapImageIdReferenceMap.get(o),i]));this._labelmapImageIdReferenceMap.set(o,a)}_setActiveSegmentation(e,t,n){let i=e.viewportSegRepresentations[t];i&&i.forEach(e=>{e.active=e.segmentationId===n})}setActiveSegmentation(e,t){this.updateState(n=>{let i=n.viewportSegRepresentations[e];i&&i.forEach(e=>{e.active=e.segmentationId===t})}),U(e,t)}getActiveSegmentation(e){if(!this.state.viewportSegRepresentations[e])return;let t=this.state.viewportSegRepresentations[e].find(e=>e.active);if(t)return this.getSegmentation(t.segmentationId)}getSegmentationRepresentations(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.state.viewportSegRepresentations[e];return n?t.type||t.segmentationId?n.filter(e=>{let n=!t.type||e.type===t.type,i=!t.segmentationId||e.segmentationId===t.segmentationId;return n&&i}):n:[]}getSegmentationRepresentation(e,t){return this.getSegmentationRepresentations(e,t)[0]}getSegmentationRepresentationVisibility(e,t){let n=this.getSegmentationRepresentation(e,t);return null==n?void 0:n.visible}setSegmentationRepresentationVisibility(e,t,n){this.updateState(i=>{let o=this.getSegmentationRepresentations(e,t);o&&o.forEach(e=>{e.visible=n,Object.entries(e.segments).forEach(e=>{let[t,i]=e;i.visible=n})})}),U(e,t.segmentationId,t.type)}addColorLUT(e,t){this.updateState(n=>{n.colorLUT[t]&&console.warn("Color LUT table already exists, overwriting"),n.colorLUT[t]=w.utilities.deepClone(e)})}removeColorLUT(e){this.updateState(t=>{delete t.colorLUT[e]})}_getStackIdForImageIds(e){return e.map(e=>e.slice(-Math.round(.15*e.length))).join("_")}getAllViewportSegmentationRepresentations(){return Object.entries(this.state.viewportSegRepresentations).map(e=>{let[t,n]=e;return{viewportId:t,representations:n}})}getSegmentationRepresentationsBySegmentationId(e){let t=[];return Object.entries(this.state.viewportSegRepresentations).forEach(n=>{let[i,o]=n,a=o.filter(t=>t.segmentationId===e);a.length>0&&t.push({viewportId:i,representations:a})}),t}_generateMapKey(e){let{segmentationId:t,referenceImageId:n}=e;return"".concat(t,"-").concat(n)}constructor(e){this._stackLabelmapImageIdReferenceMap=new Map,this._labelmapImageIdReferenceMap=new Map,e||(e=w.utilities.uuidv4()),this.state=Object.freeze(w.utilities.deepClone(G)),this.uid=e}}("DEFAULT");function H(e){return q.getSegmentation(e)}function j(e){let t=H(e);if(t){let e=Object.keys(t.segments).find(e=>t.segments[e].active);return e?Number(e):void 0}}function K(e,t){return Y(e,t)[0]}function Y(e,t){return q.getCurrentLabelmapImageIdsForViewport(e,t)}e.s(["getCurrentLabelmapImageIdForViewport",()=>K,"getCurrentLabelmapImageIdsForViewport",()=>Y],13564),e.s(["getLabelmapActorEntries",()=>J,"getLabelmapActorEntry",()=>Q,"getLabelmapActorUID",()=>Z,"getSurfaceActorEntry",()=>$,"getSurfaceRepresentationUID",()=>ee],413612);var O=_;function X(e,t,n){let i=(0,D.getEnabledElementByViewportId)(e);if(!i)return;let{renderingEngine:o,viewport:a}=i;if(!o||!a)return;let r=a.getActors().filter(n);return r.length>0?r[0]:void 0}function Z(e,t){let n=Q(e,t);return null==n?void 0:n.uid}function J(e,t){return function(e,t){let n=(0,D.getEnabledElementByViewportId)(e);if(!n)return;let{renderingEngine:i,viewport:o}=n;if(!i||!o)return;let a=o.getActors().filter(t);return a.length>0?a:void 0}(e,e=>{var n;return null==(n=e.representationUID)?void 0:n.startsWith("".concat(t,"-").concat(O.default.Labelmap))})}function Q(e,t){return X(e,t,e=>{var n;return null==(n=e.representationUID)?void 0:n.startsWith("".concat(t,"-").concat(O.default.Labelmap))})}function $(e,t,n){return X(e,t,e=>e.representationUID===ee(t,n))}function ee(e,t){return"".concat(e,"-").concat(O.default.Surface,"-").concat(t)}function et(e){let t,n=I.cache.getVolume(e);if(!n)return null;let i=n.referencedVolumeId;if(i)t=I.cache.getVolume(i);else{let e=n.imageIds,i=I.cache.getImage(e[0]).referencedImageId,o=I.cache.getVolumeContainingImageId(i);t=null==o?void 0:o.volume}return t}function en(e){let{operationData:t,viewport:n,strategy:i}=e;return t?"volumeId"in t&&null!=t.volumeId||"referencedVolumeId"in t&&null!=t.referencedVolumeId?function(e){let{operationData:t}=e,{volumeId:n}=t;if(!n){let e=new CustomEvent(C.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"No volume id found for the segmentation"},cancelable:!0});return T.eventTarget.dispatchEvent(e),null}let i=I.cache.getVolume(n),o=et(n);if(!i||!o)return null;let{imageData:a}=i,{voxelManager:r}=i,{voxelManager:l,imageData:s}=o;return{segmentationImageData:a,segmentationVoxelManager:r,segmentationScalarData:null,imageScalarData:null,imageVoxelManager:l,imageData:s}}({operationData:t}):function(e){let t,n,i,o,a,r,{operationData:l,viewport:s,strategy:d}=e,{segmentationId:c}=l;if(d.ensureSegmentationVolumeFor3DManipulation)d.ensureSegmentationVolumeFor3DManipulation({operationData:l,viewport:s}),n=l.segmentationVoxelManager,t=l.segmentationImageData,i=null;else{var u;let e=K(s.id,c);if(!e)return null;let o=Q(s.id,c);if(!o)return null;let a=I.cache.getImage(e);t=o.actor.getMapper().getInputData(),n=a.voxelManager;let r=l.imageId,d=I.cache.getImage(r);if(!d)return null;i=null==(u=d.getPixelData)?void 0:u.call(d)}if(d.ensureImageVolumeFor3DManipulation)d.ensureImageVolumeFor3DManipulation({operationData:l,viewport:s}),a=l.imageVoxelManager,o=l.imageScalarData,r=l.imageData;else{let e=s.getCurrentImageId();if(!e)return null;let t=I.cache.getImage(e);r=t?null:s.getImageData(),o=(null==t?void 0:t.getPixelData())||r.getScalarData(),a=null==t?void 0:t.voxelManager}return{segmentationImageData:t,segmentationScalarData:i,imageScalarData:o,segmentationVoxelManager:n,imageVoxelManager:a,imageData:r}}({operationData:t,viewport:n,strategy:i}):null}e.s(["default",()=>ei],920441),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.Interpolate="interpolate",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue",e.AddPreview="addPreview",e.ComputeInnerCircleRadius="computeInnerCircleRadius",e.GetStatistics="getStatistics",e.EnsureImageVolumeFor3DManipulation="ensureImageVolumeFor3DManipulation",e.EnsureSegmentationVolumeFor3DManipulation="ensureSegmentationVolumeFor3DManipulation"}(t||(t={}));let ei=t,eo=function(e){let t,{representationData:n}=H(e),{volumeId:i}=n.Labelmap;if(i&&(t=I.cache.getVolume(i)))return t;let{imageIds:o}=n.Labelmap;if((i=I.cache.generateVolumeId(o),o&&1!==o.length)&&w.utilities.isValidVolume(o))return M.volumeLoader.createAndCacheVolumeFromImagesSync(i,o)},ea={[ei.EnsureSegmentationVolumeFor3DManipulation]:e=>{let{operationData:t,viewport:n}=e,{segmentationId:i,imageIds:o}=t,a=n?n.getImageIds():o.map(e=>I.cache.getImage(e).referencedImageId);if(!w.utilities.isValidVolume(a))throw Error("Volume is not reconstructable for sphere manipulation");let r=eo(i);r&&(t.segmentationVoxelManager=r.voxelManager,t.segmentationImageData=r.imageData)}};e.s(["default",()=>er],834367);let er=function(e){if(!e||e.length<=1||!w.utilities.isValidVolume(e))return;let t=I.cache.generateVolumeId(e),n=I.cache.getVolume(t);return n||(n=M.volumeLoader.createAndCacheVolumeFromImagesSync(t,e))},el={[ei.EnsureImageVolumeFor3DManipulation]:e=>{let t,{operationData:n,viewport:i}=e;if(i){if(t=i.getImageIds(),!w.utilities.isValidVolume(t))throw Error("Volume is not reconstructable for sphere manipulation")}else t=H(n.segmentationId).representationData.Labelmap.imageIds.map(e=>I.cache.getImage(e).referencedImageId);let o=er(t);if(!o)throw Error("Failed to create or get image volume");n.imageVoxelManager=o.voxelManager,n.imageData=o.imageData}},es=(e,t)=>{(0,b.triggerEvent)(T.eventTarget,C.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:e})},ed=(e,t)=>{let{representationData:n}=H(e),{Labelmap:i}=n;if(!i)return console.debug("No labelmap found for segmentation",e),null;let o=i.volumeId,a=i.imageIds,r=!1;if(a){let e=a.map(e=>I.cache.getImage(e).referencedImageId);r=w.utilities.isValidVolume(e)}let l=t;return l?Array.isArray(l)||(l=[l,255]):l=[j(e)],{operationData:{segmentationId:e,volumeId:o,imageIds:a},segVolumeId:o,segImageIds:a,reconstructableVolume:r,indices:l}},ec=e=>en({operationData:e,strategy:{ensureSegmentationVolumeFor3DManipulation:ea.ensureSegmentationVolumeFor3DManipulation,ensureImageVolumeFor3DManipulation:el.ensureImageVolumeFor3DManipulation}}),eu=e=>{let t=[],n=[];for(let i of e){let e=I.cache.getImage(i),o=e.getPixelData(),{origin:a,direction:r,spacing:l,dimensions:s}=w.utilities.getImageDataMetadata(e);t.push({scalarData:o,dimensions:s,spacing:l,origin:a,direction:r});let d=e.referencedImageId;if(d){let e=I.cache.getImage(d);if(!e)continue;let t=e.getPixelData(),i=e.voxelManager,o=[e.rowPixelSpacing,e.columnPixelSpacing];n.push({scalarData:t,dimensions:i?i.dimensions:[e.columns,e.rows,1],spacing:o})}}return{segmentationInfo:t,imageInfo:n}},{Labelmap:eh}=_.default;async function eg(e){let{segmentations:t}=e;(0,y.registerComputeWorker)(),es(S.WorkerTypes.GENERATE_CONTOUR_SETS,0);let{representationData:n,segments:i=[0,1],segmentationId:o}=t,{volumeId:a}=n[eh];if(!a){let e=eo(o);e&&(a=e.volumeId)}let r=I.cache.getVolume(a);if(!r)return void console.warn("No volume found for ".concat(a));let l={scalarData:r.voxelManager.getCompleteScalarDataArray(),dimensions:r.dimensions,spacing:r.imageData.getSpacing(),origin:r.imageData.getOrigin(),direction:r.imageData.getDirection()},s=Array.isArray(i)?i.filter(e=>null!==e).map(e=>e.segmentIndex||e):Object.values(i).filter(e=>null!==e).map(e=>e.segmentIndex||e),d=await (0,E.getWebWorkerManager)().executeTask("compute","generateContourSetsFromLabelmapVolume",{segmentation:l,indices:s,mode:"individual"}),c=r.imageIds.map(e=>{var t;let n=null==(t=I.cache.getImage(e))?void 0:t.referencedImageId;return n?I.cache.getImage(n):void 0}),u=c.map(e=>w.utilities.getImageDataMetadata(e)),h=d.map(e=>{let t,n=i[e.segment.segmentIndex]||{};if(!e.sliceContours.length)return null;let o=e.sliceContours[0].polyData.points[0];if(o){let e=u.findIndex(e=>{let{scanAxisNormal:t,origin:n}=e,i=w.utilities.planar.planeEquation(t,n);return w.utilities.planar.isPointOnPlane(o,i)});-1!==e&&(t=c[e].imageId)}return{label:n.label,color:n.color,metadata:{FrameOfReferenceUID:r.metadata.FrameOfReferenceUID,referencedImageId:t},sliceContours:e.sliceContours.map(e=>({contours:e.contours,polyData:e.polyData,FrameNumber:e.sliceIndex+1,sliceIndex:e.sliceIndex,FrameOfReferenceUID:r.metadata.FrameOfReferenceUID,referencedImageId:t}))}}).filter(e=>null!==e);return es(S.WorkerTypes.GENERATE_CONTOUR_SETS,100),h}class ef{static getContourSequence(e,t){let{data:n}=e,{projectionPoints:i,projectionPointsImageIds:o}=n.cachedStats;return i.map((e,n)=>{var i;let a=[...(i=e)[0],...i[1],...i[3],...i[2]].flat().map(e=>e.toFixed(2)),r=function(e,t){let n=t.get("sopCommonModule",e);return{ReferencedSOPClassUID:n.sopClassUID,ReferencedSOPInstanceUID:n.sopInstanceUID}}(o[n],t);return{NumberOfContourPoints:a.length/3,ContourImageSequence:r,ContourGeometricType:"CLOSED_PLANAR",ContourData:a}})}constructor(){}}ef.toolName="RectangleROIStartEndThreshold";class em{static convert(e,t,n){if(!(null==e?void 0:e.data))throw Error("Tool data is empty");if(!e.metadata||e.metadata.referencedImageId)throw Error("Tool data is not associated with any imageId");let{toolName:i}=e.metadata,o=em.TOOL_NAMES[i];if(!o)throw Error("Unknown tool type: ".concat(i,", cannot convert to RTSSReport"));return{ReferencedROINumber:t+1,ROIDisplayColor:[Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random())],ContourSequence:o.getContourSequence(e,n)}}static register(e){em.TOOL_NAMES[e.toolName]=e}constructor(){}}em.TOOL_NAMES={},em.register(ef);let ev=em;var ep=e.i(344962);function eI(e){var t;return(null!=(t=e.childAnnotationUIDs)?t:[]).map(e=>(0,ep.getAnnotation)(e).data.contour.polyline)}function eE(e,t){let n=eI(e),i=[];return n.forEach(e=>{let n=e.length,o=Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);i.push(o)}),i}e.s(["default",()=>td],895623),e.s(["polyline",()=>ti],723392),e.s(["addCanvasPointsToArray",()=>e5,"arePolylinesIdentical",()=>eR,"containsPoint",()=>te.default,"containsPoints",()=>tt.default,"convexHull",()=>e7,"decimate",()=>eJ,"getAABB",()=>ey,"getArea",()=>eT,"getClosestLineSegmentIntersection",()=>e$,"getFirstLineSegmentIntersectionIndexes",()=>eW,"getLineSegmentIntersectionsCoordinates",()=>eQ,"getLineSegmentIntersectionsIndexes",()=>eG,"getNormal2",()=>eD,"getNormal3",()=>ex,"getSignedArea",()=>tn.default,"getSubPixelSpacingAndXYDirections",()=>e1,"getWindingDirection",()=>eb,"intersectPolyline",()=>ez,"intersectPolylines",()=>eU,"isClosed",()=>e9.default,"isPointInsidePolyline3D",()=>e6,"mergePolylines",()=>eY,"pointCanProjectOnLine",()=>e4,"pointsAreWithinCloseContourProximity",()=>e2,"projectTo2D",()=>e8,"subtractPolylines",()=>eL],335439),e.s([],905412);var ew=e.i(544279),e_=e.i(984029),eS=e.i(708580);function ey(e,t){let n=e,i=(null==t?void 0:t.numDimensions)||2,o=3===i;if(!Array.isArray(e[0])){let t=e.length/i;n=Array(e.length/i);for(let a=0;a<t;a++)n[a]=[e[a*i],e[a*i+1]],o&&n[a].push(e[a*i+2])}let a=1/0,r=1/0,l=-1/0,s=-1/0,d=1/0,c=-1/0;for(let e=0,t=n.length;e<t;e++){let[t,i,u]=n[e];a=a<t?a:t,r=r<i?r:i,l=l>t?l:t,s=s>i?s:i,o&&(d=d<u?d:u,c=c>u?c:u)}return o?{minX:a,maxX:l,minY:r,maxY:s,minZ:d,maxZ:c}:{minX:a,maxX:l,minY:r,maxY:s}}function eT(e){let t=e.length,n=0,i=t-1;for(let o=0;o<t;o++)n+=(e[i][0]+e[o][0])*(e[i][1]-e[o][1]),i=o;return Math.abs(n/2)}var eC=e.i(475307);function eb(e){return(0,eC.default)(e)>=0?1:-1}var eA=e.i(399021);function ex(e){let t=function(e){let t=eA.vec3.create(),n=e[0];for(let i=0,o=e.length;i<o;i++){let a=e[i],r=e[i===o-1?0:i+1],l=a[0]-n[0],s=a[1]-n[1],d=a[2]-n[2],c=r[0]-n[0],u=r[1]-n[1],h=r[2]-n[2];t[0]+=s*h-d*u,t[1]+=d*c-l*h,t[2]+=l*u-s*c}return eA.vec3.scale(t,t,.5),t}(e);return eA.vec3.normalize(t,t)}function eD(e){let t=(0,eC.default)(e);return[0,0,t/Math.abs(t)]}var eM=e.i(453811);function eO(e,t){return e[0]*t[1]-e[1]*t[0]}function eP(e,t){return w.utilities.isEqual(e,t,1e-7)}function eN(e,t,n,i){let o=eM.vec2.subtract(eM.vec2.create(),t,e),a=eM.vec2.subtract(eM.vec2.create(),i,n),r=eO(o,a),l=eM.vec2.subtract(eM.vec2.create(),n,e),s=eO(l,o);if(1e-7>Math.abs(r)){if(1e-7>Math.abs(s)){let r=eM.vec2.dot(o,o),l=eM.vec2.dot(a,a);if(r<1e-7||l<1e-7)return eP(e,n)||eP(e,i)?e:eP(t,n)||eP(t,i)?t:null;let s=eM.vec2.dot(eM.vec2.subtract(eM.vec2.create(),n,e),o)/r,d=eM.vec2.dot(eM.vec2.subtract(eM.vec2.create(),i,e),o)/r,c=eM.vec2.dot(eM.vec2.subtract(eM.vec2.create(),e,n),a)/l,u=eM.vec2.dot(eM.vec2.subtract(eM.vec2.create(),t,n),a)/l,h=e=>e>=-1e-7&&e<=1.0000001;if(h(s)&&eP(n,eM.vec2.scaleAndAdd(eM.vec2.create(),e,o,s)))return n;if(h(d)&&eP(i,eM.vec2.scaleAndAdd(eM.vec2.create(),e,o,d)))return i;if(h(c)&&eP(e,eM.vec2.scaleAndAdd(eM.vec2.create(),n,a,c)))return e;if(h(u)&&eP(t,eM.vec2.scaleAndAdd(eM.vec2.create(),n,a,u)))return t}return null}let d=eO(l,a)/r,c=s/r;return d>=-1e-7&&d<=1.0000001&&c>=-1e-7&&c<=1.0000001?[e[0]+d*o[0],e[1]+d*o[1]]:null}function eR(e,t){if(e.length!==t.length)return!1;let n=e.length;if(0===n)return!0;let i=!0;for(let o=0;o<n;o++)if(!eP(e[o],t[o])){i=!1;break}if(i)return!0;let o=!0;for(let i=0;i<n;i++)if(!eP(e[i],t[n-1-i])){o=!1;break}if(o)return!0;for(let i=1;i<n;i++){let o=!0;for(let a=0;a<n;a++)if(!eP(e[a],t[(a+i)%n])){o=!1;break}if(o)return!0;let a=!0;for(let o=0;o<n;o++)if(!eP(e[o],t[(n-1-o+i)%n])){a=!1;break}if(a)return!0}return!1}function eL(e,t){if(e.length<3)return[];if(t.length<3)return[e.slice()];let o=t.slice();if(eR(e,t))return[];let a=(0,eC.default)(e),r=(0,eC.default)(o);Math.sign(a)===Math.sign(r)&&Math.abs(r)>1e-7&&o.reverse();let l=[];for(let t=0;t<e.length;t++){let n=e[t],i=e[(t+1)%e.length];for(let e=0;e<o.length;e++){let a=o[e],r=o[(e+1)%o.length],s=eN(n,i,a,r);if(s){let o=Math.sqrt(eM.vec2.squaredDistance(n,i)),d=Math.sqrt(eM.vec2.squaredDistance(a,r));l.push({coord:s,seg1Idx:t,seg2Idx:e,alpha1:o<1e-7?0:Math.sqrt(eM.vec2.squaredDistance(n,s))/o,alpha2:d<1e-7?0:Math.sqrt(eM.vec2.squaredDistance(a,s))/d})}}}let s=(e,t,i)=>{let o=[],a=0;for(let r=0;r<e.length;r++){let l=e[r];for(let e of(o.push({id:"".concat(t,"_v").concat(a++),coordinates:l,type:n.Vertex,originalPolyIndex:t,originalVertexIndex:r,next:null,prev:null,isIntersection:!1,visited:!1}),i.filter(e=>(0===t?e.seg1Idx:e.seg2Idx)===r).sort((e,n)=>(0===t?e.alpha1:e.alpha2)-(0===t?n.alpha1:n.alpha2)))){if(o.length>0&&eP(o[o.length-1].coordinates,e.coord)){o[o.length-1].isIntersection||(o[o.length-1].isIntersection=!0,o[o.length-1].intersectionInfo=e,o[o.length-1].alpha=0===t?e.alpha1:e.alpha2);continue}o.push({id:"".concat(t,"_i").concat(a++),coordinates:e.coord,type:n.Intersection,originalPolyIndex:t,next:null,prev:null,isIntersection:!0,visited:!1,alpha:0===t?e.alpha1:e.alpha2,intersectionInfo:e})}}let r=[];if(o.length>0){r.push(o[0]);for(let e=1;e<o.length;e++)eP(o[e].coordinates,r[r.length-1].coordinates)?o[e].isIntersection&&(r[r.length-1].isIntersection=!0,r[r.length-1].intersectionInfo=o[e].intersectionInfo,r[r.length-1].alpha=o[e].alpha):r.push(o[e])}if(r.length>0)for(let e=0;e<r.length;e++)r[e].next=r[(e+1)%r.length],r[e].prev=r[(e-1+r.length)%r.length];return r},d=s(e,0,l),c=s(o,1,l);d.forEach(e=>{if(e.isIntersection){let n=e.intersectionInfo,o=c.find(t=>t.isIntersection&&eP(t.coordinates,e.coordinates)&&t.intersectionInfo.seg1Idx===n.seg1Idx&&t.intersectionInfo.seg2Idx===n.seg2Idx);if(o){e.partnerNode=o,o.partnerNode=e;let n=e.prev.coordinates,a=e.coordinates,r=o.next.coordinates;eM.vec2.subtract(eM.vec2.create(),a,n),eM.vec2.subtract(eM.vec2.create(),r,a);let l=[(e.prev.coordinates[0]+e.coordinates[0])/2,(e.prev.coordinates[1]+e.coordinates[1])/2];(0,e_.default)(t,l)?e.intersectionDir=i.Exiting:e.intersectionDir=i.Entering}else e.isIntersection=!1}}),d.forEach(e=>delete e.intersectionInfo),c.forEach(e=>delete e.intersectionInfo);let u=[];for(let e=0;e<d.length;e++){let n=d[e];if(n.visited||n.isIntersection||(0,e_.default)(t,n.coordinates))continue;let o=[],a=n,r=!0,l=0,s=(d.length+c.length)*2;do{if(l++>s){console.warn("Subtraction: Max iterations reached, possible infinite loop.");break}a.visited=!0,0!==o.length&&eP(o[o.length-1],a.coordinates)||o.push(a.coordinates),a.isIntersection&&(r?a.intersectionDir===i.Entering&&a.partnerNode&&(a=a.partnerNode,r=!1):a.partnerNode?(a=a.partnerNode,r=!0):console.warn("Subtraction: Intersection on source without partner.")),a=a.next}while(a!==n||!r)o.length>=3&&(eP(o[0],o[o.length-1])&&o.pop(),o.length>=3&&u.push(o))}return u}function eU(e,t){if(e.length<3||t.length<3)return[];let o=t.slice(),a=(0,eC.default)(e),r=(0,eC.default)(o);if(1e-7>Math.abs(a)||1e-7>Math.abs(r))return[];a<0&&(e=e.slice().reverse()),r<0&&(o=o.slice().reverse());let l=o,s=[];for(let t=0;t<e.length;t++){let n=e[t],i=e[(t+1)%e.length];for(let e=0;e<o.length;e++){let a=o[e],r=o[(e+1)%o.length],l=eN(n,i,a,r);if(l){let o=Math.sqrt(eM.vec2.squaredDistance(n,i)),d=Math.sqrt(eM.vec2.squaredDistance(a,r));s.push({coord:[...l],seg1Idx:t,seg2Idx:e,alpha1:o<1e-7?0:Math.sqrt(eM.vec2.squaredDistance(n,l))/o,alpha2:d<1e-7?0:Math.sqrt(eM.vec2.squaredDistance(a,l))/d})}}}if(0===s.length)return(0,e_.default)(l,e[0])&&e.every(e=>(0,e_.default)(l,e))?[[...e.map(e=>[...e])]]:(0,e_.default)(e,o[0])&&o.every(t=>(0,e_.default)(e,t))?[[...o.map(e=>[...e])]]:[];let d=(e,t,o)=>{let a=[],r=0;for(let l=0;l<e.length;l++){let s=e[l];for(let e of(a.push({id:"".concat(t,"_v").concat(r++),coordinates:[...s],type:n.Vertex,originalPolyIndex:t,originalVertexIndex:l,next:null,prev:null,isIntersection:!1,visited:!1,processedInPath:!1,intersectionDir:i.Unknown}),o.filter(e=>(0===t?e.seg1Idx:e.seg2Idx)===l).sort((e,n)=>(0===t?e.alpha1:e.alpha2)-(0===t?n.alpha1:n.alpha2)))){if(a.length>0&&eP(a[a.length-1].coordinates,e.coord)){let i=a[a.length-1];i.isIntersection||(i.isIntersection=!0,i.intersectionInfo=e,i.alpha=0===t?e.alpha1:e.alpha2,i.type=n.Intersection);continue}a.push({id:"".concat(t,"_i").concat(r++),coordinates:[...e.coord],type:n.Intersection,originalPolyIndex:t,next:null,prev:null,isIntersection:!0,visited:!1,processedInPath:!1,alpha:0===t?e.alpha1:e.alpha2,intersectionInfo:e,intersectionDir:i.Unknown})}}let l=[];if(a.length>0){l.push(a[0]);for(let e=1;e<a.length;e++)if(eP(a[e].coordinates,l[l.length-1].coordinates)){let t=l[l.length-1];a[e].isIntersection&&a[e].intersectionInfo&&(t.isIntersection=!0,t.intersectionInfo=a[e].intersectionInfo,t.alpha=a[e].alpha,t.type=n.Intersection)}else l.push(a[e])}if(l.length>1&&eP(l[0].coordinates,l[l.length-1].coordinates)){let e=l[0],t=l.pop();t.isIntersection&&!e.isIntersection&&t.intersectionInfo&&(e.isIntersection=!0,e.intersectionInfo=t.intersectionInfo,e.alpha=t.alpha,e.type=n.Intersection)}if(l.length>0)for(let e=0;e<l.length;e++)l[e].next=l[(e+1)%l.length],l[e].prev=l[(e-1+l.length)%l.length];return l},c=d(e,0,s),u=d(o,1,s);if(0===c.length||0===u.length)return[];c.forEach(e=>{if(e.isIntersection&&e.intersectionInfo){let t=e.intersectionInfo,n=u.find(n=>n.isIntersection&&n.intersectionInfo&&eP(n.coordinates,e.coordinates)&&n.intersectionInfo.seg1Idx===t.seg1Idx&&n.intersectionInfo.seg2Idx===t.seg2Idx);if(n){e.partnerNode=n,n.partnerNode=e;let t=eM.vec2.subtract(eM.vec2.create(),e.coordinates,e.prev.coordinates),o=eM.vec2.subtract(eM.vec2.create(),n.next.coordinates,n.coordinates),a=t[0]*o[1]-t[1]*o[0];if(a>1e-7)e.intersectionDir=i.Entering,n.intersectionDir=i.Exiting;else if(a<-1e-7)e.intersectionDir=i.Exiting,n.intersectionDir=i.Entering;else{let t=[(e.prev.coordinates[0]+e.coordinates[0])/2,(e.prev.coordinates[1]+e.coordinates[1])/2];(0,e_.default)(l,t)?(e.intersectionDir=i.Exiting,n.intersectionDir=i.Entering):(e.intersectionDir=i.Entering,n.intersectionDir=i.Exiting)}}else e.isIntersection=!1,e.intersectionInfo=void 0}});let h=[];for(let e of c){if(!e.isIntersection||e.visited||e.intersectionDir!==i.Entering)continue;let t=[],n=e,o=!0,r=0,l=(c.length+u.length)*2;c.forEach(e=>e.processedInPath=!1),u.forEach(e=>e.processedInPath=!1);do{if(r++>l){console.warn("Intersection: Max iterations in path tracing.",e.id,n.id),t=[];break}if(n.processedInPath&&n!==e){console.warn("Intersection: Path processing loop detected, discarding path segment.",e.id,n.id),t=[];break}n.processedInPath=!0,n.visited=!0,0!==t.length&&eP(t[t.length-1],n.coordinates)||t.push([...n.coordinates]);n.isIntersection&&n.partnerNode&&(o?(n=n.partnerNode,o=!1):(n=n.partnerNode,o=!0)),n=n.next}while(n!==e||o&&0!==n.originalPolyIndex||!o&&1!==n.originalPolyIndex)if(r>l||0===t.length||t.length>0&&eP(t[0],t[t.length-1])&&t.pop(),t.length>=3){let e=(0,eC.default)(t);a>0&&e<0?t.reverse():a<0&&e>0&&t.reverse(),h.push(t.map(e=>[...e]))}}return h}!function(e){e[e.Vertex=0]="Vertex",e[e.Intersection=1]="Intersection"}(n||(n={})),function(e){e[e.Entering=0]="Entering",e[e.Exiting=1]="Exiting",e[e.Unknown=2]="Unknown"}(i||(i={})),e.s(["default",()=>eR],945122),e.s(["default",()=>eU],157060);var ek=e.i(158817);function eV(e,t,n,i){let o=!1,a=e[0]<t[0]?e[0]:t[0],r=e[1]<t[1]?e[1]:t[1],l=e[0]>t[0]?e[0]:t[0],s=e[1]>t[1]?e[1]:t[1],d=n[0]<i[0]?n[0]:i[0],c=n[1]<i[1]?n[1]:i[1],u=n[0]>i[0]?n[0]:i[0],h=n[1]>i[1]?n[1]:i[1];if(a>u||l<d||r>h||s<c)return!1;let g=[eF(e,t,n),eF(e,t,i),eF(n,i,e),eF(n,i,t)];return g[0]!==g[1]&&g[2]!==g[3]||(0===g[0]&&eB(e,n,t)||0===g[1]&&eB(e,i,t)||0===g[2]&&eB(n,e,i)?o=!0:0===g[3]&&eB(n,t,i)&&(o=!0),o)}function eF(e,t,n){let i=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===i?0:i>0?1:2}function eB(e,t,n){return!!(t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1]))}function eG(e,t,n){let i=!(arguments.length>3)||void 0===arguments[3]||arguments[3],o=[],a=e.length,r=a-(i?1:2);for(let i=0;i<=r;i++){let r=e[i],l=i===a-1?0:i+1;eV(t,n,r,e[l])&&o.push([i,l])}return o}function eW(e,t,n){let i,o,a=!(arguments.length>3)||void 0===arguments[3]||arguments[3];a?(o=e.length-1,i=0):(o=0,i=1);for(let a=i;a<e.length;a++){if(eV(t,n,e[o],e[a]))return[o,a];o=a}}function ez(e,t){for(let n=0,i=e.length;n<i;n++){let o=eW(t,e[n],e[n===i-1?0:n+1]);if((null==o?void 0:o.length)===2)return!0}return!1}var eq=e.i(213918);function eH(e,t,n){let i=e[0]<=t[0]?e[0]:t[0],o=e[0]>=t[0]?e[0]:t[0],a=e[1]<=t[1]?e[1]:t[1],r=e[1]>=t[1]?e[1]:t[1];if(!(n[0]>=i-.01&&n[0]<=o+.01&&n[1]>=a-.01&&n[1]<=r+.01))return!1;let l=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return(l>=0?l:-l)<=.01}function ej(e,t,n,i){let o=[t[0]-e[0],t[1]-e[1]],a=[i[0]-n[0],i[1]-n[1]],r=a[1]*o[0]-a[0]*o[1];if((r>=0?r:-r)<.01){let o=[e[0]<t[0]?e[0]:t[0],e[0]>t[0]?e[0]:t[0],e[1]<t[1]?e[1]:t[1],e[1]>t[1]?e[1]:t[1]],a=[n[0]<i[0]?n[0]:i[0],n[0]>i[0]?n[0]:i[0],n[1]<i[1]?n[1]:i[1],n[1]>i[1]?n[1]:i[1]];if(!(o[0]<=a[1]&&o[1]>=a[0]&&o[2]<=a[3]&&o[3]>=a[2])||!(eH(e,t,n)||eH(e,t,i)||eH(n,i,e)))return;return[((o[0]>a[0]?o[0]:a[0])+(o[1]<a[1]?o[1]:a[1]))*.5,((o[2]>a[2]?o[2]:a[2])+(o[3]<a[3]?o[3]:a[3]))*.5]}let l=e[1]-n[1],s=e[0]-n[0],d=a[0]*l-a[1]*s,c=o[0]*l-o[1]*s;return l=d/r,s=c/r,[e[0]+l*o[0],e[1]+l*o[1]]}function eK(e){for(let t=0,n=e.length;t<n;t++){let i=e[t];i.next||(i.next=e[t===n-1?0:t+1])}}function eY(e,t){let n=eD(e),i=eD(t),l=eA.vec3.dot(i,n);if(eq.glMatrix.equals(1,l)||(t=t.slice().reverse()),!ez(t,e)&&(0,eS.default)(t,e))return t.slice();let{targetPolylinePoints:s}=function(e,t){let n=[],i=[],l=new Map,s=(0,e_.default)(t,e[0])?r.Exiting:r.Entering;for(let i=0,d=e.length;i<d;i++){let c=e[i],u=(0,e_.default)(t,c),h={type:o.Vertex,coordinates:c,position:u?a.Inside:a.Outside,visited:!1,next:null};n.push(h);let g=e[i===d-1?0:i+1],f=eG(t,c,g).map(e=>{let n=e[0],i=ej(c,g,t[e[0]],t[e[1]]),o=ek.distanceToPointSquared(c,i);return{sourceLineSegmentId:n,coordinate:i,targetStartPointDistSquared:o}});f.sort((e,t)=>e.targetStartPointDistSquared-t.targetStartPointDistSquared),f.forEach(e=>{let{sourceLineSegmentId:t,coordinate:i}=e,d={type:o.Intersection,coordinates:i,position:a.Edge,direction:s,visited:!1,next:null},c={...d,direction:r.Unknown,cloned:!0};s===r.Entering?d.next=c:c.next=d;let u=l.get(t);u||(u=[],l.set(t,u)),n.push(d),u.push(c),s*=-1})}for(let e=0,n=t.length;e<n;e++){let n=e,a=t[e],r={type:o.Vertex,coordinates:a,visited:!1,next:null};i.push(r);let s=l.get(n);(null==s?void 0:s.length)&&s.map(e=>({intersectionPoint:e,lineSegStartDistSquared:ek.distanceToPointSquared(a,e.coordinates)})).sort((e,t)=>e.lineSegStartDistSquared-t.lineSegStartDistSquared).map(e=>{let{intersectionPoint:t}=e;return t}).forEach(e=>i.push(e))}return eK(n),eK(i),{targetPolylinePoints:n,sourcePolylinePoints:i}}(e,t),d=function(e){for(let t=0,n=e.length;t<n;t++){let n=e[t];if(!n.visited&&n.position===a.Outside&&n.type===o.Vertex)return n}for(let t=0,n=e.length;t<n;t++){let n=e[t];if(!n.visited&&n.position===a.Outside)return n}}(s);if(!d)return e.slice();let c=[d.coordinates],u=d.next,h=0,g=e.length+t.length+1e3;for(;u!==d&&h<g;){if(h++,u.type===o.Intersection&&u.cloned){u=u.next;continue}if(c.push(u.coordinates),!(u=u.next)){console.warn("Broken linked list detected in mergePolylines, breaking loop");break}}return h>=g&&console.warn("Maximum iterations reached in mergePolylines, possible infinite loop detected"),c}function eX(e,t,n){let i,o=(0,ek.distanceToPointSquared)(e,t);if(e[0]===t[0]&&e[1]===t[1]&&(i=e),!i){let a=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/o;i=a<0?e:a>1?t:[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}return{point:[...i],distanceSquared:(0,ek.distanceToPointSquared)(n,i)}}function eZ(e,t,n){return eX(e,t,n).distanceSquared}function eJ(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1,n=e.length;if(n<3)return e;let i=t*t,o=[[0,n-1]],a=Array(n).fill(!1),r=2;for(a[0]=!0,a[n-1]=!0;o.length;){let[t,n]=o.pop();if(n-t==1)continue;let l=e[t],s=e[n],d=-1/0,c=-1;for(let i=t+1;i<n;i++){let t=eZ(l,s,e[i]);t>d&&(d=t,c=i)}d<i||(a[c]=!0,r++,o.push([c,n]),o.push([t,c]))}let l=Array(r);for(let t=0,i=0;t<n;t++)a[t]&&(l[i++]=e[t]);return l}function eQ(e,t,n){let i=!(arguments.length>3)||void 0===arguments[3]||arguments[3],o=[],a=eG(e,t,n,i);for(let i=0;i<a.length;i++){let r=ej(t,n,e[a[i][0]],e[a[i][1]]);o.push(r)}return o}function e$(e,t,n){let i,o,a=!(arguments.length>3)||void 0===arguments[3]||arguments[3];a?(o=e.length-1,i=0):(o=0,i=1);let r=[];for(let a=i;a<e.length;a++)eV(t,n,e[o],e[a])&&r.push([o,a]),o=a;if(0===r.length)return;let l=[];r.forEach(n=>{let i=[e[n[0]],e[n[1]]],o=[(i[0][0]+i[1][0])/2,(i[0][1]+i[1][1])/2];l.push(eM.vec2.distance(o,t))});let s=Math.min(...l);return{segment:r[l.indexOf(s)],distance:s}}!function(e){e[e.Vertex=0]="Vertex",e[e.Intersection=1]="Intersection"}(o||(o={})),function(e){e[e.Outside=-1]="Outside",e[e.Edge=0]="Edge",e[e.Inside=1]="Inside"}(a||(a={})),function(e){e[e.Exiting=-1]="Exiting",e[e.Unknown=0]="Unknown",e[e.Entering=1]="Entering"}(r||(r={}));var e0=e.i(209501);let e1=(e,t)=>{let n,i,o;if(e instanceof e0.StackViewport){let t=e.getImageData();if(!t)return;i=t.direction.slice(0,3),o=t.direction.slice(3,6),n=t.spacing}else{let t,a,{direction:r,spacing:l}=e.getImageData(),{viewPlaneNormal:s,viewUp:d}=e.getCamera(),c=r.slice(0,3),u=r.slice(3,6),h=r.slice(6,9),g=eA.vec3.create();eA.vec3.cross(g,d,s);let f=Math.abs(eA.vec3.dot(g,c)),m=Math.abs(eA.vec3.dot(g,u)),v=Math.abs(eA.vec3.dot(g,h));if(.001>Math.abs(1-f))t=l[0],i=c;else if(.001>Math.abs(1-m))t=l[1],i=u;else if(.001>Math.abs(1-v))t=l[2],i=h;else throw Error("No support yet for oblique plane planar contours");let p=Math.abs(eA.vec3.dot(d,c)),I=Math.abs(eA.vec3.dot(d,u)),E=Math.abs(eA.vec3.dot(d,h));if(.001>Math.abs(1-p))a=l[0],o=c;else if(.001>Math.abs(1-I))a=l[1],o=u;else if(.001>Math.abs(1-E))a=l[2],o=h;else throw Error("No support yet for oblique plane planar contours");n=[t,a]}return{spacing:[n[0]/t,n[1]/t],xDir:i,yDir:o}},e2=(e,t,n)=>eM.vec2.dist(e,t)<n;var e3=e.i(513336);let e5=(e,t,n,i)=>{let{xDir:o,yDir:a,spacing:r}=i,{viewport:l}=(0,e3.getEnabledElement)(e);if(!t.length)return t.push(n),console.log(">>>>> !canvasPoints. :: RETURN"),1;let s=l.canvasToWorld(t[t.length-1]),d=l.canvasToWorld(n),c=eA.vec3.create();eA.vec3.subtract(c,d,s);let u=Math.abs(eA.vec3.dot(c,o)),h=Math.abs(eA.vec3.dot(c,a)),g=Math.max(Math.floor(u/r[0]),Math.floor(h/r[0]));if(g>1){let e=t[t.length-1],i=eM.vec2.dist(e,n),o=eM.vec2.create();eM.vec2.subtract(o,n,e),eM.vec2.set(o,o[0]/i,o[1]/i);let a=i/g;for(let n=1;n<=g;n++)t.push([e[0]+a*o[0]*n,e[1]+a*o[1]*n])}else t.push(n);return g},e4=(e,t,n,i)=>{let o=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],r=o[0]*a[0]+o[1]*a[1];if(r<0)return!1;let l=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===l)return!1;let s=r/l,d=[a[0]/l,a[1]/l],c=[d[0]*s,d[1]*s],u=[t[0]+c[0],t[1]+c[1]];return!(eM.vec2.distance(e,u)>i||eM.vec2.distance(t,u)>eM.vec2.distance(t,n))};function e8(e){let t,n=w.utilities.getRandomSampleFromArray(e,50);for(let e=0;e<3;e++)if(n.every((t,n,i)=>1e-6>Math.abs(t[e]-i[0][e]))){t=e;break}if(void 0===t)throw Error("Cannot find a shared dimension index for polyline, probably oblique plane");let i=[],o=(t+1)%3,a=(t+2)%3;for(let t=0;t<e.length;t++)i.push([e[t][o],e[t][a]]);return{sharedDimensionIndex:t,projectedPolyline:i}}function e6(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{sharedDimensionIndex:i,projectedPolyline:o}=e8(t),{holes:a}=n,r=[];if(a)for(let e=0;e<a.length;e++){let t=a[e],n=[];for(let e=0;e<t.length;e++)n.push([t[e][(i+1)%3],t[e][(i+2)%3]]);r.push(n)}let l=[e[(i+1)%3],e[(i+2)%3]];return(0,e_.default)(o,l,{holes:r})}function e7(e){if(e.length<3)return e.slice();let t=e.map(e=>[e[0],e[1]]).sort((e,t)=>e[0]===t[0]?e[1]-t[1]:e[0]-t[0]);function n(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])}let i=[];for(let e of t){for(;i.length>=2&&0>=n(i[i.length-2],i[i.length-1],e);)i.pop();i.push(e)}let o=[];for(let e=t.length-1;e>=0;e--){let i=t[e];for(;o.length>=2&&0>=n(o[o.length-2],o[o.length-1],i);)o.pop();o.push(i)}return i.pop(),o.pop(),i.concat(o)}e.i(905412);var e9=ew,te=e_,tt=eS,tn=eC,ti=e.i(335439),ti=ti;e.s(["distanceToPoint",()=>ta,"distanceToPointSquared",()=>tr.default,"mirror",()=>tl],983973),e.s([],607773),e.i(607773);var to=e.i(29728);function ta(e,t){return Math.sqrt((0,to.default)(e,t))}var tr=to;function tl(e,t){let[n,i]=e,[o,a]=t;return[2*o-n,2*a-i]}var ts=e.i(983973),ts=ts;function td(e,t,n,i){var o,a,r,l;let{canvasToWorld:s,worldToCanvas:d}=n,{data:c}=e,{targetWindingDirection:u}=t,{points:h}=t,g=ti.getWindingDirection(h);(null==i||null==(o=i.decimate)?void 0:o.enabled)&&(h=ti.decimate(t.points,null==i||null==(a=i.decimate)?void 0:a.epsilon));let{closed:f}=t,m=h.length,v=Array(m);ti.getWindingDirection(h);let p=(0,ep.getParentAnnotation)(e);if(void 0===f){let e=!1;if(h.length>3){let t=ts.distanceToPointSquared(h[0],h[m-1]);e=w.utilities.isEqual(0,t)}f=e}if((null==i?void 0:i.updateWindingDirection)!==!1){let e=p?-1*p.data.contour.windingDirection:u;void 0===e&&(e=g),e!==g&&h.reverse();let t=(null!=(l=null==(r=c.handles)?void 0:r.points)?l:[]).map(d);t.length>2&&ti.getWindingDirection(t)!==e&&c.handles.points.reverse(),g=e}for(let e=0;e<m;e++)v[e]=s(h[e]);c.contour.polyline=v,c.contour.closed=f,c.contour.windingDirection=g,(0,ep.invalidateAnnotation)(e)}e.s(["default",()=>nB],567483),e.s(["state",()=>tZ],54120),e.s(["getFont",()=>tR,"getState",()=>tO,"style",()=>tP],260154),e.s([],979162),e.s(["checkAndSetAnnotationLocked",()=>tv,"getAnnotationsLocked",()=>tg,"getAnnotationsLockedCount",()=>tm,"isAnnotationLocked",()=>tf,"setAnnotationLocked",()=>tu,"unlockAllAnnotations",()=>th],10122);let tc=new Set;function tu(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],n=tp();e&&(t?function(e,t,n){if(!t.has(e)){t.add(e),n.added.push(e);let i=(0,ep.getAnnotation)(e);i&&(i.isLocked=!0)}}(e,tc,n):tI(e,tc,n)),tE(n,tc)}function th(){var e,t;let n=tp();e=tc,t=n,e.forEach(n=>{tI(n,e,t)}),tE(n,tc)}function tg(){return Array.from(tc)}function tf(e){return tc.has(e)}function tm(){return tc.size}function tv(e){let t=tf(e);return tu(e,t),t}function tp(){return Object.freeze({added:[],removed:[],locked:[]})}function tI(e,t,n){if(t.delete(e)){n.removed.push(e);let t=(0,ep.getAnnotation)(e);t&&(t.isLocked=!1)}}function tE(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach(t=>void e.locked.push(t)),(0,b.triggerEvent)(T.eventTarget,R.Events.ANNOTATION_LOCK_CHANGE,e))}e.s(["deselectAnnotation",()=>tS,"getAnnotationsSelected",()=>ty,"getAnnotationsSelectedByToolName",()=>tT,"getAnnotationsSelectedCount",()=>tb,"isAnnotationSelected",()=>tC,"setAnnotationSelected",()=>t_],433460);let tw=new Set;function t_(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];t?function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=tA();if(!t){tx(tw,n);let t=(0,ep.getAnnotation)(e);t&&(t.isSelected=!0)}if(e&&!tw.has(e)){tw.add(e),n.added.push(e);let t=(0,ep.getAnnotation)(e);t&&(t.isSelected=!0)}tD(n,tw)}(e,n):tS(e)}function tS(e){let t=tA();e?tw.delete(e)&&(t.removed.push(e),(0,ep.getAnnotation)(e).isSelected=!1):tx(tw,t),tD(t,tw)}function ty(){return Array.from(tw)}function tT(e){return ty().filter(t=>{var n;let i=(0,ep.getAnnotation)(t);return(null==i||null==(n=i.metadata)?void 0:n.toolName)===e})}function tC(e){return tw.has(e)}function tb(){return tw.size}function tA(){return Object.freeze({added:[],removed:[],selection:[]})}function tx(e,t){e.forEach(n=>{if(e.delete(n)){t.removed.push(n);let e=(0,ep.getAnnotation)(n);e&&(e.isSelected=!1)}})}function tD(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach(t=>void e.selection.push(t)),(0,b.triggerEvent)(T.eventTarget,R.Events.ANNOTATION_SELECTION_CHANGE,e))}e.s(["AnnotationStyleStates",()=>tM],36489),e.s(["default",()=>tM],936137),function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e.AutoGenerated="AutoGenerated"}(l||(l={}));let tM=l,tO=function(e){if(e){if(e.data&&e.highlighted)return tM.Highlighted;if(tC(e.annotationUID))return tM.Selected;if(tf(e.annotationUID))return tM.Locked;if(e.data&&e.autoGenerated)return tM.AutoGenerated}return tM.Default};e.s(["getStyleProperty",()=>tN],997418);let tP=new class{getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){let{annotationUID:n,viewportId:i,toolGroupId:o,toolName:a}=t;return this._getToolStyle(e,n,i,o,a)}_getToolStyle(e,t,n,i,o){if(t){let n=this.getAnnotationToolStyles(t);if(n&&void 0!==n[e])return n[e]}if(n){let t=this.getViewportToolStyles(n);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}if(i){let t=this.getToolGroupToolStyles(i);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}let a=this.getDefaultToolStyles();return a[o]&&void 0!==a[o][e]?a[o][e]:a.global&&void 0!==a.global[e]?a.global[e]:void 0}_initializeConfig(e){let t={};for(let n in e)t[n]=e[n];this.config={default:{global:t}}}constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(209, 193, 90)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(209, 193, 90)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0,markerSize:"10",angleArcLineDash:""})}};function tN(e,t,n,i){let o=function(e,t,n){let i=["".concat(e)];return t&&i.push("".concat(i[0]).concat(t)),n&&i.push("".concat(i[i.length-1]).concat(n)),i}(e,n,i);for(let e=o.length-1;e>=0;--e){let n=tP.getStyleProperty(o[e],t);if(void 0!==n)return n}}let tR=function(e,t,n){let i=tN("textBoxFontSize",e,t,n),o=tN("textBoxFontFamily",e,t,n);return"".concat(i,"px ").concat(o)};e.i(979162);var tL=e.i(260154);e.i(10122),e.i(433460);var tU=e.i(162923);e.s(["checkAndSetAnnotationVisibility",()=>tq,"isAnnotationVisible",()=>tB,"setAnnotationVisibility",()=>tV,"showAllAnnotations",()=>tF],72340);let tk=new Set;function tV(e){var t,n,i;let o=!(arguments.length>1)||void 0===arguments[1]||arguments[1],a=tG();e&&(o?tW(e,tk,a):(t=e,n=tk,i=a,n.has(t)||(n.add(t),tC(t)&&tS(t),i.lastHidden.push(t),(0,ep.getAnnotation)(t).isVisible=!1))),tz(a)}function tF(){let e=tG();tk.forEach(t=>{tW(t,tk,e)}),tz(e)}function tB(e){if((0,ep.getAnnotation)(e))return!tk.has(e)}function tG(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function tW(e,t,n){t.delete(e)&&(n.lastVisible.push(e),(0,ep.getAnnotation)(e).isVisible=!0)}function tz(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(tk.forEach(t=>void e.hidden.push(t)),(0,b.triggerEvent)(T.eventTarget,R.Events.ANNOTATION_VISIBILITY_CHANGE,e))}function tq(e){let t=!tk.has(e);return tV(e,t),t}e.i(72340),e.s(["default",()=>tK,"defaultFrameOfReferenceSpecificAnnotationManager",()=>tj],368043);class tH{setPreprocessingFn(e){this.preprocessingFn=e}constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;let t=(0,e3.getEnabledElement)(e);if(!t)throw Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return t.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{let{FrameOfReferenceUID:t}=e.detail,n=this.annotations[t];n&&Object.keys(n).forEach(e=>{n[e].forEach(e=>{void 0!==e.invalidated&&(e.invalidated=!0)})})},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{let n=this.annotations;return n[e]?t?n[e][t]?n[e][t]:[]:n[e]:[]},this.getAnnotation=e=>{let t=this.annotations;for(let n in t){let i=t[n];for(let t in i)for(let n of i[t])if(e===n.annotationUID)return n}},this.getNumberOfAnnotations=(e,t)=>{let n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let i=0;for(let e in n)i+=n[e].length;return i},this.addAnnotation=(e,t)=>{let{metadata:n}=e,{FrameOfReferenceUID:i,toolName:o}=n;t=t||i;let a=this.annotations,r=a[t];r||(a[t]={},r=a[t]);let l=r[o];l||(r[o]=[],l=r[o]),this.preprocessingFn&&(e=this.preprocessingFn(e)),l.push(e)},this.removeAnnotation=e=>{let{annotations:t}=this;for(let n in t){let i=t[n];for(let t in i){let n=i[t],o=n.findIndex(t=>t.annotationUID===e);-1!==o&&(n.splice(o,1),0===n.length&&delete i[t])}0===Object.keys(i).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{let n=this.annotations,i=[];if(!n[e])return i;if(t){let o=n[e][t];if(o)for(let e of o)this.removeAnnotation(e.annotationUID),i.push(e)}else for(let t in n[e])for(let o of n[e][t])this.removeAnnotation(o.annotationUID),i.push(o);return i},this.saveAnnotations=(e,t)=>{let n=this.annotations;if(e&&t){let i=n[e];if(!i)return;return structuredClone(i[t])}return e?structuredClone(n[e]):structuredClone(n)},this.restoreAnnotations=(e,t,n)=>{let i=this.annotations;if(t&&n){let o=i[t];o||(i[t]={},o=i[t]),o[n]=e}else t?i[t]=e:this.annotations=structuredClone(e)},this.getAllAnnotations=()=>Object.values(this.annotations).map(e=>Object.values(e)).flat(2),this.getNumberOfAllAnnotations=()=>{let e=0,t=this.annotations;for(let n in t){let i=t[n];for(let t in i)e+=i[t].length}return e},this.removeAllAnnotations=()=>{let e=[];for(let t of this.getAllAnnotations())this.removeAnnotation(t.annotationUID),e.push(t);return e},e||(e=w.utilities.uuidv4()),this.annotations={},this.uid=e,T.eventTarget.addEventListener(C.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}let tj=new tH("DEFAULT"),tK=tH;e.s(["default",()=>tX],379788);var tY=e.i(823467);class tX{unboundVisibleFilter(e){return!this._isVisible||!this.annotationUIDs.has(e)}has(e){return this.annotationUIDs.has(e)}setVisible(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this._isVisible!==e&&(this._isVisible=e,this.annotationUIDs.forEach(i=>{let o=(0,ep.getAnnotation)(i);if(!o)return void this.annotationUIDs.delete(i);if(o.isVisible===e||!e&&(null==n?void 0:n(i))===!1)return;o.isVisible=e;let a={...t,annotation:o};(0,b.triggerEvent)(T.eventTarget,tY.default.ANNOTATION_MODIFIED,a)}))}get isVisible(){return this._isVisible}findNearby(e,t){let n=[...this.annotationUIDs];if(0===n.length)return null;if(!e)return n[1===t?0:n.length-1];let i=n.indexOf(e);return -1===i||i+t<0||i+t>=n.length?null:n[i+t]}add(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];t.forEach(e=>this.annotationUIDs.add(e))}remove(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];t.forEach(e=>this.annotationUIDs.delete(e))}clear(){this.annotationUIDs.clear()}constructor(){this.annotationUIDs=new Set,this._isVisible=!0,this.visibleFilter=this.unboundVisibleFilter.bind(this)}}tj.setPreprocessingFn(e=>{let t=(e=(e=>(e.data||(e.data={}),e.data.cachedStats||(e.data.cachedStats={}),e))(e=(e=>(e.data||(e.data={}),e.data.handles||(e.data.handles={}),e.data.handles.textBox||(e.data.handles.textBox={}),e))(e))).annotationUID,n=tv(t);e.isLocked=n;let i=tq(t);return e.isVisible=i,e}),(0,ep.setAnnotationManager)(tj);let tZ={...ep,...tU,resetAnnotationManager:function(){(0,ep.setAnnotationManager)(tj)}},tJ="PlanarFreehandContourSegmentationTool";function tQ(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],{viewport:n,sliceData:i,annotation:o}=e,a=new Map,{toolName:r,originalToolName:l}=o.metadata,s=l||r,d=((0,ep.getAnnotations)(s,n.element)||[]).filter(e=>!e.metadata.originalToolName||e.metadata.originalToolName===s);if(s!==tJ){let e=(0,ep.getAnnotations)(tJ,n.element);(null==e?void 0:e.length)&&e.forEach(e=>{let{metadata:t}=e;t.originalToolName===s&&t.originalToolName!==t.toolName&&d.push(e)})}if(!(null==d?void 0:d.length))return a;for(let e=0;e<i.numberOfSlices;e++){let n=d.filter(t=>t.metadata.sliceIndex===e);if(!(null==n?void 0:n.length))continue;let i=n.filter(e=>t.every(t=>{let n=t.parentKey?t.parentKey(e):e,i=null==n?void 0:n[t.key];return Array.isArray(i)?i.every((e,n)=>e===t.value[n]):i===t.value}));i.length&&a.set(e,i)}return a}function t$(e,t,n){let i=w.utilities.deepMerge({data:{},metadata:{}},n);return Object.assign(i,{highlighted:!1,invalidated:!0,autoGenerated:!0,annotationUID:void 0,cachedStats:{},childAnnotationUIDs:[],parentAnnotationUID:void 0}),Object.assign(i.data,{handles:{points:t.points||t||[],interpolationSources:t.sources,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},contour:{...n.data.contour,polyline:e}}),i}let t0=function(e,t){let n=tQ(t,[{key:"interpolationUID",value:t.interpolationUID}]),i=function(e){let t=1/0,n=-1/0,i=!1;for(let[o,a]of e.entries())a.length&&(t=Math.min(o,t),n=Math.max(o,n),i=!0);if(i)return[t,n]}(n);if(!i)return void console.warn("No annotations found to interpolate",n);let o=function(e,t){for(let[n,i]of e)for(let e=0;e<i.length;e++)if(i[e].annotationUID===t)return n}(n,e.annotationUID),a=[];for(let e=i[0]+1;e<i[1];e++)if(function(e,t){let n=e.get(t);return!(null==n?void 0:n.length)||1===n.length&&n[0].autoGenerated}(n,e)){let t=function(e,t,n){let i=[],o=!0;for(let a=e-1;a>=t[0];a--){let e=n.get(a);if(null==e?void 0:e.length){if(e[0].autoGenerated)continue;e.length>1&&(o=!1),i.push(a);break}}if(o&&i.length){for(let a=e+1;a<=t[1];a++){let e=n.get(a);if(null==e?void 0:e.length){if(e[0].autoGenerated)continue;e.length>1&&(o=!1),i.push(a);break}}if(o&&!(i.length<2))return i}}(e,i,n);((null==t?void 0:t[0])===o||(null==t?void 0:t[1])===o)&&function(e,t,n){let[i]=e;t[i]||(t[i]={pair:e,list:[]}),t[i].list.push(n)}(t,a,e)}return{interpolationData:n,interpolationList:a}},{PointsManager:t1}=w.utilities;function t2(e,t,n,i,o){n<t&&(n+=o);let a=n-t,r=Math.ceil(a/i);if(r<=0)return e[e.length-1]!==n&&e.push(t3(n,o)),n;for(let n=1;n<=r;n++){let i=t3(t+n*a/r,o);e.push(i)}return e[e.length-1]}function t3(e,t){return(Math.round(e)+t)%t}e.s(["checkIntersection",()=>nv,"cleanupPolylines",()=>ny,"combinePolylines",()=>nE,"convertContourPolylineToCanvasSpace",()=>nf,"convertContourPolylineToWorld",()=>nm,"createNewAnnotationFromPolyline",()=>nw,"createPolylineHole",()=>nI,"getContourHolesData",()=>np,"removeDuplicatePoints",()=>nS,"updateViewportsForAnnotations",()=>n_],144730),e.s(["ContourWindingDirection",()=>s],894311),function(e){e[e.CounterClockwise=-1]="CounterClockwise",e[e.Unknown=0]="Unknown",e[e.Clockwise=1]="Clockwise"}(s||(s={}));var ti=ti;function t5(e,t){return e.minX<=t.maxX&&e.maxX>=t.minX&&e.minY<=t.maxY&&e.maxY>=t.minY}function t4(e,t){let n=e.maxX-e.minX,i=e.maxY-e.minY,o=[n,i],a=[e.minX+n/2,e.minY+i/2],r=[Math.abs(t[0]-a[0]),Math.abs(t[1]-a[1])],l=r[0]-.5*o[0],s=r[1]-.5*o[1];if(l>0&&s>0)return l*l+s*s;let d=Math.max(l,0)+Math.max(s,0);return d*d}function t8(e,t){return Math.sqrt(t4(e,t))}e.s(["aabb",()=>t6],717824),e.s(["distanceToPoint",()=>t8,"distanceToPointSquared",()=>t4,"intersectAABB",()=>t5],87988),e.s([],917664),e.i(917664);var t6=e.i(87988),t6=t6;function t7(e){if(e.parentAnnotationUID)return;if(!e.data.segmentation)throw Error("addContourSegmentationAnnotation: annotation does not have a segmentation data");let{segmentationId:t,segmentIndex:n}=e.data.segmentation,i=H(t);i.representationData.Contour||(i.representationData.Contour={annotationUIDsMap:new Map});let{annotationUIDsMap:o}=i.representationData.Contour;o||(o=new Map);let a=null==o?void 0:o.get(n);a||(a=new Set,o.set(n,a)),i.segments[n].locked&&tu(e.annotationUID,!0),o.set(n,a.add(e.annotationUID))}function t9(e){if(!e.data.segmentation)throw Error("removeContourSegmentationAnnotation: annotation does not have a segmentation data");let{segmentationId:t,segmentIndex:n}=e.data.segmentation,i=H(t),{annotationUIDsMap:o}=(null==i?void 0:i.representationData.Contour)||{},a=null==o?void 0:o.get(n);a&&(a.delete(e.annotationUID),a.size||o.delete(n))}e.s(["addContourSegmentationAnnotation",()=>t7],797433),e.s(["removeContourSegmentationAnnotation",()=>t9],668441);var ne=e.i(815926);function nt(e,t){let n=e.length,i=[];for(let o=0;o<n;o++){let n=e[o];n.getFrameOfReferenceUID()===t&&i.push(n)}return i}e.s(["getViewportIdsWithToolToRender",()=>nd],665224);var nn=e.i(273965),ni=e.i(650658);let{Active:no,Passive:na,Enabled:nr}=nn.ToolModes;function nl(e,t){let n=e.length,i=[];for(let o=0;o<n;o++){let n=e[o],a=(0,ni.getToolGroupForViewport)(n.id,n.renderingEngineId);a&&function(e,t){let{toolOptions:n}=e,i=n[t];if(!i)return!1;let o=i.mode;return o===no||o===na||o===nr}(a,t)&&i.push(n)}return i}let ns=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.999;return e.filter(e=>{let i=e.getCamera();return Math.abs(eA.vec3.dot(i.viewPlaneNormal,t.viewPlaneNormal))>n})};function nd(e,t){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2],i=(0,e3.getEnabledElement)(e),{renderingEngine:o,FrameOfReferenceUID:a}=i,r=o.getViewports();r=nl(r=nt(r,a),t);let l=o.getViewport(i.viewportId);return n&&(r=ns(r,l.getCamera())),r.map(e=>e.id)}e.s(["addTool",()=>nu,"hasToolByName",()=>nh],605509);var nc=e.i(518792);function nu(e){let t=e.toolName;if(!t)throw Error("No Tool Found for the ToolClass ".concat(e.name));nc.state.tools[t]||(nc.state.tools[t]={toolClass:e})}function nh(e){return!!(e&&nc.state.tools[e])}let ng="PlanarFreehandContourSegmentationTool";function nf(e,t){let n=e.length,i=Array(n);for(let o=0;o<n;o++)i[o]=t.worldToCanvas(e[o]);return i}function nm(e,t){let n=e.length,i=Array(n);for(let o=0;o<n;o++)i[o]=t.canvasToWorld(e[o]);return i}function nv(e,t){let n=ti.getAABB(e),i=ti.getAABB(t);if(!t6.intersectAABB(n,i))return{hasIntersection:!1,isContourHole:!1};let o=ti.intersectPolyline(e,t),a=!o&&ti.containsPoints(t,e);return{hasIntersection:o||a,isContourHole:a}}function np(e,t){return(0,ep.getChildAnnotations)(t).map(t=>{let n=nf(t.data.contour.polyline,e);return{annotation:t,polyline:n}})}function nI(e,t,n){(0,ep.addChildAnnotation)(t,n),t9(n);let{contour:i}=n.data;td(n,{points:nf(i.polyline,e),closed:i.closed,targetWindingDirection:t.data.contour.windingDirection===s.Clockwise?s.CounterClockwise:s.Clockwise},e);let{element:o}=e;n_(e,[t,n])}function nE(e,t,n,i,o){if(!nh(ng))return void console.warn("".concat(ng," is not registered in cornerstone. Cannot combine polylines."));let a=o[0],r=ti.containsPoint(n,a),l=new Set(np(e,t)),s=new Map,d=(e,t)=>{let n=s.get(e);n||(n=[],s.set(e,n)),n.push(t),l.delete(t)},c=[];if(r){let e=ti.mergePolylines(n,o);c.push(e),Array.from(l.keys()).forEach(t=>d(e,t))}else ti.subtractPolylines(n,o).forEach(e=>{c.push(e),Array.from(l.keys()).forEach(t=>{ti.containsPoints(e,t.polyline)&&d(e,t)})});Array.from(s.values()).forEach(e=>e.forEach(e=>(0,ep.clearParentAnnotation)(e.annotation)));let{element:u}=e,{metadata:h,data:g}=t,{handles:f,segmentation:m}=g,{textBox:v}=f;(0,ep.removeAnnotation)(i.annotationUID),(0,ep.removeAnnotation)(t.annotationUID),t9(i),t9(t);let p=[];for(let n=0;n<c.length;n++){var I;let i=c[n];if(!i||i.length<3){console.warn("Skipping creation of new annotation due to invalid polyline:",i);continue}let o=nw(e,t,i);(0,ep.addAnnotation)(o,u),t7(o),(0,tU.triggerAnnotationModified)(o,e.element),p.push(o),null==(I=s.get(i))||I.forEach(e=>(0,ep.addChildAnnotation)(o,e.annotation))}n_(e,[t,i])}function nw(e,t,n){let i=e.canvasToWorld(n[0]),o=e.canvasToWorld(n[n.length-1]),a={metadata:{...t.metadata,toolName:ng,originalToolName:t.metadata.originalToolName||t.metadata.toolName},data:{cachedStats:{},handles:{points:[i,o],textBox:t.data.handles.textBox?{...t.data.handles.textBox}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...t.data.segmentation}},annotationUID:w.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};return td(a,{points:n,closed:!0,targetWindingDirection:s.Clockwise},e),a}function n_(e,t){let{element:n}=e,i=new Set([ng]);for(let e of(t.forEach(e=>{i.add(e.metadata.toolName)}),i.values()))if(nh(e)){let t=nd(n,e);(0,ne.default)(t)}}function nS(e){if(!e||e.length<2)return e;let t=[e[0]];for(let n=1;n<e.length;n++){let i=e[n],o=t[t.length-1],a=Math.abs(i[0]-o[0]),r=Math.abs(i[1]-o[1]);(a>1e-10||r>1e-10)&&t.push(i)}return t}function ny(e){let t=[],n=new Set;for(let i of e){if(!i||i.length<3||(i=nS(i)).length<3)continue;let e=[...i].sort((e,t)=>e[0]!==t[0]?e[0]-t[0]:e[1]-t[1]).map(e=>"".concat(e[0].toFixed(6),",").concat(e[1].toFixed(6))).join("|");n.has(e)||(n.add(e),t.push(i))}return t}let{PointsManager:nT}=w.utilities;function nC(e,t,n){let{viewport:i}=n,o=tZ.getAnnotations(e.metadata.toolName,i.element);for(let n=0;n<o.length;n++){let i=o[n];if(i.interpolationUID===e.interpolationUID&&i.metadata.sliceIndex===t)return i}}function nb(e,t){t-=e.length*Math.floor(t/e.length);let n=e.splice(0,t);return e.push(...n),e}function nA(e,t){let n={x:[],y:[],z:[],I:[]};for(let i=0;i<e.x.length-1;i++){n.x.push(e.x[i]),n.y.push(e.y[i]),n.z.push(e.z[i]),n.I.push(!0);let o=(e.x[i+1]-e.x[i])/(t[i]+1),a=(e.y[i+1]-e.y[i])/(t[i]+1),r=(e.z[i+1]-e.z[i])/(t[i]+1);for(let e=0;e<t[i]-1;e++)n.x.push(n.x[n.x.length-1]+o),n.y.push(n.y[n.y.length-1]+a),n.z.push(n.z[n.z.length-1]+r),n.I.push(!1)}return n}function nx(e,t){let n=[];for(let t=0;t<e.length;++t)n[t]=t;n.sort(function(t,n){return e[t]<e[n]?-1:1});let i=[];for(let e=0;e<t.length;e++)i.push(t[n[e]]);let o=i.reduce(function(e,t,n){return t&&e.push(n),e},[]),a=[];for(let e=0;e<o.length-1;e++)a.push(o[e+1]-o[e]);return a}function nD(e,t){let n=Array(e+t);return n.fill(!1,0,e),n.fill(!0,e,e+t),n}function nM(e,t){let n=1/(e-1),i=[n];for(let t=1;t<e-2;t++)i.push(i[i.length-1]+n);return i.concat(t)}function nO(e){let t=[];for(let n=0;n<e.length;n++)t.push(e[n]/e[e.length-1]);return t}function nP(e){let t=[0];for(let n=1;n<e.x.length;n++){let i=Math.sqrt((e.x[n]-e.x[n-1])**2+(e.y[n]-e.y[n-1])**2+(e.z[n]-e.z[n-1])**2);t.push(t[n-1]+i)}return t}function nN(e){let t={x:[],y:[],z:[]};for(let n=0;n<e.length;n++)t.x[n]=e[n][0],t.y[n]=e[n][1],t.z[n]=e[n][2];return t.x.push(t.x[0]),t.y.push(t.y[0]),t.z.push(t.z[0]),t}let nR=function(e){if(!e.annotation)return;let{isInterpolationUpdate:t,annotation:n}=e;queueMicrotask(()=>{try{t&&(n.isInterpolationUpdate=!0,n.autoGenerated=!1),function(e){let{annotation:t}=e;!function(e){let{parentAnnotationUID:t,annotationUID:n}=e;if(!t)return e.interpolationUID;let i=tZ.getAnnotation(t),{interpolationUID:o}=i,a=i.childAnnotationUIDs.indexOf(n);e.interpolationUID="".concat(o,"-").concat(a),e.interpolationUID}(t);let{interpolationData:n,interpolationList:i}=t0(t,e)||{};if(!n||!i)return;let o={toolName:t.metadata.toolName,toolType:t.metadata.toolName,viewport:e.viewport};for(let e=0;e<i.length;e++)i[e]&&function(e,t,n,i){let o=n.get(t[0])[0],a=n.get(t[1])[0],r=nN(o.data.contour.polyline),l=nN(a.data.contour.polyline),{c1Interp:s,c2Interp:d}=function(e,t){let n=nP(e),i=nP(t),o=Math.max(Math.ceil(n[n.length-1]/.2),Math.ceil(i[i.length-1]/.2)),a=nO(n),r=nO(i),l=o+t.x.length,s=o+e.x.length,d=nM(l,a),c=nM(s,r),u=nD(l-2,e.x.length),h=nD(s-2,t.x.length),g=nx(d,u),f=nx(c,h),m=nA(e,g),v=nA(t,f);return function(e,t){let n=e.x.length,i={startingNode:0,totalSquaredXYLengths:1/0};for(let o=0;o<n;o++){let a=o,r=0;for(let i=0;i<n;i++)r+=(e.x[a]-t.x[i])**2+(e.y[a]-t.y[i])**2+(e.z[a]-t.z[i])**2,++a===n&&(a=0);r<i.totalSquaredXYLengths&&(i.totalSquaredXYLengths=r,i.startingNode=o)}let o=i.startingNode;nb(e.x,o),nb(e.y,o),nb(e.z,o),nb(e.I,o)}(m,v),function(e,t){let n={x:[],y:[],z:[],I:[]},i={x:[],y:[],z:[],I:[]};for(let o=0;o<e.x.length;o++)(e.I[o]||t.I[o])&&(n.x.push(e.x[o]),n.y.push(e.y[o]),n.z.push(e.z[o]),n.I.push(e.I[o]),i.x.push(t.x[o]),i.y.push(t.y[o]),i.z.push(t.z[o]),i.I.push(t.I[o]));return{c1Interp:n,c2Interp:i}}(m,v)}(r,l);s.kIndex=t[0],d.kIndex=t[1],e.forEach(function(e){!function(e,t,n,i,o,a,r){let[l,s]=i,d=(n-l)/(s-l),c=o.get(l)[0],u=o.get(s)[0],h=function(e,t,n,i){let o=i?e.I:t.I,a=nT.fromXYZ(e),r=nT.fromXYZ(t),{length:l}=a,s=nT.create3(l),d=eA.vec3.create(),c=eA.vec3.create(),u=nT.create3(l);u.kIndex=e.kIndex;let h=nT.create3(l);h.kIndex=t.kIndex;for(let t=0;t<e.x.length;t++)if(o[t]){let e=a.getPoint(t),i=r.getPoint(t);u.push(e),h.push(i),eA.vec3.sub(d,i,e),s.push(eA.vec3.scaleAndAdd(c,e,d,n))}return s.sources=[u,h],s}(e,t,d,a),g=d>.5?u:c,f=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,n=t1.create3(t);n.sources=[];let{sources:i}=n,{length:o,sources:a=[]}=e;if(o<15)return e.subselect(t);let r=Math.floor(Math.max(2*o/t,10));a.forEach(()=>i.push(t1.create3(t)));let l=function(e,t){let n,{max:i,deviation:o}=function(e){let{length:t}=e,n=0,i=1/0,o=-1/0,a=0;for(let a=0;a<t;a++){let t=e[a];n+=t,i=Math.min(i,t),o=Math.max(o,t)}let r=n/t;for(let n=0;n<t;n++){let t=e[n]-r;a+=t*t}return{mean:r,max:o,min:i,sumSq:a,deviation:Math.sqrt(a/t)}}(e),{length:a}=e;if(o<.01||a<3*t)return[];let r=[],l=null,s=0;for(let t=0;t<a;t++){let a=e[t];a<i-o?l?(l[2]=t,a<n&&(n=a,s=t),l[1]=s):(n=a,s=t,l=[t,t,t]):l&&(r.push(l),l=null)}return l&&(0===r[0][0]?r[0][0]=l[0]:(l[1]=s,l[2]=a-1,r.push(l))),r}(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6,{length:n}=e,i=eA.vec3.create(),o=eA.vec3.create(),a=new Float32Array(n);for(let r=0;r<n;r++){let l=e.getPoint(r),s=e.getPoint(r-t),d=e.getPoint((r+t)%n);eA.vec3.sub(i,l,s),eA.vec3.sub(o,d,l);let c=eA.vec3.dot(i,o)/(eA.vec3.len(i)*eA.vec3.len(o));a[r]=c}return a}(e,5),t),s=[];if((null==l?void 0:l.length)>2){let e=-1,t=r/3;l.forEach(n=>{let[i,,a]=n,l=Math.ceil((i+a)/2);!(a-e<t)&&(l-i>2*t?(t2(s,e,i,r,o),e=t2(s,i,l,r,o)):e=t2(s,e,l,r,o),a-e>t&&(e=t2(s,e,a,r,o)))});let n=s[0];t3(n+o-e,o)>2*t&&t2(s,e,n-t,r,o)}else{let e=Math.floor(o/t);t2(s,-1,o-e,e,o)}return s.forEach(t=>{let o=e.getPointArray(t);n.push(o),a.forEach((e,n)=>i[n].push(e.getPoint(t)))}),n}(h);o.has(n)?function(e,t,n,i,o){let a=nC(i,n,o),r=t$(e.points,t,a);Object.assign(a,{metadata:r.metadata,data:r.data})}(h,f,n,g,r):function(e,t,n,i,o){var a;let r=e.points,{viewport:l}=o,s=t$(r,t,i),d=l.getViewReference({sliceIndex:n});if(!d)throw Error("Can't find slice ".concat(n));Object.assign(s.metadata,d),tZ.addAnnotation(s,l.element),null==(a=i.onInterpolationComplete)||a.call(i,s,i);let{parentAnnotationUID:c}=i;c&&nI(l,nC(tZ.getAnnotation(c),n,o),s)}(h,f,n,g,r)}(s,d,e,t,n,r.x.length>l.x.length,i)})}(i[e].list,i[e].pair,n,o);let{id:a,renderingEngineId:r,element:l}=e.viewport;i.length&&(0,b.triggerEvent)(e.viewport.element,tY.default.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED,{annotation:t,element:l,viewportId:a,renderingEngineId:r})}(e)}finally{t&&(n.autoGenerated=!0)}})};function nL(e){let{annotation:t}=e,n=tQ(e,[{key:"interpolationUID",value:e.interpolationUID}]),i=t.metadata.sliceIndex,o=-1,a=e.sliceData.numberOfSlices;for(let[e,t]of n.entries())e!==i&&t.find(e=>!e.autoGenerated)&&(e<i?o=Math.max(e,o):a=Math.min(e,a));let r=[];for(let[e,t]of n.entries())e<=o||e>=a||e===i||t.forEach(e=>{e.autoGenerated&&(tZ.removeAnnotation(e.annotationUID),r.push(e))});if(r.length){let t={annotations:r,element:e.viewport.element,viewportId:e.viewport.id,renderingEngineId:e.viewport.getRenderingEngine().id};(0,b.triggerEvent)(e.viewport.element,tY.default.INTERPOLATED_ANNOTATIONS_REMOVED,t)}if(o>=0&&a<e.sliceData.numberOfSlices){let t=n.get(a)[0];nR({viewport:e.viewport,sliceData:{numberOfSlices:e.sliceData.numberOfSlices,imageIndex:t.metadata.sliceIndex},annotation:t,interpolationUID:t.interpolationUID})}}var nU=e.i(727044),nk=e.i(519318);let{uuidv4:nV}=w.utilities,nF=[nU.default.HandlesUpdated,nU.default.InterpolationUpdated];class nB{static addTool(e){this.toolNames.includes(e)||this.toolNames.push(e)}static removeTool(e){this.toolNames.includes(e)&&(this.toolNames=this.toolNames.filter(t=>t!==e))}static acceptAutoGenerated(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{toolNames:n,segmentationId:i,segmentIndex:o,sliceIndex:a}=t;for(let t of n||nB.toolNames){let n=tZ.getAnnotations(t,e);if(null==n?void 0:n.length)for(let e of n){let{interpolationUID:t,data:n,autoGenerated:r,metadata:l}=e;t&&(e.interpolationCompleted=!0),r&&(!o||o===n.segmentation.segmentIndex)&&(void 0===a||!l||a===l.sliceIndex)&&(i&&i!==n.segmentation.segmentationId||(t7(e),e.autoGenerated=!1))}}}}function nG(e){return{numberOfSlices:e.getNumberOfSlices(),imageIndex:e.getCurrentImageIdIndex()}}function nW(e,t){nB.acceptAutoGenerated(e,t)}nB.toolNames=[],nB.handleAnnotationCompleted=e=>{var t;let n=e.detail.annotation;if(!(null==n?void 0:n.metadata))return;let{toolName:i,originalToolName:o}=n.metadata;if(!nB.toolNames.includes(i)&&!nB.toolNames.includes(o))return;let a=(0,nk.default)(n);if(!a)return void console.warn("Unable to find viewport for",n);let r=nG(a),l={viewport:a,sliceData:r,annotation:n,interpolationUID:n.interpolationUID},s=!!n.interpolationUID;if(n.autoGenerated=!1,s){nL(l),nR(l);return}let d=function(e,t){let n=tQ(e,t),i=[];if(!(null==n?void 0:n.size))return i;for(let e of n.values())e.forEach(e=>{i.push(e)});return i}(l,[{key:"segmentIndex",value:n.data.segmentation.segmentIndex,parentKey:e=>e.data.segmentation},{key:"viewPlaneNormal",value:n.metadata.viewPlaneNormal,parentKey:e=>e.metadata},{key:"viewUp",value:n.metadata.viewUp,parentKey:e=>e.metadata}]),{sliceIndex:c}=n.metadata,u=new Set;d.forEach(e=>{if(e.interpolationCompleted||e.metadata.sliceIndex===c){let{interpolationUID:t}=e;u.add(t)}}),n.interpolationUID=(null==(t=(d=d.filter(e=>!u.has(e.interpolationUID)))[0])?void 0:t.interpolationUID)||nV(),l.interpolationUID=n.interpolationUID,nR(l)},nB.handleAnnotationUpdate=e=>{let t=e.detail.annotation,{changeType:n=nU.default.HandlesUpdated}=e.detail;if(!(null==t?void 0:t.metadata))return;let{toolName:i,originalToolName:o}=t.metadata;if(!nB.toolNames.includes(i)&&!nB.toolNames.includes(o)||!nF.includes(n))return;let a=(0,nk.default)(t);if(!a)return void console.warn("Unable to find matching viewport for annotation interpolation",t);t.autoGenerated&&(t7(t),t.autoGenerated=!1);let r=nG(a);nR({viewport:a,sliceData:r,annotation:t,interpolationUID:t.interpolationUID,isInterpolationUpdate:n===nU.default.InterpolationUpdated})},nB.handleAnnotationDelete=e=>{let t=e.detail.annotation;if(!(null==t?void 0:t.metadata))return;let{toolName:n}=t.metadata;if(!nB.toolNames.includes(n)||t.autoGenerated)return;let i=(0,nk.default)(t);if(!i)return void console.warn("No viewport, can't delete interpolated results",t);let o=nG(i),a={viewport:i,sliceData:o,annotation:t,interpolationUID:t.interpolationUID};t.autoGenerated=!1,nL(a)};let{isEqual:nz}=w.utilities;function nq(e,t){let{polyline:n}=e.data.contour,{points:i}=e.data.handles,{length:o}=i;if(t===o)return n.length;if(t<0&&(t=(t+o)%o),0===t)return 0;let a=i[t],r=n.findIndex(e=>nz(a,e));if(-1!==r)return r;let l=1/0;return n.reduce((e,t,n)=>{let i=eA.vec3.squaredDistance(t,a);return i<l?(l=i,n):e},-1)}let nH=function(e,t){let n=0;for(let t=0;t<e.length-1;t++){let i=e[t],o=e[t+1];n+=eA.vec3.dist(i,o)}if(t){let t=e[0],i=e[e.length-1];n+=eA.vec3.dist(t,i)}return n};function nj(e,t){if(!e||0===e.length||t<=0)return[];let n=[];for(let i=0;i<e.length;i++){let o=e[i];o&&!(o.length<3)&&(0,ew.default)(o)&&Math.abs((0,eC.default)(o))/100<t&&n.push(i)}return n}e.i(723383);var nK=g,nY=f,nX=m,nZ=v,nJ=p;e.s(["IslandRemoval",()=>rA,"LabelmapMemo",()=>l6,"SegmentStatsCalculator",()=>l4.default,"VolumetricCalculator",()=>l5.default,"computeMetabolicStats",()=>l2,"computeStackLabelmapFromVolume",()=>lJ,"computeVolumeLabelmapFromStack",()=>lQ,"contourAndFindLargestBidirectional",()=>lE,"createBidirectionalToolData",()=>lw,"createLabelmapVolumeForViewport",()=>oa,"createMergedLabelmapForIndex",()=>oo,"floodFill",()=>rm,"getBrushSizeForToolGroup",()=>lg,"getBrushThresholdForToolGroup",()=>lm,"getBrushToolInstances",()=>lu,"getHoveredContourSegmentationAnnotation",()=>lP,"getOrCreateImageVolume",()=>er,"getOrCreateSegmentationVolume",()=>eo,"getReferenceVolumeForSegmentationVolume",()=>et,"getSegmentIndexAtLabelmapBorder",()=>lM,"getSegmentIndexAtWorldPoint",()=>lD,"getSegmentLargestBidirectional",()=>l$,"getStatistics",()=>rF,"getUniqueSegmentIndices",()=>oC,"growCut",()=>l8,"invalidateBrushCursor",()=>lx,"rectangleROIThresholdVolumeByRange",()=>oi,"segmentContourAction",()=>lA,"setBrushSizeForToolGroup",()=>lh,"setBrushThresholdForToolGroup",()=>lf,"thresholdSegmentationByRange",()=>lp,"thresholdVolumeByRange",()=>n6,"triggerSegmentationRender",()=>rh,"triggerSegmentationRenderBySegmentationId",()=>rg,"validateLabelmap",()=>l7],753244),e.s([],855451),e.s(["getCachedSegmentIndices",()=>n5,"getVoxelOverlap",()=>n0,"processVolumes",()=>n1,"setCachedSegmentIndices",()=>n4,"setSegmentationDirty",()=>n3],62075);var nQ=e.i(498597);let n$=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function n0(e,t,n,i){let o=n[0]/2,a=n[1]/2,r=n[2]/2,l=Array(8);l[0]=w.utilities.transformWorldToIndex(e,[i[0]-o,i[1]-a,i[2]-r]);let s=[[1,-1,-1],[-1,1,-1],[1,1,-1],[-1,-1,1],[1,-1,1],[-1,1,1],[1,1,1]];for(let t=0;t<7;t++){let[n,d,c]=s[t];l[t+1]=w.utilities.transformWorldToIndex(e,[i[0]+n*o,i[1]+d*a,i[2]+c*r])}return(0,nQ.getBoundingBoxAroundShapeIJK)(l,t)}function n1(e,t){let{spacing:n}=e,i=e.voxelManager.getScalarDataLength(),o=[],a=0;for(let e=0;e<t.length;e++){let{imageData:r,spacing:l,dimensions:s,voxelManager:d}=t[e].volume,c=t[e].volume.voxelManager.getScalarDataLength();c===i&&n$(l,n)&&(a=e);let u=t[e].lower,h=t[e].upper;o.push({imageData:r,lower:u,upper:h,spacing:l,dimensions:s,volumeSize:c,voxelManager:d})}return{volumeInfoList:o,baseVolumeIdx:a}}let n2=new Map,n3=e=>{let t=n2.get(e);t&&(t.isDirty=!0)},n5=e=>{let t=n2.get(e);return t&&!t.isDirty?t.indices:null},n4=(e,t)=>{n2.set(e,{indices:t,isDirty:!1})};function n8(e,t,n){n3(e),(0,b.triggerEvent)(T.eventTarget,R.Events.SEGMENTATION_DATA_MODIFIED,{segmentationId:e,modifiedSlicesToUse:t,segmentIndex:n})}let n6=function(e,t,n){let i,o,a,{imageData:r}=e,{overwrite:l,boundsIJK:s,segmentationId:d}=n;if(!d)throw Error("Segmentation ID is required to be passed inside thresholdVolumeByRange as options");let c=(null==n?void 0:n.overlapType)||0,u=e.voxelManager,h=e.voxelManager.getScalarDataLength();if(l)for(let e=0;e<h;e++)u.setAtIndex(e,0);let{baseVolumeIdx:g,volumeInfoList:f}=n1(e,t),m=(e,t,n)=>{let{imageData:r,dimensions:l,lower:s,upper:d}=e,u=n0(r,l,t,n);o=0,i=0,a={lower:s,upper:d};let h=!1,{voxelManager:g}=r.get("voxelManager");return g.forEach(e=>{let{value:t}=e;o+=1,t>=a.lower&&t<=a.upper&&(i+=1)},{imageData:r,boundsIJK:u}),0===c?h=i>0:1==c&&(h=i===o),h},v=(e,t)=>{let{imageData:n,lower:i,upper:o}=e,a=n.get("voxelManager").voxelManager,r=a.toIndex(t),l=a.getAtIndex(r);return!(l<=i)&&!(l>=o)};return e.voxelManager.forEach(e=>{let{index:t,pointIJK:i,pointLPS:o}=e,a=f.length>0;for(let e=0;e<f.length&&(a=f[e].volumeSize===h?v(f[e],i):m(f[e],f[g].spacing,o));e++);a&&u.setAtIndex(t,n.segmentIndex||1)},{imageData:r,boundsIJK:s}),n8(n.segmentationId),e};var n7=e.i(961785);e.s(["drawHandles",()=>io],526630);let n9=function(e,t,n){return"".concat(e,"::").concat(t,"::").concat(n)},ie=function(e,t){Object.keys(e).forEach(n=>{let i=e[n];void 0!==i&&""!==i&&t.setAttribute(n,i)})},it=function(e,t){Object.keys(e).forEach(n=>{let i=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):i!==o&&t.setAttribute(n,o)})},ii=function(e,t,n,i){let o,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},r=arguments.length>5?arguments[5]:void 0,{color:l,handleRadius:s,width:d,lineWidth:c,fill:u,type:h,opacity:g}=Object.assign({color:"rgb(0, 255, 0)",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},a),f=c||d,m=n9(t,"handle","hg-".concat(n,"-index-").concat(r));if("circle"===h)o={cx:"".concat(i[0]),cy:"".concat(i[1]),r:s,stroke:l,fill:u,"stroke-width":f,opacity:g};else if("rect"===h){let e=1.5*parseFloat(s),t=i[0]-.5*e,n=i[1]-.5*e;o={x:"".concat(t),y:"".concat(n),width:"".concat(e),height:"".concat(e),stroke:l,fill:u,"stroke-width":f,rx:"".concat(.1*e),opacity:g}}else throw Error("Unsupported handle type: ".concat(h));let v=e.getSvgNode(m);if(v)it(o,v),e.setNodeTouched(m);else{let t=document.createElementNS("http://www.w3.org/2000/svg",h);ie(o,t),e.appendNode(t,m)}},io=function(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};i.forEach((i,a)=>{ii(e,t,n,i,o,a)})};function ia(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"",{color:r,width:l,lineWidth:s,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},o),c=n9(t,"rect",n),u=e.getSvgNode(c),[h,g,f,m]=i,v=Math.hypot(h[0]-g[0],h[1]-g[1]),p=Math.hypot(h[0]-f[0],h[1]-f[1]),I=[(m[0]+h[0])/2,(m[1]+h[1])/2],E=[(f[0]+h[0])/2,(f[1]+h[1])/2],w=180*Math.atan2(I[1]-E[1],I[0]-E[0])/Math.PI,_={x:"".concat(I[0]-v/2),y:"".concat(I[1]-p/2),width:"".concat(v),height:"".concat(p),stroke:r,fill:"transparent",transform:"rotate(".concat(w," ").concat(I[0]," ").concat(I[1],")"),"stroke-width":s||l,"stroke-dasharray":d};if(u)it(_,u),e.setNodeTouched(c);else{let t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==a&&t.setAttribute("data-id",a),ie(_,t),e.appendNode(t,c)}}function ir(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",l=[i[0],i[1]],s=[o[0],i[1]];ia(e,t,n,[l,s,[i[0],o[1]],[o[0],o[1]]],a,r)}function il(e){let t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function is(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||((n=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("class","background"),e.insertBefore(n,e.firstChild));let i=e.getBBox();return it({x:"".concat(i.x),y:"".concat(i.y),width:"".concat(i.width),height:"".concat(i.height),fill:t},n),i}e.s(["drawLinkedTextBox",()=>ig],515155);let id=function(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};return function(e,t,n){let i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[""],a=arguments.length>4?arguments[4]:void 0,r=arguments.length>5?arguments[5]:void 0,{padding:l,color:s,fontFamily:d,fontSize:c,background:u}=r,[h,g]=[a[0]+l,a[1]+l],f=n9(t,"text",n),m=e.getSvgNode(f);if(m){let n=m.querySelector("text"),a=Array.from(n.children);for(let e=0;e<a.length;e++)a[e].textContent=o[e]||"";if(o.length>a.length){for(let e=0;e<o.length-a.length;e++){let t=il(o[e+a.length]);n.appendChild(t)}m.appendChild(n),e.appendNode(m,f)}let r={transform:"translate(".concat(h," ").concat(g,")")};it({fill:s,"font-size":c,"font-family":d},n),it(r,m),m.setAttribute("data-annotation-uid",t),i=is(m,u),e.setNodeTouched(f)}else{let n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("data-annotation-uid",t),n.setAttribute("transform","translate(".concat(h," ").concat(g,")"));let a=function(e,t){let{color:n,fontFamily:i,fontSize:o}=t,a=document.createElementNS("http://www.w3.org/2000/svg","text"),r="filter:url(#shadow-".concat(e.svgLayerElement.id,");"),l="".concat("user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);").concat(r);return a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("fill",n),a.setAttribute("font-family",i),a.setAttribute("font-size",o),a.setAttribute("style",l),a.setAttribute("pointer-events","visible"),a}(e,r);for(let e=0;e<o.length;e++){let t=il(o[e]);a.appendChild(t)}n.appendChild(a),e.appendNode(n,f),i=is(n,u)}return Object.assign({},i,{x:h,y:g,height:i.height+l,width:i.width+l})}(e,t,n,i,o,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a))};function ic(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;let{color:l="rgb(0, 255, 0)",width:s=10,lineWidth:d,lineDash:c,markerStartId:u=null,markerEndId:h=null,shadow:g=!1,strokeOpacity:f=1}=a,m=n9(t,"line",n),v=e.getSvgNode(m),p=e.svgLayerElement.id,I={x1:"".concat(i[0]),y1:"".concat(i[1]),x2:"".concat(o[0]),y2:"".concat(o[1]),stroke:l,style:g?"filter:url(#shadow-".concat(p,");"):"","stroke-width":d||s,"stroke-dasharray":c,"marker-start":u?"url(#".concat(u,")"):"","marker-end":h?"url(#".concat(h,")"):"","stroke-opacity":f};if(v)it(I,v),e.setNodeTouched(m);else{let t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==r&&t.setAttribute("data-id",r),ie(I,t),e.appendNode(t,m)}}function iu(e,t){let n=[0,0],i=Number.MAX_SAFE_INTEGER;return e.forEach(function(e){let o=function(e,t){let[n,i]=e,[o,a]=t;return Math.sqrt(Math.pow(n-o,2)+Math.pow(i-a,2))}(t,e);o<i&&(i=o,n=[...e])}),n}let ih=function(e,t,n,i,o,a){let r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=i.length>0?iu(i,o):o,s=iu(function(e){let{x:t,y:n,height:i,width:o}=e,a=o/2,r=i/2;return[[t+a,n],[t,n+r],[t+a,n+i],[t+o,n+r]]}(a),l),d=Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},r);ic(e,t,"link-".concat(n),l,s,d)},ig=function(e,t,n,i,o,a,r){let l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{},s=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},l),d=id(e,t,n,i,o,s);return ih(e,t,n,a,o,d,s),d};var im=e.i(100563),iv=e.i(655809);function ip(e){let t=function(e){let t=[e[0],e[1]].sort(function(e,t){return e[0]<t[0]?-1:1}),n=[e[0],e[1]].sort(function(e,t){return e[1]<t[1]?-1:1}),i=t[t.length-1];return{top:n[0],bottom:n[n.length-1],right:i}}(e),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}function iI(e,t,n,i){let o=eA.vec3.create();eA.vec3.cross(o,t,e);let a=eA.vec3.fromValues(...n),r=eA.vec3.fromValues(...i),l=eA.vec3.create();eA.vec3.subtract(l,a,r);let s=eA.vec3.length(l);if(s<1e-4)return{worldWidth:0,worldHeight:0};let d=eA.vec3.dot(l,o)/(s*eA.vec3.length(o));return{worldWidth:Math.sqrt(1-d*d)*s,worldHeight:d*s}}e.s(["getTextBoxCoordsCanvas",()=>ip],836714),e.s(["hideElementCursor",()=>iA,"initElementCursor",()=>iT,"resetElementCursor",()=>ib],932057),e.s(["default",()=>i_],473327);let iE=Symbol("DefinedCursors"),iw=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class i_{getName(){return this.name+""}addFallbackStyleProperty(e){let{fallback:t}=this;return t instanceof i_?"".concat(e,", ").concat(t.getStyleProperty()):e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){let t=iS(i_,iE),n=t.get(e);return n instanceof i_?n:iw.has(e)?(n=new i_(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){return t instanceof i_&&(iS(i_,iE).set(e,t),!0)}constructor(e,t){this.name=e+"",this.fallback=t}}function iS(e,t){let n=e[t];return n instanceof Map||Object.defineProperty(e,t,{value:n=new Map}),n}iw.values();let iy=Symbol("ElementCursorsMap");function iT(e,t){ix(e)[0]=t,iC(e,t)}function iC(e,t){let n=ix(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof i_?t:i_.getDefinedCursor("auto")).getStyleProperty()}function ib(e){iC(e,ix(e)[1])}function iA(e){iC(e,i_.getDefinedCursor("none"))}function ix(e){let t=ix[iy];t instanceof WeakMap||Object.defineProperty(ix,iy,{value:t=new WeakMap});let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}e.s(["AnnotationTool",()=>ij],98021);var iD=e.i(412974);let{DefaultHistoryMemo:iM}=w.utilities.HistoryMemo;class iO{static mergeDefaultProps(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;return t?w.utilities.deepMerge(e,t):e}get toolName(){return this.getToolName()}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){var n;let{strategies:i,activeStrategy:o}=this.configuration;return null==(n=i[o])?void 0:n.call(this,e,t)}applyActiveStrategyCallback(e,t,n){for(var i,o=arguments.length,a=Array(o>3?o-3:0),r=3;r<o;r++)a[r-3]=arguments[r];let{strategies:l,activeStrategy:s}=this.configuration;if(!l[s])throw Error("applyActiveStrategyCallback: active strategy ".concat(s," not found, check tool configuration or spellings"));return null==(i=l[s][n])?void 0:i.call(this,e,t,...a)}setConfiguration(e){this.configuration=w.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetImageData(e){if(e.startsWith("imageId:")){let t=e.split("imageId:")[1],n=w.utilities.imageIdToURI(t),i=w.utilities.getViewportsWithImageURI(n);if(i&&i.length&&(i=i.filter(e=>e.getCurrentImageId()===t))&&i.length)return i[0].getImageData()}else if(e.startsWith("volumeId:")){let t=w.utilities.getVolumeId(e),n=w.utilities.getViewportsWithVolumeId(t);if(!n||!n.length)return;return n[0].getImageData()}else if(e.startsWith("videoId:")){let t=w.utilities.imageIdToURI(e),n=w.utilities.getViewportsWithImageURI(t);if(!n||!n.length)return;return n[0].getImageData()}else throw Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){var t;let n=null==(t=e.getViewReferenceId)?void 0:t.call(e);if(n)return n;throw Error("getTargetId: viewport must have a getViewReferenceId method")}undo(){this.doneEditMemo(),iM.undo()}redo(){iM.redo()}static createZoomPanMemo(e){let t={pan:e.getPan(),zoom:e.getZoom()},n={restoreMemo:()=>{let n=e.getPan(),i=e.getZoom();e.setZoom(t.zoom),e.setPan(t.pan),e.render(),t.pan=n,t.zoom=i}};return iM.push(n),n}doneEditMemo(){var e,t;(null==(t=this.memo)||null==(e=t.commitMemo)?void 0:e.call(t))&&iM.push(this.memo),this.memo=null}static startGroupRecording(){iM.startGroupRecording()}static endGroupRecording(){iM.endGroupRecording()}constructor(e,t){let n=iO.mergeDefaultProps(iO.defaults,t),{configuration:i={},supportedInteractionTypes:o,toolGroupId:a}=w.utilities.deepMerge(n,e);this.toolGroupId=a,this.supportedInteractionTypes=o||[],this.configuration=Object.assign({},i),this.mode=iD.default.Disabled}}iO.defaults={configuration:{strategies:{},defaultStrategy:void 0,activeStrategy:void 0,strategyOptions:{}}},iO.toolName="BaseTool";let iP=iO;var iN=e.i(238064),iR=e.i(802939),iL=e.i(853939);let{isEqual:iU}=w.utilities,{EPSILON:ik}=iL.CONSTANTS,iV=1-ik;function iF(e,t,n){let{viewPlaneNormal:i}=t,o=e.filter(e=>{let{planeRestriction:n,referencedImageId:o}=e.metadata,{viewPlaneNormal:a}=e.metadata;if(n){let{inPlaneVector1:e,inPlaneVector2:t}=n;return(!e||!!iU(0,eA.vec3.dot(i,e)))&&(!t||!!iU(0,eA.vec3.dot(i,t)))}if(!e.metadata.referencedImageId&&!a&&e.metadata.FrameOfReferenceUID){for(let n of e.data.handles.points){let e=eA.vec3.sub(eA.vec3.create(),n,t.focalPoint);if(!iU(eA.vec3.dot(e,i),0))return!1}return e.metadata.viewPlaneNormal=i,e.metadata.cameraFocalPoint=t.focalPoint,!0}if(!a&&o){let{imageOrientationPatient:t}=A.metaData.get("imagePlaneModule",o),n=eA.vec3.fromValues(t[0],t[1],t[2]),i=eA.vec3.fromValues(t[3],t[4],t[5]);a=eA.vec3.create(),eA.vec3.cross(a,n,i),e.metadata.viewPlaneNormal=a}let r=Math.abs(eA.vec3.dot(i,a))>iV;return a&&r});if(!o.length)return[];let a=n/2,{focalPoint:r}=t,l=[];for(let e of o){var s,d;let{data:t,metadata:n,isVisible:o}=e;if(!o)continue;let c=(null==(s=n.planeRestriction)?void 0:s.point)||t.handles.points[0]||(null==(d=t.contour)?void 0:d.polyline[0]);if(!c){l.push(e);continue}let u=eA.vec3.sub(eA.vec3.create(),r,c);Math.abs(eA.vec3.dot(u,i))<a&&l.push(e)}return l}function iB(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(e instanceof iR.VolumeViewport){let n=e.getCamera(),{spacingInNormalDirection:i}=w.utilities.getTargetVolumeAndSpacingInNormalDir(e,n);return iF(t,n,i)}if(e instanceof e0.StackViewport){let t=e.getCurrentImageId();if(!t)return[];let i=t.indexOf(":");n.imageURI=t.substring(i+1)}return t.filter(t=>!!t.isVisible&&(!!t.data.isCanvasAnnotation||e.isReferenceViewable(t.metadata,n)))}class iG extends iP{filterInteractableAnnotationsForElement(e,t){if(!(null==t?void 0:t.length))return[];let{viewport:n}=(0,e3.getEnabledElement)(e);return iB(n,t)}static createAnnotation(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let i={annotationUID:null,highlighted:!0,invalidated:!0,isLocked:!1,isVisible:!0,metadata:{toolName:this.toolName},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{},label:""}};for(let e of t)i=w.utilities.deepMerge(i,e);return i}createAnnotation(e,t){for(var n=arguments.length,i=Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];let{currentPoints:a,element:r}=e.detail,{world:l}=a,{viewport:s}=(0,e3.getEnabledElement)(r),{viewPlaneNormal:d,viewUp:c,position:u}=s.getCamera(),h=this.getReferencedImageId(s,l,d,c),g=s.getViewReference({points:[l]});return iG.createAnnotation({metadata:{toolName:this.getToolName(),...g,referencedImageId:h,viewUp:c,cameraPosition:u},data:{handles:{points:t||[]}}},...i)}getReferencedImageId(e,t,n,i){let o=this.getTargetId(e),a=o.split(/^[a-zA-Z]+:/)[1];if(e instanceof x.BaseVolumeViewport){let e=w.utilities.getVolumeId(o),i=I.cache.getVolume(e);a=w.utilities.getClosestImageId(i,t,n)}return a}getStyle(e,t,n){return tN(e,t,tO(n),this.mode)}constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{let{element:t,imageId:n}=e.detail,i=w.utilities.imageIdToURI(n),o=(0,ep.getAnnotationManager)();o.getFramesOfReference().forEach(e=>{let n=o.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach(e=>{var t;(null==(t=e.metadata)?void 0:t.referencedImageId)&&w.utilities.imageIdToURI(e.metadata.referencedImageId)===i&&(e.invalidated=!0,e.data.cachedStats={})}),(0,iN.default)(t))})}}}iG.toolName="AnnotationDisplayTool";let iW=iG,{DefaultHistoryMemo:iz}=w.utilities.HistoryMemo,{PointsManager:iq}=w.utilities;class iH extends iW{static createAnnotationForViewport(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.createAnnotation({metadata:e.getViewReference()},...n)}static createAndAddAnnotation(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];let o=this.createAnnotationForViewport(e,...n);(0,ep.addAnnotation)(o,e.element),(0,tU.triggerAnnotationModified)(o,e.element)}getHandleNearImagePoint(e,t,n,i){let{viewport:o}=(0,e3.getEnabledElement)(e),{data:a}=t,{isCanvasAnnotation:r}=a,{points:l,textBox:s}=a.handles;if(s){let{worldBoundingBox:e}=s;if(e){let t={topLeft:o.worldToCanvas(e.topLeft),topRight:o.worldToCanvas(e.topRight),bottomLeft:o.worldToCanvas(e.bottomLeft),bottomRight:o.worldToCanvas(e.bottomRight)};if(n[0]>=t.topLeft[0]&&n[0]<=t.bottomRight[0]&&n[1]>=t.topLeft[1]&&n[1]<=t.bottomRight[1])return a.handles.activeHandleIndex=null,s}}for(let e=0;e<(null==l?void 0:l.length);e++){let t=l[e],s=r?t.slice(0,2):o.worldToCanvas(t);if(!0==eM.vec2.distance(n,s)<i)return a.handles.activeHandleIndex=e,t}a.handles.activeHandleIndex=null}getLinkedTextBoxStyle(e,t){return{visibility:this.getStyle("textBoxVisibility",e,t),fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}static isSuvScaled(e,t,n){if(e instanceof x.BaseVolumeViewport){var i;let e=w.utilities.getVolumeId(t),n=I.cache.getVolume(e);return(null==n||null==(i=n.scaling)?void 0:i.PT)!==void 0}let o=n&&A.metaData.get("scalingModule",n);return"number"==typeof(null==o?void 0:o.suvbw)}getAnnotationStyle(e){let{annotation:t,styleSpecifier:n}=e,i=e=>this.getStyle(e,n,t),{annotationUID:o}=t,a=tB(o),r=tf(o),l=i("lineWidth"),s=i("lineDash"),d=i("angleArcLineDash"),c=i("color"),u=i("markerSize");return{visibility:a,locked:r,color:c,lineWidth:l,lineDash:s,lineOpacity:1,fillColor:c,fillOpacity:0,shadow:i("shadow"),textbox:this.getLinkedTextBoxStyle(n,t),markerSize:u,angleArcLineDash:d}}_imagePointNearToolOrHandle(e,t,n,i){if(this.getHandleNearImagePoint(e,t,n,i)||this.isPointNearTool(e,t,n,i,"mouse"))return!0}static createAnnotationState(e,t){let{data:n,annotationUID:i}=e,o={...n,cachedStats:{}};delete o.contour,delete o.spline;let a={annotationUID:i,data:structuredClone(o),deleting:t},r=n.contour;return r&&(a.data.contour={...r,polyline:null,pointsManager:iq.create3(r.polyline.length,r.polyline)}),a}static createAnnotationMemo(e,t,n){if(!t)return;let{newAnnotation:i,deleting:o=!i&&void 0}=n||{},{annotationUID:a}=t,r=iH.createAnnotationState(t,o),l={restoreMemo:()=>{let n=iH.createAnnotationState(t,o),{viewport:i}=(0,e3.getEnabledElement)(e)||{};if(null==i||i.setViewReference(t.metadata),!0===r.deleting){if(r.deleting=!1,Object.assign(t.data,r.data),t.data.contour){let e=t.data;e.contour.polyline=r.data.contour.pointsManager.points,delete r.data.contour.pointsManager,e.segmentation&&t7(t)}r.data=n.data,(0,ep.addAnnotation)(t,e),t_(t.annotationUID,!0),null==i||i.render();return}if(!1===r.deleting){r.deleting=!0,r.data=n.data,t_(t.annotationUID),(0,ep.removeAnnotation)(t.annotationUID),null==i||i.render();return}let l=(0,ep.getAnnotation)(a);if(!l)return void console.warn("No current annotation");Object.assign(l.data,r.data),l.data.contour&&(l.data.contour.polyline=r.data.contour.pointsManager.points),r.data=n.data,l.invalidated=!0,(0,tU.triggerAnnotationModified)(l,e,nU.default.History)},id:a,operationType:"annotation"};return iz.push(l),l}createMemo(e,t,n){this.memo||(this.memo=iH.createAnnotationMemo(e,t,n))}startGroupRecording(){iz.startGroupRecording()}endGroupRecording(){iz.endGroupRecording()}static hydrateBase(e,t,n){var i,o;let a,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!t)return null;let{viewport:l}=t,s=l.getFrameOfReferenceUID(),d=l.getCamera(),c=null!=(i=r.viewplaneNormal)?i:d.viewPlaneNormal,u=null!=(o=r.viewUp)?o:d.viewUp,h=r.toolInstance||new e,g=c,f=u;if(r.referencedImageId)a=r.referencedImageId,g=void 0,f=void 0;else if(l instanceof e0.StackViewport){let e=w.utilities.getClosestStackImageIndexForPoint(n[0],l);void 0!==e&&(a=l.getImageIds()[e])}else if(l instanceof x.BaseVolumeViewport)a=h.getReferencedImageId(l,n[0],c,u);else throw Error("Unsupported viewport type");return{FrameOfReferenceUID:s,referencedImageId:a,viewPlaneNormal:g,viewUp:f,instance:h,viewport:l}}constructor(e,t){var n,i;super(e,t),this.mouseMoveCallback=(e,t)=>{if(!t)return!1;let{element:n,currentPoints:i}=e.detail,o=i.canvas,a=!1;for(let e of t){if(tf(e.annotationUID)||!tB(e.annotationUID))continue;let{data:t}=e,i=t.handles?t.handles.activeHandleIndex:void 0,r=this._imagePointNearToolOrHandle(n,e,o,6),l=r&&!e.highlighted,s=!r&&e.highlighted;l||s?(e.highlighted=!e.highlighted,a=!0):t.handles&&t.handles.activeHandleIndex!==i&&(a=!0)}return a},this.isSuvScaled=iH.isSuvScaled,(null==(n=e.configuration)?void 0:n.getTextLines)&&(this.configuration.getTextLines=e.configuration.getTextLines),(null==(i=e.configuration)?void 0:i.statsCalculator)&&(this.configuration.statsCalculator=e.configuration.statsCalculator)}}iH.toolName="AnnotationTool";let ij=iH;var iK=e.i(563922);function iY(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(eZ(e,t,n))}function iX(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");let[n,i,o,a]=e,r=655535,l={top:[[n,i],[n+o,i]],right:[[n+o,i],[n+o,i+a]],bottom:[[n+o,i+a],[n,i+a]],left:[[n,i+a],[n,i]]};return Object.keys(l).forEach(e=>{let[n,i]=l[e],o=iY(n,i,t);o<r&&(r=o)}),r}function iZ(e,t){return iJ(A.metaData.get("generalSeriesModule",e).modality,e,t)}function iJ(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";let n=A.metaData.get("generalSeriesModule",e);if((null==n?void 0:n.modality)==="PT"){let t=A.metaData.get("petSeriesModule",e);return(null==t?void 0:t.units)||"unitless"}return"unknown"}(t,n):""}function iQ(e,t){if(e instanceof x.BaseVolumeViewport){let e=w.utilities.getVolumeId(t),n=I.cache.getVolume(e);return!!(null==n?void 0:n.scaling)&&Object.keys(n.scaling).length>0}if(!(e instanceof e0.StackViewport))return!1;{let{preScale:t}=e.getImageData()||{};return!!(null==t?void 0:t.scaled)}}e.s(["getPixelValueUnits",()=>iJ,"getPixelValueUnitsImageId",()=>iZ],739775),e.s(["isViewportPreScaled",()=>iQ],91076);var i$=e.i(428110);let{transformWorldToIndex:i0}=w.utilities;class i1 extends ij{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,calculateStats:!0,getTextLines:i2,statsCalculator:i$.BasicStatsCalculator}}){super(e,t),this.addNewAnnotation=e=>{let{currentPoints:t,element:n}=e.detail,i=t.world,{viewport:o}=(0,e3.getEnabledElement)(n);this.isDrawing=!0;let a=this.constructor.createAnnotationForViewport(o,{data:{handles:{points:[[...i],[...i],[...i],[...i]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}}});(0,ep.addAnnotation)(a,n);let r=nd(n,this.getToolName());return this.editData={annotation:a,viewportIdsToRender:r,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(n),iA(n),e.preventDefault(),(0,ne.default)(r),a},this.isPointNearTool=(e,t,n,i)=>{let{viewport:o}=(0,e3.getEnabledElement)(e),{data:a}=t,{points:r}=a.handles,l=o.worldToCanvas(r[0]),s=o.worldToCanvas(r[3]),d=this._getRectangleImageCoordinates([l,s]),c=[n[0],n[1]],{left:u,top:h,width:g,height:f}=d;return iX([u,h,g,f],c)<=i},this.toolSelectedCallback=(e,t)=>{let{element:n}=e.detail;t.highlighted=!0;let i=nd(n,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(n),iA(n);let{renderingEngine:o}=(0,e3.getEnabledElement)(n);(0,ne.default)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{let i,{element:o}=e.detail,{data:a}=t;t.highlighted=!0;let r=!1;n.worldPosition?r=!0:i=a.handles.points.findIndex(e=>e===n);let l=nd(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:i,movingTextBox:r},this._activateModify(o),iA(o);let{renderingEngine:s}=(0,e3.getEnabledElement)(o);(0,ne.default)(l),e.preventDefault()},this._endCallback=e=>{let{element:t}=e.detail,{annotation:n,viewportIdsToRender:i,newAnnotation:o,hasMoved:a}=this.editData,{data:r}=n;(!o||a)&&(r.handles.activeHandleIndex=null,this._deactivateModify(t),this._deactivateDraw(t),ib(t),this.doneEditMemo(),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,ep.removeAnnotation)(n.annotationUID),(0,ne.default)(i),o&&(0,tU.triggerAnnotationCompleted)(n))},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r,newAnnotation:l}=this.editData;this.createMemo(n,i,{newAnnotation:l});let{data:s}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){let{deltaPoints:e}=t,n=e.world,{points:o}=s.handles;o.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{let e,o,r,l,d,c,u,h,{currentPoints:g}=t,{worldToCanvas:f,canvasToWorld:m}=(0,e3.getEnabledElement)(n).viewport,v=g.world,{points:p}=s.handles;switch(p[a]=[...v],a){case 0:case 3:e=f(p[0]),o=[(l=f(p[3]))[0],e[1]],r=[e[0],l[1]],c=m(o),u=m(r),p[1]=c,p[2]=u;break;case 1:case 2:o=f(p[1]),e=[(r=f(p[2]))[0],o[1]],l=[o[0],r[1]],d=m(e),h=m(l),p[0]=d,p[3]=h}i.invalidated=!0}this.editData.hasMoved=!0,(0,e3.getEnabledElement)(n),(0,ne.default)(o),i.invalidated&&(0,tU.triggerAnnotationModified)(i,n,iK.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ib(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,ne.default)(n),i&&(0,tU.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{nc.state.isInteractingWithTool=!0,e.addEventListener(R.Events.MOUSE_UP,this._endCallback),e.addEventListener(R.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(R.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(R.Events.TOUCH_END,this._endCallback),e.addEventListener(R.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(R.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{nc.state.isInteractingWithTool=!1,e.removeEventListener(R.Events.MOUSE_UP,this._endCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(R.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(R.Events.TOUCH_END,this._endCallback),e.removeEventListener(R.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(R.Events.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{nc.state.isInteractingWithTool=!0,e.addEventListener(R.Events.MOUSE_UP,this._endCallback),e.addEventListener(R.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(R.Events.TOUCH_END,this._endCallback),e.addEventListener(R.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(R.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{nc.state.isInteractingWithTool=!1,e.removeEventListener(R.Events.MOUSE_UP,this._endCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(R.Events.TOUCH_END,this._endCallback),e.removeEventListener(R.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(R.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:o}=i,a=(0,ep.getAnnotations)(this.getToolName(),o);if(!(null==a?void 0:a.length)||!(null==(a=this.filterInteractableAnnotationsForElement(o,a))?void 0:a.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){let d,c=a[o],{annotationUID:u,data:h}=c,{points:g,activeHandleIndex:f}=h.handles,m=g.map(e=>i.worldToCanvas(e));s.annotationUID=u;let{color:v,lineWidth:p,lineDash:I}=this.getAnnotationStyle({annotation:c,styleSpecifier:s}),{viewPlaneNormal:E,viewUp:_}=i.getCamera();if(h.cachedStats[r]&&null!=h.cachedStats[r].areaUnit){if(c.invalidated&&(this._throttledCalculateCachedStats(c,E,_,l,e),i instanceof iR.VolumeViewport)){let{referencedImageId:e}=c.metadata;for(let t in h.cachedStats)t.startsWith("imageId")&&l.getStackViewports().find(t=>{let n=w.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=w.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n})&&delete h.cachedStats[t]}}else h.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(c,E,_,l,e);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!tB(u))continue;tf(u)||this.editData||null==f||(d=[m[f]]);let S=!!tN("showHandlesAlways",{});(d||S)&&io(t,u,"0",S?m:d,{color:v});let y="".concat(u,"-rect");ia(t,u,"0",m,{color:v,lineDash:I,lineWidth:p},y),n=!0;let T=this.getLinkedTextBoxStyle(s,c);if(!T.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}let C=this.configuration.getTextLines(h,r);if(!C||0===C.length)continue;if(!h.handles.textBox.hasMoved){let e=ip(m);h.handles.textBox.worldPosition=i.canvasToWorld(e)}let{x:b,y:A,width:x,height:D}=ig(t,u,"1",C,i.worldToCanvas(h.handles.textBox.worldPosition),m,{},T);h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([b,A]),topRight:i.canvasToWorld([b+x,A]),bottomLeft:i.canvasToWorld([b,A+D]),bottomRight:i.canvasToWorld([b+x,A+D])}}return n},this._getRectangleImageCoordinates=e=>{let[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,o)=>{if(!this.configuration.calculateStats)return;let{data:a}=e,{viewport:r}=o,{element:l}=r,s=a.handles.points[0],d=a.handles.points[3],{cachedStats:c}=a,u=Object.keys(c);for(let i=0;i<u.length;i++){let o=u[i],a=this.getTargetImageData(o);if(!a)continue;let{dimensions:l,imageData:v,metadata:p,voxelManager:I}=a,E=i0(v,s);E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]),E[2]=Math.floor(E[2]);let w=i0(v,d);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(E,w,l)){var h,g,f,m;let i;this.isHandleOutsideImage=!1;let l=Math.min(E[0],w[0]),u=Math.max(E[0],w[0]),_=Math.min(E[1],w[1]),S=Math.max(E[1],w[1]),y=[[l,u],[_,S],[Math.min(E[2],w[2]),Math.max(E[2],w[2])]],{worldWidth:T,worldHeight:C}=iI(t,n,s,d),b=[E,w],{scale:A,areaUnit:x}=(0,n7.getCalibratedLengthUnitsAndScale)(a,b),D=Math.abs(T*C)/(A*A),M={isPreScaled:iQ(r,o),isSuvScaled:this.isSuvScaled(r,o,e.metadata.referencedImageId)},O=iJ(p.Modality,e.metadata.referencedImageId,M);I&&(i=I.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:y,imageData:v,returnPoints:this.configuration.storePointData}));let P=this.configuration.statsCalculator.getStatistics();c[o]={Modality:p.Modality,area:D,mean:null==(h=P.mean)?void 0:h.value,stdDev:null==(g=P.stdDev)?void 0:g.value,max:null==(f=P.max)?void 0:f.value,min:null==(m=P.min)?void 0:m.value,statsArray:P.array,pointsInShape:i,areaUnit:x,modalityUnit:O}}else this.isHandleOutsideImage=!0,c[o]={Modality:p.Modality}}let v=e.invalidated;return e.invalidated=!1,v&&(0,tU.triggerAnnotationModified)(e,l,iK.ChangeTypes.StatsUpdated),c},this._isInsideVolume=(e,t,n)=>w.utilities.indexWithinDimensions(e,n)&&w.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,im.default)(this._calculateCachedStats,100,{trailing:!0})}}function i2(e,t){let{area:n,mean:i,max:o,stdDev:a,areaUnit:r,modalityUnit:l,min:s}=e.cachedStats[t];if(null==i)return;let d=[];return w.utilities.isNumber(n)&&d.push("Area: ".concat(w.utilities.roundNumber(n)," ").concat(r)),w.utilities.isNumber(i)&&d.push("Mean: ".concat(w.utilities.roundNumber(i)," ").concat(l)),w.utilities.isNumber(o)&&d.push("Max: ".concat(w.utilities.roundNumber(o)," ").concat(l)),w.utilities.isNumber(s)&&d.push("Min: ".concat(w.utilities.roundNumber(s)," ").concat(l)),w.utilities.isNumber(a)&&d.push("Std Dev: ".concat(w.utilities.roundNumber(a)," ").concat(l)),d}i1.toolName="RectangleROI",i1.hydrate=(e,t,n)=>{let i=(0,D.getEnabledElementByViewportId)(e);if(!i)return;let{FrameOfReferenceUID:o,referencedImageId:a,viewPlaneNormal:r,instance:l,viewport:s}=i1.hydrateBase(i1,i,t,n),{toolInstance:d,...c}=n||{},u={annotationUID:(null==n?void 0:n.annotationUID)||w.utilities.uuidv4(),data:{handles:{points:t,activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:l.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:o,referencedImageId:a,...c}};(0,ep.addAnnotation)(u,s.element),(0,ne.default)([s.id])};let i3=i1,{EPSILON:i5}=iL.CONSTANTS,i4=1-i5;function i8(e,t){let{viewPlaneNormal:n}=t,i=e.filter(e=>{let t=e.metadata.viewPlaneNormal;if(!t){let{referencedImageId:n}=e.metadata,{imageOrientationPatient:i}=A.metaData.get("imagePlaneModule",n),o=eA.vec3.fromValues(i[0],i[1],i[2]),a=eA.vec3.fromValues(i[3],i[4],i[5]);t=eA.vec3.create(),eA.vec3.cross(t,o,a),e.metadata.viewPlaneNormal=t}let i=Math.abs(eA.vec3.dot(n,t))>i4;return t&&i});return i.length?i:[]}let{transformWorldToIndex:i6}=w.utilities;class i7 extends i3{_computeProjectionPoints(e,t){let{data:n,metadata:i}=e,{viewPlaneNormal:o,spacingInNormal:a}=i,{imageData:r}=t,{startCoordinate:l,endCoordinate:s}=n,{points:d}=n.handles,c=i6(r,d[0]),u=i6(r,d[0]),h=eA.vec3.create();r.indexToWorldVec3(c,h);let g=eA.vec3.create();r.indexToWorldVec3(u,g);let f=this._getIndexOfCoordinatesForViewplaneNormal(o);2==f?(h[2]=l,g[2]=s):0==f?(h[0]=l,g[0]=s):1==f&&(h[1]=l,g[1]=s);let m=eA.vec3.create();eA.vec3.subtract(m,g,h);let v=eA.vec3.length(m);eA.vec3.normalize(m,m);let p=[];for(let e=0;e<v;e+=a)p.push(d.map(t=>{let n=eA.vec3.create();return eA.vec3.scaleAndAdd(n,t,m,e),Array.from(n)}));n.cachedStats.projectionPoints=p}_computePointsInsideVolume(e,t,n,i){var o,a,r;let{data:l,metadata:s}=e,{viewPlaneNormal:d,viewUp:c}=s,{viewport:u}=i,h=l.cachedStats.projectionPoints,g=[[]],f=this.getTargetImageData(t),m=l.handles.points[0],v=l.handles.points[3],{worldWidth:p,worldHeight:I}=iI(d,c,m,v),E=(0,n7.getCalibratedLengthUnitsAndScale)(f,l.habdles),w=Math.abs(p*I)/(E.scale*E.scale),_={isPreScaled:iQ(u,t),isSuvScaled:this.isSuvScaled(u,t,e.metadata.referencedImageId)},S=iJ(s.Modality,e.metadata.referencedImageId,_);for(let e=0;e<h.length;e++){if(!n)continue;let t=h[e][0],{dimensions:i,imageData:o,voxelManager:a}=n,r=i6(o,m),l=i6(o,t),s=this._getIndexOfCoordinatesForViewplaneNormal(d);r[0]=Math.floor(r[0]),r[1]=Math.floor(r[1]),r[2]=Math.floor(r[2]),r[s]=l[s];let c=i6(o,v);if(c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(c[2]),c[s]=l[s],this._isInsideVolume(r,c,i)){this.isHandleOutsideImage=!1;let e=Math.min(r[0],c[0]),t=Math.max(r[0],c[0]),n=Math.min(r[1],c[1]),i=Math.max(r[1],c[1]),l=[[e,t],[n,i],[Math.min(r[2],c[2]),Math.max(r[2],c[2])]],s=a.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:l,imageData:o,returnPoints:this.configuration.storePointData});g.push(s)}}let y=this.configuration.statsCalculator.getStatistics();l.cachedStats.pointsInVolume=g,l.cachedStats.statistics={Modality:s.Modality,area:w,mean:null==(o=y.mean)?void 0:o.value,stdDev:null==(a=y.stdDev)?void 0:a.value,max:null==(r=y.max)?void 0:r.value,statsArray:y.array,areaUnit:E.areaUnit,modalityUnit:S}}_calculateCachedStatsTool(e,t){let n=e.data,{viewport:i}=t,{cachedStats:o}=n,a=this.getTargetId(i),r=I.cache.getVolume(a.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,r),this._computePointsInsideVolume(e,a,r,t),e.invalidated=!1,(0,tU.triggerAnnotationModified)(e,i.element),o}_getStartCoordinate(e,t){return this._getCoordinateForViewplaneNormal(e,t)}_getEndCoordinate(e,t,n){let i=this.configuration.numSlicesToPropagate,o=eA.vec3.create();return eA.vec3.scaleAndAdd(o,e,n,i*t),this._getCoordinateForViewplaneNormal(o,n)}_getIndexOfCoordinatesForViewplaneNormal(e){let t=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];return t.indexOf(Math.max(...t))}_getCoordinateForViewplaneNormal(e,t){return e[this._getIndexOfCoordinatesForViewplaneNormal(t)]}constructor(e={},t={configuration:{storePointData:!1,numSlicesToPropagate:10,calculatePointsInsideVolume:!0,getTextLines:i9,statsCalculator:i$.BasicStatsCalculator,showTextBox:!1,throttleTimeout:100}}){super(e,t),this.addNewAnnotation=e=>{let t,n,i,{currentPoints:o,element:a}=e.detail,r=o.world,l=(0,e3.getEnabledElement)(a),{viewport:s,renderingEngine:d}=l;this.isDrawing=!0;let{viewPlaneNormal:c,viewUp:u}=s.getCamera();if(s instanceof e0.StackViewport)throw Error("Stack Viewport Not implemented");{let e=this.getTargetId(s);i=w.utilities.getVolumeId(e),n=I.cache.getVolume(i),t=w.utilities.getClosestImageId(n,r,c)}let h=w.utilities.getSpacingInNormalDirection(n,c),g=this._getStartCoordinate(r,c),f=this._getEndCoordinate(r,h,c),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...c],enabledElement:l,viewUp:[...u],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:t,toolName:this.getToolName(),volumeId:i,spacingInNormal:h},data:{label:"",startCoordinate:g,endCoordinate:f,cachedStats:{pointsInVolume:[],projectionPoints:[],projectionPointsImageIds:[t],statistics:[]},handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...r],[...r],[...r],[...r]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(m,n),(0,ep.addAnnotation)(m,a);let v=nd(a,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),iA(a),e.preventDefault(),(0,ne.default)(v),m},this._endCallback=e=>{let{element:t}=e.detail,{annotation:n,viewportIdsToRender:i,newAnnotation:o,hasMoved:a}=this.editData,{data:r}=n;if(o&&!a)return;r.handles.activeHandleIndex=null,this._deactivateModify(t),this._deactivateDraw(t),ib(t);let{metadata:l}=n,{enabledElement:s}=l;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,ep.removeAnnotation)(n.annotationUID);let d=this.getTargetId(s.viewport),c=I.cache.getVolume(d.split(/volumeId:|\?/)[1]);this._computePointsInsideVolume(n,d,c,s),(0,ne.default)(i),o?(0,tU.triggerAnnotationCompleted)(n):(0,tU.triggerAnnotationModified)(n,t)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,o=(0,ep.getAnnotations)(this.getToolName(),i.element);if(!(null==o?void 0:o.length))return n;o=i8(o,i.getCamera());let a={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){var r;let l,s=o[e],{annotationUID:d,data:c,metadata:u}=s,{startCoordinate:h,endCoordinate:g}=c,{points:f,activeHandleIndex:m}=c.handles,{enabledElement:v}=u,p=f.map(e=>i.worldToCanvas(e));a.annotationUID=d;let I=this.getStyle("lineWidth",a,s),E=this.getStyle("lineDash",a,s),_=this.getStyle("color",a,s),S=i.getCamera().focalPoint,y=i.getCamera().viewPlaneNormal,T=h,C=g;if(Array.isArray(h)){T=this._getCoordinateForViewplaneNormal(T,y);let e=this._getIndexOfCoordinatesForViewplaneNormal(y);c.handles.points.forEach(t=>{t[e]=T}),c.startCoordinate=T}Array.isArray(g)&&(c.endCoordinate=C=this._getCoordinateForViewplaneNormal(C,y),c.endCoordinate=C);let b=w.utilities.roundToPrecision(T),A=w.utilities.roundToPrecision(C),x=this._getCoordinateForViewplaneNormal(S,y),D=w.utilities.roundToPrecision(x);if(D<Math.min(b,A)||D>Math.max(b,A))continue;for(let e of null==(r=v.viewport)?void 0:r.volumeIds.values())s.invalidated&&s.metadata.volumeId===e&&this._throttledCalculateCachedStats(s,v);let M=!1;if((D===b||D===A)&&(M=!0),!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!tB(d))continue;tf(d)||this.editData||null===m||!M||(l=[p[m]]),l&&io(t,d,"0",l,{color:_});let O=E;if(M||(O=2),ir(t,d,"0",p[0],p[3],{color:_,lineDash:O,lineWidth:I}),n=!0,this.configuration.showTextBox){let e=this.getLinkedTextBoxStyle(a,s);if(!e.visibility){c.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}let n=this.configuration.getTextLines(c,{metadata:u});if(!n||0===n.length)continue;if(!c.handles.textBox.hasMoved){let e=ip(p);c.handles.textBox.worldPosition=i.canvasToWorld(e)}let{x:o,y:r,width:l,height:h}=ig(t,d,"1",n,i.worldToCanvas(c.handles.textBox.worldPosition),p,{},e);c.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([o,r]),topRight:i.canvasToWorld([o+l,r]),bottomLeft:i.canvasToWorld([o,r+h]),bottomRight:i.canvasToWorld([o+l,r+h])}}}return n},this.configuration.calculatePointsInsideVolume?this._throttledCalculateCachedStats=(0,im.default)(this._calculateCachedStatsTool,this.configuration.throttleTimeout,{trailing:!0}):this._throttledCalculateCachedStats=(0,iv.default)(this._calculateCachedStatsTool,this.configuration.throttleTimeout)}}function i9(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];let{area:t,mean:n,max:i,stdDev:o,areaUnit:a,modalityUnit:r}=e.cachedStats.statistics;if(void 0===n)return;let l=[];return l.push("Area: ".concat(w.utilities.roundNumber(t)," ").concat(a)),l.push("Mean: ".concat(w.utilities.roundNumber(n)," ").concat(r)),l.push("Max: ".concat(w.utilities.roundNumber(i)," ").concat(r)),l.push("Std Dev: ".concat(w.utilities.roundNumber(o)," ").concat(r)),l}i7.toolName="RectangleROIStartEndThreshold";class oe extends i3{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{let t,n,{currentPoints:i,element:o}=e.detail,a=i.world,r=(0,e3.getEnabledElement)(o),{viewport:l,renderingEngine:s}=r;this.isDrawing=!0;let{viewPlaneNormal:d,viewUp:c}=l.getCamera(),u=this.getTargetId(l);if(l instanceof e0.StackViewport)t=u.split("imageId:")[1];else{n=w.utilities.getVolumeId(u);let e=I.cache.getVolume(n);t=w.utilities.getClosestImageId(e,a,d)}let h={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:r,viewUp:[...c],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:t,toolName:this.getToolName(),volumeId:n},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},segmentationId:null}};(0,ep.addAnnotation)(h,o);let g=nd(o,this.getToolName());return this.editData={annotation:h,viewportIdsToRender:g,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),iA(o),e.preventDefault(),(0,ne.default)(g),h},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:o}=i,a=(0,ep.getAnnotations)(this.getToolName(),o);if(!(null==a?void 0:a.length)||!(null==(a=this.filterInteractableAnnotationsForElement(o,a))?void 0:a.length))return n;let r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){let l,s=a[e],{annotationUID:d,data:c}=s,{points:u,activeHandleIndex:h}=c.handles,g=u.map(e=>i.worldToCanvas(e));r.annotationUID=d;let f=this.getStyle("lineWidth",r,s),m=this.getStyle("lineDash",r,s),v=this.getStyle("color",r,s);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}(0,tU.triggerAnnotationModified)(s,o),tB(d)&&(tf(d)||this.editData||null===h||(l=[g[h]]),l&&io(t,d,"0",l,{color:v}),ir(t,d,"0",g[0],g[3],{color:v,lineDash:m,lineWidth:f}),n=!0)}return n}}}oe.toolName="RectangleROIThreshold";let ot=function(e,t){let n=e.findIndex(e=>{let[t,n]=e;return t===n});if(-1===n)throw Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e},on=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=[];return(e.forEach(e=>{var o,a;let{data:r}=e,{points:l}=r.handles,{imageData:s,dimensions:d}=t,c=l;if(null==(o=r.cachedStats)?void 0:o.projectionPoints){let{projectionPoints:e}=r.cachedStats;c=[].concat(...e)}let u=c.map(e=>w.utilities.transformWorldToIndex(s,e)),h=(0,nQ.getBoundingBoxAroundShapeIJK)(u,d);!n.numSlicesToProject||(null==(a=r.cachedStats)?void 0:a.projectionPoints)||(h=ot(h,n.numSlicesToProject)),i.push(h)}),1===i.length)?i[0]:i.reduce((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)}),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})},oi=function(e,t,n,i){let o,a=e.map(e=>tZ.getAnnotation(e));var r=a;let l=[oe.toolName,i7.toolName];for(let e of r){let t=e.metadata.toolName;if(!l.includes(t))throw Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}for(let e=0;e<n.length;e++)(n[e].volume.voxelManager.getScalarDataLength()===t.voxelManager.getScalarDataLength()||0===e)&&(o=on(a,n[e].volume,i));let s=n6(t,n,{...i,boundsIJK:o,segmentationId:i.segmentationId});return s.modified(),s},oo=function(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"mergedLabelmap";e.forEach(t=>{let{direction:n,dimensions:i,origin:o,spacing:a}=t;if(!w.utilities.isEqual(i,e[0].dimensions)||!w.utilities.isEqual(n,e[0].direction)||!w.utilities.isEqual(a,e[0].spacing)||!w.utilities.isEqual(o,e[0].origin))throw Error("labelmaps must have the same size and shape")});let o=e[0],a=new(o.voxelManager.getConstructor())(o.voxelManager.getScalarDataLength());e.forEach(e=>{let t=e.voxelManager,i=t.getScalarDataLength();for(let e=0;e<i;e++)t.getAtIndex(e)===n&&(a[e]=n)});let r={scalarData:a,metadata:o.metadata,spacing:o.spacing,origin:o.origin,direction:o.direction,dimensions:o.dimensions},l=I.cache.getVolume(i);return l?(t=l).voxelManager.setCompleteScalarDataArray(a):t=M.volumeLoader.createLocalVolume(i,r),t};async function oa(e){let{viewportId:t,renderingEngineId:n,options:i}=e,{segmentationId:o}=e,a=(0,D.getEnabledElementByIds)(t,n);if(!a)throw Error("element disabled");let{viewport:r}=a;if(!(r instanceof iR.VolumeViewport))throw Error("Segmentation only supports VolumeViewport");let{uid:l}=r.getDefaultActor();if(void 0===o){var s;o="".concat(l,"-based-segmentation-").concat(null!=(s=null==i?void 0:i.volumeId)?s:w.utilities.uuidv4().slice(0,8))}if(i){let e=structuredClone(i);await M.volumeLoader.createLocalVolume(o,e)}else{let e=r.getVolumeId();M.volumeLoader.createAndCacheDerivedLabelmapVolume(e,{volumeId:o})}return o}e.s(["triggerSegmentationRender",()=>rh,"triggerSegmentationRenderBySegmentationId",()=>rg],665034);var or=e.i(23529),O=_;function ol(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return q.getSegmentationRepresentations(e,t)}function os(e,t){if(!t.segmentationId||!t.type)throw Error("getSegmentationRepresentation: No segmentationId or type provided, you need to provide at least one of them");let n=q.getSegmentationRepresentations(e,t);return null==n?void 0:n[0]}e.s(["getSegmentationRepresentation",()=>os,"getSegmentationRepresentations",()=>ol],16297);let od=function(e,t){let{viewport:n}=(0,e3.getEnabledElement)(e),i=n.getActors().filter(e=>e.representationUID&&"string"==typeof e.representationUID&&e.representationUID.startsWith(t));n.removeActors(i.map(e=>e.uid))};var oc=e.i(334491),ou=e.i(885570),oh=e.i(833485),og=e.i(667183);let of=function(e,t,n){let i,o=$(e.id,n,t.segmentIndex),a=null==o?void 0:o.actor,r=t.visible;if(a){if(a.setVisibility(r),!r)return;let n=a.getMapper(),i=n.getInputData(),o=t.points,l=t.polys,s=i.getPoints().getData(),d=i.getPolys().getData();if(o.length===s.length&&l.length===d.length)return;let c=oh.default.newInstance();c.getPoints().setData(o,3);let u=og.default.newInstance({values:Float32Array.from(l)});c.setPolys(u),n.setInputData(c),n.modified(),e.getRenderer().resetCameraClippingRange();return}let l=t.points,s=t.polys,d=t.color,c=oh.default.newInstance();c.getPoints().setData(l,3);let u=og.default.newInstance({values:Float32Array.from(s)});c.setPolys(u);let h=oc.default.newInstance({});h.setInputData(c);let g=ou.default.newInstance();g.setMapper(h),g.getProperty().setColor(d[0]/255,d[1]/255,d[2]/255),g.getProperty().setLineWidth(2);let f=ee(n,t.segmentIndex);e.addActor({uid:w.utilities.uuidv4(),actor:g,clippingFilter:i,representationUID:f}),e.resetCamera(),e.getRenderer().resetCameraClippingRange(),e.render()};function om(e){return q.getColorLUT(e)}var ov=e.i(340354);let op=function(e){let{segmentationId:t,type:n,data:i}=e,o=H(t);if(!o)throw Error("Segmentation ".concat(t," not found"));switch(o.representationData[n]&&console.warn("Representation data of type ".concat(n," already exists for segmentation ").concat(t,", overwriting it.")),n){case _.default.Labelmap:case _.default.Contour:case _.default.Surface:i&&(o.representationData[n]=i);break;default:throw Error("Invalid representation type ".concat(n))}},oI=new Map;async function oE(e,t,n,i,o){var a;let r=await n();op({segmentationId:e,type:t,data:r}),null==o||o(),oI.has(e)||oI.set(e,[]);let l=oI.get(e);return l.includes(t)||l.push(t),(a=i)._debouncedUpdateFunction=e=>{ow(e,a)},T.eventTarget.removeEventListener(R.Events.SEGMENTATION_DATA_MODIFIED,a._debouncedUpdateFunction),T.eventTarget.addEventListener(R.Events.SEGMENTATION_DATA_MODIFIED,a._debouncedUpdateFunction),L(e),r}let ow=(0,iv.default)((e,t)=>{let n=e.detail.segmentationId,i=oI.get(n);i&&i.length&&(t(n),i.length&&L(n))},300);function o_(e,t){let n=os(e,t);return n?Object.entries(n.segments).reduce((e,t)=>{let[n,i]=t;return i.visible||e.add(Number(n)),e},new Set):new Set}async function oS(e,t){var n;let{segmentationId:i,type:o}=t,a=H(i);if(!a)return;let r=a.representationData[_.default.Surface];if(!r&&(null==(n=(0,ov.getPolySeg)())?void 0:n.canComputeRequestedRepresentation(i,_.default.Surface))){let t=(0,ov.getPolySeg)();if(!(r=await oE(i,_.default.Surface,()=>t.computeSurfaceData(i,{viewport:e}),()=>t.updateSurfaceData(i,{viewport:e}))))throw Error("No Surface data found for segmentationId ".concat(i," even we tried to compute it"))}else r||(0,ov.getPolySeg)()||console.debug("No surface data found for segmentationId ".concat(i," and PolySeg add-on is not configured. Unable to convert from other representations to surface. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion."));if(!r)return void console.warn("No Surface data found for segmentationId ".concat(i,". Skipping render."));let{geometryIds:l}=r;(null==l?void 0:l.size)||console.warn("No Surfaces found for segmentationId ".concat(i,". Skipping render."));let{colorLUTIndex:s}=t,d=om(s),c=[];l.forEach(t=>{let n=I.cache.getGeometry(t);if(!(null==n?void 0:n.data))return void console.warn("No Surfaces found for geometryId ".concat(t,". Skipping render."));let{segmentIndex:a}=n.data,r=o_(e.id,{segmentationId:i,type:o}).has(a),l=n.data;l.color=d[a].slice(0,3),l.visible=!r,c.push(l),of(e,l,i)}),e.render()}var oy=e.i(761684);e.i(222828);let oT=function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];let{annotationUIDsMap:n}=H(t).representationData.Contour;n.forEach(e=>{e.forEach(e=>{(0,ep.removeAnnotation)(e)})})};var O=_;function oC(e){let t,n=n5(e);if(n)return n;let i=H(e);if(!i)throw Error("No segmentation found for segmentationId ".concat(e));if(i.representationData.Labelmap)t=function(e,t){var n,i,o;let a=e.representationData[O.default.Labelmap],r=new Set;return a.imageIds?(n=r,a.imageIds.forEach(e=>{I.cache.getImage(e).voxelManager.getScalarData().forEach(e=>{0!==e&&n.add(e)})})):(i=r,o=t,I.cache.getVolume(o).voxelManager.forEach(e=>{let{value:t}=e;0!==t&&i.add(t)})),Array.from(r).map(Number).sort((e,t)=>e-t)}(i,e);else if(i.representationData.Contour)t=function(e){let{annotationUIDsMap:t,geometryIds:n}=e.representationData.Contour||{};if(!n)throw Error("No geometryIds found for segmentationId ".concat(e.segmentationId));let i=new Set([...t.keys()]);return n.forEach(e=>{let t=I.cache.getGeometry(e);i.add(t.data.segmentIndex)}),Array.from(i).sort((e,t)=>e-t)}(i);else if(i.representationData.Surface){var o,a;t=Array.from((null!=(a=null==(o=i.representationData.Surface)?void 0:o.geometryIds)?a:[]).keys()).map(Number).sort((e,t)=>e-t)}else throw Error("Unsupported segmentation type: ".concat(i.representationData));return n4(e,t),t}let ob=new Map,oA=new Map;async function ox(e,t){var n,i,o,a;let{segmentationId:r}=t,l=H(r);if(!l)return;let s=l.representationData[_.default.Contour],d=(0,ov.getPolySeg)();if(!s&&(null==(n=(0,ov.getPolySeg)())?void 0:n.canComputeRequestedRepresentation(r,_.default.Contour))&&!ob.get(e.id)?(ob.set(e.id,!0),s=await oE(r,_.default.Contour,()=>d.computeContourData(r,{viewport:e}),()=>void 0),ob.set(e.id,!1)):s||(0,ov.getPolySeg)()||console.debug("No contour data found for segmentationId ".concat(r," and PolySeg add-on is not configured. Unable to convert from other representations to contour. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion.")),!s||!(null==(i=s.geometryIds)?void 0:i.length))return;let c=!1,u=e.getCamera().viewPlaneNormal;s.annotationUIDsMap&&(c=!function(e,t){let n=Array.from(e.values()).flat().map(e=>Array.from(e)).flat();for(let e of w.utilities.getRandomSampleFromArray(n,3)){let n=(0,ep.getAnnotation)(e);if(null==n?void 0:n.metadata){if(!n.metadata.viewPlaneNormal)continue;let e=n.metadata.viewPlaneNormal;if(Math.abs(Math.abs(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])-1)>.01)return!1}}return!0}(s.annotationUIDsMap,u)),s.geometryIds.length>0&&(c=!function(e,t){let n=null,i=null;for(let t of e){var o,a,r;let e=I.cache.getGeometry(t);if(!e)continue;let l=e.data;if((null==(r=l.contours)||null==(a=r[0])||null==(o=a.points)?void 0:o.length)>=3){n=e,i=l;break}}if(!n||!i)return!1;let l=i.contours[0].points,s=l[0],d=l[1],c=l[2],u=eA.vec3.cross(eA.vec3.create(),eA.vec3.sub(eA.vec3.create(),d,s),eA.vec3.sub(eA.vec3.create(),c,s));return u=eA.vec3.normalize(eA.vec3.create(),u),Math.abs(eA.vec3.dot(u,t))>.9}(s.geometryIds,u));let h=oA.get(e.id)||new Set;if(c&&!ob.get(e.id)&&!h.has(r)&&e.viewportStatus===C.Enums.ViewportStatus.RENDERED){ob.set(e.id,!0);let t=oC(r),n=(await d.computeSurfaceData(r,{segmentIndices:t,viewport:e})).geometryIds,i=[];for(let e of n.values()){let t=I.cache.getGeometry(e).data;i.push({points:t.points,polys:t.polys,segmentIndex:t.segmentIndex,id:t.segmentIndex})}let o=await d.clipAndCacheSurfacesForViewport(i,e),a=d.extractContourData(o),l=d.createAndAddContourSegmentationsFromClippedSurfaces(a,e,r);s.annotationUIDsMap=new Map([...s.annotationUIDsMap,...l]),h.add(r),oA.set(e.id,h),ob.set(e.id,!1)}o=s.geometryIds,a=s.annotationUIDsMap,a.size?e.render():function(e,t,n){let{segmentationId:i}=n,o=new Map;t.forEach(t=>{let n=I.cache.getGeometry(t);if(!n)return void console.warn("No geometry found for geometryId ".concat(t,". Skipping render."));let a=n.data.segmentIndex;var r=n;if(!r)throw Error("No contours found for geometryId ".concat(r.id));let l=r.id;if(r.type!==C.Enums.GeometryType.CONTOUR)throw Error("Geometry type ".concat(r.type," not supported for rendering."));r.data||console.warn("No contours found for geometryId ".concat(l,". Skipping render."));let s=B.getStyle({viewportId:e.id,segmentationId:i,type:O.default.Contour,segmentIndex:a}),d=n.data,c=e.getCamera().viewPlaneNormal;d.contours.forEach(t=>{let{points:n,color:o,id:r}=t,l=(0,oy.getClosestImageIdForStackViewport)(e,n[0],c),s={annotationUID:w.utilities.uuidv4(),data:{contour:{closed:!0,polyline:n},segmentation:{segmentationId:i,segmentIndex:a,color:o,id:r},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!0,isVisible:!0,metadata:{referencedImageId:l,toolName:"PlanarFreehandContourSegmentationTool",FrameOfReferenceUID:e.getFrameOfReferenceUID(),viewPlaneNormal:e.getCamera().viewPlaneNormal}},d=e.element;(0,ep.addAnnotation)(s,d),t7(s)}),s&&o.set(a,s)}),e.render()}(e,o,t)}var oD=e.i(854888);async function oM(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];for(let t of n){let n=e.getViewport(t);if(!n)throw Error("Viewport with Id ".concat(t," does not exist"));if(!(n instanceof oD.default))return void console.warn("Viewport with Id ".concat(t," is not a BaseVolumeViewport. Cannot add volume to this viewport."))}let a=n.map(async n=>{let a=e.getViewport(n);await a.addVolumes(t,i,o)});await Promise.all(a)}let oO=function(e,t,n){for(let t of n){let n=e.getViewport(t);if(!n)throw Error("Viewport with Id ".concat(t," does not exist"));if(!n.addImages)return void console.warn("Viewport with Id ".concat(t," does not have addImages. Cannot add image segmentation to this viewport."))}n.forEach(n=>{e.getViewport(n).addImages(t)})};var O=_,oP=e.i(859736),oN=e.i(675396),oN=oN,O=_;let oR=new Map,oL=e=>{let{cfun:t,ofun:n,actor:i}=e;i.getProperty().setRGBTransferFunction(1,t),i.getProperty().setScalarOpacity(1,n)};async function oU(e){var t;let{viewport:n,volumeInputs:i,segmentationId:o}=e,a=n.getDefaultActor(),{actor:r}=a,{uid:l,callback:s}=a,d=n.getVolumeId();if(null==(t=oR.get(l))?void 0:t.added)return{uid:l,actor:r};let c=I.cache.getVolume(i[0].volumeId);if(!c)throw Error("imageVolume with id: ".concat(c.volumeId," does not exist"));let{volumeId:u}=i[0],h=await M.volumeLoader.loadVolume(u);if(!h)throw Error("segImageVolume with id: ".concat(h.volumeId," does not exist"));let g=h.voxelManager.getCompleteScalarDataArray(),{imageData:f}=h,m=I.cache.getVolume(d),v=m.voxelManager.getCompleteScalarDataArray(),p=new Float32Array(2*m.voxelManager.getScalarDataLength()),E=f.getDimensions();for(let e=0;e<E[2];++e)for(let t=0;t<E[1];++t)for(let n=0;n<E[0];++n){let i=n+E[0]*(t+E[1]*e);p[2*i+0]=v[i],p[2*i+1]=g[i]}n.removeActors([l]);let w=r.getMapper(),_=(0,oP.convertMapperToNotSharedMapper)(w);r.setMapper(_),_.setBlendMode(C.Enums.BlendModes.LABELMAP_EDGE_PROJECTION_BLEND);let S=_.getInputData().getPointData().getArray(0);function y(e){let{segmentationId:t}=e.detail,{representationData:i}=H(t),{volumeId:o}=i.Labelmap;if(o!==h.volumeId)return;let a=I.cache.getVolume(o).voxelManager,r=_.getInputData(),l=r.getPointData().getArray(0),s=l.getData(),d=f.getDimensions();for(let e of Array.from({length:d[2]},(e,t)=>t))for(let t=0;t<d[1];++t)for(let n=0;n<d[0];++n){let i=n+d[0]*(t+d[1]*e);s[2*i+1]=a.getAtIndex(i)}l.setData(s),r.modified(),n.render()}return S.setData(p),S.setNumberOfComponents(2),r.getProperty().setColorMixPreset(1),r.getProperty().setForceNearestInterpolation(1,!0),r.getProperty().setIndependentComponents(!0),n.addActor({actor:r,uid:l,callback:s,referencedId:d,representationUID:"".concat(o,"-").concat(O.default.Labelmap)}),oR.set(l,{added:!0,segmentationRepresentationUID:"".concat(o),originalBlendMode:n.getBlendMode()}),r.set({preLoad:oL}),T.eventTarget.addEventListenerDebounced(R.Events.SEGMENTATION_DATA_MODIFIED,y,200),T.eventTarget.addEventListener(R.Events.SEGMENTATION_REPRESENTATION_REMOVED,async e=>{T.eventTarget.removeEventListener(R.Events.SEGMENTATION_DATA_MODIFIED,y);let t=n.getActor(l),{element:i,id:o}=n;n.removeActors([l]);let a=await (0,oN.default)({volumeId:l,blendMode:C.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,callback:e=>{let{volumeActor:n}=e;t.callback&&t.callback({volumeActor:n,volumeId:u})}},i,o);n.addActor({actor:a,uid:l}),n.render()}),{uid:l,actor:r}}let{uuidv4:ok}=w.utilities;async function oV(e,t,n,i){let{renderingEngine:o,viewport:a}=(0,e3.getEnabledElement)(e),{id:r}=a;if(a instanceof x.BaseVolumeViewport){var l;let e=function(e,t){let{volumeId:n}=e;if(!n){n=ok();let i=H(t);i.representationData.Labelmap={...i.representationData.Labelmap,volumeId:n},e.volumeId=n,L(t)}return n}(t,n);I.cache.getVolume(e)||await oF(t);let s=null!=(l=null==i?void 0:i.blendMode)?l:C.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,d=s===C.Enums.BlendModes.LABELMAP_EDGE_PROJECTION_BLEND;if(d){let t=a.getVolumeId(),n=I.cache.getVolume(t),i=I.cache.getVolume(e).dimensions,o=n.dimensions;(i[0]!==o[0]||i[1]!==o[1]||i[2]!==o[2])&&(d=!1,s=C.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,console.debug("Dimensions mismatch - falling back to regular volume addition"))}let c=[{volumeId:e,visibility:!0,representationUID:"".concat(n,"-").concat(O.default.Labelmap),useIndependentComponents:d,blendMode:s}];if(c[0].useIndependentComponents)return await oU({viewport:a,volumeInputs:c,segmentationId:n});await oM(o,c,[r],!1,!0)}else oO(o,Y(a.id,n).map(e=>({imageId:e,representationUID:"".concat(n,"-").concat(O.default.Labelmap,"-").concat(e)})),[r]);n8(n)}async function oF(e){if(!(e.imageIds.length>0))throw Error("cannot create labelmap, no imageIds found for the volume labelmap");return await M.volumeLoader.createAndCacheVolumeFromImages(e.volumeId||ok(),e.imageIds)}let oB=function(e,t){let{viewport:n}=(0,e3.getEnabledElement)(e);n.removeActors([Z(n.id,t)])};function oG(e){return q.getActiveSegmentation(e)}let oW=new Map,oz=!1;async function oq(e,t){var n;let{segmentationId:i,config:o}=t,a=H(i);if(!a)return void console.warn("No segmentation found for segmentationId: ",i);let r=a.representationData[_.default.Labelmap],l=J(e.id,i);if(!r&&(null==(n=(0,ov.getPolySeg)())?void 0:n.canComputeRequestedRepresentation(i,_.default.Labelmap))&&!oz){oz=!0;let t=(0,ov.getPolySeg)();if(!(r=await oE(i,_.default.Labelmap,()=>t.computeLabelmapData(i,{viewport:e}),()=>null,()=>{q.processLabelmapRepresentationAddition(e.id,i),setTimeout(()=>{n8(i)},0)})))throw Error("No labelmap data found for segmentationId ".concat(i,"."));oz=!1}else r||(0,ov.getPolySeg)()||console.debug("No labelmap data found for segmentationId ".concat(i," and PolySeg add-on is not configured. Unable to convert from other representations to labelmap. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion."));if(r){if(e instanceof iR.VolumeViewport)(null==l?void 0:l.length)||await oj(e,r,i,o),l=J(e.id,i);else{let t=Y(e.id,i);if(!(null==t?void 0:t.length))return;l||await oj(e,r,i,o),l=J(e.id,i)}if(null==l?void 0:l.length)for(let n of l)!function(e,t,n){var i;let{segmentationId:o}=n,{cfun:a,ofun:r}=n.config,{colorLUTIndex:l}=n,s=oG(e),d=(null==s?void 0:s.segmentationId)===o,c=B.getStyle({viewportId:e,type:_.default.Labelmap,segmentationId:o}),u=B.getRenderInactiveSegmentations(e),h=om(l),g=Math.min(256,h.length),{outlineWidth:f,renderOutline:m,outlineOpacity:v,activeSegmentOutlineWidthDelta:p}=oH(c,d),I=o_(e,{segmentationId:o,type:_.default.Labelmap});for(let t=0;t<g;t++){let n=t,i=h[n],{fillAlpha:l,outlineWidth:s,renderFill:u,renderOutline:g}=oH(c,d,B.getStyle({viewportId:e,type:_.default.Labelmap,segmentationId:o,segmentIndex:n})),{forceOpacityUpdate:f,forceColorUpdate:m}=function(e,t,n,i){let{fillAlpha:o,renderFill:a,renderOutline:r,segmentColor:l,outlineWidth:s,segmentsHidden:d,cfun:c,ofun:u}=i,h="".concat(e,"-").concat(t,"-").concat(n),g=oW.get(h);if(!g)return oW.set(h,{fillAlpha:o,renderFill:a,renderOutline:r,outlineWidth:s,segmentColor:l.slice(),segmentsHidden:new Set(d),cfunMTime:c.getMTime(),ofunMTime:u.getMTime()}),{forceOpacityUpdate:!0,forceColorUpdate:!0};let{fillAlpha:f,renderFill:m,renderOutline:v,outlineWidth:p,segmentColor:I,segmentsHidden:E,cfunMTime:w,ofunMTime:_}=g,S=I[0]!==l[0]||I[1]!==l[1]||I[2]!==l[2],y=I[3]!==l[3]||f!==o||m!==a||v!==r||p!==s||E!==d;return(y||S)&&oW.set(h,{fillAlpha:o,renderFill:a,renderOutline:r,outlineWidth:s,segmentColor:l.slice(),segmentsHidden:new Set(d),cfunMTime:c.getMTime(),ofunMTime:u.getMTime()}),{forceOpacityUpdate:y,forceColorUpdate:S}}(e,o,n,{fillAlpha:l,renderFill:u,renderOutline:g,segmentColor:i,outlineWidth:s,segmentsHidden:I,cfun:a,ofun:r});if(m&&a.addRGBPoint(n,i[0]/255,i[1]/255,i[2]/255),f)if(u){let e=I.has(n)?0:i[3]/255*l;r.removePoint(n),r.addPointLong(n,e,.5,1)}else r.addPointLong(n,.01,.5,1)}r.setClamping(!1);let E=t.actor,{preLoad:w}=(null==(i=E.get)?void 0:i.call(E,"preLoad"))||{preLoad:null};if(w?w({cfun:a,ofun:r,actor:E}):(E.getProperty().setRGBTransferFunction(0,a),E.getProperty().setScalarOpacity(0,r),E.getProperty().setInterpolationTypeToNearest()),m){E.getProperty().setUseLabelOutline(m),E.getProperty().setLabelOutlineOpacity(v);let e=j(n.segmentationId),t=Array(g-1);for(let n=1;n<g;n++){if(I.has(n)){t[n-1]=0;continue}t[n-1]=n===e?f+p:f}E.getProperty().setLabelOutlineThickness(t),E.modified(),E.getProperty().modified(),E.getMapper().modified()}else E.getProperty().setLabelOutlineThickness(Array(g-1).fill(0));let S=d||u;E.setVisibility(S)}(e.id,n,t)}}function oH(e,t,n){let i={...e,...n||{}},o=t?i.fillAlpha:i.fillAlphaInactive,a=t?i.outlineWidth:i.outlineWidthInactive,r=t?i.renderFill:i.renderFillInactive,l=t?i.renderOutline:i.renderOutlineInactive;return{fillAlpha:o,outlineWidth:a,renderFill:r,renderOutline:l,outlineOpacity:t?i.outlineOpacity:i.outlineOpacityInactive,activeSegmentOutlineWidthDelta:i.activeSegmentOutlineWidthDelta}}async function oj(e,t,n,i){return await oV(e.element,t,n,i)||void 0}var ti=ti,ts=ts;function oK(e){var t=e.length-1;return function(n){var i,o,a,r=n<=0?n=0:n>=1?(n=1,t-1):Math.floor(n*t),l=e[r],s=e[r+1],d=r>0?e[r-1]:2*l-s,c=r<t-1?e[r+2]:2*s-l;return a=(o=(i=(n-r/t)*t)*i)*i,((1-3*i+3*o-a)*d+(4-6*o+3*a)*l+(1+3*i+3*o-3*a)*s+a*c)/6}}function oY(e,t){for(var n=Array(t),i=0;i<t;++i)n[i]=e(i/(t-1));return n}function oX(e){return e.length}function oZ(){return function(e){if(!(o=e.length))return[];for(var t=-1,n=function(e,t){let n;if(void 0===t)for(let t of e)null!=t&&(n>t||void 0===n&&t>=t)&&(n=t);else{let i=-1;for(let o of e)null!=(o=t(o,++i,e))&&(n>o||void 0===n&&o>=o)&&(n=o)}return n}(e,oX),i=Array(n);++t<n;)for(var o,a=-1,r=i[t]=Array(o);++a<o;)r[a]=e[a][t];return i}(arguments)}function oJ(e,t,n,i){var o,a;let r=n-t+1,l=null!=(o=Math.floor(i/100*r))?o:1,s=null!=(a=Math.floor(r/l))?a:1;if(isNaN(r)||!r||!s||r/s<2)return e;let d=Math.max(0,t),c=Math.min(e.length-1,n),u=e.slice(0,d),h=e.slice(c+1,e.length);return[...u,...function(e,t){var n;if(!t||0===t.length||t.length===e.length)return e;let i=t[t.length-1]-t[0]+1,o=oK(t.map(t=>e[t][0])),a=oK(t.map(t=>e[t][1]));if((null==(n=e[0])?void 0:n.length)!==3)return oZ(oY(o,i),oY(a,i));{let n=oK(t.map(t=>e[t][2]));return oZ(oY(o,i),oY(a,i),oY(n,i))}}(e,function(e,t){let n=[],[i,o]=t,a=o-i+1,r=Math.floor(a/e),l=0,s=Math.round((a-1)/(r-1)*0)+i;for(;s<=o;)n.push(s),s=Math.round((a-1)/(r-1)*++l)+i;return n}(s,[d,c])),...h]}function oQ(e,t){var n,i;return(null==t||!t.autoGenerated)&&((null==e||null==(n=e.smoothing)?void 0:n.smoothOnAdd)===!0||(null==e||null==(i=e.smoothing)?void 0:i.smoothOnEdit)===!0)}function o$(e,t,n,i){let[,o,a]=e,[,r,l]=t,s=a.length,d=l.length,c=e[0],u=t[0];if(!a[c]||!l[u]||!a[o]||!l[r])return[void 0,void 0];for(;c!==o&&u!==r;){if(n(l[u],a[c]))return[c,u];c=(c+s+i)%s,u=(u+d+i)%d}return[void 0,void 0]}function o0(e,t,n){let{interpolation:i,smoothing:o}=e;if(i){let{knotsRatioPercentageOnAdd:e,knotsRatioPercentageOnEdit:i,smoothOnAdd:a=!1,smoothOnEdit:r=!1}=o;if(n?r:a){let[o,a]=n?function(e,t){var n,i,o,a;let[r,l]=function(e,t){for(let o=0;o<e.length;o++)for(let a=0;a<t.length;a++){var n,i;if(n=e[o],i=t[a],0===ts.distanceToPoint(n,i))return[o,a]}}(e,t)||[],s=(e,t)=>!1==.001>ts.distanceToPoint(e,t),[d,c]=o$([(r+(n=e.length)+1)%n,r,e],[(l+(i=t.length)+1)%i,l,t],s,1),[u]=o$([(d+(o=e.length)+-1)%o,d,e],[(c+(a=t.length)+-1)%a,c,t],s,-1);return[d,u]}(t,n):[0,t.length-1];return t[o]&&t[a]?oJ(t,o,a,n?i:e):t}}return t}e.s(["default",()=>o1],822659),e.s(["KeyboardBindings",()=>c,"MouseBindings",()=>d],49119),function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button",e[e.Wheel=524288]="Wheel",e[e.Wheel_Primary=524289]="Wheel_Primary"}(d||(d={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(c||(c={}));let o1=e=>e.shiftKey?e.ctrlKey?c.ShiftCtrl:e.altKey?c.ShiftAlt:e.metaKey?c.ShiftMeta:c.Shift:e.ctrlKey?e.altKey?c.CtrlAlt:e.metaKey?c.CtrlMeta:c.Ctrl:e.altKey?e.metaKey&&c.AltMeta||c.Alt:e.metaKey?c.Meta:void 0;function o2(e,t){let n=e[0],i=e[e.length-1],o=eM.vec2.create();eM.vec2.set(o,i[0]-n[0],i[1]-n[1]),eM.vec2.normalize(o,o);let a=eM.vec2.create(),r=eM.vec2.create();eM.vec2.set(a,-o[1],o[0]),eM.vec2.set(r,o[1],-o[0]);let l=[(n[0]+i[0])/2,(n[1]+i[1])/2],s={dist:0,index:null};for(let t=0;t<e.length;t++){let n=e[t],i=eM.vec2.dist(n,l);i>s.dist&&(s.dist=i,s.index=t)}return[e[s.index],l].map(t.canvasToWorld)}var ti=ti;let{addCanvasPointsToArray:o3,pointsAreWithinCloseContourProximity:o5,getFirstLineSegmentIntersectionIndexes:o4,getSubPixelSpacingAndXYDirections:o8}=ti;function o6(e,t,n){this.isDrawing=!0;let{currentPoints:i,element:o}=e.detail,a=i.canvas,{viewport:r}=(0,e3.getEnabledElement)(o),l=o1(e.detail.event)===this.configuration.contourHoleAdditionModifierKey,{spacing:s,xDir:d,yDir:c}=o8(r,this.configuration.subPixelResolution)||{};s&&d&&c&&(this.drawData={canvasPoints:[a],polylineIndex:0,contourHoleProcessingEnabled:l,newAnnotation:!0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:s,xDir:d,yDir:c,movingTextBox:!1},nc.state.isInteractingWithTool=!0,o.addEventListener(R.Events.MOUSE_UP,this.mouseUpDrawCallback),o.addEventListener(R.Events.MOUSE_DRAG,this.mouseDragDrawCallback),o.addEventListener(R.Events.MOUSE_CLICK,this.mouseUpDrawCallback),o.addEventListener(R.Events.TOUCH_END,this.mouseUpDrawCallback),o.addEventListener(R.Events.TOUCH_DRAG,this.mouseDragDrawCallback),o.addEventListener(R.Events.TOUCH_TAP,this.mouseUpDrawCallback),iA(o))}function o7(e){nc.state.isInteractingWithTool=!1,e.removeEventListener(R.Events.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(R.Events.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(R.Events.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(R.Events.TOUCH_TAP,this.mouseUpDrawCallback),ib(e)}function o9(e){let t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,{viewport:r}=(0,e3.getEnabledElement)(i),{annotation:l,viewportIdsToRender:s,xDir:d,yDir:c,spacing:u,movingTextBox:h}=this.commonData,{polylineIndex:g,canvasPoints:f,newAnnotation:m}=this.drawData;this.createMemo(i,l,{newAnnotation:m});let v=f[f.length-1],p=r.canvasToWorld(v),I=eA.vec3.create();eA.vec3.subtract(I,o,p);let E=Math.abs(eA.vec3.dot(I,d)),w=Math.abs(eA.vec3.dot(I,c));if(!(E<=u[0])||!(w<=u[1])){if(h){this.isDrawing=!1;let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.data.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else{let t=this.findCrossingIndexDuringCreate(e);if(void 0!==t)this.applyCreateOnCross(e,t);else{let e=o3(i,f,a,this.commonData);this.drawData.polylineIndex=g+e}l.invalidated=!0}(0,ne.default)(s),l.invalidated&&(0,tU.triggerAnnotationModified)(l,i,iK.ChangeTypes.HandlesUpdated)}}function ae(e){let{allowOpenContours:t}=this.configuration,{canvasPoints:n,contourHoleProcessingEnabled:i}=this.drawData,o=n[0],a=n[n.length-1],{element:r}=e.detail;this.doneEditMemo(),this.drawData.newAnnotation=!1,t&&!o5(o,a,this.configuration.closeContourProximity)?this.completeDrawOpenContour(r,{contourHoleProcessingEnabled:i}):this.completeDrawClosedContour(r,{contourHoleProcessingEnabled:i})}function at(e,t){this.removeCrossedLinesOnCompleteDraw();let{canvasPoints:n}=this.drawData,{contourHoleProcessingEnabled:i,minPointsToSave:o}=null!=t?t:{};if(o&&n.length<o||this.haltDrawing(e,n))return!1;let{annotation:a,viewportIdsToRender:r}=this.commonData,{viewport:l,renderingEngine:d}=(0,e3.getEnabledElement)(e);o3(e,n,n[0],this.commonData),n.pop();let c=oQ(this.configuration,a)?o0(this.configuration,n):n;this.updateContourPolyline(a,{points:c,closed:!0,targetWindingDirection:s.Clockwise},l);let{textBox:u}=a.data.handles;return(null==u?void 0:u.hasMoved)||(0,tU.triggerContourAnnotationCompleted)(a,i),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,ne.default)(r),this.deactivateDraw(e),!0}function an(){let{canvasPoints:e}=this.drawData,t=e.length,n=[e[0],e[t-1]],i=o4(e.slice(0,-1).slice(1),n[0],n[1],!1);if(i){let t=i[1];1===t?this.drawData.canvasPoints=e.splice(1):this.drawData.canvasPoints=e.splice(0,t)}}function ai(e,t){let{canvasPoints:n}=this.drawData,{contourHoleProcessingEnabled:i}=null!=t?t:{};if(this.haltDrawing(e,n))return!1;let{annotation:o,viewportIdsToRender:a}=this.commonData,{viewport:r,renderingEngine:l}=(0,e3.getEnabledElement)(e),s=oQ(this.configuration,o)?o0(this.configuration,n):n;this.updateContourPolyline(o,{points:s,closed:!1},r);let{textBox:d}=o.data.handles,c=o.data.contour.polyline;return o.data.handles.points=[c[0],c[c.length-1]],o.data.isOpenUShapeContour&&(o.data.openUShapeContourVectorToPeak=o2(n,r)),d.hasMoved||(0,tU.triggerContourAnnotationCompleted)(o,i),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,ne.default)(a),this.deactivateDraw(e),!0}function ao(e){let{currentPoints:t,lastPoints:n}=e.detail,i=t.canvas,o=n.canvas,{canvasPoints:a}=this.drawData,r=o4(a.slice(0,-1),i,o,!1);if(void 0!==r)return r[0]}function aa(e,t){let{element:n}=e.detail,{canvasPoints:i,contourHoleProcessingEnabled:o}=this.drawData,{annotation:a,viewportIdsToRender:r}=this.commonData;o3(n,i,i[t],this.commonData),i.pop();let l=i.slice(t),s=ti.getArea(l);if(w.utilities.isEqual(s,0))return void i.splice(t+1);i.splice(0,t),this.completeDrawClosedContour(n,{contourHoleProcessingEnabled:o,minPointsToSave:3})&&this.activateClosedContourEdit(e,a,r)}function ar(e){let{allowOpenContours:t}=this.configuration,{canvasPoints:n,contourHoleProcessingEnabled:i}=this.drawData,o=n[0],a=n[n.length-1];t&&!o5(o,a,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e,{contourHoleProcessingEnabled:i}):this.completeDrawClosedContour(e,{contourHoleProcessingEnabled:i})}function al(e,t){let{subPixelResolution:n}=this.configuration;if(function(e,t){let n=Math.max(3*t,3);return e.length<n}(t,n)){let{annotation:t,viewportIdsToRender:n}=this.commonData,{renderingEngine:i}=(0,e3.getEnabledElement)(e);return(0,ep.removeAnnotation)(t.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,ne.default)(n),this.deactivateDraw(e),!0}return!1}let as=function(e){e.activateDraw=o6.bind(e),e.deactivateDraw=o7.bind(e),e.applyCreateOnCross=aa.bind(e),e.findCrossingIndexDuringCreate=ao.bind(e),e.completeDrawOpenContour=ai.bind(e),e.removeCrossedLinesOnCompleteDraw=an.bind(e),e.mouseDragDrawCallback=o9.bind(e),e.mouseUpDrawCallback=ae.bind(e),e.completeDrawClosedContour=at.bind(e),e.cancelDrawing=ar.bind(e),e.haltDrawing=al.bind(e)};var ti=ti;let{addCanvasPointsToArray:ad,getFirstLineSegmentIntersectionIndexes:ac}=ti;function au(e,t){let{element:n,currentPoints:i,lastPoints:o}=e.detail,a=i.canvas,r=o.canvas,{editCanvasPoints:l,prevCanvasPoints:s}=this.editData,d=ac(s,a,r,t);if(d)this.editData.startCrossingIndex=d[0],this.removePointsUpUntilFirstCrossing(t);else if(s.length>=2)if(l.length>this.configuration.checkCanvasEditFallbackProximity){let e=l[0],t=[];for(let n=0;n<s.length;n++){let i=s[n],o=eM.vec2.distance(i,e);t.push({distance:o,index:n})}t.sort((e,t)=>e.distance-t.distance);let n=[t[0],t[1]],i=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=i}else{let e=eM.vec2.create();eM.vec2.subtract(e,l[1],l[0]),eM.vec2.normalize(e,e);let i=[l[0][0]-6*e[0],l[0][1]-6*e[1]],o=ac(s,i,l[0],t);if(o){let e=[i];ad(n,e,l[0],this.commonData),l.unshift(...e),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=l.length-1,this.editData.startCrossingIndex=o[0]}}}function ah(e){let{editCanvasPoints:t,prevCanvasPoints:n}=this.editData,i=0;for(let o=0;o<t.length-1;o++){let a=[t[o],t[o+1]],r=!!ac(n,a[0],a[1],e);if(i++,r)break}t.splice(0,i),this.editData.editIndex=t.length-1}function ag(e,t){let{currentPoints:n,lastPoints:i}=e.detail,o=n.canvas,a=i.canvas,{prevCanvasPoints:r}=this.editData;return!!ac(r,o,a,t)}function af(e){let{prevCanvasPoints:t,editCanvasPoints:n}=this.editData;for(let i=n.length-1;i>0;i--){let o=[n[i],n[i-1]],a=!!ac(t,o[0],o[1],e);if(n.pop(),a)break}}function am(){let{editCanvasPoints:e,prevCanvasPoints:t,startCrossingIndex:n}=this.editData;if(void 0===n)return;let i=e[e.length-1],o=[];for(let e=0;e<t.length;e++){let n=t[e],a=eM.vec2.distance(n,i);o.push({distance:a,index:e})}o.sort((e,t)=>e.distance-t.distance);let a=e.slice(0,-1);for(let n=0;n<o.length;n++){let{index:i}=o[n];if(!ac(a,t[i],e[e.length-1],!1))return i}return -1}function av(e){let{currentPoints:t,lastPoints:n}=e.detail,i=t.canvas,o=n.canvas,{editCanvasPoints:a}=this.editData,r=ac(a.slice(0,-2),i,o,!1);if(!r)return;let l=r[0],s=a.length-l;for(let e=0;e<s;e++)a.pop()}let ap=function(e){e.checkForFirstCrossing=au.bind(e),e.removePointsUpUntilFirstCrossing=ah.bind(e),e.checkForSecondCrossing=ag.bind(e),e.findSnapIndex=am.bind(e),e.removePointsAfterSecondCrossing=af.bind(e),e.checkAndRemoveCrossesOnEditLine=av.bind(e)};var ti=ti;let{getSubPixelSpacingAndXYDirections:aI,addCanvasPointsToArray:aE,getArea:aw}=ti;function a_(e,t,n){this.isEditingClosed=!0;let{currentPoints:i,element:o}=e.detail,a=i.canvas,r=(0,e3.getEnabledElement)(o);if(!r)return;let{viewport:l}=r,s=t.data.contour.polyline.map(l.worldToCanvas),{spacing:d,xDir:c,yDir:u}=aI(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:s,editCanvasPoints:[a],startCrossingIndex:void 0,editIndex:0,annotation:t},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:c,yDir:u,movingTextBox:!1},nc.state.isInteractingWithTool=!0,o.addEventListener(R.Events.MOUSE_UP,this.mouseUpClosedContourEditCallback),o.addEventListener(R.Events.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),o.addEventListener(R.Events.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),o.addEventListener(R.Events.TOUCH_END,this.mouseUpClosedContourEditCallback),o.addEventListener(R.Events.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),o.addEventListener(R.Events.TOUCH_TAP,this.mouseUpClosedContourEditCallback),iA(o)}function aS(e){nc.state.isInteractingWithTool=!1,e.removeEventListener(R.Events.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(R.Events.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(R.Events.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(R.Events.TOUCH_TAP,this.mouseUpClosedContourEditCallback),ib(e)}function ay(e){let{currentPoints:t,element:n}=e.detail,i=t.world,o=t.canvas,{viewport:a}=(0,e3.getEnabledElement)(n),{viewportIdsToRender:r,xDir:l,yDir:s,spacing:d}=this.commonData,{editIndex:c,editCanvasPoints:u,startCrossingIndex:h,annotation:g}=this.editData;this.createMemo(n,g);let f=u[u.length-1],m=a.canvasToWorld(f),v=eA.vec3.create();eA.vec3.subtract(v,i,m);let p=Math.abs(eA.vec3.dot(v,l)),I=Math.abs(eA.vec3.dot(v,s));if(p<=d[0]&&I<=d[1])return;void 0!==h&&this.checkAndRemoveCrossesOnEditLine(e);let E=aE(n,u,o,this.commonData);if(this.editData.editIndex=c+E,void 0===h&&u.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1===this.editData.snapIndex)return void this.finishEditAndStartNewEdit(e);this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==h&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),(0,ne.default)(r)}function aT(e){let{element:t}=e.detail,{viewport:n,renderingEngine:i}=(0,e3.getEnabledElement)(t),{annotation:o,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,editCanvasPoints:l}=this.editData;td(o,{points:r,closed:!0,targetWindingDirection:s.Clockwise},n),o.autoGenerated&&(o.autoGenerated=!1),(0,tU.triggerAnnotationModified)(o,t);let d=l.pop();this.editData={prevCanvasPoints:r,editCanvasPoints:[d],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0,annotation:o},(0,ne.default)(a)}function aC(e){let t,n,{prevCanvasPoints:i,editCanvasPoints:o,startCrossingIndex:a,snapIndex:r}=this.editData;if(void 0===a||void 0===r)return;let{element:l}=e.detail,s=[...o];aE(l,s,i[r],this.commonData),s.length>o.length&&s.pop(),a>r?(t=r,n=a):(t=a,n=r);let d=eM.vec2.distance(i[t],s[0]),c=eM.vec2.distance(i[t],s[s.length-1]),u=eM.vec2.distance(i[n],s[0]),h=eM.vec2.distance(i[n],s[s.length-1]),g=[];for(let e=0;e<t;e++){let t=i[e];g.push([t[0],t[1]])}let f=d+h,m=c+u;if(f<m)for(let e=0;e<s.length;e++){let t=s[e];g.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){let t=s[e];g.push([t[0],t[1]])}for(let e=n;e<i.length;e++){let t=i[e];g.push([t[0],t[1]])}let v=[];for(let e=t;e<n;e++){let t=i[e];v.push([t[0],t[1]])}if((f=u+c)<(m=h+d))for(let e=0;e<s.length;e++){let t=s[e];v.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){let t=s[e];v.push([t[0],t[1]])}return aw(g)>aw(v)?g:v}function ab(e){let{element:t}=e.detail;this.completeClosedContourEdit(t)}function aA(e){let{viewport:t}=(0,e3.getEnabledElement)(e),{annotation:n,viewportIdsToRender:i}=this.commonData;this.doneEditMemo();let{fusedCanvasPoints:o,prevCanvasPoints:a}=this.editData;if(o){var r;let i=oQ(this.configuration,n)?o0(this.configuration,o,a):o,l=(null==(r=this.configuration)?void 0:r.decimate)||{};td(n,{points:i,closed:!0,targetWindingDirection:s.Clockwise},t,{decimate:{enabled:!!l.enabled,epsilon:l.epsilon}}),n.autoGenerated&&(n.autoGenerated=!1),(0,tU.triggerAnnotationModified)(n,e)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,(0,ne.default)(i),this.deactivateClosedContourEdit(e)}function ax(e){this.completeClosedContourEdit(e)}let aD=function(e){e.activateClosedContourEdit=a_.bind(e),e.deactivateClosedContourEdit=aS.bind(e),e.mouseDragClosedContourEditCallback=ay.bind(e),e.mouseUpClosedContourEditCallback=ab.bind(e),e.finishEditAndStartNewEdit=aT.bind(e),e.fuseEditPointsWithClosedContour=aC.bind(e),e.cancelClosedContourEdit=ax.bind(e),e.completeClosedContourEdit=aA.bind(e)};var ti=ti;let{addCanvasPointsToArray:aM,getSubPixelSpacingAndXYDirections:aO}=ti;function aP(e,t,n){this.isEditingOpen=!0;let{currentPoints:i,element:o}=e.detail,a=i.canvas,{viewport:r}=(0,e3.getEnabledElement)(o);this.doneEditMemo();let l=t.data.contour.polyline.map(r.worldToCanvas),{spacing:s,xDir:d,yDir:c}=aO(r,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:l,editCanvasPoints:[a],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:s,xDir:d,yDir:c,movingTextBox:!1},nc.state.isInteractingWithTool=!0,o.addEventListener(R.Events.MOUSE_UP,this.mouseUpOpenContourEditCallback),o.addEventListener(R.Events.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),o.addEventListener(R.Events.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),o.addEventListener(R.Events.TOUCH_END,this.mouseUpOpenContourEditCallback),o.addEventListener(R.Events.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),o.addEventListener(R.Events.TOUCH_TAP,this.mouseUpOpenContourEditCallback),iA(o)}function aN(e){nc.state.isInteractingWithTool=!1,e.removeEventListener(R.Events.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(R.Events.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(R.Events.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(R.Events.TOUCH_TAP,this.mouseUpOpenContourEditCallback),ib(e)}function aR(e){let{currentPoints:t,element:n}=e.detail,i=t.world,o=t.canvas,{viewport:a}=(0,e3.getEnabledElement)(n),{viewportIdsToRender:r,xDir:l,yDir:s,spacing:d}=this.commonData,{editIndex:c,editCanvasPoints:u,startCrossingIndex:h}=this.editData,g=u[u.length-1],f=a.canvasToWorld(g),m=eA.vec3.create();this.createMemo(n,this.commonData.annotation),eA.vec3.subtract(m,i,f);let v=Math.abs(eA.vec3.dot(m,l)),p=Math.abs(eA.vec3.dot(m,s));if(v<=d[0]&&p<=d[1])return;void 0!==h&&this.checkAndRemoveCrossesOnEditLine(e);let I=aM(n,u,o,this.commonData);this.editData.editIndex=c+I,void 0===h&&u.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==h&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),(0,ne.default)(r)}function aL(e){let{element:t}=e.detail,{viewport:n}=(0,e3.getEnabledElement)(t),{annotation:i,viewportIdsToRender:o}=this.commonData;td(i,{points:this.fuseEditPointsForOpenContourEndEdit(),closed:!1},n);let a=i.data.contour.polyline;i.data.handles.points=[a[0],a[a.length-1]],i.data.handles.activeHandleIndex=1,(0,tU.triggerAnnotationModified)(i,t),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.doneEditMemo(),this.deactivateOpenContourEdit(t),this.activateOpenContourEndEdit(e,i,o,null)}function aU(e){let{currentPoints:t,lastPoints:n}=e.detail,i=t.canvas,o=n.canvas,{snapIndex:a,prevCanvasPoints:r,startCrossingIndex:l}=this.editData;if(void 0===l||void 0===a)return!1;if(-1===a)return!0;if(0!==a&&a!==r.length-1)return!1;let s=r[a],d=eM.vec2.create(),c=eM.vec2.create();eM.vec2.set(d,i[0]-o[0],i[1]-o[1]),eM.vec2.set(c,i[0]-s[0],i[1]-s[1]);let u=eM.vec2.dot(d,c);return Math.acos(u/(Math.sqrt(d[0]*d[0]+d[1]*d[1])*Math.sqrt(c[0]*c[0]+c[1]*c[1])))<Math.PI/2}function ak(){let{snapIndex:e,prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i}=this.editData,o=[];if(0===e)for(let e=t.length-1;e>=i;e--){let n=t[e];o.push([n[0],n[1]])}else for(let e=0;e<i;e++){let n=t[e];o.push([n[0],n[1]])}if(eM.vec2.distance(t[i],n[0])<eM.vec2.distance(t[i],n[n.length-1]))for(let e=0;e<n.length;e++){let t=n[e];o.push([t[0],t[1]])}else for(let e=n.length-1;e>=0;e--){let t=n[e];o.push([t[0],t[1]])}return o}function aV(e){let t,n,{prevCanvasPoints:i,editCanvasPoints:o,startCrossingIndex:a,snapIndex:r}=this.editData;if(void 0===a||void 0===r)return;let{element:l}=e.detail,s=[...o];aM(l,s,i[r],this.commonData),s.length>o.length&&s.pop(),a>r?(t=r,n=a):(t=a,n=r);let d=eM.vec2.distance(i[t],s[0]),c=eM.vec2.distance(i[t],s[s.length-1]),u=eM.vec2.distance(i[n],s[0]),h=eM.vec2.distance(i[n],s[s.length-1]),g=[];for(let e=0;e<t;e++){let t=i[e];g.push([t[0],t[1]])}if(d+h<c+u)for(let e=0;e<s.length;e++){let t=s[e];g.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){let t=s[e];g.push([t[0],t[1]])}for(let e=n;e<i.length;e++){let t=i[e];g.push([t[0],t[1]])}return g}function aF(e){let{element:t}=e.detail,{viewport:n,renderingEngine:i}=(0,e3.getEnabledElement)(t),{annotation:o,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,editCanvasPoints:l}=this.editData;td(o,{points:r,closed:!1},n);let s=o.data.contour.polyline;o.data.handles.points=[s[0],s[s.length-1]],(0,tU.triggerAnnotationModified)(o,t);let d=l.pop();this.editData={prevCanvasPoints:r,editCanvasPoints:[d],startCrossingIndex:void 0,editIndex:0},(0,ne.default)(a)}function aB(e){let{element:t}=e.detail;this.completeOpenContourEdit(t)}function aG(e){let{viewport:t}=(0,e3.getEnabledElement)(e),{annotation:n,viewportIdsToRender:i}=this.commonData;this.doneEditMemo();let{fusedCanvasPoints:o,prevCanvasPoints:a}=this.editData;if(o){var r;let i=oQ(this.configuration)?o0(this.configuration,o,a):o,l=(null==(r=this.configuration)?void 0:r.decimate)||{};td(n,{points:i,closed:!1},t,{decimate:{enabled:!!l.enabled,epsilon:l.epsilon}});let s=n.data.contour.polyline;n.data.handles.points=[s[0],s[s.length-1]],n.data.isOpenUShapeContour&&(n.data.openUShapeContourVectorToPeak=o2(o,t)),(0,tU.triggerAnnotationModified)(n,e)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,(0,ne.default)(i),this.deactivateOpenContourEdit(e)}function aW(e){this.completeOpenContourEdit(e)}let az=function(e){e.activateOpenContourEdit=aP.bind(e),e.deactivateOpenContourEdit=aN.bind(e),e.mouseDragOpenContourEditCallback=aR.bind(e),e.mouseUpOpenContourEditCallback=aB.bind(e),e.fuseEditPointsWithOpenContour=aV.bind(e),e.finishEditOpenOnSecondCrossing=aF.bind(e),e.checkIfShouldOverwriteAnEnd=aU.bind(e),e.fuseEditPointsForOpenContourEndEdit=ak.bind(e),e.openContourEditOverwriteEnd=aL.bind(e),e.cancelOpenContourEdit=aW.bind(e),e.completeOpenContourEdit=aG.bind(e)};var ti=ti;let{getSubPixelSpacingAndXYDirections:aq}=ti;function aH(e,t,n,i){this.isDrawing=!0;let{element:o}=e.detail,{viewport:a}=(0,e3.getEnabledElement)(o),{spacing:r,xDir:l,yDir:s}=aq(a,this.configuration.subPixelResolution),d=t.data.contour.polyline.map(a.worldToCanvas);0===t.data.handles.activeHandleIndex&&d.reverse();let c=!1;(null==i?void 0:i.worldPosition)&&(c=!0),this.drawData={canvasPoints:d,polylineIndex:d.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:r,xDir:l,yDir:s,movingTextBox:c},nc.state.isInteractingWithTool=!0,o.addEventListener(R.Events.MOUSE_UP,this.mouseUpDrawCallback),o.addEventListener(R.Events.MOUSE_DRAG,this.mouseDragDrawCallback),o.addEventListener(R.Events.MOUSE_CLICK,this.mouseUpDrawCallback),o.addEventListener(R.Events.TOUCH_END,this.mouseUpDrawCallback),o.addEventListener(R.Events.TOUCH_DRAG,this.mouseDragDrawCallback),o.addEventListener(R.Events.TOUCH_TAP,this.mouseUpDrawCallback),iA(o)}let aj=function(e){e.activateOpenContourEndEdit=aH.bind(e)};function aK(e,t,n,i,o){if(i.length<2)return;let{color:a="rgb(0, 255, 0)",width:r=10,fillColor:l="none",fillOpacity:s=0,lineWidth:d,lineDash:c,closePath:u=!1,markerStartId:h=null,markerEndId:g=null}=o,f=n9(t,"polyline",n),m=e.getSvgNode(f),v="";for(let e of i)v+="".concat(e[0].toFixed(1),", ").concat(e[1].toFixed(1)," ");if(u){let e=i[0];v+="".concat(e[0],", ").concat(e[1])}let p={points:v,stroke:a,fill:l,"fill-opacity":s,"stroke-width":d||r,"stroke-dasharray":c,"marker-start":h?"url(#".concat(h,")"):"","marker-end":g?"url(#".concat(g,")"):""};if(m)it(p,m),e.setNodeTouched(f);else{let t=document.createElementNS("http://www.w3.org/2000/svg","polyline");ie(p,t),e.appendNode(t,f)}}function aY(e,t,n,i,o){let a=i.length&&i[0].length&&Array.isArray(i[0][0])?i:[i],{color:r="rgb(0, 255, 0)",width:l=10,fillColor:s="none",fillOpacity:d=0,lineWidth:c,lineDash:u,closePath:h=!1}=o,g=n9(t,"path",n),f=e.getSvgNode(g),m="";for(let e=0,t=a.length;e<t;e++){let t=a[e],n=t.length;if(!(n<2)){for(let e=0;e<n;e++){let n=t[e],i=e?"L":"M";m+="".concat(i," ").concat(n[0].toFixed(1),", ").concat(n[1].toFixed(1)," ")}h&&(m+="Z ")}}if(!m)return;let v={d:m,stroke:r,fill:s,"fill-opacity":d,"stroke-width":c||l,"stroke-dasharray":u};if(f)it(v,f),e.setNodeTouched(g);else{let t=document.createElementNS("http://www.w3.org/2000/svg","path");ie(v,t),e.appendNode(t,g)}}var ti=ti;let{pointsAreWithinCloseContourProximity:aX}=ti;function aZ(e,t){let n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},{lineWidth:i,lineDash:o,color:a,fillColor:r,fillOpacity:l}=this.getAnnotationStyle({annotation:t,styleSpecifier:n}),{closed:s}=t.data.contour;return{color:a,width:i,lineDash:o,fillColor:r,fillOpacity:l,closePath:s}}function aJ(e,t,n){var i,o,a;(null==e||null==(i=e.viewport)?void 0:i.getImageData())&&(n.data.contour.closed?this.renderClosedContour(e,t,n):n.data.isOpenUShapeContour?(o=e,(a=n).data.openUShapeContourVectorToPeak||(a.data.openUShapeContourVectorToPeak=function(e,t){let{viewport:n}=e;return o2(t.data.contour.polyline.map(n.worldToCanvas),n)}(o,a)),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n))}function aQ(e,t,n){if(n.parentAnnotationUID)return;let{viewport:i}=e,o=this._getRenderingOptions(e,n),a=[n.data.contour.polyline.map(e=>i.worldToCanvas(e)),...eE(n,i)];aY(t,n.annotationUID,"1",a,o)}function a$(e,t,n){var i;let{viewport:o}=e,a=this._getRenderingOptions(e,n),r=n.data.contour.polyline.map(e=>o.worldToCanvas(e));aK(t,n.annotationUID,"1",r,a);let l=n.data.handles.activeHandleIndex;if((null==(i=this.configuration.alwaysRenderOpenContourHandles)?void 0:i.enabled)===!0){let e=this.configuration.alwaysRenderOpenContourHandles.radius,i=[r[0],r[r.length-1]];0===l?i.shift():1===l&&i.pop(),io(t,n.annotationUID,"0",i,{color:a.color,handleRadius:e})}if(null!==l){let e=0===l?0:r.length-1,i=r[e];io(t,n.annotationUID,"1",[i],{color:a.color})}}function a0(e,t,n){let{viewport:i}=e,{openUShapeContourVectorToPeak:o}=n.data,{polyline:a}=n.data.contour;if(this.renderOpenContour(e,t,n),!o)return;let r=i.worldToCanvas(a[0]),l=i.worldToCanvas(a[a.length-1]),s=[i.worldToCanvas(o[0]),i.worldToCanvas(o[1])],d=this._getRenderingOptions(e,n);aK(t,n.annotationUID,"first-to-last",[r,l],{color:d.color,width:d.width,closePath:!1,lineDash:"2,2"}),aK(t,n.annotationUID,"midpoint-to-open-contour",[s[0],s[1]],{color:d.color,width:d.width,closePath:!1,lineDash:"2,2"})}function a1(e,t,n){let i=this._getRenderingOptions(e,n),{allowOpenContours:o}=this.configuration,{canvasPoints:a}=this.drawData;if(i.closePath=!1,aK(t,n.annotationUID,"1",a,i),o){let e=a[0],o=a[a.length-1];aX(e,o,this.configuration.closeContourProximity)?aK(t,n.annotationUID,"2",[o,e],i):io(t,n.annotationUID,"0",[e],{color:i.color,handleRadius:2})}}function a2(e,t,n){let{viewport:i}=e,{fusedCanvasPoints:o}=this.editData;if(void 0===o)return void this.renderClosedContour(e,t,n);let a=[o,...eE(n,i)],r=this._getRenderingOptions(e,n);n.parentAnnotationUID&&r.fillOpacity&&(r.fillOpacity=0),aY(t,n.annotationUID,"preview-1",a,r)}function a3(e,t,n){let{fusedCanvasPoints:i}=this.editData;if(void 0===i)return void this.renderOpenContour(e,t,n);let o=this._getRenderingOptions(e,n);aK(t,n.annotationUID,"preview-1",i,o)}function a5(e,t,n){if(n.parentAnnotationUID)return;let{viewport:i}=e,o=this._getRenderingOptions(e,n),a=n.data.contour.polyline.map(e=>i.worldToCanvas(e)),r=eE(n,i),l=a[0],s=[];for(let e=0;e<100;e++){let t=e/100*2*Math.PI,n=l[0]+6*Math.cos(t),i=l[1]+6*Math.sin(t);s.push([n,i])}let d=[[l[0]-12,l[1]],[l[0]+12,l[1]],[l[0],l[1]-12],[l[0],l[1]+12]];aY(t,n.annotationUID,"1-crosshair_v",[d[0],d[1]],o),aY(t,n.annotationUID,"1-crosshair_h",[d[2],d[3]],o);let c=[s,...r];aY(t,n.annotationUID,"1",c,o)}let a4=function(e){e.renderContour=aJ.bind(e),e.renderClosedContour=aQ.bind(e),e.renderOpenContour=a$.bind(e),e.renderPointContourWithMarker=a5.bind(e),e.renderOpenUShapedContour=a0.bind(e),e.renderContourBeingDrawn=a1.bind(e),e.renderClosedContourBeingEdited=a2.bind(e),e.renderOpenContourBeingEdited=a3.bind(e),e._getRenderingOptions=aZ.bind(e)};var O=_;class a8 extends ij{renderAnnotation(e,t){let n=!1,{viewport:i}=e,{element:o}=i;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let a=(0,ep.getAnnotations)(this.getToolName(),o);if(!(null==a?void 0:a.length)||!(null==(a=this.filterInteractableAnnotationsForElement(o,a))?void 0:a.length))return n;let r=this.getTargetId(i),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){let o=a[i];l.annotationUID=o.annotationUID;let s=this.getAnnotationStyle({annotation:o,styleSpecifier:l});if(!s.visibility)continue;let d=this.renderAnnotationInstance({enabledElement:e,targetId:r,annotation:o,annotationStyle:s,svgDrawingHelper:t});n||(n=d),o.invalidated=!1}return n}createAnnotation(e){let t=super.createAnnotation(e);return Object.assign(t.data,{contour:{polyline:[],closed:!1}}),Object.assign(t,{interpolationUID:"",autoGenerated:!1}),t}addAnnotation(e,t){return(0,ep.addAnnotation)(e,t)}cancelAnnotation(e){}moveAnnotation(e,t){let{points:n}=e.data.handles;for(let e=0,i=n.length;e<i;e++){let i=n[e];i[0]+=t[0],i[1]+=t[1],i[2]+=t[2]}e.invalidated=!0,(0,ep.getChildAnnotations)(e).forEach(e=>this.moveAnnotation(e,t))}updateContourPolyline(e,t,n,i){var o;let a=(null==(o=this.configuration)?void 0:o.decimate)||{};td(e,t,n,{decimate:{enabled:!!a.enabled,epsilon:a.epsilon},updateWindingDirection:null==i?void 0:i.updateWindingDirection})}getPolylinePoints(e){var t,n;return null!=(n=null==(t=e.data.contour)?void 0:t.polyline)?n:e.data.polyline}renderAnnotationInstance(e){let{enabledElement:t,annotationStyle:n,svgDrawingHelper:i}=e,o=e.annotation;if(o.parentAnnotationUID)return;let{annotationUID:a}=o,{viewport:r}=t,{worldToCanvas:l}=r,s=this.getPolylinePoints(o).map(e=>l(e)),{lineWidth:d,lineDash:c,color:u,fillColor:h,fillOpacity:g}=n;return aY(i,a,"contourPolyline",[s,...eE(o,r)],{color:u,lineDash:c,lineWidth:Math.max(.1,d),fillColor:h,fillOpacity:g}),!0}constructor(e,t){super(e,t)}}var a6=e.i(493158);function a7(e){return Object.entries(q.getState().viewportSegRepresentations).filter(t=>{let[,n]=t;return n.some(t=>t.segmentationId===e)}).map(e=>{let[t]=e;return t})}function a9(e){var t;let n=H(e);if(!n)return;let i=null==(t=n.representationData)?void 0:t.Contour;if(!i)return;let{annotationUIDsMap:o}=i;if(o)return o}function re(e){let t=H(e);if(!t)throw Error("No segmentation state found for ".concat(e));let{segments:n}=t;return Object.keys(n).filter(e=>n[e].locked).map(e=>parseInt(e))}e.s(["getViewportIdsWithSegmentation",()=>a7],455165),e.s(["getAnnotationsUIDMapFromSegmentation",()=>a9],690335);var O=_;function rt(e,t,n){let i=ol(e,{segmentationId:t});if(!i||0===i.length)return null;let{colorLUTIndex:o}=i[0],a=om(o),r=a[n];if(!r){if("number"!=typeof n)return console.warn("Can't create colour for LUT index ".concat(n)),null;r=a[n]=[0,0,0,0]}return r}class rn extends a8{onSetToolConfiguration(){var e;(null==(e=this.configuration.interpolation)?void 0:e.enabled)?nB.addTool(this.getToolName()):nB.removeTool(this.getToolName())}isContourSegmentationTool(){return!0}createAnnotation(e){let{element:t}=e.detail,n=(0,e3.getEnabledElement)(t);if(!n)return;let{viewport:i}=n,o=super.createAnnotation(e);if(!this.isContourSegmentationTool())return o;let a=oG(i.id);if(!a)throw Error("No active segmentation detected, create one before using scissors tool");if(!a.representationData.Contour)throw Error("A contour segmentation must be active");let{segmentationId:r}=a,l=j(r);return w.utilities.deepMerge(o,{data:{segmentation:{segmentationId:r,segmentIndex:l}}})}addAnnotation(e,t){let n=super.addAnnotation(e,t);return this.isContourSegmentationTool()&&t7(e),n}cancelAnnotation(e){this.isContourSegmentationTool()&&t9(e),super.cancelAnnotation(e)}getAnnotationStyle(e){let t=super.getAnnotationStyle(e);if(!this.isContourSegmentationTool())return t;let n=this._getContourSegmentationStyle(e);return w.utilities.deepMerge(t,n)}renderAnnotationInstance(e){let{annotation:t}=e,{invalidated:n}=t,i=super.renderAnnotationInstance(e);if(n&&this.isContourSegmentationTool()){let{segmentationId:e}=t.data.segmentation;n8(e);let n=a7(e).map(e=>(0,ni.getToolGroupForViewport)(e).id);(0,a6.triggerAnnotationRenderForToolGroupIds)(n)}return i}_getContourSegmentationStyle(e){let t=e.annotation,{segmentationId:n,segmentIndex:i}=t.data.segmentation,{viewportId:o}=e.styleSpecifier,a=ol(o,{segmentationId:n});if(!(null==a?void 0:a.length))return{};a.length>1?a.find(e=>e.segmentationId===n&&e.type===O.default.Contour):a[0];let{autoGenerated:r}=t,l=re(n).includes(i),{color:s,fillColor:d,lineWidth:c,fillOpacity:u,lineDash:h,visibility:g}=function(e){var t,n,i,o,a,r,l,s,d,c,u,h,g;let f,{segmentationId:m,segmentIndex:v,viewportId:p,autoGenerated:I=!1}=e,E=rt(p,m,v),w=(g={segmentationId:m,type:O.default.Contour},q.getSegmentationRepresentationVisibility(p,g)),_=oG(p),S=(null==_?void 0:_.segmentationId)===m,y=B.getStyle({viewportId:p,segmentationId:m,type:O.default.Contour,segmentIndex:v}),T=1,C=1,b=0;I?(T=null!=(t=y.outlineWidthAutoGenerated)?t:T,f=null!=(n=y.outlineDashAutoGenerated)?n:f,C=null!=(i=y.outlineOpacity)?i:C,b=null!=(o=y.fillAlphaAutoGenerated)?o:b):S?(T=null!=(a=y.outlineWidth)?a:T,f=null!=(r=y.outlineDash)?r:f,C=null!=(l=y.outlineOpacity)?l:C,b=null!=(s=y.fillAlpha)?s:b):(T=null!=(d=y.outlineWidthInactive)?d:T,f=null!=(c=y.outlineDashInactive)?c:f,C=null!=(u=y.outlineOpacityInactive)?u:C,b=null!=(h=y.fillAlphaInactive)?h:b),j(m)===v&&(T+=y.activeSegmentOutlineWidthDelta),T=y.renderOutline?T:0,b=y.renderFill?b:0;let A="rgba(".concat(E[0],", ").concat(E[1],", ").concat(E[2],", ").concat(C,")"),x="rgb(".concat(E[0],", ").concat(E[1],", ").concat(E[2],")"),D=!o_(p,{segmentationId:m,type:O.default.Contour}).has(v);return{color:A,fillColor:x,lineWidth:T,fillOpacity:b,lineDash:f,textbox:{color:A},visibility:w&&D}}({segmentationId:n,segmentIndex:i,viewportId:o,autoGenerated:r});return{color:s,fillColor:d,lineWidth:c,fillOpacity:u,lineDash:h,textbox:{color:s},visibility:g,locked:l}}constructor(e,t){var n;super(e,t),(null==(n=this.configuration.interpolation)?void 0:n.enabled)&&nB.addTool(this.getToolName())}}rn.PreviewSegmentIndex=255;let{pointCanProjectOnLine:ri}=ti,{EPSILON:ro}=iL.CONSTANTS,ra=1-ro;class rr extends rn{filterInteractableAnnotationsForElement(e,t){let n;if(!t||!t.length)return;let{viewport:i}=(0,e3.getEnabledElement)(e);if(i instanceof iR.VolumeViewport){let e=i.getCamera(),{spacingInNormalDirection:o}=w.utilities.getTargetVolumeAndSpacingInNormalDir(i,e);n=this.filterAnnotationsWithinSlice(t,e,o)}else n=iB(i,t);return n}filterAnnotationsWithinSlice(e,t,n){let{viewPlaneNormal:i}=t,o=e.filter(e=>{let n=e.metadata.viewPlaneNormal;if(!e.metadata.referencedImageId&&!n&&e.metadata.FrameOfReferenceUID){for(let n of e.data.contour.polyline){let e=eA.vec3.sub(eA.vec3.create(),n,t.focalPoint),i=eA.vec3.dot(e,t.viewPlaneNormal);if(!w.utilities.isEqual(i,0))return!1}return e.metadata.viewPlaneNormal=t.viewPlaneNormal,e.metadata.cameraFocalPoint=t.focalPoint,!0}if(!n){let{referencedImageId:t}=e.metadata,{imageOrientationPatient:i}=A.metaData.get("imagePlaneModule",t),o=eA.vec3.fromValues(i[0],i[1],i[2]),a=eA.vec3.fromValues(i[3],i[4],i[5]);n=eA.vec3.create(),eA.vec3.cross(n,o,a),e.metadata.viewPlaneNormal=n}let o=Math.abs(eA.vec3.dot(i,n))>ra;return n&&o});if(!o.length)return[];let a=n/2,{focalPoint:r}=t,l=[];for(let e of o){let t=e.data.contour.polyline[0];if(!e.isVisible)continue;let n=eA.vec3.create();eA.vec3.sub(n,r,t),Math.abs(eA.vec3.dot(n,i))<a&&l.push(e)}return l}isContourSegmentationTool(){return!1}createAnnotation(e){let t=e.detail.currentPoints.world,n=super.createAnnotation(e);return w.utilities.deepMerge(n,{data:{contour:{polyline:[[...t]]},label:"",cachedStats:{}},onInterpolationComplete:e=>{e.data.handles.points.length=0}})}getAnnotationStyle(e){return super.getAnnotationStyle(e)}renderAnnotationInstance(e){let{enabledElement:t,targetId:n,svgDrawingHelper:i}=e,o=e.annotation,a=!1,{viewport:r,renderingEngine:l}=t,s=this.isDrawing,d=this.isEditingOpen,c=this.isEditingClosed;if(s||d||c){let e=this.commonData.annotation.annotationUID;if(o.annotationUID===e)if(s)this.renderContourBeingDrawn(t,i,o);else if(c)this.renderClosedContourBeingEdited(t,i,o);else if(d)this.renderOpenContourBeingEdited(t,i,o);else throw Error("Unknown ".concat(this.getToolName()," annotation rendering state"));else this.configuration.displayOnePointAsCrosshairs&&1===o.data.contour.polyline.length?this.renderPointContourWithMarker(t,i,o):this.renderContour(t,i,o);a=!0}else this.configuration.displayOnePointAsCrosshairs&&1===o.data.contour.polyline.length?this.renderPointContourWithMarker(t,i,o):this.renderContour(t,i,o);if(this.configuration.calculateStats)return o.invalidated&&this._calculateStatsIfActive(o,n,r,l,t),this._renderStats(o,r,t,i),a}_calculateStatsIfActive(e,t,n,i,o){var a,r,l,s;let d=null==(a=this.commonData)?void 0:a.annotation.annotationUID;if((e.annotationUID!==d||(null==(r=this.commonData)?void 0:r.movingTextBox))&&!(null==(l=this.commonData)?void 0:l.movingTextBox)){let{data:a}=e;(null==(s=a.cachedStats[t])?void 0:s.unit)?e.invalidated&&this._throttledCalculateCachedStats(e,n,i,o):(a.cachedStats[t]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,unit:null},this._calculateCachedStats(e,n,i,o))}}updateClosedCachedStats(e){var t,n,i,o;let a,{viewport:r,points:l,imageData:s,metadata:d,cachedStats:c,targetId:u,modalityUnit:h,canvasCoordinates:g,calibratedScale:f,deltaInX:m,deltaInY:v}=e,{scale:p,areaUnit:I,unit:E}=f,{voxelManager:_}=r.getImageData(),S=w.utilities.transformWorldToIndex(s,l[0]);S[0]=Math.floor(S[0]),S[1]=Math.floor(S[1]),S[2]=Math.floor(S[2]);let y=S[0],T=S[0],C=S[1],b=S[1],A=S[2],x=S[2];for(let e=1;e<l.length;e++){let t=w.utilities.transformWorldToIndex(s,l[e]);t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),y=Math.min(y,t[0]),T=Math.max(T,t[0]),C=Math.min(C,t[1]),b=Math.max(b,t[1]),A=Math.min(A,t[2]),x=Math.max(x,t[2])}let D=w.utilities.transformWorldToIndex(s,l[1]);D[0]=Math.floor(D[0]),D[1]=Math.floor(D[1]),D[2]=Math.floor(D[2]);let M=ti.getArea(g)/p/p;M*=m*v;let O=nH(l,closed)/p,P=.01*(T-y),N=.01*(b-C),R=.01*(x-A),L=[[y=Math.floor(y-P),T=Math.ceil(T+P)],[C=Math.floor(C-N),b=Math.ceil(b+N)],[A=Math.floor(A-R),x=Math.ceil(x+R)]],U=s.indexToWorld([T,b,x]),k=r.worldToCanvas(U),V=0,F=[],B=0;_&&(a=_.forEach(this.configuration.statsCalculator.statsCallback,{imageData:s,isInObject:(e,t)=>{let n=!0,i=r.worldToCanvas(e);i[1]!=V&&(B=0,V=i[1],(F=eQ(g,i,[k[0],i[1]])).sort(function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}));return F.length&&i[0]>F[0][0]&&(F.shift(),B++),B%2==0&&(n=!1),n},boundsIJK:L,returnPoints:this.configuration.storePointData}));let G=this.configuration.statsCalculator.getStatistics();c[u]={Modality:d.Modality,area:M,perimeter:O,mean:null==(t=G.mean)?void 0:t.value,max:null==(n=G.max)?void 0:n.value,min:null==(i=G.min)?void 0:i.value,stdDev:null==(o=G.stdDev)?void 0:o.value,statsArray:G.array,pointsInShape:a,areaUnit:I,modalityUnit:h,unit:E}}updateOpenCachedStats(e){let{targetId:t,metadata:n,cachedStats:i,modalityUnit:o,calibratedScale:a,points:r}=e,{scale:l,unit:s}=a,d=nH(r,closed)/l;i[t]={Modality:n.Modality,length:d,modalityUnit:o,unit:s}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,shadow:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:c.Shift,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,makeClockWise:!0,subPixelResolution:4,smoothing:{smoothOnAdd:!1,smoothOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},interpolation:{enabled:!1,onInterpolationComplete:null},decimate:{enabled:!1,epsilon:.1},displayOnePointAsCrosshairs:!1,calculateStats:!0,getTextLines:rl,statsCalculator:i$.BasicStatsCalculator}}){super(e,t),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{let{element:t}=e.detail,n=this.createAnnotation(e);this.addAnnotation(n,t);let i=nd(t,this.getToolName());return this.activateDraw(e,n,i),e.preventDefault(),(0,ne.default)(i),n},this.handleSelectedCallback=(e,t,n)=>{let{element:i}=e.detail,o=nd(i,this.getToolName());this.activateOpenContourEndEdit(e,t,o,n)},this.toolSelectedCallback=(e,t)=>{let{element:n}=e.detail,i=nd(n,this.getToolName());t.data.contour.closed?this.activateClosedContourEdit(e,t,i):this.activateOpenContourEdit(e,t,i),e.preventDefault()},this.isPointNearTool=(e,t,n,i)=>{let{viewport:o}=(0,e3.getEnabledElement)(e),{polyline:a}=t.data.contour,r=o.worldToCanvas(a[0]);for(let e=1;e<a.length;e++){let t=r,l=o.worldToCanvas(a[e]);if(ri(n,t,l,i))return!0;r=l}return!!t.data.contour.closed&&ri(n,o.worldToCanvas(a[0]),o.worldToCanvas(a[a.length-1]),i)},this.cancel=e=>{let t=this.isDrawing,n=this.isEditingOpen,i=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):i&&this.cancelClosedContourEdit(e)},this._calculateCachedStats=(e,t,n,i)=>{let{data:o}=e,{cachedStats:a}=o,{polyline:r,closed:l}=o.contour,s=Object.keys(a);for(let n=0;n<s.length;n++){let i=s[n],d=this.getTargetImageData(i);if(!d)continue;let{imageData:c,metadata:u}=d,h=r.map(e=>t.worldToCanvas(e)),g={isPreScaled:iQ(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},f=iJ(u.Modality,e.metadata.referencedImageId,g),m=(0,n7.getCalibratedLengthUnitsAndScale)(d,()=>{let e=o.contour.polyline,n=e.length,i=Array(n);for(let o=0;o<n;o++)i[o]=t.worldToCanvas(e[o]);let{maxX:a,maxY:r,minX:l,minY:s}=ti.getAABB(i),d=t.canvasToWorld([l,s]),u=w.utilities.transformWorldToIndex(c,d),h=t.canvasToWorld([a,r]);return[u,w.utilities.transformWorldToIndex(c,h)]}),v=h[0],p=t.canvasToWorld(v),I=t.canvasToWorld([v[0]+1,v[1]]),E=t.canvasToWorld([v[0],v[1]+1]),_=eA.vec3.distance(p,I),S=eA.vec3.distance(p,E);l?this.updateClosedCachedStats({targetId:i,viewport:t,canvasCoordinates:h,points:r,imageData:c,metadata:u,cachedStats:a,modalityUnit:f,calibratedScale:m,deltaInX:_,deltaInY:S}):this.updateOpenCachedStats({metadata:u,targetId:i,cachedStats:a,modalityUnit:f,calibratedScale:m,points:r})}let d=e.invalidated;return e.invalidated=!1,d&&(0,tU.triggerAnnotationModified)(e,i.viewport.element,iK.ChangeTypes.StatsUpdated),a},this._renderStats=(e,t,n,i)=>{var o;let{data:a}=e,r=this.getTargetId(t),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id,annotationUID:e.annotationUID},s=this.getLinkedTextBoxStyle(l,e);if(!s.visibility)return;let d=this.configuration.getTextLines(a,r);if(!d||0===d.length)return;let c=a.contour.polyline.map(e=>t.worldToCanvas(e));if(!a.handles.textBox.hasMoved){let e=ip(c);a.handles.textBox.worldPosition=t.canvasToWorld(e)}let u=t.worldToCanvas(a.handles.textBox.worldPosition),{x:h,y:g,width:f,height:m}=ig(i,null!=(o=e.annotationUID)?o:"","1",d,u,c,{},s);a.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([h,g]),topRight:t.canvasToWorld([h+f,g]),bottomLeft:t.canvasToWorld([h,g+m]),bottomRight:t.canvasToWorld([h+f,g+m])}},as(this),ap(this),aD(this),az(this),aj(this),a4(this),this._throttledCalculateCachedStats=(0,im.default)(this._calculateCachedStats,100,{trailing:!0})}}function rl(e,t){let{area:n,mean:i,stdDev:o,length:a,perimeter:r,max:l,min:s,isEmptyArea:d,unit:c,areaUnit:u,modalityUnit:h}=e.cachedStats[t]||{},g=[];if(w.utilities.isNumber(n)){let e=d?"Area: Oblique not supported":"Area: ".concat(w.utilities.roundNumber(n)," ").concat(u);g.push(e)}return w.utilities.isNumber(i)&&g.push("Mean: ".concat(w.utilities.roundNumber(i)," ").concat(h)),w.utilities.isNumber(l)&&g.push("Max: ".concat(w.utilities.roundNumber(l)," ").concat(h)),w.utilities.isNumber(s)&&g.push("Min: ".concat(w.utilities.roundNumber(s)," ").concat(h)),w.utilities.isNumber(o)&&g.push("Std Dev: ".concat(w.utilities.roundNumber(o)," ").concat(h)),w.utilities.isNumber(r)&&g.push("Perimeter: ".concat(w.utilities.roundNumber(r)," ").concat(c)),w.utilities.isNumber(a)&&g.push("".concat(w.utilities.roundNumber(a)," ").concat(c)),g}rr.toolName="PlanarFreehandROI";let rs=rr;class rd extends rs{isContourSegmentationTool(){return!0}renderAnnotationInstance(e){let t=e.annotation,{invalidated:n}=t,i=super.renderAnnotationInstance(e);if(n){let{segmentationId:e}=t.data.segmentation;n8(e)}return i}constructor(e){super(w.utilities.deepMerge({configuration:{calculateStats:!1,allowOpenContours:!1}},e))}}rd.toolName="PlanarFreehandContourSegmentationTool";let rc={[_.default.Labelmap]:{render:oq,removeRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=(0,D.getEnabledElementByViewportId)(e);if(oW.forEach((e,n)=>{n.includes(t)&&oW.delete(n)}),!i)return;let{viewport:o}=i;oB(o.element,t),n&&o.render()}},[_.default.Contour]:{render:ox,removeRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=(0,D.getEnabledElementByViewportId)(e);if(!i)return;let{viewport:o}=i;oT(e,t),n&&o.render()}},[_.default.Surface]:{render:oS,removeRepresentation:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=(0,D.getEnabledElementByViewportId)(e);if(!i)return;let{viewport:o}=i;od(o.element,t),n&&o.render()}}},ru=rd.toolName;function rh(e){rf.renderSegmentationsForViewport(e)}function rg(e){rf.renderSegmentation(e)}let rf=new class{renderSegmentationsForViewport(e){let t=e?[e]:this._getViewportIdsForSegmentation();this._setViewportsToBeRenderedNextFrame(t)}renderSegmentation(e){let t=this._getViewportIdsForSegmentation(e);this._setViewportsToBeRenderedNextFrame(t)}_getViewportIdsForSegmentation(e){let t=this._getAllViewports(),n=[];for(let i of t){let t=i.id;if(e){let i=ol(t,{segmentationId:e});(null==i?void 0:i.length)>0&&n.push(t)}else{let e=ol(t);(null==e?void 0:e.length)>0&&n.push(t)}}return n}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setViewportsToBeRenderedNextFrame(e){if(this._animationFrameSet)return void this._pendingRenderQueue.push(e);e.forEach(e=>{this._needsRender.add(e)}),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedSegmentations),this._animationFrameSet=!0)}_triggerRender(e){let t=ol(e);if(!(null==t?void 0:t.length))return;let{viewport:n}=(0,D.getEnabledElementByViewportId)(e)||{};if(!n)return;let i=[];Promise.allSettled(t.map(e=>{e.type===O.default.Contour&&this._addPlanarFreeHandToolIfAbsent(n);let t=rc[e.type];try{let o=t.render(n,e);i.push(o)}catch(e){console.error(e)}return Promise.resolve({segmentationId:e.segmentationId,type:e.type})})).then(e=>{let t=e.filter(e=>"fulfilled"===e.status).map(e=>e.value);n.element.addEventListener(C.Enums.Events.IMAGE_RENDERED,function e(n){let{element:i,viewportId:o}=n.detail;i.removeEventListener(C.Enums.Events.IMAGE_RENDERED,e),t.forEach(e=>{let t={viewportId:o,segmentationId:e.segmentationId,type:e.type};(0,b.triggerEvent)(T.eventTarget,R.Events.SEGMENTATION_RENDERED,{...t})})}),n.render()})}_addPlanarFreeHandToolIfAbsent(e){ru in nc.state.tools||nu(rd);let t=(0,ni.getToolGroupForViewport)(e.id);t.hasTool(ru)||(t.addTool(ru),t.setToolPassive(ru))}constructor(){this._needsRender=new Set,this._pendingRenderQueue=[],this._animationFrameSet=!1,this._animationFrameHandle=null,this._getAllViewports=()=>(0,or.getRenderingEngines)().flatMap(e=>e.getViewports()),this._renderFlaggedSegmentations=()=>{if(this._throwIfDestroyed(),Array.from(this._needsRender).forEach(e=>{this._triggerRender(e)}),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._pendingRenderQueue.length>0){let e=this._pendingRenderQueue.shift();e&&e.length>0&&this._setViewportsToBeRenderedNextFrame(e)}}}};e.s(["default",()=>rm],579126);let rm=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=n.onFlood,o=n.onBoundary,a=n.equals,r=n.filter,l=n.diagonals||!1,s=e(...t),d=(function(e){let t=[];for(let a=0;a<Math.pow(3,e);a+=1){var n,i,o;let r=(n=a.toString(3),i="0",(Array((o=e)+1).join("0")+n).slice(-o));t.push(r.split("").map(function(e){return parseInt(e,10)-1}))}return t})(t.length).filter(function(e){let t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||l)}),c=[],u=[],h=new Set,g=n.bounds;for(c.push({currentArgs:t});c.length>0;)!function(t){var n;let l=t.currentArgs,m=t.previousArgs;f(l)||(function(e){let[t,n,i=0]=e;h.add(t+32768+65536*(n+32768+65536*(i+32768)))}(l),function(t){let n=e(...t);return a?a(n,s):n===s}(l)?(n=l,u.push(n),i&&i(...n),function(e){for(let t=0;t<d.length;t+=1){let n=d[t],i=e.slice(0);for(let t=0;t<e.length;t+=1)i[t]+=n[t];(null==r?void 0:r(i))!==!1&&(f(i)||c.push({currentArgs:i,previousArgs:e}))}}(l)):function(e){let[t,n,i=0]=e;null==g||g.set(t+32768+65536*(n+32768+65536*(i+32768)),e),o&&o(...e)}(m))}(c.pop());return{flooded:u};function f(e){let[t,n,i=0]=e;return h.has(t+32768+65536*(n+32768+65536*(i+32768)))}};var rv=e.i(557141);let rp={[ei.OnInteractionStart]:e=>{let{segmentIndex:t,previewSegmentIndex:n,segmentationVoxelManager:i,centerIJK:o,viewPlaneNormal:a,segmentationImageData:r,configuration:l}=e;if(!(null==l?void 0:l.useCenterSegmentIndex)){e.centerSegmentIndexInfo.segmentIndex=null,e.centerSegmentIndexInfo.hasSegmentIndex=!1,e.centerSegmentIndexInfo.hasPreviewIndex=!1;return}let s=!1,d=!1,c=[...i.getBoundsIJK()];if(Math.abs(a[0])>.8?c[0]=[o[0],o[0]]:Math.abs(a[1])>.8?c[1]=[o[1],o[1]]:Math.abs(a[2])>.8&&(c[2]=[o[2],o[2]]),i.forEach(e=>{let{value:i}=e;s||(s=i===t),d||(d=i===n)},{imageData:r,isInObject:e.isInObject,boundsIJK:c}),!s&&!d){e.centerSegmentIndexInfo.segmentIndex=null;return}let u=i.getAtIJKPoint(o);e.centerSegmentIndexInfo.segmentIndex=u,e.centerSegmentIndexInfo.hasSegmentIndex=s,e.centerSegmentIndexInfo.hasPreviewIndex=d}},rI={[ei.Initialize]:e=>{var t;let{operationName:n,centerIJK:i,segmentationVoxelManager:o,imageVoxelManager:a,configuration:r,segmentIndex:l,viewport:s}=e;if(!(null==r||null==(t=r.threshold)?void 0:t.isDynamic)||!i||!l||n===ei.RejectPreview||n===ei.OnInteractionEnd)return;let d=o.getBoundsIJK(),{range:c,dynamicRadius:u=0}=r.threshold,h=c?0:u,{viewPlaneNormal:g}=s.getCamera(),f=d.map((e,t)=>{let[n,o]=e;return[Math.max(n,i[t]-h),Math.min(o,i[t]+h)]});Math.abs(g[0])>.8?f[0]=[i[0],i[0]]:Math.abs(g[1])>.8?f[1]=[i[1],i[1]]:Math.abs(g[2])>.8&&(f[2]=[i[2],i[2]]);let m=c||[1/0,-1/0],v=h*h;a.forEach(e=>{let{value:t,pointIJK:n}=e;if(eA.vec3.sqrDist(i,n)>v)return;let o=Array.isArray(t)?eA.vec3.len(t):t;m[0]=Math.min(o,m[0]),m[1]=Math.max(o,m[1])},{boundsIJK:f}),r.threshold.range=m},[ei.OnInteractionStart]:e=>{var t;let{configuration:n}=e;(null==n||null==(t=n.threshold)?void 0:t.isDynamic)&&(n.threshold.range=null)},[ei.ComputeInnerCircleRadius]:e=>{let{configuration:t,viewport:n}=e,{dynamicRadius:i=0,isDynamic:o}=t.threshold;if(!o){t.threshold.dynamicRadiusInCanvas=0;return}if(0===i)return;let a=n.getImageData();if(!a)return;let{spacing:r}=a,l=[n.element.clientWidth/2,n.element.clientHeight/2],s=i*r[0],d=n.canvasToWorld(l).map(e=>e+s),c=n.worldToCanvas(d),u=Math.abs(l[0]-c[0]);t.threshold.dynamicRadiusInCanvas||(t.threshold.dynamicRadiusInCanvas=0),t.threshold.dynamicRadiusInCanvas=3+u}},rE={[ei.Initialize]:e=>{e.segmentIndex=0}};e.s(["default",()=>rA],894794),e.s(["default",()=>rT],935840);let{isEqual:rw}=w.utilities,r_={toIJK:e=>e,fromIJK:e=>e,type:"acquistion"},rS={toIJK:e=>{let[t,n,i]=e;return[i,t,n]},fromIJK:e=>{let[t,n,i]=e;return[n,i,t]},type:"jk"},ry={toIJK:e=>{let[t,n,i]=e;return[t,i,n]},fromIJK:e=>{let[t,n,i]=e;return[t,i,n]},type:"ik"};function rT(e,t){if(!(e instanceof x.BaseVolumeViewport))return{...r_,boundsIJKPrime:t};let{viewPlaneNormal:n}=e.getCamera(),i=rw(Math.abs(n[0]),1)&&rS||rw(Math.abs(n[1]),1)&&ry||rw(Math.abs(n[2]),1)&&r_;return i?{...i,boundsIJKPrime:i.fromIJK(t)}:{toIJK:null,boundsIJKPrime:null,fromIJK:null,error:"Only mappings orthogonal to acquisition plane are permitted, but requested ".concat(n)}}let{RLEVoxelMap:rC,VoxelManager:rb}=w.utilities;!function(e){e[e.SEGMENT=-1]="SEGMENT",e[e.ISLAND=-2]="ISLAND",e[e.INTERIOR=-3]="INTERIOR",e[e.EXTERIOR=-4]="EXTERIOR",e[e.INTERIOR_SMALL=-5]="INTERIOR_SMALL",e[e.INTERIOR_TEST=-6]="INTERIOR_TEST"}(u||(u={}));class rA{initialize(e,t,n){let i=!!t.sourceVoxelManager,o=i?t.sourceVoxelManager:t,a=i?t:rb.createRLEHistoryVoxelManager(o),{segmentIndex:r=1,previewSegmentIndex:l=1}=n,s=n.points||o.getPoints();if(!(null==s?void 0:s.length))return;let d=o.getBoundsIJK().map((e,t)=>[Math.min(e[0],...s.map(e=>e[t])),Math.max(e[1],...s.map(e=>e[t]))]);if(d.find(e=>e[0]<0||e[1]>65535))return;let{toIJK:c,fromIJK:h,boundsIJKPrime:g,error:f}=rT(e,d);if(f)return void console.warn("Not performing island removal for planes not orthogonal to acquisition plane",f);let[m,v,p]=h(o.dimensions),I=new rC(m,v,p);return I.fillFrom((e,t,n)=>{let i=o.toIndex(c([e,t,n])),a=o.getAtIndex(i);if(a===l||a===r)return u.SEGMENT},g),I.normalizer={toIJK:c,fromIJK:h,boundsIJKPrime:g},this.segmentSet=I,this.previewVoxelManager=a,this.segmentIndex=r,this.previewSegmentIndex=null!=l?l:r,this.selectedPoints=s,!0}floodFillSegmentIsland(){let{selectedPoints:e,segmentSet:t}=this,n=0,{fromIJK:i}=t.normalizer;return e.forEach(e=>{let o=i(e),a=t.toIndex(o),[r,l,s]=o;t.get(a)===u.SEGMENT&&(n+=t.floodFill(r,l,s,u.ISLAND))}),n}removeExternalIslands(){let{previewVoxelManager:e,segmentSet:t}=this,{toIJK:n}=t.normalizer;t.forEach((i,o)=>{let[,a,r]=t.toIJK(i);if(o.value!==u.ISLAND)for(let t=o.start;t<o.end;t++){let i=n([t,a,r]),o=e.getAtIJKPoint(i);e.setAtIJKPoint(i,void 0===o?0:null)}},{rowModified:!0})}removeInternalIslands(){let{segmentSet:e,previewVoxelManager:t,previewSegmentIndex:n}=this,{height:i,normalizer:o,width:a}=e,{toIJK:r}=o;return e.forEachRow((t,n)=>{let i;for(let o of[...n])if(o.value===u.ISLAND){if(!i){if(this.fillInternalEdge&&o.start>0)for(let n=0;n<o.start;n++)e.set(t+n,u.INTERIOR);i=o;continue}for(let n=i.end;n<o.start;n++)e.set(t+n,u.INTERIOR);i=o}if(this.fillInternalEdge&&(null==i?void 0:i.end)<a)for(let n=i.end;n<a;n++)e.set(t+n,u.INTERIOR)}),e.forEach((t,n)=>{if(n.value!==u.INTERIOR)return;let[,o,a]=e.toIJK(t),r=o>0?e.getRun(o-1,a):null,l=o+1<i?e.getRun(o+1,a):null,s=o===i-1,d=0===o,c=rA.covers(n,r)||d&&this.fillInternalEdge,h=rA.covers(n,l)||s&&this.fillInternalEdge;!(n.end-n.start>2)||c&&h||e.floodFill(n.start,o,a,u.EXTERIOR,{singlePlane:!0})}),e.forEach((t,n)=>{if(n.value!==u.INTERIOR)return;let[,i,o]=e.toIJK(t),a=e.floodFill(n.start,i,o,u.INTERIOR_TEST)>this.maxInternalRemove?u.EXTERIOR:u.INTERIOR_SMALL;e.floodFill(n.start,i,o,a)}),e.forEach((i,o)=>{if(o.value===u.INTERIOR_SMALL)for(let a=o.start;a<o.end;a++){let o=r(e.toIJK(i+a));t.setAtIJKPoint(o,n)}}),t.getArrayOfModifiedSlices()}static covers(e,t){if(!t)return!1;let{start:n}=e,{end:i}=e;for(let e of t)if(n>=e.start&&n<e.end&&(n=e.end)>=i)return!0;return!1}constructor(e){var t,n;this.fillInternalEdge=!1,this.maxInternalRemove=128,this.maxInternalRemove=null!=(t=null==e?void 0:e.maxInternalRemove)?t:this.maxInternalRemove,this.fillInternalEdge=null!=(n=null==e?void 0:e.fillInternalEdge)?n:this.fillInternalEdge}}let rx={[ei.OnInteractionEnd]:e=>{let{previewSegmentIndex:t,segmentIndex:n,viewport:i,segmentationVoxelManager:o,activeStrategy:a,memo:r}=e;if("THRESHOLD_INSIDE_SPHERE_WITH_ISLAND_REMOVAL"!==a||null===n)return;let l=new rA,s=(null==r?void 0:r.voxelManager)||o;if(!l.initialize(i,s,{previewSegmentIndex:t,segmentIndex:n}))return;l.floodFillSegmentIsland(),l.removeExternalIslands(),l.removeInternalIslands();let d=s.getArrayOfModifiedSlices();d&&n8(e.segmentationId,d,t)}},rD={[ei.Preview]:function(e){var t,n;let{previewSegmentIndex:i,configuration:o,enabledElement:a}=e;if(!i||!o)return;null==(t=this.onInteractionStart)||t.call(this,a,e);let r=this.fill(a,e);return r&&(null==(n=this.onInteractionEnd)||n.call(this,a,e)),r},[ei.Initialize]:e=>{let{segmentIndex:t,previewColor:n,previewSegmentIndex:i}=e;if(e.modified=!1,null==i||null==t)return;let o=a7(e.segmentationId);null==o||o.forEach(t=>{!function(e,t,n,i){let o=rt(e,t,n);for(let e=0;e<i.length;e++)o[e]=i[e];U(e,t)}(t,e.segmentationId,i,n)}),e.modified=!0},[ei.AcceptPreview]:e=>{let{previewSegmentIndex:t,segmentationVoxelManager:n,memo:i,segmentIndex:o,centerSegmentIndexInfo:a}=e||{},{changedIndices:r}=a||{};n.forEach(e=>{let{index:a}=e,l=n.getAtIndex(a);(null==r?void 0:r.length)>0?r.includes(a)&&i.voxelManager.setAtIndex(a,0):l===t&&i.voxelManager.setAtIndex(a,o)}),n8(e.segmentationId,n.getArrayOfModifiedSlices(),o),e.centerSegmentIndexInfo.changedIndices=[]},[ei.RejectPreview]:e=>{e&&w.utilities.HistoryMemo.DefaultHistoryMemo.undoIf(t=>{if(!(null==t?void 0:t.voxelManager))return!1;let{segmentationVoxelManager:n}=t,i=!1;return n.forEach(t=>{let{value:n}=t;n===e.previewSegmentIndex&&(i=!0)}),i})}},rM={[ei.Fill]:e=>{var t;let{segmentsLocked:n,segmentationImageData:i,segmentationVoxelManager:o,brushStrategy:a,centerIJK:r}=e,l=null==(t=a.createIsInThreshold)?void 0:t.call(a,e),{setValue:s}=a,d=l?t=>{let{value:i,index:o}=t;!n.includes(i)&&l(o)&&s(e,t)}:t=>s(e,t);o.forEach(d,{imageData:i,isInObject:e.isInObject,boundsIJK:e.isInObjectBoundsIJK}),o.addPoint(r)}},rO={[ei.INTERNAL_setValue]:(e,t)=>{let{value:n,index:i}=t,{segmentsLocked:o,previewSegmentIndex:a,memo:r,segmentationVoxelManager:l,centerSegmentIndexInfo:s,segmentIndex:d}=e,c=l.getAtIndex(i);if(!o.includes(n)&&(s||c!==d)&&((null==s?void 0:s.segmentIndex)===0||c!==d)){if((null==s?void 0:s.segmentIndex)===null)return void r.voxelManager.setAtIndex(i,null!=a?a:d);if(!a){let e=d;s&&(e=s.segmentIndex),r.voxelManager.setAtIndex(i,e);return}!function(e){let{operationData:t,existingValue:n,index:i}=e,{previewSegmentIndex:o,memo:a,centerSegmentIndexInfo:r,previewOnHover:l,segmentIndex:s}=t,{hasPreviewIndex:d,hasSegmentIndex:c,segmentIndex:u}=r;if(0===u&&c&&d)return n===s||l||n===o&&a.voxelManager.setAtIndex(i,0);if(0===u&&c&&!d){if(0===n||n!==s)return;a.voxelManager.setAtIndex(i,o),r.changedIndices.push(i);return}if(0===u&&!c&&d)return n===s||l||n===o&&a.voxelManager.setAtIndex(i,0);if(0===u&&!c&&!d)return n===s||n===o&&a.voxelManager.setAtIndex(i,o);if(u===o&&c&&d||u===o&&!c&&d||u===s&&c&&d||u===s&&c&&!d){if(n===s)return;a.voxelManager.setAtIndex(i,o)}}({operationData:e,existingValue:c,index:i})}}},rP={[ei.CreateIsInThreshold]:e=>{let{imageVoxelManager:t,segmentIndex:n,configuration:i}=e;if(i&&n)return e=>{var n;let o=t.getAtIndex(e),a=Array.isArray(o)?eA.vec3.length(o):o,{threshold:r}=i||{};return null==r||null==(n=r.range)||!n.length||r.range[0]<=a&&a<=r.range[1]}}};var rN=e.i(416263);let rR=Math.pow(3e3/(4*Math.PI),1/3);async function rL(e){var t;let{operationData:n,indices:i,unit:o,mode:a}=e,{segmentationVoxelManager:r,imageVoxelManager:l,segmentationImageData:s,imageData:d}=ec(n);if(!r||!s)return;let c=s.getSpacing(),{boundsIJK:u}=r;if(!u)return rN.default.getStatistics({spacing:c});let h={scalarData:r.getCompleteScalarDataArray(),dimensions:s.getDimensions(),spacing:s.getSpacing(),origin:s.getOrigin(),direction:s.getDirection()},g={scalarData:l.getCompleteScalarDataArray(),dimensions:d.getDimensions(),spacing:d.getSpacing(),origin:d.getOrigin(),direction:d.getDirection()};if(!(null==(t=g.scalarData)?void 0:t.length))return;let f=await (0,E.getWebWorkerManager)().executeTask("compute","calculateSegmentsStatisticsVolume",{segmentationInfo:h,imageInfo:g,indices:i,unit:o,mode:a});if(es(S.WorkerTypes.COMPUTE_STATISTICS,100),"collective"===a)return rk({stats:f,unit:o,spacing:c,segmentationImageData:s,imageVoxelManager:l});{let e={};return Object.entries(f).forEach(t=>{let[n,i]=t;e[n]=rk({stats:i,unit:o,spacing:c,segmentationImageData:s,imageVoxelManager:l})}),e}}let rU=(e,t)=>{if(!e.array)return;let n=e.array.findIndex(e=>e.name===t.name);-1!==n?e.array[n]=t:e.array.push(t)},rk=e=>{let{stats:t,unit:n,spacing:i,segmentationImageData:o,imageVoxelManager:a}=e;if(t.mean.unit=n,t.max.unit=n,t.min.unit=n,"SUV"!==n)return t;let r=i.map(e=>Math.max(1,Math.round(1.1*rR/e)));for(let e of t.maxIJKs){let l=function(e,t,n,i,o){let{pointIJK:a,pointLPS:r}=e;if(!a)return;let l=a.map((e,n)=>[e-t[n],e+t[n]]);return rN.default.statsInit({storePointData:!1}),w.utilities.pointInShapeCallback(n,{pointInShapeFn:(e,n)=>{let i=(n[0]-a[0])/t[0],o=(n[1]-a[1])/t[1],r=(n[2]-a[2])/t[2];return i*i+o*o+r*r<=1},callback:e=>{let{pointIJK:t,pointLPS:n}=e,o=i.getAtIJKPoint(t);void 0!==o&&rN.default.statsCallback({value:o,pointLPS:n,pointIJK:t})},boundsIJK:l}),rN.default.getStatistics({spacing:o})}(e,r,o,a,i);if(!l)continue;let{mean:s}=l;(!t.peakValue||t.peakValue.value<=s.value)&&(t.peakValue={name:"peakValue",label:"Peak Value",value:s.value,unit:n},t.peakPoint={name:"peakLPS",label:"Peak SUV Point",value:e.pointLPS?[...e.pointLPS]:null,unit:null},rU(t,t.peakValue),rU(t,t.peakPoint))}if(t.volume&&t.mean){let e=t.volume.value,i=t.mean.value;t.lesionGlycolysis={name:"lesionGlycolysis",label:"Lesion Glycolysis",value:e*i,unit:"".concat(t.volume.unit,"").concat(n)},rU(t,t.lesionGlycolysis)}return t};async function rV(e){let{segImageIds:t,indices:n,unit:i,mode:o}=e;es(S.WorkerTypes.COMPUTE_STATISTICS,0);let{segmentationInfo:a,imageInfo:r}=eu(t),l=await (0,E.getWebWorkerManager)().executeTask("compute","calculateSegmentsStatisticsStack",{segmentationInfo:a,imageInfo:r,indices:n,mode:o});es(S.WorkerTypes.COMPUTE_STATISTICS,100);let s=a[0].spacing,d=a[0],c=r[0].voxelManager;if("collective"===o)return rk({stats:l,unit:i,spacing:s,segmentationImageData:d,imageVoxelManager:c});{let e={};return Object.entries(l).forEach(t=>{let[n,o]=t;e[n]=rk({stats:o,unit:i,spacing:s,segmentationImageData:d,imageVoxelManager:c})}),e}}let rF=async function e(e){let{segmentationId:t,segmentIndices:n,mode:i="collective"}=e;(0,y.registerComputeWorker)(),es(S.WorkerTypes.COMPUTE_STATISTICS,0);let o=ed(t,n);if(!o)return;let{operationData:a,segVolumeId:r,segImageIds:l,reconstructableVolume:s,indices:d}=o,{refImageId:c,modalityUnitOptions:u}=((e,t)=>{var n;let i;if(e){let t=I.cache.getVolume(e).imageIds,n=I.cache.getImage(t[0]);n&&(i=n.referencedImageId)}else(null==t?void 0:t.length)&&(i=I.cache.getImage(t[0]).referencedImageId);let o=I.cache.getImage(i),a=A.metaData.get("scalingModule",i);return{refImageId:i,modalityUnitOptions:{isPreScaled:!!(null==o||null==(n=o.preScale)?void 0:n.scaled),isSuvScaled:"number"==typeof(null==a?void 0:a.suvbw)}}})(r,l),h=iZ(c,u);return s?await rL({operationData:a,indices:d,unit:h,mode:i}):await rV({segImageIds:l,indices:d,unit:h,mode:i})},rB={determineSegmentIndex:rp,dynamicThreshold:rI,erase:rE,islandRemoval:rx,preview:rD,regionFill:rM,setValue:rO,threshold:rP,labelmapStatistics:{[ei.GetStatistics]:function(e,t,n){let{indices:i}=n,{segmentationId:o,viewport:a}=t;rF({segmentationId:o,segmentIndices:i})}},ensureSegmentationVolumeFor3DManipulation:ea,ensureImageVolumeFor3DManipulation:el};class rG{initialize(e,t,n){let{viewport:i}=e,o=en({operationData:t,viewport:i,strategy:this});if(!o)return null;let{imageVoxelManager:a,segmentationVoxelManager:r,segmentationImageData:l}=o,s=t.createMemo(t.segmentationId,r),d={operationName:n,...t,segmentIndex:t.segmentIndex,enabledElement:e,imageVoxelManager:a,segmentationVoxelManager:r,segmentationImageData:l,viewport:i,centerWorld:null,isInObject:null,isInObjectBoundsIJK:null,brushStrategy:this,memo:s};return this._initialize.forEach(e=>e(d)),d}constructor(e,...t){for(let n of(this._initialize=[],this._fill=[],this._onInteractionStart=[],this.fill=(e,t)=>{let n=this.initialize(e,t,ei.Fill);if(!n)return;this._fill.forEach(e=>e(n));let{segmentationVoxelManager:i,segmentIndex:o}=n;return n8(n.segmentationId,i.getArrayOfModifiedSlices(),o),n},this.onInteractionStart=(e,t)=>{let n=this.initialize(e,t);n&&this._onInteractionStart.forEach(e=>e.call(this,n))},this.addPreview=(e,t)=>{let n=this.initialize(e,t,ei.AddPreview);if(n)return n},this.configurationName=e,this.compositions=t,t.forEach(e=>{let t="function"==typeof e?e():e;if(t)for(let e in t){if(!rG.childFunctions[e])throw Error("Didn't find ".concat(e," as a brush strategy"));rG.childFunctions[e](this,t[e])}}),this.strategyFunction=(e,t)=>this.fill(e,t),Object.keys(rG.childFunctions)))this.strategyFunction[n]=this[n]}}function rW(e,t){let n="_".concat(e);return(i,o)=>{i[n]||(i[n]=[]),i[n].push(o),i[e]||(i[e]=t?function(o,a){let r;for(var l=arguments.length,s=Array(l>2?l-2:0),d=2;d<l;d++)s[d-2]=arguments[d];let c=i[t](o,a,e);return i[n].forEach(e=>{let t=e.call(i,c,...s);r||(r=t)}),r}:function(e){for(var t=arguments.length,o=Array(t>1?t-1:0),a=1;a<t;a++)o[a-1]=arguments[a];i[n].forEach(t=>t.call(i,e,...o))})}}function rz(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return(n,i)=>{if(n[e])throw Error("The singleton method ".concat(e," already exists"));n[e]=t?i:function(e,t){for(var o=arguments.length,a=Array(o>2?o-2:0),r=2;r<o;r++)a[r-2]=arguments[r];return t.enabledElement=e,i.call(n,t,...a)}}}function rq(e,t){let{center:n,radius:i}=e,o=e.radius2||i*i;return(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])<=o}rG.COMPOSITIONS=rB,rG.childFunctions={[ei.OnInteractionStart]:rW(ei.OnInteractionStart,ei.Initialize),[ei.OnInteractionEnd]:rW(ei.OnInteractionEnd,ei.Initialize),[ei.Fill]:rW(ei.Fill),[ei.Initialize]:rW(ei.Initialize),[ei.CreateIsInThreshold]:rz(ei.CreateIsInThreshold),[ei.Interpolate]:rW(ei.Interpolate,ei.Initialize),[ei.AcceptPreview]:rW(ei.AcceptPreview,ei.Initialize),[ei.RejectPreview]:rW(ei.RejectPreview,ei.Initialize),[ei.INTERNAL_setValue]:rz(ei.INTERNAL_setValue),[ei.Preview]:rz(ei.Preview,!1),[ei.ComputeInnerCircleRadius]:rW(ei.ComputeInnerCircleRadius),[ei.EnsureSegmentationVolumeFor3DManipulation]:rW(ei.EnsureSegmentationVolumeFor3DManipulation),[ei.EnsureImageVolumeFor3DManipulation]:rW(ei.EnsureImageVolumeFor3DManipulation),[ei.AddPreview]:rW(ei.AddPreview),[ei.GetStatistics]:rz(ei.GetStatistics),compositions:null},e.s(["pointInSphere",()=>rq],649440);let{transformWorldToIndex:rH,transformIndexToWorld:rj,isEqual:rK}=w.utilities;function rY(e){let[t,n,i,o]=e,a=[i[0],n[1]],r=[o[0],t[1]];return[a,r,[i[0],t[1]],[o[0],n[1]]]}let rX={[ei.Initialize]:e=>{let{points:t,viewport:n,segmentationImageData:i,viewUp:o,viewPlaneNormal:a}=e;if(!t)return;let r=eA.vec3.create();t.length>=2?(eA.vec3.add(r,t[0],t[1]),eA.vec3.scale(r,r,.5)):eA.vec3.copy(r,t[0]),e.centerWorld=r,e.centerIJK=rH(i,r);let l=t.length>=2?eA.vec3.distance(t[0],t[1])/2:0,s=rY(t.map(e=>n.worldToCanvas(e))).map(e=>n.canvasToWorld(e)),d=eA.vec3.fromValues(o[0],o[1],o[2]);eA.vec3.normalize(d,d);let c=eA.vec3.fromValues(a[0],a[1],a[2]);eA.vec3.normalize(c,c);let u=eA.vec3.create();eA.vec3.cross(u,d,c),eA.vec3.normalize(u,u);let h=(e.strokePointsWorld&&e.strokePointsWorld.length>0?e.strokePointsWorld:[e.centerWorld]).map(e=>eA.vec3.clone(e)),g=h.flatMap(e=>(function(e,t,n,i){let o=eA.vec3.fromValues(e[0],e[1],e[2]),a=eA.vec3.create();eA.vec3.scaleAndAdd(a,o,t,i);let r=eA.vec3.create();eA.vec3.scaleAndAdd(r,o,t,-i);let l=eA.vec3.create();eA.vec3.scaleAndAdd(l,o,n,i);let s=eA.vec3.create();return eA.vec3.scaleAndAdd(s,o,n,-i),[r,a,s,l]})(e,d,u,l)).map(e=>rH(i,e)),f=(0,nQ.getBoundingBoxAroundShapeIJK)(g,i.getDimensions());e.strokePointsWorld=h,e.isInObject=rZ(s,{strokePointsWorld:h,segmentationImageData:i,radius:l}),e.isInObjectBoundsIJK=f}};function rZ(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t||4!==t.length)throw Error("createPointInEllipse: cornersInWorld must have 4 points");let[i,o,a,r]=t,l=eA.vec3.create();eA.vec3.add(l,i,o),eA.vec3.scale(l,l,.5);let s=eA.vec3.create();eA.vec3.subtract(s,r,i);let d=eA.vec3.length(s)/2;eA.vec3.normalize(s,s);let c=eA.vec3.create();eA.vec3.subtract(c,a,i);let u=eA.vec3.length(c)/2;eA.vec3.normalize(c,c);let h=eA.vec3.create();eA.vec3.cross(h,s,c),eA.vec3.normalize(h,h);let g=null!=(e=n.radius)?e:Math.max(d,u),f=function(e,t){if(!e.length||t<=0)return null;let n=t*t,i=e.map(e=>[e[0],e[1],e[2]]),o=[];for(let e=1;e<i.length;e++){let t=i[e-1],n=i[e],a=n[0]-t[0],r=n[1]-t[1],l=n[2]-t[2],s=a*a+r*r+l*l;o.push({start:t,vector:[a,r,l],lengthSquared:s})}return e=>{if(!e)return!1;for(let t of i){let i=e[0]-t[0],o=e[1]-t[1],a=e[2]-t[2];if(i*i+o*o+a*a<=n)return!0}for(let{start:t,vector:i,lengthSquared:a}of o){if(0===a){let i=e[0]-t[0],o=e[1]-t[1],a=e[2]-t[2];if(i*i+o*o+a*a<=n)return!0;continue}let o=e[0]-t[0],r=e[1]-t[1],l=e[2]-t[2],s=Math.max(0,Math.min(1,(o*i[0]+r*i[1]+l*i[2])/a)),d=t[0]+i[0]*s,c=t[1]+i[1]*s,u=t[2]+i[2]*s,h=e[0]-d,g=e[1]-c,f=e[2]-u;if(h*h+g*g+f*f<=n)return!0}return!1}}(n.strokePointsWorld||[],g);if(rK(d,u)){let e={center:l,radius:d,radius2:d*d};return(t,i)=>{let o=t;return!o&&i&&n.segmentationImageData&&(o=rj(n.segmentationImageData,i)),!!o&&(null!=f&&!!f(o)||rq(e,o))}}return(e,t)=>{let o=e;if(!o&&t&&n.segmentationImageData&&(o=rj(n.segmentationImageData,t)),!o)return!1;if(null==f?void 0:f(o))return!0;let a=eA.vec3.create();eA.vec3.subtract(a,o,l);let r=eA.vec3.dot(a,h),g=eA.vec3.create();eA.vec3.scaleAndAdd(g,a,h,-r);let m=eA.vec3.create(),v=eA.vec3.create();eA.vec3.subtract(v,l,i),eA.vec3.subtract(m,g,v);let p=eA.vec3.dot(m,s),I=eA.vec3.dot(m,c);return p*p/(d*d)+I*I/(u*u)<=1}}let rJ=new rG("Circle",rB.regionFill,rB.setValue,rX,rB.determineSegmentIndex,rB.preview,rB.labelmapStatistics),rQ=new rG("CircleThreshold",rB.regionFill,rB.setValue,rX,rB.determineSegmentIndex,rB.dynamicThreshold,rB.threshold,rB.preview,rB.islandRemoval,rB.labelmapStatistics),r$=rJ.strategyFunction,r0=rQ.strategyFunction;var r1=e.i(518519);let{transformWorldToIndex:r2}=w.utilities,r3={[ei.Initialize]:e=>{let{points:t,viewport:n,segmentationImageData:i}=e;if(!t)return;let o=eA.vec3.create();t.length>=2?(eA.vec3.add(o,t[0],t[1]),eA.vec3.scale(o,o,.5)):eA.vec3.copy(o,t[0]),e.centerWorld=o,e.centerIJK=r2(i,o);let a=(0,r1.getSphereBoundsInfoFromViewport)(t.slice(0,2),i,n),r=rY(t.map(e=>n.worldToCanvas(e))).map(e=>n.canvasToWorld(e)),l=t.length>=2?eA.vec3.distance(t[0],t[1])/2:void 0,s=e.strokePointsWorld&&e.strokePointsWorld.length>0?e.strokePointsWorld:[e.centerWorld],d=a.boundsIJK,c=e.centerIJK,u=s.reduce((e,t)=>{if(!t)return e;let n=r2(i,t),o=[n[0]-c[0],n[1]-c[1],n[2]-c[2]],a=[[d[0][0]+o[0],d[0][1]+o[0]],[d[1][0]+o[1],d[1][1]+o[1]],[d[2][0]+o[2],d[2][1]+o[2]]];return e?[[Math.min(e[0][0],a[0][0]),Math.max(e[0][1],a[0][1])],[Math.min(e[1][0],a[1][0]),Math.max(e[1][1],a[1][1])],[Math.min(e[2][0],a[2][0]),Math.max(e[2][1],a[2][1])]]:a},null),h=null!=u?u:a.boundsIJK;if(i){let t=i.getDimensions();e.isInObjectBoundsIJK=[[Math.max(0,Math.min(h[0][0],t[0]-1)),Math.max(0,Math.min(h[0][1],t[0]-1))],[Math.max(0,Math.min(h[1][0],t[1]-1)),Math.max(0,Math.min(h[1][1],t[1]-1))],[Math.max(0,Math.min(h[2][0],t[2]-1)),Math.max(0,Math.min(h[2][1],t[2]-1))]]}else e.isInObjectBoundsIJK=h;e.isInObject=rZ(r,{strokePointsWorld:e.strokePointsWorld,segmentationImageData:i,radius:l})}},r5=new rG("Sphere",rB.regionFill,rB.setValue,r3,rB.determineSegmentIndex,rB.preview,rB.labelmapStatistics,rB.ensureSegmentationVolumeFor3DManipulation),r4=r5.strategyFunction,r8=new rG("SphereThreshold",...r5.compositions,rB.dynamicThreshold,rB.threshold,rB.ensureSegmentationVolumeFor3DManipulation,rB.ensureImageVolumeFor3DManipulation),r6=new rG("SphereThreshold",...r5.compositions,rB.dynamicThreshold,rB.threshold,rB.islandRemoval,rB.ensureSegmentationVolumeFor3DManipulation,rB.ensureImageVolumeFor3DManipulation),r7=r8.strategyFunction,r9=r6.strategyFunction,le=new rG("EraseSphere",rB.erase,...r5.compositions).strategyFunction,lt=new rG("EraseCircle",rB.erase,...rJ.compositions).strategyFunction;e.s(["drawCircle",()=>ln],579816);let ln=function(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",{color:l,fill:s,width:d,lineWidth:c,lineDash:u,fillOpacity:h,strokeOpacity:g}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},a),f=n9(t,"circle",n),m=e.getSvgNode(f),v={cx:"".concat(i[0]),cy:"".concat(i[1]),r:"".concat(o),stroke:l,fill:s,"stroke-width":c||d,"stroke-dasharray":u,"fill-opacity":h,"stroke-opacity":g};if(m)it(v,m),e.setNodeTouched(f);else{let t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==r&&t.setAttribute("data-id",r),ie(v,t),e.appendNode(t,f)}};e.s(["BaseTool",()=>iP],460209),e.s(["createLabelmapMemo",()=>la,"createRleMemo",()=>ll,"restoreMemo",()=>lr],658319);let{VoxelManager:li,RLEVoxelMap:lo}=w.utilities;function la(e,t){return ll(e,t)}function lr(e){let{segmentationVoxelManager:t,undoVoxelManager:n,redoVoxelManager:i}=this,o=!1===e?i:n;o.forEach(e=>{let{value:n,pointIJK:i}=e;t.setAtIJKPoint(i,n)});let a=o.getArrayOfModifiedSlices();n8(this.segmentationId,a)}function ll(e,t){let n=li.createRLEHistoryVoxelManager(t);return{segmentationId:e,restoreMemo:lr,commitMemo:ls,segmentationVoxelManager:t,voxelManager:n,id:w.utilities.uuidv4(),operationType:"labelmap"}}function ls(){if(this.redoVoxelManager)return!0;if(!this.voxelManager.modifiedSlices.size)return!1;let{segmentationVoxelManager:e}=this,t=li.createRLEHistoryVoxelManager(e);for(let e of(lo.copyMap(t.map,this.voxelManager.map),this.voxelManager.modifiedSlices.keys()))t.modifiedSlices.add(e);this.undoVoxelManager=t;let n=li.createRLEVolumeVoxelManager({dimensions:this.segmentationVoxelManager.dimensions});return this.redoVoxelManager=n,t.forEach(t=>{let{index:i,pointIJK:o,value:a}=t,r=e.getAtIJKPoint(o);r!==a&&n.setAtIndex(i,r)}),!0}class ld extends iP{_historyRedoHandler(e){let{id:t,operationType:n}=e.detail;if("labelmap"===n){if(this.acceptedMemoIds.has(t)){this._hoverData=null;let e=this.acceptedMemoIds.get(t),n=null==e?void 0:e.element,i=this.getOperationData(n);i.segmentIndex=null==e?void 0:e.segmentIndex,n&&this.applyActiveStrategyCallback((0,e3.getEnabledElement)(n),i,ei.AcceptPreview)}this._previewData.isDrag=!0}}get _previewData(){return ld.previewData}hasPreviewData(){return!!this._previewData.preview}shouldResolvePreviewRequests(){return("Active"===this.mode||"Enabled"===this.mode)&&this.hasPreviewData()}createMemo(e,t){let n=t.id;if(this.memo&&this.memo.segmentationVoxelManager===t)return this.memo;let i=this.memoMap.get(n);return i?i.redoVoxelManager&&(i=ll(e,t),this.memoMap.set(n,i)):(i=ll(e,t),this.memoMap.set(n,i)),this.memo=i,i}createEditData(e){let{viewport:t}=(0,e3.getEnabledElement)(e),n=oG(t.id);if(!n){let e=new CustomEvent(C.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"No active segmentation detected, create a segmentation representation before using the brush tool"},cancelable:!0});return T.eventTarget.dispatchEvent(e),null}let{segmentationId:i}=n,o=re(i),{representationData:a}=H(i);return this.getEditData({viewport:t,representationData:a,segmentsLocked:o,segmentationId:i})}getEditData(e){let{viewport:t,representationData:n,segmentsLocked:i,segmentationId:o}=e;if(t instanceof x.BaseVolumeViewport){var a,r,l,s;let{volumeId:e}=n[_.default.Labelmap],o=t.getActors();if(t instanceof e0.StackViewport){let e=new CustomEvent(C.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"Cannot perform brush operation on the selected viewport"},cancelable:!0});return T.eventTarget.dispatchEvent(e),null}let d=o.map(e=>I.cache.getVolume(e.referencedId)),c=I.cache.getVolume(e),u=(null==(a=d.find(e=>w.utilities.isEqual(e.dimensions,c.dimensions)))?void 0:a.volumeId)||(null==(r=d[0])?void 0:r.volumeId);return{volumeId:e,referencedVolumeId:null!=(s=null==(l=this.configuration.threshold)?void 0:l.volumeId)?s:u,segmentsLocked:i}}{let e=K(t.id,o);if(!e)return;return{imageId:e,segmentsLocked:i}}}createHoverData(e,t){let{viewport:n}=(0,e3.getEnabledElement)(e),{viewPlaneNormal:i,viewUp:o}=n.getCamera(),a=[n.id],{segmentIndex:r,segmentationId:l,segmentColor:s}=this.getActiveSegmentationData(n)||{};return{brushCursor:{metadata:{viewPlaneNormal:[...i],viewUp:[...o],FrameOfReferenceUID:n.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:s},data:{}},centerCanvas:t,segmentIndex:r,viewport:n,segmentationId:l,segmentColor:s,viewportIdsToRender:a}}getActiveSegmentationData(e){let t=e.id,n=oG(t);if(!n)return;let{segmentationId:i}=n,o=j(i);if(!o)return;let a=rt(t,i,o);return{segmentIndex:o,segmentationId:i,segmentColor:a}}getOperationData(e){var t,n,i,o;let a=this._editData||this.createEditData(e),{segmentIndex:r,segmentationId:l,brushCursor:s}=this._hoverData||this.createHoverData(e),{data:d,metadata:c={}}=s||{},{viewPlaneNormal:u,viewUp:h}=c,g=null==(n=this.configuration.preview)||null==(t=n.previewColors)?void 0:t[r],{viewport:f}=(0,e3.getEnabledElement)(e),m=rt(f.id,l,r);if(!g&&!m)return;let v=null,p=null;return(null==(i=this.configuration.preview)?void 0:i.enabled)&&(v=g||function(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.4;return[Math.round(e+(255-e)*o),Math.round(t+(255-t)*o),Math.round(n+(255-n)*o),i]}(...m),p=255),{...a,points:null==d||null==(o=d.handles)?void 0:o.points,segmentIndex:r,viewPlaneNormal:u,previewOnHover:!this._previewData.isDrag,toolGroupId:this.toolGroupId,segmentationId:l,viewUp:h,centerSegmentIndexInfo:this.centerSegmentIndexInfo,activeStrategy:this.configuration.activeStrategy,configuration:this.configuration,previewColor:v,previewSegmentIndex:p,createMemo:this.createMemo.bind(this)}}addPreview(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._previewData.element,t=arguments.length>1?arguments[1]:void 0,{_previewData:n}=this,i=null==t?void 0:t.acceptReject;!0===i?this.acceptPreview(e):!1===i&&this.rejectPreview(e);let o=(0,e3.getEnabledElement)(e),a=this.applyActiveStrategyCallback(o,this.getOperationData(e),ei.AddPreview);return n.isDrag=!0,(null==a?void 0:a.modified)&&(n.preview=a,n.element=e),a}rejectPreview(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._previewData.element;if(!e)return;this.doneEditMemo();let t=(0,e3.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),ei.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1}acceptPreview(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._previewData.element;if(!e)return;let t=this.getOperationData(e);this.memo&&this.memo.id&&this.acceptedMemoIds.set(this.memo.id,{element:e,segmentIndex:t.segmentIndex});let n=(0,e3.getEnabledElement)(e);this.applyActiveStrategyCallback(n,t,ei.AcceptPreview),this.doneEditMemo(),this._previewData.preview=null,this._previewData.isDrag=!1}static viewportContoursToLabelmap(e,t){var n,i;let o=null==(n=null==t?void 0:t.removeContours)||n,a=iB(e,(0,ep.getAllAnnotations)());if(!(null==a?void 0:a.length))return;let r=a.filter(e=>{var t,n;return null==(n=e.data.contour)||null==(t=n.polyline)?void 0:t.length});if(!r.length)return;let{memo:l,segmentationId:s}=new ld({},{configuration:{strategies:{FILL_INSIDE_CIRCLE:r$},activeStrategy:"FILL_INSIDE_CIRCLE"}}).addPreview(e.element),d=null==l?void 0:l.voxelManager,c=d.sourceVoxelManager||d,{dimensions:u}=d,h=e.getDefaultActor().actor.getMapper().getInputData();for(let e of r){let t=[[1/0,-1/0],[1/0,-1/0],[1/0,-1/0]],{polyline:n}=e.data.contour;for(let e of n)h.worldToIndex(e).forEach((e,n)=>{t[n][0]=Math.min(t[n][0],e),t[n][1]=Math.max(t[n][1],e)});t.forEach((e,t)=>{e[0]=Math.round(Math.max(0,e[0])),e[1]=Math.round(Math.min(u[t]-1,e[1]))});let a=j(s),r=(null==(i=e.data.handles)?void 0:i[0])||n[0],l=h.worldToIndex(r).map(Math.round),g=c.getAtIJKPoint(l)||0,f=!1,m=!1;for(let e of n){let t=h.worldToIndex(e).map(Math.round),n=c.getAtIJKPoint(t);n===g?f=!0:n>=0&&(m=!0)}let v=f&&m?g:0===g?a:0;for(let e=t[0][0];e<=t[0][1];e++)for(let i=t[1][0];i<=t[1][1];i++)for(let o=t[2][0];o<=t[2][1];o++)e6(h.indexToWorld([e,i,o]),n)&&d.setAtIJK(e,i,o,v);o&&(0,ep.removeAnnotation)(e.annotationUID)}n8(s,d.getArrayOfModifiedSlices())}constructor(e,t){super(e,t),this.memoMap=new Map,this.acceptedMemoIds=new Map,this.centerSegmentIndexInfo={segmentIndex:null,hasSegmentIndex:!1,hasPreviewIndex:!1,changedIndices:[]}}}ld.previewData={preview:null,element:null,timerStart:0,timer:null,startPoint:[NaN,NaN],isDrag:!1};class lc extends ld{disableCursor(){this._hoverData=void 0,this.rejectPreview()}updateCursor(e){let t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas;this._hoverData=this.createHoverData(n,o),this._calculateCursor(n,o),this._hoverData&&(0,ne.default)(this._hoverData.viewportIdsToRender)}_calculateCursor(e,t){let{viewport:n}=(0,e3.getEnabledElement)(e),{canvasToWorld:i}=n,o=n.getCamera(),{brushSize:a}=this.configuration,r=eA.vec3.fromValues(o.viewUp[0],o.viewUp[1],o.viewUp[2]),l=eA.vec3.fromValues(o.viewPlaneNormal[0],o.viewPlaneNormal[1],o.viewPlaneNormal[2]),s=eA.vec3.create();eA.vec3.cross(s,r,l);let d=i([t[0],t[1]]),c=eA.vec3.create(),u=eA.vec3.create(),h=eA.vec3.create(),g=eA.vec3.create();for(let e=0;e<=2;e++)c[e]=d[e]-r[e]*a,u[e]=d[e]+r[e]*a,h[e]=d[e]-s[e]*a,g[e]=d[e]+s[e]*a;if(!this._hoverData)return;let{brushCursor:f}=this._hoverData,{data:m}=f;void 0===m.handles&&(m.handles={}),m.handles.points=[c,u,h,g];let v=this.configuration.activeStrategy,p=this.configuration.strategies[v];"function"==typeof(null==p?void 0:p.computeInnerCircleRadius)&&p.computeInnerCircleRadius({configuration:this.configuration,viewport:n}),m.invalidated=!1}getStatistics(e,t){if(!e)return;let n=(0,e3.getEnabledElement)(e);return this.applyActiveStrategyCallback(n,this.getOperationData(e),ei.GetStatistics,t)}rejectPreview(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._previewData.element;if(!e)return;this.doneEditMemo();let t=(0,e3.getEnabledElement)(e);t&&(this.applyActiveStrategyCallback(t,this.getOperationData(e),ei.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1)}acceptPreview(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._previewData.element;e&&super.acceptPreview(e)}interpolate(e,t){if(!e)return;let n=(0,e3.getEnabledElement)(e);this._previewData.preview=this.applyActiveStrategyCallback(n,this.getOperationData(e),ei.Interpolate,t.configuration),this._previewData.isDrag=!0}invalidateBrushCursor(){if(void 0===this._hoverData)return;let{data:e}=this._hoverData.brushCursor,{viewport:t}=this._hoverData;e.invalidated=!0;let{segmentColor:n}=this.getActiveSegmentationData(t)||{};this._hoverData.brushCursor.metadata.segmentColor=n}renderAnnotation(e,t){var n,i;if(!this._hoverData)return;let{viewport:o}=e;if(!this._hoverData.viewportIdsToRender.includes(o.id))return;let a=this._hoverData.brushCursor;if(!0===a.data.invalidated){let{centerCanvas:e}=this._hoverData,{element:t}=o;this._calculateCursor(t,e)}let r=a.metadata;if(!r)return;let l=r.brushCursorUID,{points:s}=a.data.handles,d=s.map(e=>o.worldToCanvas(e)),c=d[0],u=d[1],h=[Math.floor((c[0]+u[0])/2),Math.floor((c[1]+u[1])/2)],g=Math.abs(c[1]-Math.floor((c[1]+u[1])/2)),f="rgb(".concat((null==(n=r.segmentColor)?void 0:n.slice(0,3))||[0,0,0],")");if(!o.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");ln(t,l,"0",h,g,{color:f,lineDash:0===this.centerSegmentIndexInfo.segmentIndex?[1,2]:null});let{dynamicRadiusInCanvas:m}=(null==(i=this.configuration)?void 0:i.threshold)||{dynamicRadiusInCanvas:0};m&&ln(t,l,"1",h,m,{color:f})}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:r$,ERASE_INSIDE_CIRCLE:lt,FILL_INSIDE_SPHERE:r4,ERASE_INSIDE_SPHERE:le,THRESHOLD_INSIDE_CIRCLE:r0,THRESHOLD_INSIDE_SPHERE:r7,THRESHOLD_INSIDE_SPHERE_WITH_ISLAND_REMOVAL:r9},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25,useCenterSegmentIndex:!1,preview:{enabled:!1,previewColors:{0:[255,255,255,128]},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},actions:{[ei.AcceptPreview]:{method:ei.AcceptPreview,bindings:[{key:"Enter"}]},[ei.RejectPreview]:{method:ei.RejectPreview,bindings:[{key:"Escape"}]},[ei.Interpolate]:{method:ei.Interpolate,bindings:[{key:"i"}],configuration:{useBallStructuringElement:!0,noUseDistanceTransform:!0,noUseExtrapolation:!0}},interpolateExtrapolation:{method:ei.Interpolate,bindings:[{key:"e"}],configuration:{}}}}}){super(e,t),this._lastDragInfo=null,this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{let{element:t,currentPoints:n}=e.detail,i=(0,e3.getEnabledElement)(t),{viewport:o}=i;this._editData=this.createEditData(t),this._activateDraw(t),iA(t),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now();let a=eM.vec2.clone(n.canvas),r=o.canvasToWorld([a[0],a[1]]);this._lastDragInfo={canvas:a,world:eA.vec3.clone(r)};let l=this._hoverData||this.createHoverData(t);(0,ne.default)(l.viewportIdsToRender);let s=this.getOperationData(t);return this.applyActiveStrategyCallback(i,s,ei.OnInteractionStart),!0},this.mouseMoveCallback=e=>{if(this.mode===nn.ToolModes.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;let{previewTimeMs:t,previewMoveDistance:n,dragMoveDistance:i}=this.configuration.preview,{currentPoints:o,element:a}=e.detail,{canvas:r}=o,{startPoint:l,timer:s,timerStart:d,isDrag:c}=this._previewData;if(c)return;let u=eM.vec2.distance(r,l),h=Date.now()-d;if((u>n||h>t&&u>i)&&(s&&(window.clearTimeout(s),this._previewData.timer=null),c||this.rejectPreview(a)),!this._previewData.timer){let e=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:e,startPoint:r,element:a})}}},this.previewCallback=()=>{if(this._previewData.isDrag){this._previewData.timer=null;return}this._previewData.timer=null;let e=this.getOperationData(this._previewData.element),t=(0,e3.getEnabledElement)(this._previewData.element);if(!t)return;let{viewport:n}=t,i=en({operationData:e,viewport:n,strategy:this.configuration.activeStrategy});if(!e)return;let o=this.createMemo(e.segmentationId,i.segmentationVoxelManager);this._previewData.preview=this.applyActiveStrategyCallback((0,e3.getEnabledElement)(this._previewData.element),{...e,...i,memo:o},ei.Preview)},this._dragCallback=e=>{let{element:t,currentPoints:n}=e.detail,i=(0,e3.getEnabledElement)(t),{viewport:o}=i;this.updateCursor(e);let{viewportIdsToRender:a}=this._hoverData;(0,ne.default)(a);let r=eM.vec2.distance(n.canvas,this._previewData.startPoint),{dragTimeMs:l,dragMoveDistance:s}=this.configuration.preview;if(!this._previewData.isDrag&&Date.now()-this._previewData.timerStart<l&&r<s)return;if(this._previewData.timer&&(window.clearTimeout(this._previewData.timer),this._previewData.timer=null),!this._lastDragInfo){let e=this._previewData.startPoint,t=o.canvasToWorld([e[0],e[1]]);this._lastDragInfo={canvas:eM.vec2.clone(e),world:eA.vec3.clone(t)}}let d=n.canvas,c=o.canvasToWorld([d[0],d[1]]);this._hoverData=this.createHoverData(t,d),this._calculateCursor(t,d);let u=this.getOperationData(t);u.strokePointsWorld=[eA.vec3.clone(this._lastDragInfo.world),eA.vec3.clone(c)],this._previewData.preview=this.applyActiveStrategy(i,u);let h=eM.vec2.clone(d);this._lastDragInfo={canvas:h,world:eA.vec3.clone(c)},this._previewData.element=t,this._previewData.timerStart=Date.now()+l,this._previewData.isDrag=!0,this._previewData.startPoint=h},this._endCallback=e=>{let{element:t}=e.detail,n=(0,e3.getEnabledElement)(t),i=this.getOperationData(t);this._previewData.preview||this._previewData.isDrag||this.applyActiveStrategy(n,i),this.doneEditMemo(),this._deactivateDraw(t),ib(t),this.updateCursor(e),this._editData=null,this._lastDragInfo=null,this.applyActiveStrategyCallback(n,i,ei.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(t)},this._activateDraw=e=>{e.addEventListener(R.Events.MOUSE_UP,this._endCallback),e.addEventListener(R.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(R.Events.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(R.Events.MOUSE_UP,this._endCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this._endCallback)}}}function lu(e,t){let n=(0,rv.getToolGroup)(e);if(void 0===n)return[];let i=n._toolInstances;return Object.keys(i).length?t&&i[t]?[i[t]]:Object.values(i).filter(e=>e instanceof lc):[]}function lh(e,t,n){let i=(0,rv.getToolGroup)(e);if(void 0===i)return;lu(e,n).forEach(e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()});let o=i.getViewportsInfo(),a=Object.keys(o).map(e=>o[e]);if(!a.length)return;let{renderingEngineId:r}=a[0],l=i.getViewportIds();(0,or.getRenderingEngine)(r),(0,ne.default)(l)}function lg(e,t){let n=(0,rv.getToolGroup)(e);if(void 0===n||!Object.keys(n._toolInstances).length)return;let i=lu(e,t)[0];if(i)return i.configuration.brushSize}function lf(e,t){let n=(0,rv.getToolGroup)(e);if(void 0===n||(lu(e).forEach(e=>{e.configuration.activeStrategy.toLowerCase().includes("threshold")&&(e.configuration={...e.configuration,threshold:{...e.configuration.threshold,...t}})}),!n.getViewportsInfo().length))return;let i=n.getViewportIds();(0,ne.default)(i)}function lm(e){let t=(0,rv.getToolGroup)(e);if(void 0===t||!Object.keys(t._toolInstances).length)return;let n=lu(e)[0];if(n)return n.configuration.threshold.range}lc.toolName="Brush";var lv=e.i(310522);let lp=function(e,t,n,i,o){if(!o)throw Error("Segmentation ID is required to be passed inside thresholdSegmentationByRange");let{baseVolumeIdx:a,volumeInfoList:r}=n1(e,n),{voxelManager:l}=r[a],s=e.voxelManager.getScalarDataLength(),d=e.voxelManager;return r.forEach(e=>{let{volumeSize:n}=e;n===s?function(e,t,n,i){let{lower:o,upper:a}=i,r=e.getScalarDataLength();for(let i=0;i<r;i++)if(e.getAtIndex[i]===n){let r=t.getAtIndex(i);e.setAtIndex(i,r>=o&&r<=a?n:0)}}(d,l,t,e):function(e,t,n,i,o,a,r){let l,s,d,{imageData:c,lower:u,upper:h,dimensions:g}=i,f=e.getScalarDataLength();for(let t=0;t<f;t++)if(f.getAtIndex(t)===n){let i=n0(c,g,o[a].spacing,o[a].imageData.getPoint(t)),f=e=>{let{value:t}=e;l+=1,t>=d.lower&&t<=d.upper&&(s+=1)};l=0,s=0,d={lower:u,upper:h};let m=!1;e.forEach(f,{imageData:c,boundsIJK:i}),m=0===r?s>0:s===l,e.setAtIndex(t,m?n:0)}}(d,0,t,e,r,a,i)}),n8(o),e};var lI=e.i(185005);async function lE(e){let t=await eg({segmentations:e});if(!(null==t?void 0:t.length)||!t[0].sliceContours.length)return;let{segments:n=[null,{label:"Unspecified",color:null,containedSegmentIndices:null}]}=e,i=eo(e.segmentationId);if(!i)return;let o=n.findIndex(e=>!!e);if(-1!==o)return n[o].segmentIndex=o,(0,lI.default)(t[0],i.volumeId,n[o])}function lw(e,t){let{majorAxis:n,minorAxis:i,label:o="",sliceIndex:a}=e,[r,l]=n,[s,d]=i;return{highlighted:!0,invalidated:!0,metadata:{toolName:"Bidirectional",...t.getViewReference({sliceIndex:a})},data:{handles:{points:[r,l,s,d],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:o,cachedStats:{}},isLocked:!1,isVisible:!0}}function l_(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function lS(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],[a,r]=e,[l,s]=t,[d,c]=n,[u,h]=i;if(o){let e=(a-l)*(c-h)-(r-s)*(d-u);if(1e-10>Math.abs(e))return;let t=((a-d)*(c-h)-(r-c)*(d-u))/e;return[a+t*(l-a),r+t*(s-r)]}let g=s-r,f=a-l,m=l*r-a*s,v=g*d+f*c+m,p=g*u+f*h+m;if(0!==v&&0!==p&&l_(v)===l_(p))return;let I=h-c,E=d-u,w=u*c-d*h,_=I*a+E*r+w,S=I*l+E*s+w;if(0!==_&&0!==S&&l_(_)===l_(S))return;let y=g*E-I*f;return[(f*w-E*m)/y,(I*m-g*w)/y]}e.s(["intersectLine",()=>lS],477621);let{transformWorldToIndex:ly}=w.utilities;class lT extends ij{addNewAnnotation(e){let{currentPoints:t,element:n}=e.detail,i=t.world;this.isDrawing=!0;let o=this.createAnnotation(e,[[...i],[...i],[...i],[...i]]);(0,ep.addAnnotation)(o,n);let a=nd(n,this.getToolName());return this.editData={annotation:o,viewportIdsToRender:a,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(n),iA(n),e.preventDefault(),(0,ne.default)(a),o}_calculateLength(e,t){let n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:lC}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{let{viewport:o}=(0,e3.getEnabledElement)(e),{data:a}=t,{points:r}=a.handles,l=o.worldToCanvas(r[0]),s=o.worldToCanvas(r[1]),d={start:{x:l[0],y:l[1]},end:{x:s[0],y:s[1]}},c=iY([d.start.x,d.start.y],[d.end.x,d.end.y],[n[0],n[1]]);return c<=i||(l=o.worldToCanvas(r[2]),s=o.worldToCanvas(r[3]),(c=iY([(d={start:{x:l[0],y:l[1]},end:{x:s[0],y:s[1]}}).start.x,d.start.y],[d.end.x,d.end.y],[n[0],n[1]]))<=i)},this.toolSelectedCallback=(e,t)=>{let{element:n}=e.detail;t.highlighted=!0;let i=nd(n,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(n);let{renderingEngine:o}=(0,e3.getEnabledElement)(n);(0,ne.default)(i),iA(n),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{let i,{element:o}=e.detail,a=t.data;t.highlighted=!0;let r=!1;n.worldPosition?r=!0:i=a.handles.points.findIndex(e=>e===n);let l=nd(o,this.getToolName());iA(o),this.editData={annotation:t,viewportIdsToRender:l,handleIndex:i,movingTextBox:r},this._activateModify(o);let{renderingEngine:s}=(0,e3.getEnabledElement)(o);(0,ne.default)(l),e.preventDefault()},this._endCallback=e=>{let{element:t}=e.detail,{annotation:n,viewportIdsToRender:i,newAnnotation:o,hasMoved:a}=this.editData,{data:r}=n;if(o&&!a)return;this.doneEditMemo(),r.handles.activeHandleIndex=null,this._deactivateModify(t),this._deactivateDraw(t),ib(t);let{renderingEngine:l}=(0,e3.getEnabledElement)(t);if(void 0!==this.editData.handleIndex){let{points:e}=r.handles,t=eA.vec3.distance(e[0],e[1]);if(eA.vec3.distance(e[2],e[3])>t){let t,n=[[...e[2]],[...e[3]]],i=[...e[0]],o=[...e[1]],a=eM.vec2.create();eM.vec2.set(a,n[1][0]-n[0][0],n[1][1]-n[1][0]);let l=eM.vec2.create();eM.vec2.set(l,-a[1],a[0]);let s=eM.vec2.create();eM.vec2.set(s,o[0]-i[0],o[1]-i[0]),t=eM.vec2.dot(s,l)>0?[i,o]:[o,i],r.handles.points=[n[0],n[1],t[0],t[1]]}}this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,ep.removeAnnotation)(n.annotationUID),(0,ne.default)(i),o&&(0,tU.triggerAnnotationCompleted)(n),this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;let{currentPoints:t,element:n}=e.detail,{viewport:i}=(0,e3.getEnabledElement)(n),{worldToCanvas:o}=i,{annotation:a,viewportIdsToRender:r,handleIndex:l,newAnnotation:s}=this.editData;this.createMemo(n,a,{newAnnotation:s});let{data:d}=a,c=t.world;d.handles.points[l]=[...c];let u=d.handles.points.map(o),h={longLineSegment:{start:{x:u[0][0],y:u[0][1]},end:{x:u[1][0],y:u[1][1]}},shortLineSegment:{start:{x:u[2][0],y:u[2][1]},end:{x:u[3][0],y:u[3][1]}}},g=eM.vec2.distance(u[0],u[1])/3,f=h.longLineSegment.start.x-h.longLineSegment.end.x,m=h.longLineSegment.start.y-h.longLineSegment.end.y,v=Math.sqrt(f*f+m*m),p=f/v,I=m/v,E=(h.longLineSegment.start.x+h.longLineSegment.end.x)/2,w=(h.longLineSegment.start.y+h.longLineSegment.end.y)/2;d.handles.points[2]=i.canvasToWorld([E+g*I,w-g*p]),d.handles.points[3]=i.canvasToWorld([E-g*I,w+g*p]),a.invalidated=!0,(0,ne.default)(r),(0,tU.triggerAnnotationModified)(a,n,iK.ChangeTypes.HandlesUpdated),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r,newAnnotation:l}=this.editData;this.createMemo(n,i,{newAnnotation:l});let{data:s}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){let{deltaPoints:e}=t,n=e.world;s.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else this._dragModifyHandle(e),i.invalidated=!0;(0,ne.default)(o),i.invalidated&&(0,tU.triggerAnnotationModified)(i,n,iK.ChangeTypes.HandlesUpdated)},this._dragModifyHandle=e=>{let{currentPoints:t,element:n}=e.detail,{viewport:i}=(0,e3.getEnabledElement)(n),{annotation:o,handleIndex:a}=this.editData,{data:r}=o,l=t.world,s=[i.worldToCanvas(r.handles.points[0]),i.worldToCanvas(r.handles.points[1]),i.worldToCanvas(r.handles.points[2]),i.worldToCanvas(r.handles.points[3])],d={start:{x:s[0][0],y:s[0][1]},end:{x:s[1][0],y:s[1][1]}},c={start:{x:s[2][0],y:s[2][1]},end:{x:s[3][0],y:s[3][1]}},u=[...l],h=i.worldToCanvas(u);if(0===a||1===a){let e=s[+(0===a)],t=eM.vec2.set(eM.vec2.create(),h[0]-e[0],h[1]-e[1]),n=eM.vec2.set(eM.vec2.create(),s[a][0]-e[0],s[a][1]-e[1]);eM.vec2.normalize(t,t),eM.vec2.normalize(n,n);let o={start:{x:e[0],y:e[1]},end:{x:h[0],y:h[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(o,c))return;let l=this._getSignedAngle(n,t),d=s[2][0],g=s[2][1],f=s[3][0],m=s[3][1];d-=e[0],g-=e[1],f-=e[0],m-=e[1];let v=d*Math.cos(l)-g*Math.sin(l),p=d*Math.sin(l)+g*Math.cos(l),I=f*Math.cos(l)-m*Math.sin(l),E=f*Math.sin(l)+m*Math.cos(l);d=v+e[0],g=p+e[1],f=I+e[0],m=E+e[1];let w=i.canvasToWorld([d,g]),_=i.canvasToWorld([f,m]);r.handles.points[a]=u,r.handles.points[2]=w,r.handles.points[3]=_}else{let e=2===a?3:2,t={longLineSegment:{start:d.start,end:d.end},shortLineSegment:{start:c.start,end:c.end}},n=eM.vec2.subtract(eM.vec2.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),o=eM.vec2.normalize(eM.vec2.create(),n),l=eM.vec2.subtract(eM.vec2.create(),[h[0],h[1]],[s[a][0],s[a][1]]),g=eM.vec2.length(l),f=Math.cos(this._getSignedAngle(o,l))*g,m=eM.vec2.scaleAndAdd(eM.vec2.create(),[s[e][0],s[e][1]],o,f);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:h[0],y:h[1]},end:{x:m[0],y:m[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}})||!lS([h[0],h[1]],[m[0],m[1]],[d.start.x,d.start.y],[d.end.x,d.end.y]))return;r.handles.points[e]=i.canvasToWorld(m),r.handles.points[a]=u}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),ib(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;return t.highlighted=!1,o.handles.activeHandleIndex=null,(0,ne.default)(n),i&&(0,tU.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{nc.state.isInteractingWithTool=!0,e.addEventListener(R.Events.MOUSE_UP,this._endCallback),e.addEventListener(R.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(R.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(R.Events.TOUCH_TAP,this._endCallback),e.addEventListener(R.Events.TOUCH_END,this._endCallback),e.addEventListener(R.Events.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{nc.state.isInteractingWithTool=!1,e.removeEventListener(R.Events.MOUSE_UP,this._endCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(R.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(R.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(R.Events.TOUCH_END,this._endCallback),e.removeEventListener(R.Events.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{nc.state.isInteractingWithTool=!0,e.addEventListener(R.Events.MOUSE_UP,this._endCallback),e.addEventListener(R.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(R.Events.TOUCH_END,this._endCallback),e.addEventListener(R.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(R.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{nc.state.isInteractingWithTool=!1,e.removeEventListener(R.Events.MOUSE_UP,this._endCallback),e.removeEventListener(R.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(R.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(R.Events.TOUCH_END,this._endCallback),e.removeEventListener(R.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(R.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0,{viewport:i}=e,{element:o}=i,a=(0,ep.getAnnotations)(this.getToolName(),o);if(!(null==a?void 0:a.length)||!(null==(a=this.filterInteractableAnnotationsForElement(o,a))?void 0:a.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){let d,c,u=a[o],{annotationUID:h,data:g}=u,{points:f,activeHandleIndex:m}=g.handles,v=f.map(e=>i.worldToCanvas(e));s.annotationUID=h;let{color:p,lineWidth:I,lineDash:E,shadow:w}=this.getAnnotationStyle({annotation:u,styleSpecifier:s});if(g.cachedStats[r]&&null!=g.cachedStats[r].unit?u.invalidated&&this._throttledCalculateCachedStats(u,l,e):(g.cachedStats[r]={length:null,width:null,unit:null},this._calculateCachedStats(u,l,e)),!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!tB(h))continue;tf(h)||this.editData||null===m||(d=[v[m]]);let _=!!tN("showHandlesAlways",{});(d||_)&&io(t,h,"0",_?v:d,{color:p});let S="".concat(h,"-line-1"),y="".concat(h,"-line-2");ic(t,h,"0",v[0],v[1],{color:p,lineDash:E,lineWidth:I,shadow:w},S),ic(t,h,"1",v[2],v[3],{color:p,lineDash:E,lineWidth:I,shadow:w},y),n=!0;let T=this.getLinkedTextBoxStyle(s,u);if(!T.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}let C=this.configuration.getTextLines(g,r);if(!C||0===C.length)continue;g.handles.textBox.hasMoved||(c=ip(v),g.handles.textBox.worldPosition=i.canvasToWorld(c));let{x:b,y:A,width:x,height:D}=ig(t,h,"1",C,i.worldToCanvas(g.handles.textBox.worldPosition),v,{},T);g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([b,A]),topRight:i.canvasToWorld([b+x,A]),bottomLeft:i.canvasToWorld([b,A+D]),bottomRight:i.canvasToWorld([b+x,A+D])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{let n=eM.vec2.create();eM.vec2.set(n,t.end.x-t.start.x,t.end.y-t.start.y),eM.vec2.normalize(n,n);let i={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!lS([i.start.x,i.start.y],[i.end.x,i.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{let{data:i}=e,{element:o}=n.viewport,a=i.handles.points[0],r=i.handles.points[1],l=i.handles.points[2],s=i.handles.points[3],{cachedStats:d}=i,c=Object.keys(d);for(let e=0;e<c.length;e++){let t=c[e],n=this.getTargetImageData(t);if(!n)continue;let{imageData:i,dimensions:o}=n,u=ly(i,a),h=ly(i,r),g=ly(i,l),f=ly(i,s),m=[u,h],v=[g,f],{scale:p,unit:I}=(0,n7.getCalibratedLengthUnitsAndScale)(n,m),{scale:E,unit:w}=(0,n7.getCalibratedLengthUnitsAndScale)(n,v),_=this._calculateLength(a,r)/p,S=this._calculateLength(l,s)/E,y=_>S?_:S,T=_>S?S:_,C=_>S?I:w,b=_>S?w:I;this._isInsideVolume(u,h,g,f,o)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,d[t]={length:y,width:T,unit:C,widthUnit:b}}let u=e.invalidated;return e.invalidated=!1,u&&(0,tU.triggerAnnotationModified)(e,o,iK.ChangeTypes.StatsUpdated),d},this._isInsideVolume=(e,t,n,i,o)=>w.utilities.indexWithinDimensions(e,o)&&w.utilities.indexWithinDimensions(t,o)&&w.utilities.indexWithinDimensions(n,o)&&w.utilities.indexWithinDimensions(i,o),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=(0,im.default)(this._calculateCachedStats,100,{trailing:!0})}}function lC(e,t){let{cachedStats:n,label:i}=e,{length:o,width:a,unit:r}=n[t],l=[];return i&&l.push(i),void 0===o||l.push("L: ".concat(w.utilities.roundNumber(o)," ").concat(r||r),"W: ".concat(w.utilities.roundNumber(a)," ").concat(r)),l}function lb(){return q.getState().segmentations}async function lA(e,t){let n;console.warn("Deprecation Alert: There is a new getSegmentLargestBidirectional function that handles volume, stack and individual segment cases properly. This function is deprecated and will be removed in a future version.");let{data:i}=t,o=(0,e3.getEnabledElement)(e),a=(i.getSegment||function(e,t){var n,i;let o=lb();if(!o.length)return;let a=t.segmentationId||o[0].segmentationId,r=null!=(i=t.segmentIndex)?i:j(a);if(!r)return;let l=null==(n=t.segmentData)?void 0:n.get(r);return{label:"Segment ".concat(r),segmentIndex:r,segmentationId:a,...l}})(o,i);if(!a)return;let r=o.viewport.getFrameOfReferenceUID(),l=lb(),{segmentIndex:s,segmentationId:d}=a,c=tZ.getAnnotations(this.toolName||lT.toolName,r),u=!1,h=c.filter(e=>{let t=e.data.segment;return!!t&&(t.segmentationId===d&&t.segmentIndex===s&&(u=!0,e.data.segment=t),!0)});if(u||h.push({data:{segment:a}}),h.forEach(async e=>{let t=[],i=e.data.segment,{segmentIndex:s,segmentationId:d}=i;t[s]=i,tZ.removeAnnotation(e.annotationUID);let c=await lE({...l.find(e=>e.segmentationId===d),segments:t});if(!c)return;let u=lw(c,o.viewport);u.annotationUID=e.annotationUID,u.data.segment=i;let h=tZ.addAnnotation(u,r);if(i.segmentIndex===a.segmentIndex&&i.segmentationId===a.segmentationId){n=c;let{style:e}=a;e&&tL.style.setAnnotationStyles(h,e)}}),n){let{sliceIndex:t}=n,i=o.viewport.getImageIds();w.utilities.jumpToSlice(e,{imageIndex:i.length-1-t}),o.viewport.render()}else console.warn("No bidirectional found");return n}function lx(e){let t=(0,rv.getToolGroup)(e);if(void 0===t)return;lu(e).forEach(e=>{e.invalidateBrushCursor()});let n=t.getViewportsInfo();if(!Object.keys(n).map(e=>n[e]).length)return;let i=t.getViewportIds();(0,ne.default)(i)}lT.toolName="Bidirectional",lT.hydrate=(e,t,n)=>{let i=(0,D.getEnabledElementByViewportId)(e);if(!i)return;let{FrameOfReferenceUID:o,referencedImageId:a,viewPlaneNormal:r,instance:l,viewport:s}=lT.hydrateBase(lT,i,t[0],n),[d,c]=t,[u,h]=d,[g,f]=c,{toolInstance:m,...v}=n||{},p={annotationUID:(null==n?void 0:n.annotationUID)||w.utilities.uuidv4(),data:{handles:{points:[u,h,g,f],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:l.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:o,referencedImageId:a,...v}};return(0,ep.addAnnotation)(p,s.element),(0,ne.default)([s.id]),p};var O=_;function lD(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=H(e),a=o.representationData,r=null!=(n=null==i?void 0:i.representationType)?n:Object.keys(a)[0];if(!r)throw Error("Segmentation ".concat(e," does not have any representations"));switch(r){case O.default.Labelmap:return function(e,t,n){let{viewport:i}=n,o=e.representationData.Labelmap;if(i instanceof x.BaseVolumeViewport){let{volumeId:e}=o,n=I.cache.getVolume(e);if(!n)return;return n.imageData.getScalarValueFromWorld(t)}let a=Y(i.id,e.segmentationId);if(a.length>1)return void console.warn("Segment selection for labelmaps with multiple imageIds in stack viewports is not supported yet.");let r=a[0];if(!I.cache.getImage(r))return;let l=Q(i.id,e.segmentationId),s=null==l?void 0:l.actor.getMapper().getInputData(),d=w.utilities.transformWorldToIndex(s,t),c=s.getDimensions();return(s.voxelManager||w.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:c,scalarData:s.getPointData().getScalars().getData()})).getAtIJKPoint(d)}(o,t,i);case O.default.Contour:return function(e,t,n){let{viewport:i}=n,o=e.representationData.Contour,a=Array.from(o.annotationUIDsMap.keys()),{viewPlaneNormal:r}=i.getCamera();for(let e of a){let n=o.annotationUIDsMap.get(e);if(n)for(let i of n){let n=(0,ep.getAnnotation)(i);if(!n)continue;let{polyline:o}=n.data.contour;if(w.utilities.isEqual(r,n.metadata.viewPlaneNormal)&&e6(t,o))return Number(e)}}}(o,t,i);default:return}}function lM(e,t,n){var i,o,a,r,l,s;let{viewport:d,searchRadius:c}=n,u=H(e).representationData.Labelmap;if(d instanceof x.BaseVolumeViewport){let{volumeId:e}=u,n=I.cache.getVolume(e);if(!n)return;let l=n.voxelManager,s=n.imageData,h=w.utilities.transformWorldToIndex(s,t),g=l.getAtIJK(h[0],h[1],h[2]);return(i=d.worldToCanvas(t),o=g,a=d,r=s,lO((e,t)=>{let n=[i[0]+e,i[1]+t],o=a.canvasToWorld(n),l=r.get("voxelManager").voxelManager,s=w.utilities.transformWorldToIndex(r,o);return l.getAtIJK(s[0],s[1],s[2])},o,c))?g:void 0}let h=K(d.id,e);if(!I.cache.getImage(h))return;let g=Q(d.id,e),f=null==g?void 0:g.actor.getMapper().getInputData(),m=w.utilities.transformWorldToIndex(f,t),v=f.getDimensions(),p=f.voxelManager||w.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:v,scalarData:f.getPointData().getScalars().getData()}),E=p.getAtIJKPoint(m);return(l=m,s=p,lO((e,t,n)=>{let i=[l[0]+e,l[1]+t,l[2]+n];return s.getAtIJK(i[0],i[1],i[2])},E,void 0))?E:void 0}function lO(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=Array.from({length:2*n+1},(e,t)=>t-n);for(let n of i)for(let o of i)for(let a of i){if(0===n&&0===o&&0===a)continue;let i=e(n,o,a);if(void 0!==i&&t!==i)return!0}return!1}function lP(e){let{annotationUIDsMap:t}=H(e).representationData.Contour;for(let[e,n]of t.entries())if(Array.from(n).find(e=>(0,ep.getAnnotation)(e).highlighted))return e}e.s(["run",()=>lR,"runGrowCutForBoundingBox",()=>lW,"runGrowCutForSphere",()=>lV,"runOneClickGrowCut",()=>lq],366980),e.s([],852721),e.i(852721);let lN={windowSize:3,maxProcessingTime:3e4,inspection:{numCyclesInterval:5,numCyclesBelowThreshold:3,threshold:1e-4}};async function lR(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:lN,{windowSize:o,maxProcessingTime:a}=Object.assign({},lN,i),r=Object.assign({},lN.inspection,i.inspection),l=I.cache.getVolume(e),s=I.cache.getVolume(t),[d,c,u]=l.dimensions;if(s.dimensions[0]!==d||s.dimensions[1]!==c||s.dimensions[2]!==u)throw Error("Volume and labelmap must have the same size");let h=Math.floor(Math.sqrt(c**2+d**2+u**2)/2);h=Math.min(h,500);let g=s.voxelManager.getCompleteScalarDataArray(),f=l.voxelManager.getCompleteScalarDataArray();f instanceof Float32Array||(f=new Float32Array(f));let m=await (null==(n=navigator.gpu)?void 0:n.requestAdapter()),v=await m.requestDevice({requiredLimits:{maxStorageBufferBindingSize:2136746229.76,maxBufferSize:2136746229.76}}),p=f.byteLength,E=h*Uint32Array.BYTES_PER_ELEMENT,w=6*Int32Array.BYTES_PER_ELEMENT,_=v.createShaderModule({code:"\nconst MAX_STRENGTH = 65535f;\n\n// Workgroup size - X*Y*Z must be multiple of 32 for better performance\noverride workGroupSizeX = 1u;\noverride workGroupSizeY = 1u;\noverride workGroupSizeZ = 1u;\n\n// Compare the current voxel to neighbors using a 9x9x9 window\noverride windowSize = 9i;\n\nstruct Params {\n  size: vec3u,\n  iteration: u32,\n}\n\n// New structure to track bounds of modified voxels\nstruct Bounds {\n  minX: atomic<i32>,\n  minY: atomic<i32>,\n  minZ: atomic<i32>,\n  maxX: atomic<i32>,\n  maxY: atomic<i32>,\n  maxZ: atomic<i32>,\n}\n\n@group(0) @binding(0) var<uniform> params: Params;\n@group(0) @binding(1) var<storage> volumePixelData: array<f32>;\n@group(0) @binding(2) var<storage, read_write> labelmap: array<u32>;\n@group(0) @binding(3) var<storage, read_write> strengthData: array<f32>;\n@group(0) @binding(4) var<storage> prevLabelmap: array<u32>;\n@group(0) @binding(5) var<storage> prevStrengthData: array<f32>;\n@group(0) @binding(6) var<storage, read_write> updatedVoxelsCounter: array<atomic<u32>>;\n@group(0) @binding(7) var<storage, read_write> modifiedBounds: Bounds;\n\nfn getPixelIndex(ijkPos: vec3u) -> u32 {\n  let numPixelsPerSlice = params.size.x * params.size.y;\n  return ijkPos.x + ijkPos.y * params.size.x + ijkPos.z * numPixelsPerSlice;\n}\n\nfn updateBounds(position: vec3i) {\n  // Atomically update min bounds (use min operation)\n  let oldMinX = atomicMin(&modifiedBounds.minX, position.x);\n  let oldMinY = atomicMin(&modifiedBounds.minY, position.y);\n  let oldMinZ = atomicMin(&modifiedBounds.minZ, position.z);\n\n  // Atomically update max bounds (use max operation)\n  let oldMaxX = atomicMax(&modifiedBounds.maxX, position.x);\n  let oldMaxY = atomicMax(&modifiedBounds.maxY, position.y);\n  let oldMaxZ = atomicMax(&modifiedBounds.maxZ, position.z);\n}\n\n@compute @workgroup_size(workGroupSizeX, workGroupSizeY, workGroupSizeZ)\nfn main(\n  @builtin(global_invocation_id) globalId: vec3u,\n) {\n  // Make sure it will not get out of bounds for volume with sizes that\n  // are not multiple of workGroupSize\n  if (\n    globalId.x >= params.size.x ||\n    globalId.y >= params.size.y ||\n    globalId.z >= params.size.z\n  ) {\n    return;\n  }\n\n  // Initialize bounds for the first iteration\n  if (params.iteration == 0 && globalId.x == 0 && globalId.y == 0 && globalId.z == 0) {\n    // Initialize to opposite extremes to ensure any update will improve the bounds\n    atomicStore(&modifiedBounds.minX, i32(params.size.x));\n    atomicStore(&modifiedBounds.minY, i32(params.size.y));\n    atomicStore(&modifiedBounds.minZ, i32(params.size.z));\n    atomicStore(&modifiedBounds.maxX, -1);\n    atomicStore(&modifiedBounds.maxY, -1);\n    atomicStore(&modifiedBounds.maxZ, -1);\n  }\n\n  let currentCoord = vec3i(globalId);\n  let currentPixelIndex = getPixelIndex(globalId);\n\n  let numPixels = arrayLength(&volumePixelData);\n  let currentPixelValue = volumePixelData[currentPixelIndex];\n\n  if (params.iteration == 0) {\n    // All non-zero initial labels are given maximum strength\n    strengthData[currentPixelIndex] = select(MAX_STRENGTH, 0., labelmap[currentPixelIndex] == 0);\n\n    // Update bounds for non-zero initial labels\n    if (labelmap[currentPixelIndex] != 0) {\n      updateBounds(currentCoord);\n    }\n    return;\n  }\n\n  // It should at least copy the values from previous state\n  var newLabel = prevLabelmap[currentPixelIndex];\n  var newStrength = prevStrengthData[currentPixelIndex];\n\n  let window = i32(ceil(f32(windowSize - 1) * .5));\n  let minWindow = -1i * window;\n  let maxWindow = 1i * window;\n\n  for (var k = minWindow; k <= maxWindow; k++) {\n    for (var j = minWindow; j <= maxWindow; j++) {\n      for (var i = minWindow; i <= maxWindow; i++) {\n        // Skip current voxel\n        if (i == 0 && j == 0 && k == 0) {\n          continue;\n        }\n\n        let neighborCoord = currentCoord + vec3i(i, j, k);\n\n        //  Boundary conditions. Do not grow outside of the volume\n        if (\n          neighborCoord.x < 0i || neighborCoord.x >= i32(params.size.x) ||\n          neighborCoord.y < 0i || neighborCoord.y >= i32(params.size.y) ||\n          neighborCoord.z < 0i || neighborCoord.z >= i32(params.size.z)\n        ) {\n          continue;\n        }\n\n        let neighborIndex = getPixelIndex(vec3u(neighborCoord));\n        let neighborPixelValue = volumePixelData[neighborIndex];\n        let prevNeighborStrength = prevStrengthData[neighborIndex];\n        let strengthCost = abs(neighborPixelValue - currentPixelValue);\n        let takeoverStrength = prevNeighborStrength - strengthCost;\n\n        if (takeoverStrength > newStrength) {\n          newLabel = prevLabelmap[neighborIndex];\n          newStrength = takeoverStrength;\n        }\n      }\n    }\n  }\n\n  if (labelmap[currentPixelIndex] != newLabel) {\n    atomicAdd(&updatedVoxelsCounter[params.iteration], 1u);\n\n    // Update bounds for modified voxels\n    updateBounds(currentCoord);\n  }\n\n  labelmap[currentPixelIndex] = newLabel;\n  strengthData[currentPixelIndex] = newStrength;\n}\n"}),S=new Uint32Array([d,c,u,0]),y=v.createBuffer({size:S.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),T=v.createBuffer({size:p,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});v.queue.writeBuffer(T,0,f);let C=[0,1].map(()=>v.createBuffer({size:p,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}));v.queue.writeBuffer(C[0],0,new Uint32Array(g));let b=[0,1].map(()=>v.createBuffer({size:p,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})),A=v.createBuffer({size:E,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),x=v.createBuffer({size:w,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),D=new Int32Array([d,c,u,-1,-1,-1]);v.queue.writeBuffer(x,0,D);let M=v.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:7,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),O=[0,1].map(e=>{let t=C[e],n=b[e],i=C[(e+1)%2],o=b[(e+1)%2];return v.createBindGroup({layout:M,entries:[{binding:0,resource:{buffer:y}},{binding:1,resource:{buffer:T}},{binding:2,resource:{buffer:t}},{binding:3,resource:{buffer:n}},{binding:4,resource:{buffer:i}},{binding:5,resource:{buffer:o}},{binding:6,resource:{buffer:A}},{binding:7,resource:{buffer:x}}]})}),P=v.createComputePipeline({layout:v.createPipelineLayout({bindGroupLayouts:[M]}),compute:{module:_,entryPoint:"main",constants:{workGroupSizeX:8,workGroupSizeY:8,workGroupSizeZ:4,windowSize:o}}}),N=[Math.ceil(d/8),Math.ceil(c/8),Math.ceil(u/4)],R=v.createBuffer({size:E,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),L=a?performance.now()+a:0,U=r.numCyclesInterval,k=0;for(let e=0;e<h;e++){S[3]=e,v.queue.writeBuffer(y,0,S);let t=v.createCommandEncoder(),n=t.beginComputePass();if(n.setPipeline(P),n.setBindGroup(0,O[e%2]),n.dispatchWorkgroups(N[0],N[1],N[2]),n.end(),t.copyBufferToBuffer(A,e*Uint32Array.BYTES_PER_ELEMENT,R,e*Uint32Array.BYTES_PER_ELEMENT,Uint32Array.BYTES_PER_ELEMENT),v.queue.submit([t.finish()]),e>0&&!(e%U)){await R.mapAsync(GPUMapMode.READ,0,E);let t=new Uint32Array(R.getMappedRange(0,E).slice(0))[e]/f.length;if(R.unmap(),e>=1&&t<r.threshold){if(U=1,++k===r.numCyclesBelowThreshold)break}else U=r.numCyclesInterval}if(L&&performance.now()>L){console.warn("Exceeded processing time limit (".concat(a,")ms"));break}}let V=v.createCommandEncoder(),F=(h+1)%2,B=v.createBuffer({size:p,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),G=v.createBuffer({size:w,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});V.copyBufferToBuffer(C[F],0,B,0,p),V.copyBufferToBuffer(x,0,G,0,w),v.queue.submit([V.finish()]),await B.mapAsync(GPUMapMode.READ,0,p);let W=new Uint32Array(B.getMappedRange(0,p));g.set(W),B.unmap(),await G.mapAsync(GPUMapMode.READ,0,w);let z=new Int32Array(G.getMappedRange(0,w).slice(0));G.unmap();let q=z[0],H=z[1],j=z[2],K=z[3],Y=z[4],X=z[5];s.voxelManager.setCompleteScalarDataArray(g),s.voxelManager.clearBounds(),s.voxelManager.setBounds([[q,K],[H,Y],[j,X]])}var lL=e.i(698119);let{transformWorldToIndex:lU}=w.utilities;async function lk(e,t,n,i){let o=await M.volumeLoader.createAndCacheDerivedLabelmapVolume(e.volumeId);return!function(e,t,n,i){var o,a;let r=e.voxelManager.getCompleteScalarDataArray(),l=n.center,[s,d,c]=e.dimensions,u=s*d,h=lU(e.imageData,l),g=r[h[2]*u+h[1]*s+h[0]],f=null!=(o=i.positiveSeedValue)?o:254,m=Math.abs(g*(null!=(a=i.positiveSeedVariance)?a:.1)),v=g-m,p=g+m,I=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],E=h[2]*u+h[1]*s+h[0];t.voxelManager.setAtIndex(E,f);let w=[h];for(;w.length;){let[e,n,i]=w.shift();for(let o=0,a=I.length;o<a;o++){let a=I[o],l=e+a[0],h=n+a[1],g=i+a[2];if(l<0||l>=s||h<0||h>=d||g<0||g>=c)continue;let m=g*u+h*s+l,E=r[m];t.voxelManager.getAtIndex(m)===f||E<v||E>p||(t.voxelManager.setAtIndex(m,f),w.push([l,h,g]))}}}(e,o,t,i),!function(e,t,n,i,o){var a,r;let l=e.voxelManager.getCompleteScalarDataArray(),[s,d,c]=t.dimensions,u=s*d,{worldVecRowDir:h,worldVecSliceDir:g}=w.utilities.getVolumeDirectionVectors(t.imageData,i.getCamera()),f=lU(e.imageData,n.center),m=l[f[2]*s*d+f[1]*s+f[0]],v=null!=(a=o.negativeSeedVariance)?a:.8,p=null!=(r=null==o?void 0:o.negativeSeedValue)?r:255,I=Math.abs(m*v),E=m-I,_=m+I,S=2*Math.PI/360,y=lL.quat.setAxisAngle(lL.quat.create(),g,S),T=eA.vec3.clone(h);for(let e=0;e<360;e++){let e=eA.vec3.scaleAndAdd(eA.vec3.create(),n.center,T,n.radius),[i,o,a]=lU(t.imageData,e);if(eA.vec3.transformQuat(T,T,y),i<0||i>=s||o<0||o>=d||a<0||a>=c)continue;let r=i+o*s+a*u,h=l[r];(h<E||h>_)&&t.voxelManager.setAtIndex(r,p)}}(e,o,t,n,i),o}async function lV(e,t,n,i){let o=function(e,t,n){let i=e.imageData,o=n.getCamera(),{ijkVecRowDir:a,ijkVecColDir:r}=w.utilities.getVolumeDirectionVectors(i,o);if([a,r].some(e=>!w.utilities.isEqual(Math.abs(e[0]),1)&&!w.utilities.isEqual(Math.abs(e[1]),1)&&!w.utilities.isEqual(Math.abs(e[2]),1)))return void console.warn("Oblique view is not supported!");let{boundsIJK:l}=function(e,t){let n=e.imageData.getDirection(),i=eA.vec3.fromValues(n[3],n[4],n[5]),{center:o,radius:a}=t,r=e.imageData,l=eA.vec3.scaleAndAdd(eA.vec3.create(),o,i,-a),s=eA.vec3.scaleAndAdd(eA.vec3.create(),o,i,a),d=(0,r1.getSphereBoundsInfo)([s,l],r),{topLeftWorld:c,bottomRightWorld:u}=d,h=lU(e.imageData,c),g=lU(e.imageData,u);return{...d,topLeftIJK:h,bottomRightIJK:g}}(e,t),s={minX:l[0][0],maxX:l[0][1]+1,minY:l[1][0],maxY:l[1][1]+1,minZ:l[2][0],maxZ:l[2][1]+1};return w.utilities.createSubVolume(e.volumeId,s,{targetBuffer:{type:"Float32Array"}})}(I.cache.getVolume(e),t,n),a=await lk(o,t,n,i);return await lR(o.volumeId,a.volumeId),a}let lF=[-1/0,-995],lB=[0,1900];async function lG(e,t){let n=M.volumeLoader.createAndCacheDerivedLabelmapVolume(e.volumeId);return!function(e,t,n){let{positiveSeedValue:i=254,positivePixelRange:o=lB}=n,a=e.voxelManager.getCompleteScalarDataArray();t.voxelManager.getCompleteScalarDataArray();let[r,l,s]=t.dimensions,d=Math.max(Math.floor(s/2)-3,0),c=Math.max(d+5,s),u=r*l;for(let e=d;e<c;e++){let n=e*u;for(let e=0;e<l;e++){let l=e*r;for(let e=0;e<r;e++){let r=n+l+e,s=a[r];s>=o[0]&&s<=o[1]&&t.voxelManager.setAtIndex(r,i)}}}}(e,n,t),!function(e,t,n){let{negativeSeedValue:i=255,negativePixelRange:o=lF}=n,a=e.voxelManager.getCompleteScalarDataArray(),[r,l,s]=t.dimensions,d=Math.floor(s/2),c=Array(r*l).fill(!1),u=d*r*l,h=(e,n)=>{let s=[[e,n]];for(;s.length;){let[e,n]=s.shift(),d=n*r+e;if(e<0||e>=r||n<0||n>=l||c[d])continue;c[d]=!0;let h=u+d,g=a[h];g<o[0]||g>o[1]||(t.voxelManager.setAtIndex(h,i),s.push([e-1,n]),s.push([e+1,n]),s.push([e,n-1]),s.push([e,n+1]))}},g=(e,t,n,i)=>{for(let l=e;l!==t;l+=n){let e=i*r+l,t=a[u+e];if(t<o[0]||t>o[1])break;c[e]||h(l,i)}};for(let e=0;e<l;e++)g(0,r-1,1,e),g(r-1,0,-1,e)}(e,n,t),n}async function lW(e,t,n){let{boundingBox:i}=t,{ijkTopLeft:o,ijkBottomRight:a}=i,r={minX:o[0],maxX:a[0],minY:o[1],maxY:a[1],minZ:o[2],maxZ:a[2]},l=w.utilities.createSubVolume(e,r,{targetBuffer:{type:"Float32Array"}}),s=await lG(l,n);return await lR(l.volumeId,s.volumeId),s}let{transformWorldToIndex:lz}=w.utilities;async function lq(e){var t,n,i;let{referencedVolumeId:o,worldPosition:a,options:r}=e,l=I.cache.getVolume(o),s=M.volumeLoader.createAndCacheDerivedLabelmapVolume(o);s.voxelManager.forEach(e=>{let{index:t,value:n}=e;0!==n&&s.voxelManager.setAtIndex(t,0)});let d=null!=(t=r.seeds)?t:function(e,t,n){var i,o,a,r,l;let{dimensions:s,imageData:d}=e,[c,u,h]=s,g=e.voxelManager,f=g.getCompleteScalarDataArray(),m=c*u,v=null!=(i=null==n?void 0:n.initialNeighborhoodRadius)?i:1,p=null!=(o=null==n?void 0:n.positiveStdDevMultiplier)?o:1.8,I=null!=(a=null==n?void 0:n.negativeStdDevMultiplier)?a:3.2,E=null!=(r=null==n?void 0:n.negativeSeedMargin)?r:30,_=null!=(l=null==n?void 0:n.negativeSeedsTargetPatches)?l:70,S=lz(d,t).map(Math.round),y=g.toIndex(S);if(S[0]<0||S[0]>=c||S[1]<0||S[1]>=u||S[2]<0||S[2]>=h)return console.warn("Click position is outside volume bounds."),null;let T=w.utilities.calculateNeighborhoodStats(f,s,S,v);0===T.count&&(T.mean=f[y],T.stdDev=0);let C=T.mean-p*T.stdDev,b=T.mean+p*T.stdDev,A=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],x=1/0,D=1/0,M=1/0,O=-1/0,P=-1/0,N=-1/0,R=new Set,L=[],U=f[y];if(!(U>=C)||!(U<=b))return console.warn("Clicked voxel intensity is outside the calculated positive range. No positive seeds generated."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};R.add(y),L.push(S),x=O=S[0],D=P=S[1],M=N=S[2];let k=0;for(;k<L.length&&R.size<1e5;){let[e,t,n]=L[k++];x=Math.min(e,x),D=Math.min(t,D),M=Math.min(n,M),O=Math.max(e,O),P=Math.max(t,P),N=Math.max(n,N);for(let i=0;i<A.length;i++){let[o,a,r]=A[i],l=e+o,s=t+a,d=n+r;if(l<0||l>=c||s<0||s>=u||d<0||d>=h)continue;let g=d*m+s*c+l;if(R.has(g))continue;let v=f[g];v>=C&&v<=b&&(R.add(g),R.size<1e5&&L.push([l,s,d]))}}if(R.size>=1e5&&console.debug("Reached maximum number of positive seeds (".concat(1e5,"). Stopping BFS.")),0===R.size)return console.warn("No positive seeds found after BFS."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};let V=0,F=0;R.forEach(e=>{let t=f[e];V+=t,F+=t*t});let B=R.size,G=V/B,W=I*Math.sqrt(Math.max(0,F/B-G*G)),z=Math.max(0,x-E),q=Math.max(0,D-E),H=Math.max(0,M-E),j=Math.min(c-1,O+E),K=Math.min(u-1,P+E),Y=Math.min(h-1,N+E),X=new Set,Z=0,J=0,Q=50*_;for(;J<_&&Z<Q;){Z++;let e=Math.floor(Math.random()*(j-z+1)+z),t=Math.floor(Math.random()*(K-q+1)+q),n=Math.floor(Math.random()*(Y-H+1)+H),i=n*m+t*c+e;if(!(R.has(i)||X.has(i))&&Math.abs(f[i]-G)>W){let i=!1;for(let o=-1;o<=1;o++){let a=t+o;if(!(a<0)&&!(a>=u))for(let t=-1;t<=1;t++){let o=e+t;if(o<0||o>=c)continue;let r=n*m+a*c+o;R.has(r)||X.has(r)||(X.add(r),i=!0)}}i&&J++}}return 0===X.size&&console.warn("Could not find any negative seeds. GrowCut might fail or produce poor results."),console.debug("positiveSeedIndices",R.size),console.debug("negativeSeedIndices",X.size),{positiveSeedIndices:R,negativeSeedIndices:X}}(l,a,r),c=null!=(n=null==r?void 0:r.positiveSeedValue)?n:254,u=null!=(i=null==r?void 0:r.negativeSeedValue)?i:255;if(!d)return null;let{positiveSeedIndices:h,negativeSeedIndices:g}=d;return h.size<10||h.size>1e5||g.size<10?console.warn("Not enough seeds found. GrowCut might fail or produce poor results."):(h.forEach(e=>{s.voxelManager.setAtIndex(e,c)}),g.forEach(e=>{s.voxelManager.setAtIndex(e,u)}),await lR(o,s.volumeId,r)),s}var lH=e.i(366980),lj=e.i(658319);function lK(e){if("volumeId"in e){if(!I.cache.getVolume(e.volumeId))throw Error("volumeId of ".concat(e.volumeId," not found in cache, you should load and cache volume before adding segmentation"))}else if("imageIds"in e){if(!e.imageIds)throw Error("The segmentationInput.representationData.imageIds is undefined, please provide a valid representationData.imageIds for stack data")}else throw Error("The segmentationInput.representationData is undefined, please provide a valid representationData")}function lY(e){if(!e.representation.data)throw Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");lK(e.representation.data)}function lX(e){lK(e)}e.s(["validate",()=>lX,"validatePublic",()=>lY],257185);var lZ=e.i(257185),O=_;async function lJ(e){let{volumeId:t}=e;return{imageIds:I.cache.getVolume(t).imageIds}}async function lQ(e){return W(e)}async function l$(e){let{segmentationId:t,segmentIndices:n,mode:i="individual"}=e;(0,y.registerComputeWorker)(),es(S.WorkerTypes.COMPUTE_LARGEST_BIDIRECTIONAL,0);let o=ed(t,n);if(!o)return;let{operationData:a,segImageIds:r,reconstructableVolume:l,indices:s}=o,d=l?await l0({operationData:a,indices:s,mode:i}):await l1({segImageIds:r,indices:s,mode:i});return es(S.WorkerTypes.COMPUTE_LARGEST_BIDIRECTIONAL,100),d}async function l0(e){let{operationData:t,indices:n,mode:i}=e,{segmentationVoxelManager:o,segmentationImageData:a}=ec(t),r={scalarData:o.getCompleteScalarDataArray(),dimensions:a.getDimensions(),spacing:a.getSpacing(),origin:a.getOrigin(),direction:a.getDirection()};return await (0,E.getWebWorkerManager)().executeTask("compute","getSegmentLargestBidirectionalInternal",{segmentationInfo:r,indices:n,mode:i})}async function l1(e){let{segImageIds:t,indices:n,mode:i}=e,{segmentationInfo:o}=eu(t);return await (0,E.getWebWorkerManager)().executeTask("compute","getSegmentLargestBidirectionalInternal",{segmentationInfo:o,indices:n,mode:i,isStack:!0})}async function l2(e){let{segmentationIds:t,segmentIndex:n}=e;(0,y.registerComputeWorker)(),es(S.WorkerTypes.COMPUTE_STATISTICS,0);let{imageIds:i}=H(t[0]).representationData.Labelmap;if(!w.utilities.isValidVolume(i))throw Error("Invalid volume - TMTV cannot be calculated");return await l3({segmentationIds:t,segmentIndex:n})}async function l3(e){let{segmentationIds:t,segmentIndex:n}=e,i=oo(t.map(e=>eo(e)),n);if(!i)throw Error("Invalid volume - TMTV cannot be calculated");let{imageData:o,dimensions:a,direction:r,origin:l,voxelManager:s}=i,d=o.getSpacing(),c={scalarData:s.getCompleteScalarDataArray(),dimensions:a,spacing:d,origin:l,direction:r},u=function(e){let t,n=H(e);if(!n)return null;let i=n.representationData.Labelmap;if("imageIds"in i){let{imageIds:e}=i,n=I.cache.getImage(e[0]),o=I.cache.getVolumeContainingImageId(n.referencedImageId);if(null==o?void 0:o.volume)return o.volume;t=e.map(e=>I.cache.getImage(e).referencedImageId)}else if("volumeId"in i){let{volumeId:e,referencedVolumeId:n}=i;if(n){let e=I.cache.getVolume(n);if(e)return e}let o=I.cache.getVolume(e);o&&(t=o.imageIds.map(e=>I.cache.getImage(e).referencedImageId))}return er(t)}(t[0]),h={dimensions:u.dimensions,spacing:u.spacing,origin:u.origin,direction:u.direction,scalarData:u.voxelManager.getCompleteScalarDataArray()};if(0===h.scalarData.length||0===c.scalarData.length)return{[n]:{name:"TMTV",value:0}};let g=await (0,E.getWebWorkerManager)().executeTask("compute","computeMetabolicStats",{segmentationInfo:c,imageInfo:h});return es(S.WorkerTypes.COMPUTE_STATISTICS,100),g}e.i(855451);var l5=rN,l4=lv,l8=lH,l6=lj,l7=lZ;e.s(["getTextBoxCoordsCanvas",()=>ip],381711),e.s([],193579),e.i(193579),e.s(["BasicStatsCalculator",()=>sI,"aabb",()=>sp,"angle",()=>sb,"circle",()=>sE,"ellipse",()=>sw,"lineSegment",()=>s_,"point",()=>sS,"polyline",()=>sy,"rectangle",()=>sT,"vec2",()=>sC],607623),e.s([],282274),e.s(["BasicStatsCalculator",()=>se.BasicStatsCalculator,"Calculator",()=>st.Calculator,"InstanceBasicStatsCalculator",()=>se.InstanceBasicStatsCalculator,"InstanceCalculator",()=>st.InstanceCalculator],67396),e.s([],432403);var l9=e.i(960774);e.i(432403);var se=i$,st=l9,sn=e.i(67396);function si(e){let[t,n]=e;return ta(t,n)}function so(e){let[t,n]=e,i=ta(t,n);return[[t[0]-i,t[1]-i],[t[0]+i,t[1]+i]]}e.s(["getCanvasCircleCorners",()=>so,"getCanvasCircleRadius",()=>si],751036),e.s([],326366),e.s(["default",()=>si],309489),e.s(["default",()=>so],813416),e.i(326366);var sa=e.i(751036);function sr(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.precalculated||sl(e,n),n.precalculated(t)}e.s(["getCanvasEllipseCorners",()=>ss,"pointInEllipse",()=>sr,"precalculatePointInEllipse",()=>sl],226563),e.s([],496593),e.s(["default",()=>sr,"precalculatePointInEllipse",()=>sl],273345);let sl=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{xRadius:n,yRadius:i,zRadius:o}=e;(void 0===t.invXRadiusSq||void 0===t.invYRadiusSq||void 0===t.invZRadiusSq)&&(t.invXRadiusSq=0!==n?1/n**2:0,t.invYRadiusSq=0!==i?1/i**2:0,t.invZRadiusSq=0!==o?1/o**2:0);let{invXRadiusSq:a,invYRadiusSq:r,invZRadiusSq:l}=t,{center:s}=e,[d,c,u]=s;return t.precalculated=e=>{let t=e[0]-d,n=t*t*a;if(n>1)return!1;let i=e[1]-c;if((n+=i*i*r)>1)return!1;let o=e[2]-u;return(n+=o*o*l)<=1},t};function ss(e){let[t,n,i,o]=e;return[[i[0],n[1]],[o[0],t[1]]]}e.i(496593);var sd=e.i(226563);e.s(["distanceToPoint",()=>iY,"distanceToPointSquared",()=>eZ,"distanceToPointSquaredInfo",()=>eX,"intersectLine",()=>lS,"isPointOnLineSegment",()=>eH],505769),e.s([],550983),e.i(550983);var sc=e.i(505769);e.s(["distanceToPoint",()=>iX],877491),e.s([],472482),e.i(472482);var su=e.i(877491);function sh(e,t,n){let[i,o]=n;if(1e-6>Math.abs(t))return e<0;let a=e/t;if(t>0){if(a>o)return 0;a>i&&(n[0]=a)}else{if(a<i)return 0;a<o&&(n[1]=a)}return 1}function sg(e,t,n,i,o){let[a,r]=e,[l,s]=t,d=l-a,c=s-r;if(void 0===i||void 0===o?(i=e,o=t):(i[0]=e[0],i[1]=e[1],o[0]=t[0],o[1]=t[1]),1e-6>Math.abs(d)&&1e-6>Math.abs(c)&&a>=n[0]&&a<=n[2]&&r>=n[1]&&r<=n[3])return 1;let u=[0,1];if(sh(n[0]-a,d,u)&&sh(a-n[2],-d,u)&&sh(n[1]-r,c,u)&&sh(r-n[3],-c,u)){let[e,t]=u;return t<1&&(o[0]=a+t*d,o[1]=r+t*c),e>0&&(i[0]+=e*d,i[1]+=e*c),1}return 0}e.s(["findClosestPoint",()=>iu,"liangBarksyClip",()=>sg],379506),e.s([],193319),e.i(193319);var sf=e.i(379506);function sm(e,t){return 3===e[0].length?function(e,t){let[n,i]=e,[o,a]=t,r=eA.vec3.sub(eA.vec3.create(),i,n),l=eA.vec3.sub(eA.vec3.create(),o,a),s=eA.vec3.dot(r,l),d=eA.vec3.length(r);return 180*Math.acos(s/(d*eA.vec3.length(l)))/Math.PI}(e,t):function(e,t){let[n,i]=e,[o,a]=t,r=eM.vec2.sub(eM.vec2.create(),i,n),l=eM.vec2.sub(eM.vec2.create(),o,a),s=eM.vec2.dot(r,l),d=eM.vec2.length(r);return 180/Math.PI*Math.acos(s/(d*eM.vec2.length(l)))}(e,t)}e.s(["angleBetweenLines",()=>sm],985090),e.s([],891535),e.i(891535);var sv=e.i(985090);e.i(282274);var sp=t6,sI=sn,sE=sa,sw=sd,s_=sc,sS=ts,sy=ti,sT=su,sC=sf,sb=sv;function sA(e,t,n,i){let o=eA.vec3.create();eA.vec3.cross(o,t,e);let a=eA.vec3.fromValues(...n),r=eA.vec3.fromValues(...i),l=eA.vec3.create();eA.vec3.subtract(l,a,r);let s=eA.vec3.length(l);if(s<1e-4)return{worldWidth:0,worldHeight:0};let d=eA.vec3.dot(l,o)/(s*eA.vec3.length(o));return{worldWidth:Math.sqrt(1-d*d)*s,worldHeight:d*s}}function sx(e,t,n,i){let o,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.25;for(let r of sD(e,t,{targetVolumeId:n,stepSize:a})){let t=i(e.getIntensityFromWorld(r),r);t&&(o=t)}return o}function sD(e,t,n){let{targetVolumeId:i,stepSize:o}=n,a=e.getCamera(),{viewPlaneNormal:r}=a,{spacingInNormalDirection:l}=w.utilities.getTargetVolumeAndSpacingInNormalDir(e,a,i),s=l*o||1,d=e.getBounds(),c=[],u=[...t];for(;sM(u,d);)c.push([...u]),u[0]+=r[0]*s,u[1]+=r[1]*s,u[2]+=r[2]*s;for(u=[...t];sM(u,d);)c.push([...u]),u[0]-=r[0]*s,u[1]-=r[1]*s,u[2]-=r[2]*s;return c}e.s(["default",()=>sP,"filterAnnotationsForDisplay",()=>iB,"filterAnnotationsWithinSamePlane",()=>i8,"filterAnnotationsWithinSlice",()=>iF,"getPointInLineOfSightWithCriteria",()=>sx,"getPointsInLineOfSight",()=>sD,"getWorldWidthAndHeightFromCorners",()=>iI,"getWorldWidthAndHeightFromTwoPoints",()=>sA,"isPlaneIntersectingAABB",()=>sO],504761),e.s(["default",()=>sP],221630),e.s(["default",()=>sA],402932);let sM=function(e,t){let[n,i,o,a,r,l]=t;return e[0]>n+10&&e[0]<i-10&&e[1]>o+10&&e[1]<a-10&&e[2]>r+10&&e[2]<l-10},sO=(e,t,n,i,o,a,r,l)=>{let s=[eA.vec3.fromValues(n,i,o),eA.vec3.fromValues(a,i,o),eA.vec3.fromValues(n,r,o),eA.vec3.fromValues(a,r,o),eA.vec3.fromValues(n,i,l),eA.vec3.fromValues(a,i,l),eA.vec3.fromValues(n,r,l),eA.vec3.fromValues(a,r,l)],d=eA.vec3.fromValues(t[0],t[1],t[2]),c=eA.vec3.fromValues(e[0],e[1],e[2]),u=-eA.vec3.dot(d,c),h=null;for(let e of s){let t=eA.vec3.dot(d,e)+u;if(null===h)h=Math.sign(t);else if(Math.sign(t)!==h)return!0}return!1},sP={filterAnnotationsWithinSlice:iF,getWorldWidthAndHeightFromCorners:iI,getWorldWidthAndHeightFromTwoPoints:sA,filterAnnotationsForDisplay:iB,getPointInLineOfSightWithCriteria:sx,isPlaneIntersectingAABB:sO,filterAnnotationsWithinSamePlane:i8,getPointsInLineOfSight:sD};function sN(e){let t="",n=e[0]<0?"R":"L",i=e[1]<0?"A":"P",o=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];for(let e=0;e<3;e++)if(a[0]>1e-4&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>1e-4&&a[1]>a[0]&&a[1]>a[2])t+=i,a[1]=0;else if(a[2]>1e-4&&a[2]>a[0]&&a[2]>a[1])t+=o,a[2]=0;else if(a[0]>1e-4&&a[1]>1e-4&&a[0]===a[1])t+=n+i,a[0]=0,a[1]=0;else if(a[0]>1e-4&&a[2]>1e-4&&a[0]===a[2])t+=n+o,a[0]=0,a[2]=0;else if(a[1]>1e-4&&a[2]>1e-4&&a[1]===a[2])t+=i+o,a[1]=0,a[2]=0;else break;return t}function sR(e){let t=e.replace("H","f");return(t=(t=(t=(t=(t=t.replace("F","h")).replace("R","l")).replace("L","r")).replace("A","p")).replace("P","a")).toUpperCase()}e.i(221630),e.s(["filterViewportsWithFrameOfReferenceUID",()=>nt,"filterViewportsWithParallelNormals",()=>ns,"filterViewportsWithToolEnabled",()=>nl,"getViewportIdsWithToolToRender",()=>nd],335339),e.s([],838461),e.i(838461),e.s(["getOrientationStringLPS",()=>sN,"invertOrientationStringLPS",()=>sR],377752),e.s([],465836),e.i(465836),e.s(["Events",()=>sU,"addToolState",()=>sV,"getToolState",()=>sF,"playClip",()=>sz,"stopClip",()=>sq],111793),e.s([],575590);var sL=e.i(381505),sL=sL;!function(e){e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"}(h||(h={}));let sU=h,sk={};function sV(e,t){let{viewportId:n}=(0,e3.getEnabledElement)(e);sk[n]=t}function sF(e){let{viewportId:t}=(0,e3.getEnabledElement)(e);return sk[t]}let{ViewportStatus:sB}=C.Enums,{triggerEvent:sG}=w.utilities,sW=new Map;function sz(e,t){var n,i,o,a,r,l;let s,d;if(void 0===e)throw Error("playClip: element must not be undefined");let c=(0,e3.getEnabledElement)(e);if(!c)throw Error("playClip: element must be a valid Cornerstone enabled element");t||(t={}),t.dynamicCineEnabled=null==(n=t.dynamicCineEnabled)||n;let{viewport:u}=c,h=function(e,t){if(e instanceof e0.StackViewport){var n,i,o,a=null!=(n=t.waitForRendered)?n:30;let r=e.getImageIds();return{get numScrollSteps(){return r.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(t){if(this.waitForRenderedCount<=a&&e.viewportStatus!==sB.RENDERED)return void this.waitForRenderedCount++;this.waitForRenderedCount=0,w.utilities.scroll(e,{delta:t,debounceLoading:!0})}}}if(e instanceof iR.VolumeViewport){let n=sY(e);if(t.dynamicCineEnabled&&(null==n?void 0:n.isDynamicVolume()))return{get numScrollSteps(){return n.numDimensionGroups},get currentStepIndex(){return n.dimensionGroupNumber-1},get frameTimeVectorEnabled(){return!1},scroll(e){n.scroll(e)}};let{volumeId:i}=n,o={viewPlaneNormal:eA.vec3.create(),scrollInfo:null},a=()=>{let t=e.getCamera();if(!o.scrollInfo||!eA.vec3.equals(t.viewPlaneNormal,o.viewPlaneNormal)){let n=w.utilities.getVolumeViewportScrollInfo(e,i);o.viewPlaneNormal=t.viewPlaneNormal,o.scrollInfo=n}return o.scrollInfo};return{get numScrollSteps(){return a().numScrollSteps},get currentStepIndex(){return a().currentStepIndex},get frameTimeVectorEnabled(){let t=e.getCamera(),i=n.direction.slice(6,9).map(e=>-e),o=eA.vec3.dot(i,t.viewPlaneNormal);return eq.glMatrix.equals(o,1)},scroll(t){a().currentStepIndex+=t,w.utilities.scroll(e,{delta:t})}}}if(e instanceof sL.default)return o=null!=(i=t.waitForRendered)?i:30,{get numScrollSteps(){return e.getNumberOfSlices()},get currentStepIndex(){return e.getSliceIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(t){if(this.waitForRenderedCount<=o&&e.viewportStatus!==sB.RENDERED)return void this.waitForRenderedCount++;this.waitForRenderedCount=0,w.utilities.scroll(e,{delta:t,debounceLoading:!0})},play:t=>(t&&e.setPlaybackRate(t/24),e.play(),e.getFrameRate())};throw Error("Unknown viewport type")}(u,t),g=sF(e),f=t.dynamicCineEnabled;if(f&&sj(e),g?sH(e,{stopDynamicCine:!f,viewportId:u.id}):sV(e,g={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:null!=(i=t.frameTimeVector)?i:void 0,speed:null!=(o=t.frameTimeVectorSpeedMultiplier)?o:1,reverse:null!=(a=t.reverse)&&a,loop:null==(r=t.loop)||r,bounce:null!=(l=t.bounce)&&l}),g.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(g.framesPerSecond=Number(t.framesPerSecond),g.reverse=g.framesPerSecond<0,g.ignoreFrameTimeVector=!0),!0!==g.ignoreFrameTimeVector&&g.frameTimeVector&&g.frameTimeVector.length===h.numScrollSteps&&h.frameTimeVectorEnabled){let{timeouts:e,isTimeVarying:t}=function(e,t){let n,i,o,a=0,r=e.length,l=[],s=!1;for(("number"!=typeof t||t<=0)&&(t=1),n=1;n<r;n++)l.push(o=Number(e[n])/t|0),1===n?i=o:o!==i&&(s=!0),a+=o;return l.length>0&&(o=s?a/l.length|0:l[0],l.push(o)),{timeouts:l,isTimeVarying:s}}(g.frameTimeVector,g.speed);s=e,d=t}void 0!==t.bounce&&(g.bounce=t.bounce);let m=()=>{let{numScrollSteps:t,currentStepIndex:n}=h,i=n+(g.reverse?-1:1);if(i<0||i>=t)if(g.bounce)g.reverse=!g.reverse,i=Math.max(0,Math.min(t-1,i=n+(g.reverse?-1:1)));else if(g.loop)i=g.reverse?t-1:0;else{sH(e,{stopDynamicCine:!f,viewportId:u.id}),sG(e,sU.CLIP_STOPPED,{element:e});return}let o=i-n;if(o)try{h.scroll(o)}catch(t){console.warn("Play clip not scrolling",t),sK(g),sG(e,sU.CLIP_STOPPED,{element:e})}};if(f){let t=sY(u);t&&sW.set(t.volumeId,e)}h.play?g.framesPerSecond=h.play(t.framesPerSecond):s&&s.length>0&&d?(g.usingFrameTimeVector=!0,g.intervalId=window.setTimeout(function e(){g.intervalId=window.setTimeout(e,s[h.currentStepIndex]),m()},0)):(g.usingFrameTimeVector=!1,g.intervalId=window.setInterval(m,1e3/Math.abs(g.framesPerSecond))),sG(e,sU.CLIP_STARTED,{element:e})}function sq(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};sH(e,{stopDynamicCine:!0,...t})}function sH(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{stopDynamicCine:!0,viewportId:void 0},{stopDynamicCine:i,viewportId:o}=n,a=(0,e3.getEnabledElement)(e),r=null==a?void 0:a.viewport;if(a){let{viewport:e}=a;t=sF(e.element)}else{if(!o)return;t=sk[o]}t&&sK(t),r instanceof sL.default?r.pause():i&&r instanceof x.BaseVolumeViewport&&sj(e)}function sj(e){let{viewport:t}=(0,e3.getEnabledElement)(e);if(t instanceof iR.VolumeViewport){let n=sY(t);if(null==n?void 0:n.isDynamicVolume()){let t=sW.get(n.volumeId);sW.delete(n.volumeId),t&&t!==e&&sq(t)}}}function sK(e){let t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}function sY(e){if(!(e instanceof iR.VolumeViewport))return;let t=e.getAllVolumeIds();if(!(null==t?void 0:t.length))return;let n=t.find(e=>{var t;return null==(t=I.cache.getVolume(e))?void 0:t.isDynamicVolume()}),i=null!=n?n:t[0];return I.cache.getVolume(i)}e.i(575590),e.s(["extend2DBoundingBoxInViewAxis",()=>ot,"getBoundingBoxAroundShape",()=>sX.getBoundingBoxAroundShapeIJK,"getBoundingBoxAroundShapeIJK",()=>sX.getBoundingBoxAroundShapeIJK,"getBoundingBoxAroundShapeWorld",()=>sX.getBoundingBoxAroundShapeWorld],962393),e.s([],802085),e.i(802085);var sX=nQ;e.s(["default",()=>s$,"smoothAnnotation",()=>sQ],671018),e.s(["default",()=>s$],397350);var sZ=e.i(786735);function sJ(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Math.floor(Math.random()*(e.length-1));if(0===t)return 0;let n=[...e],{length:i}=e;for(let o=0;o<i;o++)e[o]=n[(o+t+i)%i];return t}function sQ(e,t){if(function(e,t){var n,i,o;let a=(null==t?void 0:t.knotsRatioPercentage)||30;return null==e||null==(o=e.data)||null==(i=o.contour)||null==(n=i.polyline)||!n.length||!!(a<=0)}(e,t))return!1;let{viewPlaneNormal:n}=e.metadata,{closed:i,polyline:o}=e.data.contour,a=function(e,t){let n=sZ.mat4.create(),i=eA.vec3.add(eA.vec3.create(),t,e),o=Math.abs(e[0])>.1?eA.vec3.fromValues(-e[1],e[0],0):eA.vec3.fromValues(0,-e[2],e[1]);return sZ.mat4.lookAt(n,t,i,o),n}(n,e.data.contour.polyline[0]),r=e.data.contour.polyline.map(e=>{let t=eA.vec3.transformMat4(eA.vec3.create(),e,a);return[t[0],t[1]]}),l=i?sJ(r):0,s=oJ(r,0,r.length-1,(null==t?void 0:t.knotsRatioPercentage)||30);if(s===r)return!1;sJ(s,-l);for(let e=1;e<(null==t?void 0:t.loop);e++)l=i?sJ(s):0,sJ(s=oJ(s,0,s.length-1,(null==t?void 0:t.knotsRatioPercentage)||30),-l);let d=sZ.mat4.invert(sZ.mat4.create(),a);return e.data.contour.polyline=s.map(e=>eA.vec3.transformMat4([0,0,0],[...e,0],d)),!0}let s$={smoothAnnotation:sQ};e.i(397350),e.s(["getBoundsIJKFromRectangleAnnotations",()=>on,"isAxisAlignedRectangle",()=>s3],200932),e.s([],554928);let{isEqual:s0}=w.utilities,s1=eA.vec3.fromValues(1,0,0),s2=[s1,eA.vec3.fromValues(0,1,0),eA.vec3.fromValues(0,0,1)];function s3(e){let t=eA.vec3.subtract(eA.vec3.create(),e[0],e[1]),n=eA.vec3.subtract(eA.vec3.create(),e[0],e[2]);return[...s5(t,s2),...s5(n,s2)].every(e=>s0(e,0)||s0(e,90)||s0(e,180)||s0(e,270))}function s5(e,t){return t.map(t=>180*eA.vec3.angle(e,t)/Math.PI)}e.i(554928)},660103,(e,t,n)=>{var i="__lodash_hash_undefined__",o=1/0,a=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,r=/^\w*$/,l=/^\./,s=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,d=/\\(\\)?/g,c=/^\[object .+?Constructor\]$/,u=e.g&&e.g.Object===Object&&e.g,h="object"==typeof self&&self&&self.Object===Object&&self,g=u||h||Function("return this")(),f=Array.prototype,m=Function.prototype,v=Object.prototype,p=g["__core-js_shared__"],I=function(){var e=/[^.]+$/.exec(p&&p.keys&&p.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),E=m.toString,w=v.hasOwnProperty,_=v.toString,S=RegExp("^"+E.call(w).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),y=g.Symbol,T=f.splice,C=R(g,"Map"),b=R(Object,"create"),A=y?y.prototype:void 0,x=A?A.toString:void 0;function D(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function M(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function O(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function P(e,t){for(var n,i,o=e.length;o--;){if(n=e[o][0],n===(i=t)||n!=n&&i!=i)return o}return -1}function N(e,t){var n,i,o=e.__data__;return("string"==(i=typeof(n=t))||"number"==i||"symbol"==i||"boolean"==i?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function R(e,t){var n,i,o,a=null==e?void 0:e[t];return!(!V(a)||(n=a,I&&I in n))&&("[object Function]"==(o=V(i=a)?_.call(i):"")||"[object GeneratorFunction]"==o||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(a)?S:c).test(function(e){if(null!=e){try{return E.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(a))?a:void 0}D.prototype.clear=function(){this.__data__=b?b(null):{}},D.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},D.prototype.get=function(e){var t=this.__data__;if(b){var n=t[e];return n===i?void 0:n}return w.call(t,e)?t[e]:void 0},D.prototype.has=function(e){var t=this.__data__;return b?void 0!==t[e]:w.call(t,e)},D.prototype.set=function(e,t){return this.__data__[e]=b&&void 0===t?i:t,this},M.prototype.clear=function(){this.__data__=[]},M.prototype.delete=function(e){var t=this.__data__,n=P(t,e);return!(n<0)&&(n==t.length-1?t.pop():T.call(t,n,1),!0)},M.prototype.get=function(e){var t=this.__data__,n=P(t,e);return n<0?void 0:t[n][1]},M.prototype.has=function(e){return P(this.__data__,e)>-1},M.prototype.set=function(e,t){var n=this.__data__,i=P(n,e);return i<0?n.push([e,t]):n[i][1]=t,this},O.prototype.clear=function(){this.__data__={hash:new D,map:new(C||M),string:new D}},O.prototype.delete=function(e){return N(this,e).delete(e)},O.prototype.get=function(e){return N(this,e).get(e)},O.prototype.has=function(e){return N(this,e).has(e)},O.prototype.set=function(e,t){return N(this,e).set(e,t),this};var L=U(function(e){e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(F(e))return x?x.call(e):"";var t=e+"";return"0"==t&&1/e==-o?"-0":t}(t);var t,n=[];return l.test(e)&&n.push(""),e.replace(s,function(e,t,i,o){n.push(i?o.replace(d,"$1"):t||e)}),n});function U(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw TypeError("Expected a function");var n=function(){var i=arguments,o=t?t.apply(this,i):i[0],a=n.cache;if(a.has(o))return a.get(o);var r=e.apply(this,i);return n.cache=a.set(o,r),r};return n.cache=new(U.Cache||O),n}U.Cache=O;var k=Array.isArray;function V(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function F(e){return"symbol"==typeof e||!!e&&"object"==typeof e&&"[object Symbol]"==_.call(e)}t.exports=function(e,t,n){var i=null==e?void 0:function(e,t){var n;t=!function(e,t){if(k(e))return!1;var n=typeof e;return!!("number"==n||"symbol"==n||"boolean"==n||null==e||F(e))||r.test(e)||!a.test(e)||null!=t&&e in Object(t)}(t,e)?k(n=t)?n:L(n):[t];for(var i=0,l=t.length;null!=e&&i<l;)e=e[function(e){if("string"==typeof e||F(e))return e;var t=e+"";return"0"==t&&1/e==-o?"-0":t}(t[i++])];return i&&i==l?e:void 0}(e,t);return void 0===i?n:i}},385658,(e,t,n)=>{var i=e.r(702922),o=0;t.exports=function(e){var t=++o;return i(e)+t}},476112,240634,299511,530070,832876,704063,985704,989663,419930,854246,97428,470254,365800,14807,554911,512761,e=>{"use strict";let t,n;e.s(["utilities",()=>n$],476112),e.s(["AnnotationMultiSlice",()=>nA.default,"IslandRemoval",()=>nY.default,"annotationHydration",()=>nD.annotationHydration,"boundingBox",()=>nV,"calibrateImageSpacing",()=>nw.default,"cine",()=>nk,"contourSegmentation",()=>nj,"contours",()=>nM,"debounce",()=>np.default,"drawing",()=>nP,"dynamicVolume",()=>nz,"geometricSurfaceUtils",()=>nZ,"getAnnotationNearPoint",()=>nv.getAnnotationNearPoint,"getAnnotationNearPointOnEnabledElement",()=>nv.getAnnotationNearPointOnEnabledElement,"getCalibratedAspect",()=>n_.getCalibratedAspect,"getCalibratedLengthUnitsAndScale",()=>n_.getCalibratedLengthUnitsAndScale,"getCalibratedProbeUnitsAndValue",()=>n_.getCalibratedProbeUnitsAndValue,"getClosestImageIdForStackViewport",()=>nD.getClosestImageIdForStackViewport,"getOrCreateImageVolume",()=>nJ.default,"getPixelValueUnits",()=>nX.getPixelValueUnits,"getPixelValueUnitsImageId",()=>nX.getPixelValueUnitsImageId,"getSphereBoundsInfo",()=>nC.getSphereBoundsInfo,"getViewportForAnnotation",()=>nx.default,"isObject",()=>nE.default,"math",()=>nN,"moveAnnotationToViewPlane",()=>ni,"normalizeViewportPlane",()=>nK.default,"orientation",()=>nU,"planar",()=>nR,"planarFreehandROITool",()=>nF,"pointInSurroundingSphereCallback",()=>t0,"pointToString",()=>nb.pointToString,"polyDataUtils",()=>nq,"rectangleROITool",()=>nB,"roundNumber",()=>nf,"segmentation",()=>nO,"setAnnotationLabel",()=>nt,"stackContextPrefetch",()=>ea,"stackPrefetch",()=>Q,"throttle",()=>nI.default,"touch",()=>nW,"triggerAnnotationRender",()=>nT.default,"triggerAnnotationRenderForToolGroupIds",()=>ny.default,"triggerAnnotationRenderForViewportIds",()=>nS.default,"triggerEvent",()=>nm.triggerEvent,"usFanExtraction",()=>nQ,"viewport",()=>nG,"viewportFilters",()=>nL,"voi",()=>nH],389014),e.s(["roundNumber",()=>nf],605643);var i,o,a,r=e.i(581632),l=e.i(736260),s=e.i(477210),d=e.i(655809),c=e.i(100563),u=e.i(183169),h=e.i(166956),g=e.i(961785),f=e.i(815926),m=e.i(493158),v=e.i(238064),p=e.i(518519),I=e.i(275864),E=e.i(392511),w=e.i(519318),_=e.i(761684),S=e.i(806003),y=e.i(753244),T=e.i(381711),C=e.i(607623),b=e.i(504761),A=e.i(335339),x=e.i(377752),D=e.i(111793),M=e.i(962393),O=e.i(671018),P=e.i(200932),N=e.i(184300),R=e.i(883035),L=e.i(378588),U=e.i(492047),U=U,k=e.i(560031),V=e.i(504019),F=e.i(513336);let B={};function G(e,t){let{viewportId:n}=(0,F.getEnabledElement)(e);B[n]=t}function W(e){let{viewportId:t}=(0,F.getEnabledElement)(e);return B[t]}var z=e.i(209501);let q=R.Enums.RequestType.Prefetch;function H(e){let t=(0,F.getEnabledElement)(e);if(!t)return null;let{viewport:n}=t;return n instanceof z.StackViewport?{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}:null}function j(e){return function(t){let n,i=t.detail;try{n=H(e)}catch(e){return}if(!n||!n.imageIds||0===n.imageIds.length)return;let o=n.imageIds.indexOf(i.imageId);if(o<0)return;let a=W(e);a&&a.indicesToRequest&&a.indicesToRequest.length&&a.indicesToRequest.push(o)}}var K=e.i(783224);let{imageRetrieveMetadataProvider:Y}=r.utilities,X={maxImagesToPrefetch:1/0,preserveExistingPool:!0};function Z(e){var t,n,i,o,a;let r,s,d,c,u=W(e);if(!u)return;let h=u||{},g=H(e);if(!(null==g||null==(t=g.imageIds)?void 0:t.length))return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");let{currentImageIdIndex:f}=g;if(h.enabled=h.enabled&&(null!=(i=null==(n=h.indicesToRequest)?void 0:n.length)?i:0)>0,!1===h.enabled)return;function m(e){let t=h.indicesToRequest.indexOf(e);t>-1&&h.indicesToRequest.splice(t,1)}if(u.indicesToRequest.sort((e,t)=>e-t),h.indicesToRequest.slice().forEach(function(e){let t=g.imageIds[e];t&&(6>Math.abs(f-e)?k.cache.getImageLoadObject(t):k.cache.isLoaded(t))&&m(e)}),!h.indicesToRequest.length)return;X.preserveExistingPool||U.default.clearRequestStack(q);let v=(o=h.indicesToRequest,a=g.currentImageIdIndex,d=0,c=o.length-1,o.forEach((e,t)=>{e<a?d=Math.max(t,d):e>a&&(c=Math.min(t,c))}),{low:d,high:c}),p=v.low,I=v.high,E=[];for(;p>=0||I<h.indicesToRequest.length;){let e=g.currentImageIdIndex,t=e-h.indicesToRequest[p]>X.maxImagesToPrefetch,n=h.indicesToRequest[I]-e>X.maxImagesToPrefetch,i=!t&&p>=0,o=!n&&I<h.indicesToRequest.length;if(!o&&!i)break;i&&(s=h.indicesToRequest[p--],r=g.imageIds[s],E.push(r)),o&&(s=h.indicesToRequest[I++],r=g.imageIds[s],E.push(r))}let w=(t,n)=>{var i;let{retrieveOptions:o={}}=V.metaData.get(Y.IMAGE_RETRIEVE_CONFIGURATION,t,"stack")||{};return n.retrieveOptions={...n.retrieveOptions,...o.default||(null==(i=Object.values(o))?void 0:i[0])||{}},N.imageLoader.loadAndCacheImage(t,n).then(()=>{console.log("prefetch done: %s",t),m(g.imageIds.indexOf(t)),0===h.indicesToRequest.length&&(0,l.triggerEvent)(L.eventTarget,K.Events.STACK_PREFETCH_COMPLETE,{element:e,lastPrefetchedImageId:t})})};E.forEach(e=>{U.default.addRequest(w.bind(null,e,{requestType:q}),q,{imageId:e},0)})}function J(e){clearTimeout(t),t=setTimeout(function(){let t=e.target;try{Z(t)}catch(e){return}},10)}let Q={enable:function(e){let t=H(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");let n={indicesToRequest:function(e,t){e=Math.round(e)||0;let n=[],i=(t=Math.round(t)||0)-e+1;if(i<=0)return n;for(;i--;)n[i]=t--;return n}(0,t.imageIds.length-1),enabled:!0,direction:1},i=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(i,1),G(e,n),Z(e),e.removeEventListener(R.Enums.Events.STACK_NEW_IMAGE,J),e.addEventListener(R.Enums.Events.STACK_NEW_IMAGE,J);let o=j(e);L.eventTarget.removeEventListener(R.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o),L.eventTarget.addEventListener(R.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o)},disable:function(e){clearTimeout(t),e.removeEventListener(R.Enums.Events.STACK_NEW_IMAGE,J);let n=j(e);L.eventTarget.removeEventListener(R.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n);let i=W(e);i&&i.indicesToRequest.length&&(i.enabled=!1,U.default.clearRequestStack(q))},getConfiguration:function(){return X},setConfiguration:function(e){X=e}};var U=U;let{imageRetrieveMetadataProvider:$}=r.utilities,ee={maxImagesToPrefetch:1/0,minBefore:2,maxAfter:2,directionExtraImages:10,preserveExistingPool:!1},et={};function en(e){var t,n,i;let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=H(e);if(!a)return;if(!(null==a||null==(t=a.imageIds)?void 0:t.length))return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");let r=W(e);if(!r)return;let s=r||{};if(s.enabled=s.enabled&&(null!=(i=null==(n=s.indicesToRequest)?void 0:n.length)?i:0)>0,!1===s.enabled)return;function d(e){let t=s.indicesToRequest.indexOf(e);t>-1&&s.indicesToRequest.splice(t,1)}let c=s.indicesToRequest.slice(),{currentImageIdIndex:u}=a;if(c.forEach(e=>{let t=a.imageIds[e];t&&(6>Math.abs(u-e)?k.cache.getImageLoadObject(t):k.cache.isLoaded(t))&&d(e)}),!s.indicesToRequest.length)return;ee.preserveExistingPool||U.default.filterRequests((e=>{let t=new Set(e.imageIds);return e=>e.type!==q||!t.has(e.additionalDetails.imageId)})(a));let h=(t,n)=>{var i;let{retrieveOptions:r={}}=V.metaData.get($.IMAGE_RETRIEVE_CONFIGURATION,t,"stack")||{};return n.retrieveOptions={...n.retrieveOptions,...r.default||(null==(i=Object.values(r))?void 0:i[0])||{}},N.imageLoader.loadAndCacheImage(t,n).then(()=>(function(t){var n,i;d(a.imageIds.indexOf(t));let r=k.cache.getCachedImageBasedOnImageURI(t),{stats:c}=s,u=(null==r||null==(n=r.image)?void 0:n.decodeTimeInMS)||0;if(u){c.imageIds.set(t,u),c.decodeTimeInMS+=u;let e=(null==r||null==(i=r.image)?void 0:i.loadTimeInMS)||0;c.loadTimeInMS+=e}if(!s.indicesToRequest.length&&(null==r?void 0:r.sizeInBytes)){let{sizeInBytes:t}=r,n=k.cache.getMaxCacheSize()/4/t;if(s.cacheFill){if(c.imageIds.size){c.fillTime=Date.now()-c.start;let{size:e}=c.imageIds;c.fillSize=e}}else c.initialTime=Date.now()-c.start,c.initialSize=c.imageIds.size,eo(e,n),en(e,o)}0===s.indicesToRequest.length&&(0,l.triggerEvent)(L.eventTarget,K.Events.STACK_PREFETCH_COMPLETE,{element:e,lastPrefetchedImageId:t})})(t))};s.indicesToRequest.forEach(e=>{let t=a.imageIds[e];U.default.addRequest(h.bind(null,t,{requestType:q}),q,{imageId:t},o)})}function ei(e){clearTimeout(n),n=setTimeout(function(){let t=e.target;try{eo(t),en(t,et[t])}catch(e){return}},5)}let eo=(e,t)=>{var n;let i=H(e);if(!i)return;if(!(null==(n=i.imageIds)?void 0:n.length))return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");let{currentImageIdIndex:o}=i,{maxAfter:a=2,minBefore:r=2}=ee,{directionExtraImages:l=10}=ee,s=W(e)||{indicesToRequest:[],currentImageIdIndex:o,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},d=o-s.currentImageIdIndex;if(s.direction=d<0?-1:1,s.currentImageIdIndex=o,s.enabled=!0,s.stackCount<100&&(s.stackCount+=l),Math.abs(d)>a||!d)if(s.stackCount=0,t){let e=o/i.imageIds.length;r=Math.ceil(t*e),a=Math.ceil(t*(1-e)),s.cacheFill=!0}else s.cacheFill=!1;else d<0?(r+=s.stackCount,a=0):(a+=s.stackCount,r=0);let c=Math.max(0,o-r),u=Math.min(i.imageIds.length-1,o+a),h=[];for(let e=o+1;e<=u;e++)h.push(e);for(let e=o-1;e>=c;e--)h.push(e);s.indicesToRequest=h,G(e,s)},ea={enable:function(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=H(e);if(!i)return;if(!(null==(t=i.imageIds)?void 0:t.length))return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");eo(e),et[e]=n,en(e,n),e.removeEventListener(R.Enums.Events.STACK_NEW_IMAGE,ei),e.addEventListener(R.Enums.Events.STACK_NEW_IMAGE,ei);let o=j(e);L.eventTarget.removeEventListener(R.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o),L.eventTarget.addEventListener(R.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o)},disable:function(e){clearTimeout(n),e.removeEventListener(R.Enums.Events.STACK_NEW_IMAGE,ei);let t=j(e);L.eventTarget.removeEventListener(R.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);let i=W(e);i&&(i.enabled=!1)},getConfiguration:function(){return ee},setConfiguration:function(e){ee=e}};e.s(["isViewportPreScaled",()=>el.isViewportPreScaled],74071),e.s([],440697);var er=e.i(91076);e.i(440697);var el=er,es=e.i(74071);function ed(e,t){var n,i;let o=em(e),a=em(t);return{page:ep(o.page,a.page),client:ep(o.client,a.client),canvas:ep(o.canvas,a.canvas),world:(n=o.world,i=a.world,[n[0]-i[0],n[1]-i[1],n[2]-i[2]])}}function ec(e,t){let n=em(e),i=em(t);return{page:eE(n.page,i.page),client:eE(n.client,i.client),canvas:eE(n.canvas,i.canvas),world:ew(n.world,i.world)}}function eu(e,t){}function eh(e,t){let n=eI(e),i=eI(t);return{page:n.page-i.page,client:n.client-i.client,canvas:n.canvas-i.canvas,world:n.world-i.world}}function eg(e){return JSON.parse(JSON.stringify(e))}function ef(e){return JSON.parse(JSON.stringify(e))}function em(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function ev(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function ep(e,t){return[e[0]-t[0],e[1]-t[1]]}function eI(e){let t=[];for(let n=0;n<e.length;n++)for(let i=0;i<e.length;i++)n<i&&t.push({page:eE(e[n].page,e[i].page),client:eE(e[n].client,e[i].client),canvas:eE(e[n].canvas,e[i].canvas),world:ew(e[n].world,e[i].world)});return t.reduce((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length}),{page:0,client:0,canvas:0,world:0})}function eE(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function ew(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}e.s(["copyPoints",()=>ef,"copyPointsList",()=>eg,"getDeltaDistance",()=>ec,"getDeltaDistanceBetweenIPoints",()=>eh,"getDeltaPoints",()=>ed,"getDeltaRotation",()=>eu,"getMeanPoints",()=>em,"getMeanTouchPoints",()=>ev],240634);var e_=e.i(240634);e.s(["generateImageFromTimeData",()=>eb,"getDataInTime",()=>ey,"updateVolumeFromTimeData",()=>eA],151448),e.s([],97123);var eS=e.i(62075);let ey=function(e,t){let n,i=t.dimensionGroupNumbers||t.frameNumbers||Array.from({length:e.numDimensionGroups},(e,t)=>t+1);if(t.frameNumbers&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead."),!t.maskVolumeId&&!t.worldCoordinate)throw Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.worldCoordinate)throw Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){let n=k.cache.getVolume(t.maskVolumeId);if(!n)throw Error("Segmentation volume not found");let[o,a]=function(e,t,n){let{imageData:i}=n,o=n.voxelManager,a=o.getScalarDataLength(),r=[];r.length=a;let l=0;for(let e=0;e<a;e++)0!==o.getAtIndex(e)&&(r[l++]=e);r.length=l;let s=[],d=t.voxelManager.getScalarDataLength()===a&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing),c=[];if(d){for(let n=0;n<r.length;n++){let i=[],a=r[n];for(let n=0;n<e.length;n++)i.push(t.voxelManager.getAtIndexAndDimensionGroup(a,e[n]));s.push(i),c.push(o.toIJK(a))}return[s,c]}return n.voxelManager.forEach(n=>{let{pointLPS:i,value:o,pointIJK:a}=n;if(0===o)return;let r=(0,eS.getVoxelOverlap)(t.imageData,t.dimensions,t.spacing,i),l=0,d=new Map;e.forEach(e=>d.set(e,0)),t.voxelManager.forEach(n=>{let{index:i}=n;for(let n=0;n<e.length;n++){let o=t.voxelManager.getAtIndexAndDimensionGroup(i,e[n]),a=e[n];d.set(a,d.get(a)+o)}l++},{imageData:t.imageData,boundsIJK:r});let u=[];d.forEach(e=>{u.push(e/l)}),c.push(a),s.push(u)},{imageData:i}),[s,c]}(i,e,n);return[o,a]}return t.worldCoordinate?function(e,t,n){let{dimensions:i,imageData:o}=n,a=o.worldToIndex(t);if(a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),!r.utilities.indexWithinDimensions(a,i))throw Error("outside bounds");let l=i[0],s=i[0]*i[1],d=[];return e.forEach(e=>{let t=a[2]*s+a[1]*l+a[0];d.push(n.voxelManager.getAtIndexAndDimensionGroup(t,e))}),d}(i,t.worldCoordinate,e):n};function eT(e,t){let n=e.getScalarDataLength(),i=new Float32Array(n);for(let o of t){let t=e.getDimensionGroupScalarData(o);for(let e=0;e<n;e++)i[e]+=t[e]}return i}let eC={[R.Enums.GenerateImageType.SUM]:(e,t,n)=>{let i=eT(e,t);for(let e=0;e<i.length;e++)n(e,i[e])},[R.Enums.GenerateImageType.AVERAGE]:(e,t,n)=>{let i=function(e,t){let n=eT(e,t),i=t.length;for(let e=0;e<n.length;e++)n[e]/=i;return n}(e,t);for(let e=0;e<i.length;e++)n(e,i[e])},[R.Enums.GenerateImageType.SUBTRACT]:(e,t,n)=>{if(2!==t.length)throw Error("Please provide only 2 dimension groups for subtraction.");let i=e.getScalarDataLength(),o=e.getDimensionGroupScalarData(t[0]),a=e.getDimensionGroupScalarData(t[1]);for(let e=0;e<i;e++){let t=o[e]-a[e];n(e,t)}}};function eb(e,t,n){let{dimensionGroupNumbers:i,frameNumbers:o}=n;o&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead.");let a=i||o||Array.from({length:e.numDimensionGroups},(e,t)=>t+1);if(a.length<=1)throw Error("Please provide two or more dimension groups");let r=e.voxelManager,l=r.getScalarDataLength(),s=eC[t];if(!s)throw Error("Unsupported operation: ".concat(t));let d=new Float32Array(l);return s(r,a,(e,t)=>{d[e]=t}),d}function eA(e,t,n){let{dimensionGroupNumbers:i,frameNumbers:o,targetVolume:a}=n;if(!a)throw Error("A target volume must be provided");o&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead.");let r=i||o||Array.from({length:e.numDimensionGroups},(e,t)=>t+1);if(r.length<=1)throw Error("Please provide two or more dimension groups");let l=e.voxelManager,s=a.voxelManager,d=eC[t];if(!d)throw Error("Unsupported operation: ".concat(t));d(l,r,(e,t)=>{s.setAtIndex(e,t)}),s.resetModifiedSlices();for(let e=0;e<a.dimensions[2];e++)s.modifiedSlices.add(e)}e.i(97123);var ex=e.i(151448);e.s(["getPoint",()=>eM,"getPolyDataPointIndexes",()=>eO,"getPolyDataPoints",()=>eP],519879);var eD=e.i(399021);function eM(e,t){let n=3*t;if(n<e.length)return eD.vec3.fromValues(e[n],e[n+1],e[n+2])}function eO(e){let t=e.getLines().getData(),n=0,i=new Map;for(;n<t.length;){let e=t[n++],o=[];for(let i=0;i<e;i++)o.push(t[n+i]);i.set(o[0],o),n+=e}let o=[],a=e=>{for(let[t,n]of e.entries())if(void 0!==n)return t;return -1},r=a(i);for(;-1!==r;){let e=[r];for(;i.has(r);){let t=i.get(r)[1];i.has(t)&&e.push(t),i.delete(r),r=t}o.push(e),r=a(i)}return o.length?o:void 0}function eP(e){let t=eO(e);if(!t)return;let n=e.getPoints().getData();return t.map(e=>e.map(e=>eM(n,e)))}var eN=e.i(519879);e.s(["colorbar",()=>e5,"windowLevel",()=>e4],222453),e.s([],296484),e.s(["Colorbar",()=>eY,"Enums",()=>eL,"ViewportColorbar",()=>eQ],413894),e.s([],133866),e.s(["ColorbarRangeTextPosition",()=>i],749571),e.s([],346335),e.i(346335),function(e){e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right"}(i||(i={}));var eR=e.i(749571);e.i(133866);var eL=eR,eU=e.i(453811);let ek=e=>e&&e.upper>e.lower,eV=(e,t)=>!!e&&!!t&&e.lower===t.lower&&e.upper===t.upper,eF=(e,t,n)=>[e[0]*(1-n)+t[0]*n,e[1]*(1-n)+t[1]*n,e[2]*(1-n)+t[2]*n],eB=e=>!!e&&e.width>0&&e.height>0,eG=(e,t)=>!!e&&!!t&&e.width===t.width&&e.height===t.height,{clamp:eW}=r.utilities;class ez{get colormap(){return this._colormap}set colormap(e){this._colormap=e,this.render()}get size(){let{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){let{_canvas:t}=this;!eB(e)||eG(t,e)||(this._setCanvasSize(t,e),this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){!ek(e)||eV(e,this._imageRange)||(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){!ek(e)||eV(e,this._voiRange)||(this._voiRange=e,this.render())}get showFullImageRange(){return this._showFullImageRange}set showFullImageRange(e){e!==this._showFullImageRange&&(this._showFullImageRange=e,this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}dispose(){let{_canvas:e}=this,{parentElement:t}=e;null==t||t.removeChild(e)}static validateProps(e){let{size:t,imageRange:n,voiRange:i}=e;if(t&&!eB(t))throw Error('Invalid "size"');if(n&&!ek(n))throw Error('Invalid "imageRange"');if(i&&!ek(i))throw Error('Invalid "voiRange"')}_setCanvasSize(e,t){let{width:n,height:i}=t;e.width=n,e.height=i,Object.assign(e.style,{width:"".concat(n,"px"),height:"".concat(i,"px")})}_createRootElement(e){let t=document.createElement("canvas");return Object.assign(t.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",boxSizing:"border-box"}),this._setCanvasSize(t,e),t}render(){let e;if(!this._canvas.isConnected)return;let{_colormap:t}=this,{RGBPoints:n}=t,i=n.length/4,o=e=>{let t=4*e;if(!(e<0)&&!(e>=i))return{index:e,position:n[t],color:[n[t+1],n[t+2],n[t+3]]}},{width:a,height:r}=this._canvas,l=this._canvas.getContext("2d");if(!l)return;let s=a>r,d=s?a:r,{_voiRange:c}=this,u=this._showFullImageRange?this._imageRange:{...c},h=o(0),g=(u.upper-u.lower)/(d-1),f=u.lower;for(let t=0;t<d;t++){let n,d=(f-c.lower)/Math.abs(c.upper-c.lower);if(h)for(let t=h.index;t<i&&!(d<=h.position);t++)e=h,h=o(t+1);if(e)if(h){let t=(d-e.position)/(h.position-e.position);n=eF(e.color,h.color,t)}else n=[...e.color];else n=[...h.color];let u=n.map(e=>eW(Math.round(255*e),0,255));l.fillStyle="rgb(".concat(u[0],", ").concat(u[1],", ").concat(u[2],")"),s?l.fillRect(t,0,1,r):l.fillRect(0,r-t-1,a,1),f+=g}}constructor(e){ez.validateProps(e);let{colormap:t,size:n={width:20,height:100},imageRange:i={lower:0,upper:1},voiRange:o={lower:0,upper:1},container:a,showFullPixelValueRange:r=!1}=e;this._colormap=t,this._imageRange=i,this._voiRange=o,this._showFullImageRange=r,this._canvas=this._createRootElement(n),a&&this.appendTo(a)}}let eq={FONT:"10px Arial",COLOR:"white",TICK_SIZE:5,TICK_WIDTH:1,TICK_LABEL_MARGIN:3,MAX_NUM_TICKS:8,TICKS_STEPS:[1,2.5,5,10]};class eH{get size(){let{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){let{_canvas:t}=this;!eB(e)||eG(t,e)||(this._setCanvasSize(t,e),this.render())}get top(){return Number.parseInt(this._canvas.style.top)}set top(e){let{_canvas:t}=this;e!==this.top&&(t.style.top="".concat(e,"px"),this.render())}get left(){return Number.parseInt(this._canvas.style.left)}set left(e){let{_canvas:t}=this;e!==this.left&&(t.style.left="".concat(e,"px"),this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){!ek(e)||eV(e,this._imageRange)||(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){!ek(e)||eV(e,this._voiRange)||(this._voiRange=e,this.render())}get tickSize(){return this._tickSize}set tickSize(e){e!==this._tickSize&&(this._tickSize=e,this.render())}get tickWidth(){return this._tickWidth}set tickWidth(e){e!==this._tickWidth&&(this._tickWidth=e,this.render())}get color(){return this._color}set color(e){e!==this._color&&(this._color=e,this.render())}get showFullPixelValueRange(){return this._showFullPixelValueRange}set showFullPixelValueRange(e){e!==this._showFullPixelValueRange&&(this._showFullPixelValueRange=e,this.render())}get visible(){return"block"===this._canvas.style.display}set visible(e){e!==this.visible&&(this._canvas.style.display=e?"block":"none",e&&this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}static validateProps(e){let{size:t,imageRange:n,voiRange:i}=e;if(t&&!eB(t))throw Error('Invalid "size"');if(n&&!ek(n))throw Error('Invalid "imageRange"');if(i&&!ek(i))throw Error('Invalid "voiRange"')}_setCanvasSize(e,t){let{width:n,height:i}=t;e.width=n,e.height=i,Object.assign(e.style,{width:"".concat(n,"px"),height:"".concat(i,"px")})}_createCanvasElement(e,t,n){let i=document.createElement("canvas");return Object.assign(i.style,{display:"none",position:"absolute",boxSizing:"border-box",top:"".concat(t,"px"),left:"".concat(n,"px")}),this._setCanvasSize(i,e),i}_getTicks(e){let{lower:t,upper:n}=e,i=(n-t)/(this._maxNumTicks-1),o=Math.pow(10,-Math.floor(Math.log10(Math.abs(i)))),a=i*o,r=eq.TICKS_STEPS.find(e=>e>=a)/o,l=Math.ceil(n/r)*r,s=Math.floor(t/r)*r,d=Math.round((l-s)/r)+1,c=[];for(let e=0;e<d;e++)c.push(s+e*r);return{scaleMin:s,scaleMax:l,step:r,ticks:c}}_getLeftTickInfo(e){let{position:t,labelMeasure:n}=e,{width:i}=this._canvas;return{labelPoint:[i-this.tickSize-n.width-this._labelMargin,t],tickPoints:{start:[i-this._tickSize,t],end:[i,t]}}}_getRightTickInfo(e){let{position:t}=e;return{labelPoint:[this._tickSize+this._labelMargin,t],tickPoints:{start:[0,t],end:[this._tickSize,t]}}}_getTopTickInfo(e){let{position:t,labelMeasure:n}=e,{height:i}=this._canvas;return{labelPoint:[t,i-this.tickSize-this._labelMargin],tickPoints:{start:[t,i-this._tickSize],end:[t,i]}}}_getBottomTickInfo(e){let{position:t,labelMeasure:n}=e;return{labelPoint:[t,this._tickSize+this._labelMargin],tickPoints:{start:[t,0],end:[t,this._tickSize]}}}render(){let{_canvas:e}=this;if(!e.isConnected||!this.visible)return;let{width:t,height:n}=e,o=t>=n,a=o?t:n,r=e.getContext("2d"),{_voiRange:l}=this,s=this._showFullPixelValueRange?this._imageRange:{...l},d=s.upper-s.lower,{ticks:c}=this._getTicks(s);r.clearRect(0,0,t,n),r.font=this._font,r.textBaseline=o?"top":"middle",r.textAlign=o?"center":"left",r.fillStyle=this._color,r.strokeStyle=this._color,r.lineWidth=this.tickWidth,c.forEach(e=>{let t=Math.round(a*((e-s.lower)/d));if(o||(t=n-t),t<0||t>a)return;let l=e.toString(),c=r.measureText(l),{labelPoint:u,tickPoints:h}=o?this._rangeTextPosition===i.Top?this._getTopTickInfo({position:t,labelMeasure:c}):this._getBottomTickInfo({position:t,labelMeasure:c}):this._rangeTextPosition===i.Left?this._getLeftTickInfo({position:t,labelMeasure:c}):this._getRightTickInfo({position:t}),{start:g,end:f}=h;return r.beginPath(),r.moveTo(g[0],g[1]),r.lineTo(f[0],f[1]),r.fillText(l,u[0],u[1]),r.stroke(),t})}constructor(e){var t,n,o,a,r,l;eH.validateProps(e);let{top:s=0,left:d=0,size:c={width:20,height:100},imageRange:u={lower:0,upper:1},voiRange:h={lower:0,upper:1},ticks:g,container:f,showFullPixelValueRange:m=!1}=e,{style:v,position:p}=null!=g?g:{};this._imageRange=u,this._voiRange=h,this._font=null!=(t=null==v?void 0:v.font)?t:eq.FONT,this._color=null!=(n=null==v?void 0:v.color)?n:eq.COLOR,this._tickSize=null!=(o=null==v?void 0:v.tickSize)?o:eq.TICK_SIZE,this._tickWidth=null!=(a=null==v?void 0:v.tickWidth)?a:eq.TICK_WIDTH,this._labelMargin=null!=(r=null==v?void 0:v.labelMargin)?r:eq.TICK_LABEL_MARGIN,this._maxNumTicks=null!=(l=null==v?void 0:v.maxNumTicks)?l:eq.MAX_NUM_TICKS,this._rangeTextPosition=null!=p?p:i.Right,this._showFullPixelValueRange=m,this._canvas=this._createCanvasElement(c,s,d),f&&this.appendTo(f)}}class ej{get id(){return this._id}get rootElement(){return this._rootElement}appendTo(e){let{_rootElement:t,_containerResizeObserver:n}=this,{parentElement:i}=t;e&&e!==i&&(i&&n.unobserve(i),e.appendChild(t),n.observe(e))}destroy(){let{_rootElement:e,_containerResizeObserver:t}=this,{parentElement:n}=e;null==n||n.removeChild(e),t.disconnect()}get containerSize(){return{...this._containerSize}}createRootElement(e){let t=document.createElement("div");return t.id=e,t.classList.add("widget"),Object.assign(t.style,{width:"100%",height:"100%"}),t}onContainerResize(){}constructor({id:e,container:t}){this._containerResizeCallback=e=>{let t,n,{contentRect:i,contentBoxSize:o}=e[0];i?(t=i.width,n=i.height):(null==o?void 0:o.length)&&(t=o[0].inlineSize,n=o[0].blockSize),this._containerSize={width:t,height:n},this.onContainerResize()},this._id=e,this._containerSize={width:0,height:0},this._rootElement=this.createRootElement(e),this._containerResizeObserver=new ResizeObserver(this._containerResizeCallback),t&&this.appendTo(t)}}let eK={MULTIPLIER:1,RANGE_TEXT_POSITION:i.Right,TICKS_BAR_SIZE:50};class eY extends ej{get activeColormapName(){return this._activeColormapName}set activeColormapName(e){if(e===this._activeColormapName)return;let t=this._colormaps.get(e);if(!t)return void console.warn("Invalid colormap name (".concat(e,")"));this._activeColormapName=e,this._canvas.colormap=t}get imageRange(){return this._canvas.imageRange}set imageRange(e){this._canvas.imageRange=e,this._ticksBar.imageRange=e}get voiRange(){return this._canvas.voiRange}set voiRange(e){let{voiRange:t}=this._canvas;!ek(e)||eV(e,t)||(this._canvas.voiRange=e,this._ticksBar.voiRange=e,this.onVoiChange(e))}get showFullImageRange(){return this._canvas.showFullImageRange}set showFullImageRange(e){this._canvas.showFullImageRange=e,this._ticksBar.showFullPixelValueRange=e}destroy(){super.destroy(),this._eventListenersManager.reset()}createRootElement(){let e=document.createElement("div");return Object.assign(e.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),e}onContainerResize(){super.onContainerResize(),this.updateTicksBar(),this._canvas.size=this.containerSize}getVOIMultipliers(){return[eK.MULTIPLIER,eK.MULTIPLIER]}onVoiChange(e){}showTicks(){this.updateTicksBar(),this._ticksBar.visible=!0}hideTicks(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}static getColormapsMap(e){let{colormaps:t}=e;return t.reduce((e,t)=>e.set(t.Name,t),new Map)}static getInitialColormapName(e){let{activeColormapName:t,colormaps:n}=e;return t&&n.some(e=>e.Name===t)?t:n[0].Name}_createCanvas(e){let{imageRange:t,voiRange:n,showFullPixelValueRange:i}=e;return new ez({colormap:this._colormaps.get(this._activeColormapName),imageRange:t,voiRange:n,showFullPixelValueRange:i})}_createTicksBar(e){let t=e.ticks;return new eH({imageRange:e.imageRange,voiRange:e.voiRange,ticks:t,showFullPixelValueRange:e.showFullPixelValueRange})}_getPointsFromMouseEvent(e){let{rootElement:t}=this,n=[e.clientX,e.clientY],i=[e.pageX,e.pageY],o=t.getBoundingClientRect(),a=[i[0]-o.left-window.pageXOffset,i[1]-o.top-window.pageYOffset];return{client:n,page:i,local:a}}updateTicksBar(){let e,t,{width:n,height:o}=this.containerSize;if(0===n&&0===o)return;let{_ticksBar:a,_rangeTextPosition:r}=this,l=n>=o,s=l?n:eK.TICKS_BAR_SIZE,d=l?eK.TICKS_BAR_SIZE:o;if(!(n>=o?[i.Top,i.Bottom]:[i.Left,i.Right]).includes(r))throw Error("Invalid rangeTextPosition value for the current colobar orientation");a.size={width:s,height:d},l?(t=0,e=r===i.Top?-d:o):(e=0,t=r===i.Left?-s:n),a.top=e,a.left=t}_addRootElementEventListeners(){let{_eventListenersManager:e}=this,{rootElement:t}=this;e.addEventListener(t,"mouseover",this._mouseOverCallback),e.addEventListener(t,"mouseout",this._mouseOutCallback),e.addEventListener(t,"mousedown",this._mouseDownCallback)}_addVOIEventListeners(e){let{_eventListenersManager:t}=this,n={points:this._getPointsFromMouseEvent(e),voiRange:{...this._canvas.voiRange}};this._removeVOIEventListeners(),t.addEventListener(document,"voi.mouseup",this._mouseUpCallback),t.addEventListener(document,"voi.mousemove",e=>this._mouseDragCallback(e,n))}_removeVOIEventListeners(){let{_eventListenersManager:e}=this;e.removeEventListener(document,"voi.mouseup"),e.removeEventListener(document,"voi.mousemove")}constructor(e){var t,n;super(e),this._isMouseOver=!1,this._isInteracting=!1,this._mouseOverCallback=e=>{this._isMouseOver=!0,this.showTicks(),e.stopPropagation()},this._mouseOutCallback=e=>{this._isMouseOver=!1,this.hideTicks(),e.stopPropagation()},this._mouseDownCallback=e=>{this._isInteracting=!0,this.showTicks(),this._addVOIEventListeners(e),e.stopPropagation()},this._mouseDragCallback=(e,t)=>{let n=this.getVOIMultipliers(),i=this._getPointsFromMouseEvent(e),{points:o,voiRange:a}=t,l=eU.vec2.sub(eU.vec2.create(),i.local,o.local),s=l[0]*n[0],d=l[1]*n[1];if(!s&&!d)return;let{lower:c,upper:u}=a,{windowWidth:h,windowCenter:g}=r.utilities.windowLevel.toWindowLevel(c,u);h=Math.max(h+s,1),g+=d;let f=r.utilities.windowLevel.toLowHighRange(h,g);this.voiRange=f,e.stopPropagation(),e.preventDefault()},this._mouseUpCallback=e=>{this._isInteracting=!1,this.hideTicks(),this._removeVOIEventListeners(),e.stopPropagation()},this._eventListenersManager=new r.utilities.eventListener.MultiTargetEventListenerManager,this._colormaps=eY.getColormapsMap(e),this._activeColormapName=eY.getInitialColormapName(e),this._canvas=this._createCanvas(e),this._ticksBar=this._createTicksBar(e),this._rangeTextPosition=null!=(n=null==(t=e.ticks)?void 0:t.position)?n:eK.RANGE_TEXT_POSITION,this._canvas.appendTo(this.rootElement),this._ticksBar.appendTo(this.rootElement),this._addRootElementEventListeners()}}var eX=e.i(802939);let{Events:eZ}=R.Enums,eJ={lower:-1e3,upper:1e3};class eQ extends eY{get element(){return this._element}get enabledElement(){return(0,F.getEnabledElement)(this._element)}getVOIMultipliers(){let{viewport:e}=this.enabledElement;return function(e,t,n){if("PT"===r.utilities.getViewportModality(e,t)){let{clientWidth:n,clientHeight:i}=e.element,o=5/Math.max(n,i),a=(0,er.isViewportPreScaled)(e,t),{fixedPTWindowWidth:r=!0}={},l=r?0:o;return a?[l,o]:[l,4]}return[4,4]}(e,this._volumeId)}onVoiChange(e){super.onVoiChange(e);let{viewport:t}=this.enabledElement;if(t instanceof z.StackViewport)t.setProperties({voiRange:e}),t.render();else if(t instanceof eX.VolumeViewport){let{_volumeId:n}=this,i=r.utilities.getViewportsWithVolumeId(n);t.setProperties({voiRange:e},n),i.forEach(e=>e.render())}}static _getImageRange(e,t){let n,{viewport:i}=(0,F.getEnabledElement)(e),o=i.getImageActor(t);if(!o)return eJ;let a=o.getMapper().getInputData().getPointData().getScalars();if(a)n=a.getRange();else{if(!t)throw Error("volumeId is required when scalarData is not available");let[e,i]=k.cache.getVolume(t).voxelManager.getRange();n=[e,i]}return 0===n[0]&&0===n[1]?eJ:{lower:n[0],upper:n[1]}}static _getVOIRange(e,t){let{viewport:n}=(0,F.getEnabledElement)(e),i=n.getImageActor(t);if(!i)return eJ;let o=i.getProperty().getRGBTransferFunction(0).getRange();return 0===o[0]&&0===o[1]?eJ:{lower:o[0],upper:o[1]}}showAndAutoHideTicks(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this._hideTicksTime=Date.now()+e,this.showTicks(),this.autoHideTicks()}_addCornerstoneEventListener(){let{_element:e}=this;L.eventTarget.addEventListener(eZ.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.addEventListener(eZ.STACK_NEW_IMAGE,this._stackNewImageCallback),e.addEventListener(eZ.VOI_MODIFIED,this._viewportVOIModifiedCallback),e.addEventListener(eZ.COLORMAP_MODIFIED,this._viewportColormapModifiedCallback)}destroy(){super.destroy();let{_element:e}=this;L.eventTarget.removeEventListener(eZ.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.removeEventListener(eZ.STACK_NEW_IMAGE,this._stackNewImageCallback),e.removeEventListener(eZ.VOI_MODIFIED,this._viewportVOIModifiedCallback),e.removeEventListener(eZ.COLORMAP_MODIFIED,this._viewportColormapModifiedCallback)}constructor(e){let{element:t,volumeId:n}=e;super({...e,imageRange:eQ._getImageRange(t,n),voiRange:eQ._getVOIRange(t,n)}),this.autoHideTicks=()=>{if(this._hideTicksTimeoutId)return;let e=this._hideTicksTime-Date.now();e<=0?this.hideTicks():this._hideTicksTimeoutId=window.setTimeout(()=>{this._hideTicksTimeoutId=0,this.autoHideTicks()},e)},this._stackNewImageCallback=()=>{this.imageRange=eQ._getImageRange(this._element)},this._imageVolumeModifiedCallback=e=>{let{volumeId:t}=e.detail;if(t!==this._volumeId)return;let{_element:n}=this;this.imageRange=eQ._getImageRange(n,t)},this._viewportVOIModifiedCallback=e=>{let{viewportId:t,volumeId:n,range:i,colormap:o}=e.detail,{viewport:a}=this.enabledElement;t===a.id&&n===this._volumeId&&(this.voiRange=i,o&&(this.activeColormapName=o.name),this.showAndAutoHideTicks())},this._viewportColormapModifiedCallback=e=>{let{viewportId:t,colormap:n,volumeId:i}=e.detail,{viewport:o}=this.enabledElement;t===o.id&&i===this._volumeId&&(this.activeColormapName=n.name)},this._element=t,this._volumeId=n,this._addCornerstoneEventListener()}}var e$=e.i(413894);function e0(e,t,n,i,o){let a,r,l,s=[],d=0,c=e.scalarData;if(e.color)for(r=0;r<o;r++)for(l=0;l<i;l++){let i=c[a=((r+n)*e.columns+(l+t))*4],o=c[a+1],u=c[a+2];s[d++]=.2126*i+.7152*o+.0722*u}else for(r=0;r<o;r++)for(l=0;l<i;l++)a=(r+n)*e.columns+(l+t),s[d++]=c[a];return s}function e1(e,t,n){let i=e.length,o=n,a=t,r=0;if(i<2)return{min:o,max:a,mean:(t+n)/2};for(let t=0;t<i;t++){let n=e[t];o=Math.min(o,n),a=Math.max(a,n),r+=n}return{min:o,max:a,mean:r/i}}function e2(e){if(e instanceof eX.VolumeViewport){var t=e;let{scalarData:n,width:i,height:o}=r.utilities.getCurrentVolumeViewportSlice(t),{min:a,max:l}=r.utilities.getMinMax(n);return{scalarData:n,minPixelValue:a,maxPixelValue:l,width:i,height:o,rows:i,columns:o}}if(e instanceof z.StackViewport)return function(e){let t=e.getImageData(),{scalarData:n}=t,{min:i,max:o}=r.utilities.getMinMax(n),a=t.dimensions[0],l=t.dimensions[1],{rows:s,columns:d,color:c}=e.getCornerstoneImage();return{scalarData:n,width:a,height:l,minPixelValue:i,maxPixelValue:o,rows:s,columns:d,color:c}}(e);throw Error("Viewport not supported")}e.s(["calculateMinMaxMean",()=>e1,"extractWindowLevelRegionToolData",()=>e2,"getLuminanceFromRegion",()=>e0],743600),e.s([],373839),e.i(373839);var e3=e.i(743600);e.i(296484);var e5=e$,e4=e3,e8=e.i(222453);function e6(e,t){let{segmentation:n}=e.data,{segmentation:i}=t.data;return n.segmentationId===i.segmentationId&&n.segmentIndex===i.segmentIndex}e.s(["LogicalOperation",()=>o,"add",()=>tx,"addContourSegmentationAnnotation",()=>tL.addContourSegmentationAnnotation,"areSameSegment",()=>e6,"checkIntersection",()=>tX.checkIntersection,"cleanupPolylines",()=>tX.cleanupPolylines,"combinePolylines",()=>tX.combinePolylines,"contourSegmentationOperation",()=>tY,"convertContourPolylineToCanvasSpace",()=>tX.convertContourPolylineToCanvasSpace,"convertContourPolylineToWorld",()=>tX.convertContourPolylineToWorld,"convertContourSegmentationAnnotation",()=>tn,"copy",()=>tP,"copyAnnotation",()=>ts,"copyContourSegment",()=>td,"createNewAnnotationFromPolyline",()=>tX.createNewAnnotationFromPolyline,"createPolylineHole",()=>tX.createPolylineHole,"deleteOperation",()=>tN,"findAllIntersectingContours",()=>tV,"getContourHolesData",()=>tX.getContourHolesData,"intersect",()=>tM,"intersectPolylinesSets",()=>ty,"isContourSegmentationAnnotation",()=>tR,"processMultipleIntersections",()=>tq,"removeContourSegmentationAnnotation",()=>tU.removeContourSegmentationAnnotation,"removeDuplicatePoints",()=>tX.removeDuplicatePoints,"subtract",()=>tD,"subtractAnnotationPolylines",()=>t_,"subtractMultiplePolylineSets",()=>tw,"subtractPolylineSets",()=>tE,"unifyAnnotationPolylines",()=>tI,"unifyMultiplePolylineSets",()=>tp,"unifyPolylineSets",()=>tv,"updateViewportsForAnnotations",()=>tX.updateViewportsForAnnotations,"xor",()=>tO,"xorPolylinesSets",()=>tT],416877),e.s([],553718),e.s(["default",()=>e6],299511);var e7=e.i(344962),e9=e.i(668441),te=e.i(797433),tt=e.i(162923);function tn(e){var t;let{polyline:n}=(null==(t=e.data)?void 0:t.contour)||{};if(!n||n.length<3)return void console.warn("Skipping creation of new annotation due to invalid polyline:",n);(0,e7.removeAnnotation)(e.annotationUID),(0,e9.removeContourSegmentationAnnotation)(e);let i=n[0],o=n[n.length-1],a={metadata:{...e.metadata,toolName:"PlanarFreehandContourSegmentationTool",originalToolName:e.metadata.originalToolName||e.metadata.toolName},data:{cachedStats:{},handles:{points:[i,o],textBox:e.data.handles.textBox?{...e.data.handles.textBox}:void 0},contour:{...e.data.contour},spline:e.data.spline,segmentation:{...e.data.segmentation}},annotationUID:r.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:e.interpolationUID,interpolationCompleted:e.interpolationCompleted};return(0,e7.addAnnotation)(a,e.metadata.FrameOfReferenceUID),(0,te.addContourSegmentationAnnotation)(a),(0,tt.triggerAnnotationModified)(a),a}var ti=e.i(573855),to=e.i(455165);function ta(e){let t=function(e){let t=(0,to.getViewportIdsWithSegmentation)(e);if((null==t?void 0:t.length)===0)return[];let n=[];for(let e of t){let{viewport:t}=(0,ti.getEnabledElementByViewportId)(e)||{};t&&n.push(t)}return n}(e);return t.length>0?t[0]:void 0}var tr=e.i(650658),tl=e.i(690335);function ts(e,t,n){var i,o;let a={annotationUID:r.utilities.uuidv4(),data:{contour:{closed:!0,polyline:[]},segmentation:{segmentationId:t,segmentIndex:n},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{...e.metadata,toolName:e.metadata.toolName}};return a.data.segmentation.segmentationId=t,a.data.segmentation.segmentIndex=n,(null==(i=e.data.contour)?void 0:i.polyline)&&(a.data.contour.polyline=[...e.data.contour.polyline]),(null==(o=e.data.handles)?void 0:o.points)&&(a.data.handles.points=e.data.handles.points.map(e=>[...e])),a}function td(e,t,n,i){let o=(0,tl.getAnnotationsUIDMapFromSegmentation)(e),a=(0,tl.getAnnotationsUIDMapFromSegmentation)(n);if(!o||!a||!(null==o?void 0:o.has(t)))return;let r=o.get(t),l=ta(n);if(!l)return;let s=(0,tr.getToolGroupForViewport)(l.id),d=e=>{let t=ts(e,n,i);if(s){let n=s.getToolInstance(e.metadata.toolName);n&&"function"==typeof n.isSplineAnnotation&&n.isSplineAnnotation(e)&&n.createSplineObjectFromType(t,e.data.spline.type)}return(0,e7.addAnnotation)(t,l.element),c.add(t.annotationUID),t},c=new Set;for(let e of r){let t=(0,e7.getAnnotation)(e),n=d(t);if(null==t?void 0:t.childAnnotationUIDs)for(let e of(n.childAnnotationUIDs=[],t.childAnnotationUIDs)){let t=d((0,e7.getAnnotation)(e));t.parentAnnotationUID=n.annotationUID,n.childAnnotationUIDs.push(t.annotationUID)}}a.set(i,c)}e.i(553718),e.s(["LogicalOperation",()=>o,"add",()=>tx,"copy",()=>tP,"deleteOperation",()=>tN,"intersect",()=>tM,"subtract",()=>tD,"xor",()=>tO],443856);var tc=e.i(144730),tu=e.i(819485);e.s(["unifyAnnotationPolylines",()=>tI,"unifyMultiplePolylineSets",()=>tp,"unifyPolylineSets",()=>tv],553934);var th=e.i(723392),tg=e.i(945122);function tf(e){let{metadata:t}=e;if(!t)return{};let{FrameOfReferenceUID:n,referencedImageId:i,referencedImageURI:o,multiSliceReference:a,cameraFocalPoint:r,viewPlaneNormal:l,viewUp:s,sliceIndex:d,volumeId:c,bounds:u}=t;return{FrameOfReferenceUID:n,referencedImageId:i,referencedImageURI:o,multiSliceReference:a,cameraFocalPoint:r,viewPlaneNormal:l,viewUp:s,sliceIndex:d,volumeId:c,bounds:u}}function tm(e,t){if(!e||!t||e.FrameOfReferenceUID!==t.FrameOfReferenceUID||e.referencedImageId!==t.referencedImageId||!e.viewPlaneNormal||!t.viewPlaneNormal||e.viewPlaneNormal.length!==t.viewPlaneNormal.length)return!1;for(let n=0;n<e.viewPlaneNormal.length;n++)if(e.viewPlaneNormal[n]!==t.viewPlaneNormal[n])return!1;return!0}function tv(e,t){let n=[],i=new Set,o=new Set;for(let a=0;a<e.length;a++){if(i.has(a))continue;let r=e[a],l=!1;for(let e=0;e<t.length;e++){if(o.has(e))continue;let s=t[e];if(!tm(r.viewReference,s.viewReference))continue;if((0,tg.default)(r.polyline,s.polyline)){n.push(r),i.add(a),o.add(e),l=!0;break}let d=(0,tc.checkIntersection)(r.polyline,s.polyline);if(d.hasIntersection&&!d.isContourHole){let t=th.polyline.mergePolylines(r.polyline,s.polyline);n.push({polyline:t,viewReference:r.viewReference}),i.add(a),o.add(e),l=!0;break}}l||(n.push(r),i.add(a))}for(let e=0;e<t.length;e++)o.has(e)||n.push(t[e]);return n}function tp(e){if(0===e.length)return[];if(1===e.length)return[...e[0]];let t=[...e[0]];for(let n=1;n<e.length;n++)t=tv(t,e[n]);return t}function tI(e,t,n){return tv(e.map(e=>({polyline:(0,tc.convertContourPolylineToCanvasSpace)(e.data.contour.polyline,n),viewReference:tf(e)})),t.map(e=>({polyline:(0,tc.convertContourPolylineToCanvasSpace)(e.data.contour.polyline,n),viewReference:tf(e)})))}function tE(e,t){let n=[];for(let i=0;i<e.length;i++){let o=[e[i]];for(let e=0;e<t.length;e++){let n=t[e],i=[];for(let e of o){if(!tm(e.viewReference,n.viewReference)){i.push(e);continue}if((0,tg.default)(e.polyline,n.polyline))continue;let t=(0,tc.checkIntersection)(e.polyline,n.polyline);if(t.hasIntersection&&!t.isContourHole)for(let t of(0,tc.cleanupPolylines)(th.polyline.subtractPolylines(e.polyline,n.polyline))){let n=(0,tc.removeDuplicatePoints)(t);n.length>=3&&i.push({polyline:n,viewReference:e.viewReference})}else i.push({polyline:e.polyline,viewReference:e.viewReference})}o=i}n.push(...o)}return n}function tw(e,t){if(0===t.length)return[...e];let n=[...e];for(let e=0;e<t.length;e++)n=tE(n,t[e]);return n}function t_(e,t,n){return tE(e.map(e=>({polyline:(0,tc.convertContourPolylineToCanvasSpace)(e.data.contour.polyline,n),viewReference:tf(e)})),t.map(e=>({polyline:(0,tc.convertContourPolylineToCanvasSpace)(e.data.contour.polyline,n),viewReference:tf(e)})))}e.s(["subtractAnnotationPolylines",()=>t_,"subtractMultiplePolylineSets",()=>tw,"subtractPolylineSets",()=>tE],789630),e.s(["intersectPolylinesSets",()=>ty],261553);var tS=e.i(157060),tS=tS;function ty(e,t){if(!e.length||!t.length)return[];let n=[];for(let i of e)for(let e of t){if(!tm(i.viewReference,e.viewReference))continue;if((0,tg.default)(i.polyline,e.polyline)){n.push({...i});continue}let t=(0,tc.checkIntersection)(i.polyline,e.polyline);if(t.hasIntersection&&!t.isContourHole){let t=(0,tc.cleanupPolylines)((0,tS.default)(i.polyline,e.polyline));t&&t.length>0&&t.forEach(e=>{n.push({polyline:e,viewReference:i.viewReference})})}}return n}function tT(e,t){if(!e.length&&!t.length)return[];if(!e.length)return t;if(!t.length)return e;if(e.length===t.length){let n=!0;for(let i=0;i<e.length;i++){let o=!1;for(let n=0;n<t.length;n++)if(tm(e[i].viewReference,t[n].viewReference)&&(0,tg.default)(e[i].polyline,t[n].polyline)){o=!0;break}if(!o){n=!1;break}}if(n)return[]}return[...tE(e,t),...tE(t,e)]}function tC(e,t){let n=[],{annotationUIDsMap:i}=e||{};if(null==i?void 0:i.has(t)){for(let e of i.get(t)){let t=(0,e7.getAnnotation)(e),{polyline:i}=t.data.contour;n.push({polyline:i,viewReference:tf(t)})}return n}}function tb(e){e.forEach(e=>{let t=(0,e7.getAnnotation)(e);(0,e7.removeAnnotation)(e),(0,e9.removeContourSegmentationAnnotation)(t)}),e.clear()}function tA(e,t,n,i){let a,l=ta(e.segmentationId);if(!l)return;let{polyLinesInfoCanvas1:s,polyLinesInfoCanvas2:d}=function(e,t,n){let i=(0,tu.getSegmentation)(t.segmentationId),o=(0,tu.getSegmentation)(n.segmentationId);if(!i||!o||!i.representationData.Contour||!o.representationData.Contour)return;let a=tC(i.representationData.Contour,t.segmentIndex),r=tC(o.representationData.Contour,n.segmentIndex);if(a&&r)return{polyLinesInfoCanvas1:a.map(t=>{let{polyline:n,viewReference:i}=t;return{polyline:(0,tc.convertContourPolylineToCanvasSpace)(n,e),viewReference:i}}),polyLinesInfoCanvas2:r.map(t=>{let{polyline:n,viewReference:i}=t;return{polyline:(0,tc.convertContourPolylineToCanvasSpace)(n,e),viewReference:i}})}}(l,e,t)||{};if(!s||!d)return;switch(i){case o.Union:a=tv(s,d);break;case o.Subtract:a=tE(s,d);break;case o.Intersect:a=ty(s,d);break;case o.XOR:a=tT(s,d);break;default:a=tv(s,d)}let c=a.map(e=>{let{polyline:t,viewReference:n}=e;return{polyline:(0,tc.convertContourPolylineToWorld)(t,l),viewReference:n}}),u=(0,tu.getSegmentation)(n.segmentationId),h=n.segmentIndex,g=n.color,f=n.label,{annotationUIDsMap:m}=u.representationData.Contour;if(m){var v;if(e.segmentationId===n.segmentationId&&e.segmentIndex===h){let e=m.get(h);e&&tb(e)}v=u.segmentationId,c.forEach(e=>{let{polyline:t,viewReference:n}=e;if(t.length<3)return;let i={annotationUID:r.utilities.uuidv4(),data:{contour:{closed:!0,polyline:t},segmentation:{segmentationId:v,segmentIndex:h},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:"PlanarFreehandContourSegmentationTool",...n}};(0,e7.addAnnotation)(i,l.element);let o=(null==m?void 0:m.get(h))||new Set;o.add(i.annotationUID),m.set(h,o)}),function(e,t){var n;let{segmentIndex:i,label:o,color:a}=t;if(!(null==e?void 0:e.segments))return;let r=null!=(n=e.segments[i])?n:{active:!1,locked:!1,segmentIndex:i,cachedStats:{},label:o,color:a};void 0!==o&&(r.label=o),void 0!==a&&(r.color=a),e.segments[i]=r}(u,{segmentIndex:h,color:g,label:f})}}function tx(e,t,n){tA(e,t,n,o.Union)}function tD(e,t,n){tA(e,t,n,o.Subtract)}function tM(e,t,n){tA(e,t,n,o.Intersect)}function tO(e,t,n){tA(e,t,n,o.XOR)}function tP(e,t){td(e.segmentationId,e.segmentIndex,t.segmentationId,t.segmentIndex)}function tN(e){let t=(0,tu.getSegmentation)(e.segmentationId);if(!t)return void console.log("No active segmentation detected");if(!t.representationData.Contour)return void console.log("No contour representation found");let{annotationUIDsMap:n}=t.representationData.Contour;return n?n.has(e.segmentIndex)?void tb(n.get(e.segmentIndex)):void console.log("Segmentation index has no annotations"):void console.log("No annotation map found")}function tR(e){var t;return!!(null==(t=e.data)?void 0:t.segmentation)}e.s(["xorPolylinesSets",()=>tT],986062),!function(e){e[e.Union=0]="Union",e[e.Subtract=1]="Subtract",e[e.Intersect=2]="Intersect",e[e.XOR=3]="XOR",e[e.Copy=4]="Copy",e[e.Delete=5]="Delete"}(o||(o={})),e.i(443856),e.s(["default",()=>tR],530070);var tL=te,tU=e9;e.s(["findAllIntersectingContours",()=>tV],832876);var tk=e.i(717824);function tV(e,t,n){let i=[],o=th.polyline.getAABB(t);for(let a=0;a<n.length;a++){let r=n[a],l=function(e,t){let n=e.length,i=Array(n);for(let o=0;o<n;o++)i[o]=t.worldToCanvas(e[o]);return i}(r.data.contour.polyline,e),s=th.polyline.getAABB(l);if(!tk.aabb.intersectAABB(o,s))continue;let d=th.polyline.intersectPolyline(t,l),c=!d&&th.polyline.containsPoints(l,t);(d||c)&&i.push({targetAnnotation:r,targetPolyline:l,isContourHole:c})}return i}e.s(["processMultipleIntersections",()=>tq],704063);var tF=e.i(894311),tB=e.i(895623),tG=e.i(665224),tW=e.i(605509);let tz="PlanarFreehandContourSegmentationTool";function tq(e,t,n,i){let o=i.filter(e=>e.isContourHole),a=i.filter(e=>!e.isContourHole);if(o.length>0){let n=o[0];(function(e,t,n){(0,e7.addChildAnnotation)(t,n),(0,e9.removeContourSegmentationAnnotation)(n);let{contour:i}=n.data,o=tH(i.polyline,e);(0,tB.default)(n,{points:o,closed:i.closed,targetWindingDirection:t.data.contour.windingDirection===tF.ContourWindingDirection.Clockwise?tF.ContourWindingDirection.CounterClockwise:tF.ContourWindingDirection.Clockwise},e)})(e,n.targetAnnotation,t),tj(e,[t,n.targetAnnotation]);return}if(0!==a.length){if(!(0,tW.hasToolByName)(tz))return void console.warn("".concat(tz," is not registered in cornerstone. Cannot process multiple intersections."));!function(e,t,n,i){var o,a,l;let{element:s}=e,d=[t],c=[],u=[];i.forEach(t=>{var n,i;let{targetAnnotation:o}=t,a=(n=e,i=o,(0,e7.getChildAnnotations)(i).map(e=>{let t=tH(e.data.contour.polyline,n);return{annotation:e,polyline:t}}));u.push(...a),d.push(o)});let h=n[0];if(i.some(e=>{let{targetPolyline:t}=e;return th.polyline.containsPoint(t,h)})){let e=n;i.forEach(t=>{let{targetPolyline:n}=t;e=th.polyline.mergePolylines(e,n)}),c.push(e)}else i.forEach(e=>{let{targetPolyline:t}=e,i=th.polyline.subtractPolylines(t,n);c.push(...i)});d.forEach(e=>{(0,e7.removeAnnotation)(e.annotationUID),(0,e9.removeContourSegmentationAnnotation)(e)}),u.forEach(e=>(0,e7.clearParentAnnotation)(e.annotation));let g=i[0].targetAnnotation,f=[];c.forEach(t=>{if(!t||t.length<3)return void console.warn("Skipping creation of new annotation due to invalid polyline:",t);let n=function(e,t,n){let i=e.canvasToWorld(n[0]),o=e.canvasToWorld(n[n.length-1]),a={metadata:{...t.metadata,toolName:tz,originalToolName:t.metadata.originalToolName||t.metadata.toolName},data:{cachedStats:{},handles:{points:[i,o],textBox:t.data.handles.textBox?{...t.data.handles.textBox}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...t.data.segmentation}},annotationUID:r.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};return(0,tB.default)(a,{points:n,closed:!0,targetWindingDirection:tF.ContourWindingDirection.Clockwise},e),a}(e,g,t);(0,e7.addAnnotation)(n,s),(0,te.addContourSegmentationAnnotation)(n),(0,tt.triggerAnnotationModified)(n,e.element),f.push(n)}),o=e,a=u,l=f,a.forEach(e=>{let t=l.find(t=>{let n=tH(t.data.contour.polyline,o);return th.polyline.containsPoints(n,e.polyline)});t&&(0,e7.addChildAnnotation)(t,e.annotation)}),tj(e,d)}(e,t,n,a)}}function tH(e,t){let n=e.length,i=Array(n);for(let o=0;o<n;o++)i[o]=t.worldToCanvas(e[o]);return i}function tj(e,t){let{element:n}=e,i=new Set([tz]);for(let e of(t.forEach(e=>{i.add(e.metadata.toolName)}),i.values()))if((0,tW.hasToolByName)(e)){let t=(0,tG.getViewportIdsWithToolToRender)(n,e);(0,f.default)(t)}}var tK=e.i(950004);async function tY(e,t,n){let i=!(arguments.length>3)||void 0===arguments[3]||arguments[3],o="string"==typeof e?(0,e7.getAnnotation)(e):e,a="string"==typeof t?(0,e7.getAnnotation)(t):t;if(!o||!a)throw Error("Both source and target annotations must be valid");n||(n=function(e){let t=(0,tK.default)(e);if(!t.length)throw Error("No viewport found for the annotation");return t[0]}(o));let r=(0,tc.convertContourPolylineToCanvasSpace)(o.data.contour.polyline,n),l=(0,tc.convertContourPolylineToCanvasSpace)(a.data.contour.polyline,n),s=(0,tc.checkIntersection)(r,l);if(!s.hasIntersection)return void console.warn("No intersection found between the two annotations");if(s.isContourHole){if(!i)return void console.warn("Hole processing is disabled");(0,tc.createPolylineHole)(n,a,o)}else(0,tc.combinePolylines)(n,a,l,o,r)}var tX=tc;e.i(553934),e.i(789630),e.i(261553),e.i(986062);var tZ=e.i(416877),tJ=e.i(649440),tQ=e.i(498597),tQ=tQ;let{transformWorldToIndex:t$}=r.utilities;function t0(e,t,n,i){let{boundsIJK:o,centerWorld:a,radiusWorld:l}=function(e,t,n){let[i,o]=e,a=eD.vec3.fromValues((i[0]+o[0])/2,(i[1]+o[1])/2,(i[2]+o[2])/2),r=eD.vec3.distance(i,o)/2;if(!n){let e=t$(t,a),n=Math.ceil(r/Math.min(...t.getSpacing()));return{boundsIJK:[[e[0]-n,e[0]+n],[e[1]-n,e[1]+n],[e[2]-n,e[2]+n]],centerWorld:a,radiusWorld:r}}return{boundsIJK:function(e,t,n,i,o){let[a,r]=n,l=e.getDimensions(),s=t.getCamera(),d=eD.vec3.fromValues(s.viewUp[0],s.viewUp[1],s.viewUp[2]),c=eD.vec3.fromValues(s.viewPlaneNormal[0],s.viewPlaneNormal[1],s.viewPlaneNormal[2]),u=eD.vec3.create();eD.vec3.cross(u,d,c);let h=eD.vec3.create(),g=eD.vec3.create();eD.vec3.scaleAndAdd(h,r,c,o),eD.vec3.scaleAndAdd(g,a,c,-o),eD.vec3.scaleAndAdd(h,h,u,-o),eD.vec3.scaleAndAdd(g,g,u,o);let f=[t$(e,h),t$(e,g)];return(0,tQ.getBoundingBoxAroundShapeIJK)(f,l)}(t,n,e,0,r),centerWorld:a,radiusWorld:r}}(t,e,i),s={center:a,radius:l},d=e.getDimensions();r.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:d,scalarData:e.getPointData().getScalars().getData()}).forEach(n,{boundsIJK:o,isInObject:e=>(0,tJ.pointInSphere)(s,e),imageData:e})}var t1=e.i(935840),t2=e.i(894794),t3=e.i(739775);function t5(e){if(!Array.isArray(e)||9!==e.length)throw Error("Matrix must be an array of 9 numbers");if(!e.every(e=>"number"==typeof e&&!isNaN(e)))throw Error("Matrix must contain only valid numbers")}function t4(e){t5(e);let t=[[e[0],e[1],e[2]],[e[3],e[4],e[5]],[e[6],e[7],e[8]]],n=t[0][0]*(t[1][1]*t[2][2]-t[1][2]*t[2][1])-t[0][1]*(t[1][0]*t[2][2]-t[1][2]*t[2][0])+t[0][2]*(t[1][0]*t[2][1]-t[1][1]*t[2][0]);if(1e-10>Math.abs(n))throw Error("Matrix is not invertible (determinant is zero)");let i=[[t[1][1]*t[2][2]-t[1][2]*t[2][1],-(t[0][1]*t[2][2]-t[0][2]*t[2][1]),t[0][1]*t[1][2]-t[0][2]*t[1][1]],[-(t[1][0]*t[2][2]-t[1][2]*t[2][0]),t[0][0]*t[2][2]-t[0][2]*t[2][0],-(t[0][0]*t[1][2]-t[0][2]*t[1][0])],[t[1][0]*t[2][1]-t[1][1]*t[2][0],-(t[0][0]*t[2][1]-t[0][1]*t[2][0]),t[0][0]*t[1][1]-t[0][1]*t[1][0]]],o=[];for(let e=0;e<3;e++)for(let t=0;t<3;t++)o.push(i[e][t]/n);return o}function t8(e){let t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return e.map(e=>e/t)}function t6(e){t5(e);let t=e.slice(0,3),n=e.slice(3,6),i=e.slice(6,9),o=t8(t),a=t8(n),r=t8(i),l=[1,0,0],s=[0,1,0],d=[0,0,1],c=o.every((e,t)=>1e-10>Math.abs(e-l[t]))&&a.every((e,t)=>1e-10>Math.abs(e-s[t]))&&r.every((e,t)=>1e-10>Math.abs(e-d[t])),u=c?[...l,...s,...d]:t4([...o,...a,...r]);return{isStandard:c,rotationMatrix:u}}function t7(e,t,n){let i=[];for(let o=0;o<n.length;o+=3){let a=function(e,t,n){let i=e[0]-t[0],o=e[1]-t[1],a=e[2]-t[2];return[n[0]*i+n[1]*o+n[2]*a+t[0],n[3]*i+n[4]*o+n[5]*a+t[1],n[6]*i+n[7]*o+n[8]*a+t[2]]}(n.slice(o,o+3),t,e);i.push(...a)}return i}e.s(["checkStandardBasis",()=>t6,"inverse3x3Matrix",()=>t4,"rotatePoints",()=>t7],586164);var t9=e.i(586164),ne=e.i(563922);function nt(e,t,n){e.data.label=n,(0,tt.triggerAnnotationModified)(e,t,ne.ChangeTypes.LabelChange)}var nn=e.i(572208);function ni(e,t){let{data:n}=e,{points:i}=n.handles,{focalPoint:o,viewPlaneNormal:a}=t.getCamera(),r=nn.dot(nn.sub(nn.create(),i[0],o),a);return i.forEach(e=>{nn.add(e,e,nn.scale(nn.create(),[-a[0],-a[1],-a[2]],r))}),t instanceof z.StackViewport&&(e.metadata.referencedImageId=t.getCurrentImageId()),e}var no=e.i(834367);e.s(["calculateFanGeometry",()=>nh,"default",()=>nc,"downloadFanJpeg",()=>nu,"exportContourJpeg",()=>ns,"getPixelData",()=>nd],550286);var na=e.i(579126),na=na,nr=e.i(477621);function nl(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function ns(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},{strokeStyle:a="#f00",lineWidth:r=2,quality:l=.92}=o,s=document.createElement("canvas");s.width=t,s.height=n;let d=s.getContext("2d"),c=t*n,u=e.length/c,h=d.createImageData(t,n),g=h.data;for(let t=0;t<c;t++){let n=t*u,i=4*t;if(1===u){let t=e[n];g[i]=t,g[i+1]=t,g[i+2]=t,g[i+3]=255}else g[i]=e[n],g[i+1]=e[n+1],g[i+2]=e[n+2],g[i+3]=4===u?e[n+3]:255}if(d.putImageData(h,0,0),i.length>0){d.strokeStyle=a,d.lineWidth=r,d.beginPath(),d.moveTo(i[0][0]+.5,i[0][1]+.5);for(let e=1;e<i.length;e++)d.lineTo(i[e][0]+.5,i[e][1]+.5);d.closePath(),d.stroke()}return s.toDataURL("image/jpeg",l)}function nd(e){let t=k.cache.getImage(e);if(!t)return;let n=t.width,i=t.height;return{pixelData:t.getPixelData(),width:n,height:i}}function nc(e,t){let n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.style.display="none",n.click(),n.remove()}function nu(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,{contour:n,simplified:i,hull:o,refined:a,fanGeometry:r}=nh(e),{pixelData:l,width:s,height:d}=nd(e)||{};l&&nc(1===t?ns(l,s,d,n):2===t?ns(l,s,d,i):3===t?ns(l,s,d,o):4===t?ns(l,s,d,[a.P1,a.P2,a.P3,a.P4]):function(e,t,n,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},{center:a,startAngle:r,endAngle:l,innerRadius:s,outerRadius:d}=i,{strokeStyle:c="#0ff",lineWidth:u=2,quality:h=.92}=o,g=r*Math.PI/180,f=l*Math.PI/180,m=document.createElement("canvas");m.width=t,m.height=n;let v=m.getContext("2d"),p=t*n,I=e.length/p,E=v.createImageData(t,n),w=E.data;for(let t=0;t<p;t++){let n=4*t;if(1===I){let i=e[t];w[n]=i,w[n+1]=i,w[n+2]=i,w[n+3]=255}else{let i=t*I;w[n]=e[i],w[n+1]=e[i+1],w[n+2]=e[i+2],w[n+3]=4===I?e[i+3]:255}}v.putImageData(E,0,0),v.beginPath();for(let e=g;e<=f;e+=.01){let t=a[0]+s*Math.cos(e),n=a[1]+s*Math.sin(e);e===g?v.moveTo(t,n):v.lineTo(t,n)}for(let e=f;e>=g;e-=.01){let t=a[0]+d*Math.cos(e),n=a[1]+d*Math.sin(e);v.lineTo(t,n)}return v.closePath(),v.strokeStyle=c,v.lineWidth=u,v.stroke(),m.toDataURL("image/jpeg",h)}(l,s,d,r,{strokeStyle:"#f00",lineWidth:3,quality:.95}),"contour.jpg")}function nh(e){let{pixelData:t,width:n,height:i}=nd(e)||{};if(!t)return;let o=function(e,t,n){let i=t*n,o=e.length/i;if(![1,3,4].includes(o))throw Error("Buffer must be 1, 3, or 4 channels per pixel");let a=Array.from({length:n},()=>Array(t).fill(!1));for(let i=0;i<n;i++)for(let n=0;n<t;n++){let r=(i*t+n)*o,l=!1;for(let t=0;t<Math.min(3,o);t++)if(e[r+t]>0){l=!0;break}a[i][n]=l}let r=Array.from({length:n},()=>Array(t).fill(0)),l=0,s={};for(let e=0;e<n;e++)for(let i=0;i<t;i++)if(a[e][i]&&0===r[e][i]){l++;let o=(e,i)=>!(e<0)&&!(e>=t)&&!(i<0)&&!(i>=n)&&a[i][e]&&0===r[i][e],d=0,c={onFlood:(e,t)=>{r[t][e]=l,d++},diagonals:!1};(0,na.default)(o,[i,e],c),s[l]=d}if(0===l)return[];let d=Object.keys(s).reduce((e,t)=>s[e]>s[t]?e:t);function c(e,i){if(r[i][e]!==+d)return!1;for(let[o,a]of[[1,0],[-1,0],[0,1],[0,-1]]){let l=e+o,s=i+a;if(l<0||l>=t||s<0||s>=n||r[s][l]!==+d)return!0}return!1}let u=null;e:for(let e=0;e<n;e++)for(let n=0;n<t;n++)if(c(n,e)){u=[n,e];break e}if(!u)return[];let h=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]],g=[],f=u,m=[u[0]-1,u[1]];do{g.push([f[0],f[1]]);let e=m[0]-f[0],i=m[1]-f[1],o=h.findIndex(t=>t[0]===e&&t[1]===i);o<0&&(o=0);let a=null;for(let e=1;e<=8;e++){let[i,r]=h[(o+e)%8],l=f[0]+i,s=f[1]+r;if(l>=0&&l<t&&s>=0&&s<n&&c(l,s)){a=[l,s];let[t,n]=h[(o+e-1+8)%8];m=[f[0]+t,f[1]+n];break}}if(!a)break;f=a}while(f[0]!==u[0]||f[1]!==u[1])return g}(t,n,i),{simplified:a,hull:r}=function(e){let t=th.polyline.decimate(e,2),n=th.polyline.convexHull(t);return{simplified:t,hull:n}}(o),l=function(e,t,n,i,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},{maxDist:r=15,slack:l=2}=a;function s(i,a){let{dx:s,dy:d}=a,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,u=s<0?i[0]-r:i[0]-l,h=s<0?i[0]+l:i[0]+r,g=d<0?i[1]-r:i[1]-l,f=d<0?i[1]+l:i[1]+r,m=i;for(let[i,a]of o){if(i<u||i>h||a<g||a>f)continue;let o=Math.round(i),r=Math.round(a);if(o<0||o>=t||r<0||r>=n)continue;let l=(o-m[0])*s,v=(r-m[0])*d;e[r*t+o]>c&&(l>0||v>0)&&(m=[i,a])}return m}return{P1:s(i.P1,{dx:-1,dy:-1}),P2:s(i.P2,{dx:-1,dy:1}),P3:s(i.P3,{dx:1,dy:1}),P4:s(i.P4,{dx:1,dy:-1})}}(t,n,i,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7;if(!e.length)throw Error("Convex hull is empty");let n=e.length,i=e=>(e+1)%n,o=(e,t)=>{let n=[];for(let o=e;n.push(o),o!==t;o=i(o));return n},a=0,r=0;for(let t=1;t<n;t++)e[t][0]<e[a][0]&&(a=t),e[t][0]>e[r][0]&&(r=t);let l=e[a],s=e[r],d=o(a,r),c=o(r,a),u=Math.min(...e.map(e=>e[1])),h=d.some(t=>e[t][1]===u)?d:c,g=Math.min(...h.map(t=>e[t][1])),f=h.map(t=>e[t]).filter(e=>Math.abs(e[1]-g)<=t);return f.length<2&&(f=h.map(t=>e[t]).sort((e,t)=>e[1]-t[1]).slice(0,2)),{P1:f.reduce((e,t)=>t[0]<e[0]?t:e,f[0]),P2:l,P3:s,P4:f.reduce((e,t)=>t[0]>e[0]?t:e,f[0])}}(r),a,{maxDist:20,step:.5}),s=function(e){let{P1:t,P2:n,P3:i,P4:o}=e,a=(0,nr.intersectLine)(t,n,o,i,!0);if(!a)throw Error("Fan edges appear parallel  no apex found");let r=nl(a,t)*(180/Math.PI),l=nl(a,o)*(180/Math.PI);if(l<=r){let e=r;r=l,l=e}let s=Math.hypot(t[0]-a[0],t[1]-a[1]),d=Math.hypot(o[0]-a[0],o[1]-a[1]),c=Math.hypot(n[0]-a[0],n[1]-a[1]),u=Math.hypot(i[0]-a[0],i[1]-a[1]);return{center:a,startAngle:r,endAngle:l,innerRadius:Math.min(s,d),outerRadius:Math.max(c,u)}}({P1:l.P1,P2:l.P2,P3:l.P3,P4:l.P4});return{contour:o,simplified:a,hull:r,refined:l,fanGeometry:s}}var ng=e.i(550286);let nf=r.utilities.roundNumber;e.i(605643);var nm=l,nv=s,np=d,nI=c,nE=u,nw=h,n_=g,nS=f,ny=m,nT=v,nC=p,nb=I,nA=E,nx=w,nD=_,nM=S,nO=y,nP=T,nN=C,nR=b,nL=A,nU=x,nk=D,nV=M,nF=O,nB=P,nG=es,nW=e_,nz=ex,nq=eN,nH=e8,nj=tZ,nK=t1,nY=t2,nX=t3,nZ=t9,nJ=no,nQ=ng,n$=e.i(389014);e.s(["annotation",()=>n6],985704),e.s(["AnnotationGroup",()=>n8.default,"FrameOfReferenceSpecificAnnotationManager",()=>n4.default,"config",()=>n1,"locking",()=>n2,"selection",()=>n3,"state",()=>n0.state,"visibility",()=>n5],342633);var n0=e.i(54120),n1=e.i(260154),n2=e.i(10122),n3=e.i(433460),n5=e.i(72340),n4=e.i(368043),n8=e.i(379788),n6=e.i(342633);e.s(["CircleROITool",()=>ip],989663);var n7=e.i(98021),n9=e.i(407072),ie=e.i(579816),it=e.i(526630),ii=e.i(515155),io=e.i(518792),ia=e.i(836714),ir=e.i(402932),il=e.i(932057),is=e.i(813416),is=is,id=e.i(309489),id=id,ic=e.i(273345),ic=ic,iu=e.i(428110),ih=e.i(997418);let{transformWorldToIndex:ig}=r.utilities;class im extends n7.AnnotationTool{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,calculateStats:!0,getTextLines:iv,statsCalculator:iu.BasicStatsCalculator,simplified:!0}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{let t,{currentPoints:n,element:i}=e.detail,o=n.world;this.isDrawing=!0,t=this.configuration.simplified?[[...o],[...o]]:[[...o],[...o],[...o],[...o],[...o]];let a=this.createAnnotation(e,t);(0,e7.addAnnotation)(a,i);let r=(0,tG.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:a,viewportIdsToRender:r,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,il.hideElementCursor)(i),e.preventDefault(),(0,f.default)(r),a},this.isPointNearTool=(e,t,n,i)=>{let{viewport:o}=(0,F.getEnabledElement)(e),{points:a}=t.data.handles,r=a.map(e=>o.worldToCanvas(e)),l=r[0],s=(0,id.default)([l,r[1]]);return Math.abs((0,id.default)([l,n])-s)<i/2},this.toolSelectedCallback=(e,t)=>{let{element:n}=e.detail;t.highlighted=!0;let i=(0,tG.getViewportIdsWithToolToRender)(n,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},(0,il.hideElementCursor)(n),this._activateModify(n),(0,f.default)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{let i,{element:o}=e.detail,{data:a}=t;t.highlighted=!0;let r=!1;if(n.worldPosition)r=!0;else{let{points:e}=a.handles;i=e.findIndex(e=>e===n)}let l=(0,tG.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:i,movingTextBox:r},this._activateModify(o),(0,il.hideElementCursor)(o),(0,f.default)(l),e.preventDefault()},this._endCallback=e=>{let{element:t}=e.detail,{annotation:n,viewportIdsToRender:i,newAnnotation:o,hasMoved:a}=this.editData,{data:r}=n;(!o||a)&&(this.doneEditMemo(),n.highlighted=!1,r.handles.activeHandleIndex=null,this._deactivateModify(t),this._deactivateDraw(t),(0,il.resetElementCursor)(t),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,e7.removeAnnotation)(n.annotationUID),(0,f.default)(i),o&&(0,tt.triggerAnnotationCompleted)(n))},this._dragDrawCallback=e=>{this.isDrawing=!0;let{element:t,currentPoints:n}=e.detail,{world:i,canvas:o}=n,{viewport:a}=(0,F.getEnabledElement)(t),{canvasToWorld:r}=a,{annotation:l,viewportIdsToRender:s,newAnnotation:d}=this.editData;this.createMemo(t,l,{newAnnotation:d});let{data:c}=l,u=c.handles.points[0],h=a.worldToCanvas(u);if(this.configuration.simplified)c.handles.points[1]=i;else{let e=eU.vec2.distance(h,o);c.handles.points[0]=[...u],c.handles.points[1]=r([h[0],h[1]-e]),c.handles.points[2]=r([h[0],h[1]+e]),c.handles.points[3]=r([h[0]-e,h[1]]),c.handles.points[4]=r([h[0]+e,h[1]])}l.invalidated=!0,this.editData.hasMoved=!0,(0,f.default)(s),(0,tt.triggerAnnotationModified)(l,t,ne.ChangeTypes.HandlesUpdated)},this._dragModifyCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:r,newAnnotation:l}=this.editData;this.createMemo(n,i,{newAnnotation:l});let{data:s}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=s.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){let{deltaPoints:e}=t,n=e.world;s.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;(0,f.default)(o),i.invalidated&&(0,tt.triggerAnnotationModified)(i,n,ne.ChangeTypes.HandlesUpdated)},this._dragHandle=e=>{let t=e.detail,{element:n}=t,{canvasToWorld:i,worldToCanvas:o}=(0,F.getEnabledElement)(n).viewport,{annotation:a,handleIndex:r}=this.editData,{data:l}=a,{points:s}=l.handles,{currentPoints:d,deltaPoints:c}=t;if(0===r){let e=c.world;s.forEach(t=>{eD.vec3.add(t,t,e)})}else{let e=o(s[0]),t=d.canvas,n=eU.vec2.distance(e,t);s[1]=i([e[0],e[1]-n]),s[2]=i([e[0],e[1]+n]),s[3]=i([e[0]-n,e[1]]),s[4]=i([e[0]+n,e[1]])}a.invalidated=!0},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,il.resetElementCursor)(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;return t.highlighted=!1,t.data.handles.activeHandleIndex=null,(0,f.default)(n),i&&(0,tt.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{io.state.isInteractingWithTool=!0,e.addEventListener(K.Events.MOUSE_UP,this._endCallback),e.addEventListener(K.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(K.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(K.Events.TOUCH_END,this._endCallback),e.addEventListener(K.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(K.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{io.state.isInteractingWithTool=!1,e.removeEventListener(K.Events.MOUSE_UP,this._endCallback),e.removeEventListener(K.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(K.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(K.Events.TOUCH_END,this._endCallback),e.removeEventListener(K.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(K.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{io.state.isInteractingWithTool=!0,e.addEventListener(K.Events.MOUSE_UP,this._endCallback),e.addEventListener(K.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(K.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(K.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(K.Events.TOUCH_END,this._endCallback),e.addEventListener(K.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(K.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{io.state.isInteractingWithTool=!1,e.removeEventListener(K.Events.MOUSE_UP,this._endCallback),e.removeEventListener(K.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(K.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(K.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(K.Events.TOUCH_END,this._endCallback),e.removeEventListener(K.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(K.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:o}=i,a=(0,e7.getAnnotations)(this.getToolName(),o);if(!(null==a?void 0:a.length)||!(null==(a=this.filterInteractableAnnotationsForElement(o,a))?void 0:a.length))return n;let l=this.getTargetId(i),s=i.getRenderingEngine(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){let c,u=a[o],{annotationUID:h,data:g}=u,{handles:f}=g,{points:m,activeHandleIndex:v}=f;d.annotationUID=h;let{color:p,lineWidth:I,lineDash:E}=this.getAnnotationStyle({annotation:u,styleSpecifier:d}),w=m.map(e=>i.worldToCanvas(e)),_=w[0],S=(0,id.default)([_,w[1]]),y=(0,is.default)([_,w[1]]),{centerPointRadius:T}=this.configuration;if(g.cachedStats[l]&&null!=g.cachedStats[l].areaUnit){if(u.invalidated&&(this._throttledCalculateCachedStats(u,i,s,e),i instanceof eX.VolumeViewport)){let{referencedImageId:e}=u.metadata;for(let t in g.cachedStats)t.startsWith("imageId")&&s.getStackViewports().find(t=>{let n=r.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=r.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n})&&delete g.cachedStats[t]}}else g.cachedStats[l]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(u,i,s,e);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!(0,n5.isAnnotationVisible)(h))continue;(0,n2.isAnnotationLocked)(h)||this.editData||null===v||(c=this.configuration.simplified?[w[v]]:w);let C=!!(0,ih.getStyleProperty)("showHandlesAlways",{});(c||C)&&(0,it.drawHandles)(t,h,"0",C?w:c,{color:p});let b="".concat(h,"-circle");if((0,ie.drawCircle)(t,h,"0",_,S,{color:p,lineDash:E,lineWidth:I},b),T>0&&S>3*T&&(0,ie.drawCircle)(t,h,"".concat("0","-center"),_,T,{color:p,lineDash:E,lineWidth:I}),n=!0,this.configuration.calculateStats){let e,n=this.getLinkedTextBoxStyle(d,u);if(!n.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}let o=this.configuration.getTextLines(g,l);if(!o||0===o.length)continue;g.handles.textBox.hasMoved||(e=(0,ia.getTextBoxCoordsCanvas)(y),g.handles.textBox.worldPosition=i.canvasToWorld(e));let a=i.worldToCanvas(g.handles.textBox.worldPosition),{x:r,y:s,width:c,height:f}=(0,ii.drawLinkedTextBox)(t,h,"1",o,a,[_,w[1]],{},n);g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([r,s]),topRight:i.canvasToWorld([r+c,s]),bottomLeft:i.canvasToWorld([r,s+f]),bottomRight:i.canvasToWorld([r+c,s+f])}}}return n},this._calculateCachedStats=(e,t,n,i)=>{if(!this.configuration.calculateStats)return;let o=e.data,{element:a}=t,r=e.invalidated,{points:l}=o.handles,s=l.map(e=>t.worldToCanvas(e)),d=s[0],c=s[1],{viewPlaneNormal:u,viewUp:h}=t.getCamera(),[f,m]=(0,is.default)([d,c]),v=t.canvasToWorld(f),p=t.canvasToWorld(m),{cachedStats:I}=o,E=Object.keys(I);for(let n=0;n<E.length;n++){let i=E[n],o=this.getTargetImageData(i);if(!o)continue;let{dimensions:a,imageData:r,metadata:s,voxelManager:d}=o,c=ig(r,v);c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(c[2]);let f=ig(r,p);if(f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),this._isInsideVolume(c,f,a)){var w,_,S,y;let n,a=Math.min(c[0],f[0]),m=Math.max(c[0],f[0]),E=Math.min(c[1],f[1]),T=Math.max(c[1],f[1]),C=[[a,m],[E,T],[Math.min(c[2],f[2]),Math.max(c[2],f[2])]],b=l[0],A=Math.abs(v[0]-p[0])/2,x=Math.abs(v[1]-p[1])/2,D=Math.abs(v[2]-p[2])/2,M={center:b,xRadius:A<n9.EPSILON/2?0:A,yRadius:x<n9.EPSILON/2?0:x,zRadius:D<n9.EPSILON/2?0:D},{worldWidth:O,worldHeight:P}=(0,ir.default)(u,h,v,p),N=0===O&&0===P,R=[c,f],{scale:L,unit:U,areaUnit:k}=(0,g.getCalibratedLengthUnitsAndScale)(o,R),V=Math.abs(O/L/2*Math.PI*(P/(0,g.getCalibratedAspect)(o)/L/2)),F={isPreScaled:(0,er.isViewportPreScaled)(t,i),isSuvScaled:this.isSuvScaled(t,i,e.metadata.referencedImageId)},B=(0,t3.getPixelValueUnits)(s.Modality,e.metadata.referencedImageId,F);d&&(n=d.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,ic.default)(M,e,{fast:!0}),boundsIJK:C,imageData:r,returnPoints:this.configuration.storePointData}));let G=this.configuration.statsCalculator.getStatistics();I[i]={Modality:s.Modality,area:V,mean:null==(w=G.mean)?void 0:w.value,max:null==(_=G.max)?void 0:_.value,min:null==(S=G.min)?void 0:S.value,pointsInShape:n,stdDev:null==(y=G.stdDev)?void 0:y.value,statsArray:G.array,isEmptyArea:N,areaUnit:k,radius:O/2/L,radiusUnit:U,perimeter:2*Math.PI*(O/2)/L,modalityUnit:B}}else this.isHandleOutsideImage=!0,I[i]={Modality:s.Modality}}return e.invalidated=!1,r&&(0,tt.triggerAnnotationModified)(e,a,ne.ChangeTypes.StatsUpdated),I},this._isInsideVolume=(e,t,n)=>r.utilities.indexWithinDimensions(e,n)&&r.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,c.default)(this._calculateCachedStats,100,{trailing:!0})}}function iv(e,t){let{radius:n,radiusUnit:i,area:o,mean:a,stdDev:l,max:s,min:d,isEmptyArea:c,areaUnit:u,modalityUnit:h}=e.cachedStats[t],g=[];if(r.utilities.isNumber(n)){let e=c?"Radius: Oblique not supported":"Radius: ".concat(r.utilities.roundNumber(n)," ").concat(i);g.push(e)}if(r.utilities.isNumber(o)){let e=c?"Area: Oblique not supported":"Area: ".concat(r.utilities.roundNumber(o)," ").concat(u);g.push(e)}return r.utilities.isNumber(a)&&g.push("Mean: ".concat(r.utilities.roundNumber(a)," ").concat(h)),r.utilities.isNumber(s)&&g.push("Max: ".concat(r.utilities.roundNumber(s)," ").concat(h)),r.utilities.isNumber(d)&&g.push("Min: ".concat(r.utilities.roundNumber(d)," ").concat(h)),r.utilities.isNumber(l)&&g.push("Std Dev: ".concat(r.utilities.roundNumber(l)," ").concat(h)),g}im.toolName="CircleROI",im.hydrate=(e,t,n)=>{let i=(0,ti.getEnabledElementByViewportId)(e);if(!i)return;let{FrameOfReferenceUID:o,referencedImageId:a,viewPlaneNormal:l,instance:s,viewport:d}=im.hydrateBase(im,i,t,n),{toolInstance:c,...u}=n||{},h={annotationUID:(null==n?void 0:n.annotationUID)||r.utilities.uuidv4(),data:{handles:{points:t,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:s.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:o,referencedImageId:a,...u}};(0,e7.addAnnotation)(h,d.element),(0,f.default)([d.id])};let ip=im;e.s(["PanTool",()=>iw],419930);var iI=e.i(460209);class iE extends iI.BaseTool{touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_checkImageInViewport(e,t){let n,{canvas:i}=e,o=window.devicePixelRatio,a=i.width/o,l=i.height/o,s=e.getDefaultActor(),d=e.getRenderer();n=s&&r.utilities.isImageActor(s)?s.actor.getMapper().getInputData().getBounds():d.computeVisiblePropBounds();let[c,u]=e.worldToCanvas([n[0],n[2],n[4]]),[h,g]=e.worldToCanvas([n[1],n[3],n[5]]);if(1>=e.getZoom()){if(c+t[0]<0&&t[0]<0||h+t[0]>a&&t[0]>0||u+t[1]<0&&t[1]<0||g+t[1]>l&&t[1]>0)return!1}else if(c+t[0]>0&&t[0]>0||h+t[0]<a&&t[0]<0||u+t[1]>0&&t[1]>0||g+t[1]<l&&t[1]<0)return!1;return!0}_dragCallback(e){let{element:t,deltaPoints:n}=e.detail,i=(0,F.getEnabledElement)(t),o=n.world,a=n.canvas;if(0===o[0]&&0===o[1]&&0===o[2])return;let r=i.viewport,{focalPoint:l,position:s}=r.getCamera();if(this.configuration.limitToViewport&&!this._checkImageInViewport(r,a))return;let d=[s[0]-o[0],s[1]-o[1],s[2]-o[2]],c=[l[0]-o[0],l[1]-o[1],l[2]-o[2]];r.setCamera({focalPoint:c,position:d}),r.render()}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{limitToViewport:!1}}){super(e,t)}}iE.toolName="Pan";let iw=iE;e.s(["Enums",()=>ik],97428),e.s(["AnnotationStyleStates",()=>iO.default,"ChangeTypes",()=>iL.default,"Events",()=>iP.default,"KeyboardBindings",()=>iD.KeyboardBindings,"MouseBindings",()=>iD.MouseBindings,"SegmentationRepresentations",()=>iN.default,"StrategyCallbacks",()=>iR.default,"Swipe",()=>a,"ToolModes",()=>iM.default,"WorkerTypes",()=>iU.default],661146),e.s([],743872);var i_=e.i(49119),iS=e.i(412974),iy=e.i(936137),iT=e.i(823467),iC=e.i(391297);e.s(["Swipe",()=>a],854246),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(a||(a={}));var ib=e.i(920441),iA=e.i(727044),ix=e.i(922538);e.i(743872);var iD=i_,iM=iS,iO=iy,iP=iT,iN=iC,iR=ib,iL=iA,iU=ix,ik=e.i(661146);e.s(["ToolGroupManager",()=>oE],14807),e.s(["createToolGroup",()=>oc,"destroy",()=>oh,"destroyToolGroup",()=>ou,"getAllToolGroups",()=>of,"getToolGroup",()=>ov.default,"getToolGroupForViewport",()=>op.default,"getToolGroupsWithToolName",()=>oI.default],669838),e.s([],472046);var iV=e.i(273965),iF=e.i(660103),iB=e.i(23529);e.s(["Settings",()=>iH],470254);let iG=Symbol("DefaultSettings"),iW=Symbol("RuntimeSettings"),iz=Symbol("ObjectSettingsMap"),iq=Symbol("Dictionary");class iH{set(e,t){return iK(this[iq],e,t,null)}get(e){var t;return t=this[iq],t[e]}unset(e){return function(e,t){if(t.endsWith(".")){let n=0,i=t.slice(0,-1),o=0===i.length;for(let a in e)Object.prototype.hasOwnProperty.call(e,a)&&(o||a.startsWith(t)||a===i)&&(delete e[a],++n);return n>0}return delete e[t]}(this[iq],e+"")}forEach(e){ij(this[iq],e)}extend(){return new iH(this)}import(e){iY(e)&&Object.keys(e).forEach(t=>{iK(this[iq],t,e[t],null)})}dump(){let e={};return ij(this[iq],(t,n)=>{void 0!==n&&function e(t,n,i){let o=n.indexOf(".");if(o>=0){let a=n.slice(0,o),r=t[a];if("object"!=typeof r||null===r){let e=r;r={},void 0!==e&&(r[""]=e),t[a]=r}e(r,n.slice(o+1,n.length),i)}else t[n]=i}(e,t,n)}),e}static assert(e){return e instanceof iH?e:iH.getRuntimeSettings()}static getDefaultSettings(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=iH[iG];if(t instanceof iH||(t=new iH,iH[iG]=t),e){let n={};return t.forEach(i=>{i.startsWith(e)&&(n[i.split("".concat(e,"."))[1]]=t.get(i))}),n}return t}static getRuntimeSettings(){let e=iH[iW];return e instanceof iH||(e=new iH(iH.getDefaultSettings()),iH[iW]=e),e}static getObjectSettings(e,t){let n=null;if(e instanceof iH)n=e;else if("object"==typeof e&&null!==e){let i=iH[iz];i instanceof WeakMap||(i=new WeakMap,iH[iz]=i),(n=i.get(e))instanceof iH||(n=new iH(iH.assert(iH.getObjectSettings(t))),i.set(e,n))}return n}static extendRuntimeSettings(){return iH.getRuntimeSettings().extend()}constructor(e){let t=Object.create(e instanceof iH&&iq in e?e[iq]:null);Object.seal(Object.defineProperty(this,iq,{value:t}))}}function ij(e,t){for(let n in e)t(n,e[n])}function iK(e,t,n,i){if(function(e){let t,n,i;if("string"!=typeof e||(t=e.length-1)<0)return!1;for(i=-1;(n=e.indexOf(".",i+1))>=0;){if(n-i<2||n===t)return!1;i=n}return!0}(t)){if(iY(n)){let a;var o=i instanceof WeakSet?i:new WeakSet;if(o.has(n))return iK(e,t,null,o);for(let i in o.add(n),a=0,n)Object.prototype.hasOwnProperty.call(n,i)&&!iK(e,0===i.length?t:"".concat(t,".").concat(i),n[i],o)&&++a;return o.delete(n),0===a}return e[t]=n,!0}return!1}function iY(e){if("object"==typeof e&&null!==e){let t=Object.getPrototypeOf(e);if(t===Object.prototype||null===t)return!0}return!1}iH.getDefaultSettings().set("useCursors",!0);var iX=e.i(473327),iX=iX,iZ=e.i(36489),iJ=iX;class iQ extends iJ.default{getStyleProperty(){let{url:e,x:t,y:n}=this,i="url('".concat(e,"')");return t>=0&&n>=0&&(t>0||n>0)&&(i+=" ".concat(t," ").concat(n)),this.addFallbackStyleProperty(i)}static getUniqueInstanceName(e){return"".concat(e,"-").concat(r.utilities.getRuntimeId(iQ))}constructor(e,t,n,i,o){super(i||iQ.getUniqueInstanceName("image-cursor"),o),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}}let i$={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},i0={x:127,y:60},i1='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',i2='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',i3='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',i5='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',i4='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',i8={Angle:i6(i$,{name:"Angle",iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:i6(i$,{name:"ArrowAnnotate",iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:i6(i$,{name:"Bidirectional",iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:i6(i$,{name:"CobbAngle",iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:i6(i$,{name:"CircleROI",iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:i6(i$,{name:"EllipticalROI",iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:i6(i$,{name:"FreehandROI",iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:i6(i$,{name:"FreehandROISculptor",iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:i6(i$,{name:"Length",iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Height:i6(i$,{name:"Height",iconContent:'<path d="m 6 22 l 8.5 0 v -16 h 8" stroke-width="3" fill="none" stroke="{{color}}" />',viewBox:{x:24,y:24}}),Probe:i6(i$,{name:"Probe",iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:i6(i$,{name:"RectangleROI",iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),Label:i6(i$,{name:"Label",iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:i6(i$,{name:"Crosshairs",iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:i6(i$,{name:"Eraser",iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:i6(i$,{name:"Magnify",iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:i6(i$,{name:"Pan",iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:i6(i$,{name:"Rotate",iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:i6(i$,{name:"StackScroll",iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:i6(i$,{name:"WindowLevelRegion",iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:i6(i$,{name:"WindowLevel",iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:i6(i$,{name:"Zoom",iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:i6(i$,{name:"SegmentationFreeHandEraseInside",iconContent:"".concat(i3," ").concat(i1),viewBox:i0}),SegmentationFreeHandFillInside:i6(i$,{name:"SegmentationFreeHandFillInside",iconContent:"".concat(i3," ").concat(i2),viewBox:i0}),SegmentationFreeHandEraseOutside:i6(i$,{name:"SegmentationFreeHandEraseOutside",iconContent:"".concat(i3," ").concat(i1),viewBox:i0}),SegmentationFreeHandFillOutside:i6(i$,{name:"SegmentationFreeHandFillOutside",iconContent:"".concat(i3," ").concat(i2),viewBox:i0}),SegmentationRectangleEraseInside:i6(i$,{name:"SegmentationRectangleEraseInside",iconContent:"".concat(i5," ").concat(i1),viewBox:i0}),RectangleScissor:i6(i$,{name:"RectangleScissor",iconContent:"".concat(i5," ").concat(i2),viewBox:i0}),"RectangleScissor.FILL_INSIDE":i6(i$,{name:"RectangleScissor.FILL_INSIDE",iconContent:"".concat(i5," ").concat(i2),viewBox:i0}),"RectangleScissor.FILL_OUTSIDE":i6(i$,{name:"RectangleScissor.FILL_OUTSIDE",iconContent:"".concat(i5," ").concat(i2),viewBox:i0}),"RectangleScissor.ERASE_OUTSIDE":i6(i$,{name:"RectangleScissor.ERASE_OUTSIDE",iconContent:"".concat(i5," ").concat(i1),viewBox:i0}),"RectangleScissor.ERASE_INSIDE":i6(i$,{name:"RectangleScissor.ERASE_INSIDE",iconContent:"".concat(i5," ").concat(i1),viewBox:i0}),CircleScissor:i6(i$,{name:"CircleScissor",iconContent:"".concat(i4," ").concat(i2),viewBox:i0}),"CircleScissor.FILL_INSIDE":i6(i$,{name:"CircleScissor.FILL_INSIDE",iconContent:"".concat(i4," ").concat(i2),viewBox:i0}),"CircleScissor.ERASE_OUTSIDE":i6(i$,{name:"CircleScissor.ERASE_OUTSIDE",iconContent:"".concat(i4," ").concat(i1),viewBox:i0}),"CircleScissor.FILL_OUTSIDE":i6(i$,{name:"CircleScissor.FILL_OUTSIDE",iconContent:"".concat(i4," ").concat(i2),viewBox:i0})};function i6(e,t){return Object.assign(Object.create(e),{...t,name:t.name||e.name})}Object.keys(i8);let i7=iZ.AnnotationStyleStates.Highlighted,i9=iV.ToolModes.Active;class oe extends iQ{static getDefinedCursor(e){var t,n,i;let o=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=arguments.length>2?arguments[2]:void 0;a||(a=(0,ih.getStyleProperty)("color",{},i7,i9));let r=(t=e,n=o,i=a,"".concat(n?"pointer":"cursor",":").concat(t,"/").concat(i)),l=super.getDefinedCursor(r),s=Number((0,ih.getStyleProperty)("pointerStrokeWidth",{}));if(!l){let t=i8[e];t&&(l=function(e,t,n,i,o,a){let{x:r,y:l}=e.mousePoint;return new oe(function(e,t,n){let i=new Blob([(t?function(e,t){let{iconContent:n,iconSize:i,viewBox:o,mousePointerGroupString:a}=e,r=i/Math.max(o.x,o.y,1),l=16+i,s=t.pointerStrokeWidth||1;return ot('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(l,'" height="').concat(l,'" viewBox="0 0 ').concat(l," ").concat(l,'">\n      <g stroke-width="').concat(s,'">').concat(a,'</g>\n      <g transform="translate(16, 16) scale(').concat(r,')">').concat(n,"</g>\n    </svg>"),t)}:function(e,t){let{iconContent:n,iconSize:i,viewBox:o}=e;return ot('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(i,'" height="').concat(i,'" viewBox="0 0\n      ').concat(o.x," ").concat(o.y,'">\n      ').concat(n,"\n    </svg>"),t)})(e,n)],{type:"image/svg+xml"}),o=URL.createObjectURL(i);return"".concat(o,"#").concat(e.name||"unknown","-").concat(t?"pointer":"cursor")}(e,n,{color:i,pointerStrokeWidth:o}),r,l,t,a)}(t,r,o,a,s,super.getDefinedCursor("default")),super.setDefinedCursor(r,l))}return l}constructor(e,t,n,i,o){super(e,t,n,i,o)}}function ot(e,t){let n=Object(t),i=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,(e,t)=>i(t)?n[t]+"":"")}var on=e.i(478411);let{Active:oi,Passive:oo,Enabled:oa,Disabled:or}=iV.ToolModes,ol=[{mouseButton:i_.MouseBindings.Primary}];class os{getViewportIds(){return this.viewportsInfo.map(e=>{let{viewportId:t}=e;return t})}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(e){let t=this._toolInstances[e];return t||void console.warn("'".concat(e,"' is not registered with this toolGroup (").concat(this.id,")."))}getToolInstances(){return this._toolInstances}hasTool(e){return!!this._toolInstances[e]}addTool(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=io.state.tools[e],i=void 0!==e&&""!==e,o=this.toolOptions[e];if(!i)return void console.warn("Tool with configuration did not produce a toolName: ",t);if(!n)return void console.warn("'".concat(e,"' is not registered with the library. You need to use cornerstoneTools.addTool to register it."));if(o)return void console.warn("'".concat(e,"' is already registered for ToolGroup ").concat(this.id,"."));let{toolClass:a}=n,r=new a({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=r}addToolInstance(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=null==(n=io.state.tools[e])?void 0:n.toolClass;if(!o){let n=io.state.tools[t].toolClass;class i extends n{}i.toolName=e,o=i,io.state.tools[e]={toolClass:i}}this.addTool(o.toolName,i)}addViewport(e,t){if("string"!=typeof e)throw Error("viewportId must be defined and be a string");let n=this._findRenderingEngine(e,t);this.viewportsInfo.some(t=>{let{viewportId:n}=t;return n===e})||this.viewportsInfo.push({viewportId:e,renderingEngineId:n});let i=this.getActivePrimaryMouseButtonTool();this.setViewportsCursorByToolName(i);let o={toolGroupId:this.id,viewportId:e,renderingEngineId:n};(0,l.triggerEvent)(L.eventTarget,K.Events.TOOLGROUP_VIEWPORT_ADDED,o)}removeViewports(e,t){let n=[];if(this.viewportsInfo.forEach((i,o)=>{let a=!1;i.renderingEngineId===e&&(a=!0,t&&i.viewportId!==t&&(a=!1)),a&&n.push(o)}),n.length)for(let e=n.length-1;e>=0;e--)this.viewportsInfo.splice(n[e],1);let i={toolGroupId:this.id,viewportId:t,renderingEngineId:e};(0,l.triggerEvent)(L.eventTarget,K.Events.TOOLGROUP_VIEWPORT_REMOVED,i)}setActiveStrategy(e,t){let n=this._toolInstances[e];if(void 0===n)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool configuration."));n.setActiveStrategy(t)}setToolMode(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e?t===iV.ToolModes.Active?void this.setToolActive(e,n||this.restoreToolOptions[e]):t===iV.ToolModes.Passive?void this.setToolPassive(e):t===iV.ToolModes.Enabled?void this.setToolEnabled(e):t===iV.ToolModes.Disabled?void this.setToolDisabled(e):void console.warn("setToolMode: mode must be defined"):void console.warn("setToolMode: toolName must be defined")}setToolActive(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this._toolInstances[e];if(void 0===n)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));if(!n)return void console.warn("'".concat(e,"' instance ").concat(n," is not registered with this toolGroup, can't set tool mode."));let i=[...this.toolOptions[e]?this.toolOptions[e].bindings:[],...t.bindings?t.bindings:[]].reduce((e,t)=>{let n=void 0!==t.numTouchPoints,i=void 0!==t.mouseButton;return!e.some(e=>od(e,t))&&(n||i)&&e.push(t),e},[]);if(this.toolOptions[e]={bindings:i,mode:oi},this._toolInstances[e].mode=oi,this._hasMousePrimaryButtonBinding(t))this.setViewportsCursorByToolName(e);else if(!this.getActivePrimaryMouseButtonTool()){let e=iX.default.getDefinedCursor("default");this._setCursorForViewports(e)}this._hasMousePrimaryButtonBinding(t)&&(null===this.prevActivePrimaryToolName?this.prevActivePrimaryToolName=e:this.prevActivePrimaryToolName=this.currentActivePrimaryToolName,this.currentActivePrimaryToolName=e),"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();let o={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,l.triggerEvent)(L.eventTarget,K.Events.TOOL_ACTIVATED,o),this._triggerToolModeChangedEvent(e,oi,t)}setToolPassive(e,t){let n=this._toolInstances[e];if(void 0===n)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));let i=this.getToolOptions(e),o=Object.assign({bindings:i?i.bindings:[]},i,{mode:oo}),a=Array.isArray(null==t?void 0:t.removeAllBindings)?t.removeAllBindings:this.getDefaultPrimaryBindings();o.bindings=o.bindings.filter(e=>(null==t?void 0:t.removeAllBindings)!==!0&&!a.some(t=>od(e,t)));let r=oo;0!==o.bindings.length&&(o.mode=r=oi),this.toolOptions[e]=o,n.mode=r,"function"==typeof n.onSetToolPassive&&n.onSetToolPassive(),this._renderViewports(),this._triggerToolModeChangedEvent(e,oo)}setToolEnabled(e){let t=this._toolInstances[e];if(void 0===t)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));this.toolOptions[e]={bindings:[],mode:oa},t.mode=oa,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,oa)}setToolDisabled(e){let t=this._toolInstances[e];if(void 0===t)return void console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."));this.restoreToolOptions[e]=this.toolOptions[e],this.toolOptions[e]={bindings:[],mode:or},t.mode=or,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,or)}getToolOptions(e){let t=this.toolOptions[e];if(void 0!==t)return t}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find(e=>{let t=this.toolOptions[e];return t.mode===oi&&this._hasMousePrimaryButtonBinding(t)})}setViewportsCursorByToolName(e,t){let n=this._getCursor(e,t);this._setCursorForViewports(n)}_getCursor(e,t){let n,i;return t&&(n="".concat(e,".").concat(t),i=oe.getDefinedCursor(n,!0))?i:(n="".concat(e),(i=oe.getDefinedCursor(n,!0))||(n=e,i=oe.getDefinedCursor(n,!0)))?i:iX.default.getDefinedCursor("default")}_setCursorForViewports(e){iH.getRuntimeSettings().get("useCursors")&&this.viewportsInfo.forEach(t=>{let{renderingEngineId:n,viewportId:i}=t,o=(0,ti.getEnabledElementByIds)(i,n);if(!o)return;let{viewport:a}=o;(0,il.initElementCursor)(a.element,e)})}setToolConfiguration(e,t,n){let i,o=this._toolInstances[e];return void 0===o?(console.warn("Tool ".concat(e," not present, can't set tool configuration.")),!1):(i=n?t:Object.assign(o.configuration,t),o.configuration=i,"function"==typeof o.onSetToolConfiguration&&o.onSetToolConfiguration(),this._renderViewports(),!0)}getDefaultMousePrimary(){return i_.MouseBindings.Primary}getDefaultPrimaryBindings(){return ol}getToolConfiguration(e,t){if(void 0===this._toolInstances[e])return void console.warn("Tool ".concat(e," not present, can't set tool configuration."));let n=(0,iF.default)(this._toolInstances[e].configuration,t)||this._toolInstances[e].configuration;return r.utilities.deepClone(n)}getPrevActivePrimaryToolName(){return this.prevActivePrimaryToolName}setActivePrimaryTool(e){let t=this.getCurrentActivePrimaryToolName();this.setToolDisabled(t),this.setToolActive(e,{bindings:[{mouseButton:i_.MouseBindings.Primary}]})}getCurrentActivePrimaryToolName(){return this.currentActivePrimaryToolName}clone(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=(0,on.default)(e);return n?console.debug("ToolGroup ".concat(e," already exists")):(n=new os(e),io.state.toolGroups.push(n),t=null!=t?t:()=>!0,Object.keys(this._toolInstances).filter(t).forEach(e=>{var t;let i=this._toolInstances[e],o=this.toolOptions[e],a=i.mode;n.addTool(e),n.setToolMode(e,a,{bindings:null!=(t=o.bindings)?t:[]})})),n}_hasMousePrimaryButtonBinding(e){var t;let n=this.getDefaultPrimaryBindings();return null==e||null==(t=e.bindings)?void 0:t.some(e=>n.some(t=>od(e,t)))}_renderViewports(){this.viewportsInfo.forEach(e=>{let{renderingEngineId:t,viewportId:n}=e;(0,iB.getRenderingEngine)(t).renderViewport(n)})}_triggerToolModeChangedEvent(e,t,n){let i={toolGroupId:this.id,toolName:e,mode:t,toolBindingsOptions:n};(0,l.triggerEvent)(L.eventTarget,K.Events.TOOL_MODE_CHANGED,i)}_findRenderingEngine(e,t){let n=(0,iB.getRenderingEngines)();if((null==n?void 0:n.length)===0)throw Error("No rendering engines found.");if(t)return t;let i=n.filter(t=>t.getViewport(e));if(0===i.length){if(1===n.length)return n[0].id;throw Error("No rendering engines found that contain the viewport with the same viewportId, you must specify a renderingEngineId.")}if(i.length>1)throw Error("Multiple rendering engines found that contain the viewport with the same viewportId, you must specify a renderingEngineId.");return i[0].id}constructor(e){this.viewportsInfo=[],this.toolOptions={},this.currentActivePrimaryToolName=null,this.prevActivePrimaryToolName=null,this.restoreToolOptions={},this._toolInstances={},this.id=e}}function od(e,t){return e.mouseButton===t.mouseButton&&e.numTouchPoints===t.numTouchPoints&&e.modifierKey===t.modifierKey}let oc=function(e){if(io.state.toolGroups.some(t=>t.id===e))return void console.warn("'".concat(e,"' already exists."));let t=new os(e);return io.state.toolGroups.push(t),t},ou=function(e){let t=io.state.toolGroups.findIndex(t=>t.id===e);t>-1&&io.state.toolGroups.splice(t,1)};e.s(["default",()=>oh],365800);let oh=function(){for(let e of[...io.state.toolGroups])ou(e.id);io.state.toolGroups=[]};var og=e.i(916821);let of=function(){return io.state.toolGroups};var om=e.i(239078);e.i(472046);var ov=on,op=og,oI=om,oE=e.i(669838);e.s(["ZoomTool",()=>oT],554911),e.i(656444);var ow=e.i(630656),o_=e.i(467418),oS=iI;class oy extends oS.BaseTool{mouseWheelCallback(e){this._zoom(e)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){let{element:t,currentPoints:n}=e.detail,{viewport:i}=(0,F.getEnabledElement)(t),o=i.getCamera(),a=n.world,{focalPoint:r}=o;this.initialMousePosWorld=a;let l=eD.vec3.fromValues(r[0]-a[0],r[1]-a[1],r[2]-a[2]);l=eD.vec3.normalize(eD.vec3.create(),l),this.dirVec=l,o.parallelProjection?this._dragParallelProjection(e,i,o,!0):this._dragPerspectiveProjection(e,i,o,!0),i.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){let{element:t}=e.detail,{viewport:n}=(0,F.getEnabledElement)(t),i=n.getCamera();i.parallelProjection?this._dragParallelProjection(e,n,i):this._dragPerspectiveProjection(e,n,i),n.render()}_zoom(e){let{element:t,points:n}=e.detail,i=(0,F.getEnabledElement)(t),{viewport:o}=i;o.getCamera();let a=e.detail.wheel.direction,r={detail:{element:t,eventName:K.Events.MOUSE_WHEEL,renderingEngineId:i.renderingEngineId,viewportId:o.id,camera:{},deltaPoints:{page:n.page,client:n.client,world:n.world,canvas:[0,-(5*a)]},startPoints:n,lastPoints:n,currentPoints:n}};o.type===R.Enums.ViewportType.STACK&&this.preMouseDownCallback(r),this._dragCallback(r)}_panCallback(e){let{element:t,deltaPoints:n}=e.detail,i=(0,F.getEnabledElement)(t),o=n.world,{focalPoint:a,position:r}=i.viewport.getCamera(),l=[r[0]-o[0],r[1]-o[1],r[2]-o[2]],s=[a[0]-o[0],a[1]-o[1],a[2]-o[2]];i.viewport.setCamera({focalPoint:s,position:l}),i.viewport.render()}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.001,maxZoomScale:3e3,pinchToZoom:!0,pan:!0,invert:!1}}){var n;super(e,t),n=this,this.preMouseDownCallback=e=>{let{element:t,currentPoints:n}=e.detail,i=n.world,{focalPoint:o}=(0,F.getEnabledElement)(t).viewport.getCamera();this.initialMousePosWorld=i;let a=eD.vec3.fromValues(o[0]-i[0],o[1]-i[1],o[2]-i[2]);return a=eD.vec3.normalize(eD.vec3.create(),a),this.dirVec=a,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=function(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],{element:a,deltaPoints:r}=e.detail,l=o?e.detail.deltaDistance.canvas:r.canvas[1],s=[a.clientWidth,a.clientHeight],{parallelScale:d,focalPoint:c,position:u}=i,h=l*(5/s[1])*(n.configuration.invert?-1:1),g=(1-h)*d,f=c,m=u;if(!n.configuration.zoomToCenter){let e=eD.vec3.distance(c,n.initialMousePosWorld);m=eD.vec3.scaleAndAdd(eD.vec3.create(),u,n.dirVec,-e*h),f=eD.vec3.scaleAndAdd(eD.vec3.create(),c,n.dirVec,-e*h)}let v=t.getImageData(),p=[1,1,1],I=g,E=!1;if(v){var w,_,S,y,T,C;let e;p=v.spacing;let{dimensions:i}=v,o=i[0]*p[0],a=i[1]*p[1],r=s[0]/s[1],l=(null==(w=(0,o_.getConfiguration)().rendering)?void 0:w.useLegacyCameraFOV)?1.1:1,d=null==(_=t.options)?void 0:_.displayArea,c=null!=(T=null==d||null==(S=d.imageArea)?void 0:S[0])?T:l,u=null!=(C=null==d||null==(y=d.imageArea)?void 0:y[1])?C:l,h=o*c,f=a*u;e=h/f>r?h/r*.5:.5*f;let{minZoomScale:m,maxZoomScale:b}=n.configuration,A=e/b,x=e/m;g<A?(I=A,E=!0):g>x&&(I=x,E=!0)}t.setCamera({parallelScale:I,focalPoint:E?c:f,position:E?u:m})},this._dragPerspectiveProjection=function(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],{element:a,deltaPoints:r}=e.detail,l=o?e.detail.deltaDistance.canvas:r.canvas[1],s=[a.clientWidth,a.clientHeight],{position:d,focalPoint:c,viewPlaneNormal:u}=i,h=Math.sqrt(ow.default.distance2BetweenPoints(d,c))/s[1],g=[-u[0],-u[1],-u[2]],f=n.configuration.invert?l/h:l*h,m=f*g[0];d[0]+=m,c[0]+=m,m=f*g[1],d[1]+=m,c[1]+=m,m=f*g[2],d[2]+=m,c[2]+=m,t.setCamera({position:d,focalPoint:c})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}}oy.toolName="Zoom";let oT=oy;e.s(["cornerstoneNiftiImageLoader",()=>oP],512761);var oC=e.i(477888),ob=e.i(559688),ob=ob,oA=e.i(312154);function ox(e,t){let n=e/8*t;if(!k.cache.isCacheable(n))throw Error(R.Enums.Events.CACHE_SIZE_EXCEEDED);return k.cache.decacheIfNecessaryUntilBytesAvailable(n),n}function oD(e,t){let n,i=t.length;switch(e){case"Float32Array":ox(32,i),n=new Float32Array(i);break;case"Int16Array":ox(16,i),n=new Int16Array(i);break;case"Int8Array":ox(8,i),n=new Int16Array(i);break;case"Uint16Array":ox(16,i),n=new Uint16Array(i);break;case"Uint8Array":ox(8,i),n=new Uint8Array(i);break;case"Float64Array":ox(64,i),n=new Float64Array(i);break;default:throw Error("TypedArray ".concat(e," is not yet supported"))}return n.set(t),n}var oM=e.i(809166);let oO=new Map;function oP(e){let[t,n]=e.substring(6).split("?frame="),i=parseInt(n,10),o=V.metaData.get(R.Enums.MetadataModules.IMAGE_PIXEL,e),a=V.metaData.get(R.Enums.MetadataModules.IMAGE_PLANE,e);return{promise:new Promise((n,r)=>{var l,s,d,c,u;oO.get(t)?(l=e,s=t,d=i,c=o,u=a,new Promise((e,t)=>{let n=setInterval(()=>{let i=oO.get(s);i||(clearInterval(n),t("dataFetchState for ".concat(s," is not found. The cache was purged before it completed loading."))),(null==i?void 0:i.status)==="fetched"&&(clearInterval(n),e(oR(l,d,c,u,i.scalarData)))},10)})).then(n).catch(r):(oO.set(t,{status:"fetching"}),oN(e,t,i,o,a).then(n).catch(r))}),cancelFn:void 0,decache:()=>{oO.delete(t)}}}async function oN(e,t,n,i,o){let a=await function(e){let{url:t,signal:n,onload:i}=e;return new Promise(async(e,o)=>{let a=new XMLHttpRequest;a.open("GET",t,!0);let r={},s=(0,oM.getOptions)(),d=await s.beforeSend(a,r,t),c=Object.assign({},r,d);a.responseType="arraybuffer",Object.keys(c).forEach(function(e){null!==c[e]&&a.setRequestHeader(e,c[e])});let u=function(t){i&&"function"==typeof i&&i(),n&&n.removeEventListener("abort",h),e(a.response)},h=()=>{a.abort(),a.removeEventListener("load",u),o(Error("Request aborted"))};a.addEventListener("load",u),a.onprogress=function(e){var n,i;n=e.loaded,i=e.total,(0,l.triggerEvent)(L.eventTarget,ob.default.NIFTI_VOLUME_PROGRESS,{data:{url:t,loaded:n,total:i}})},n&&n.aborted?(a.abort(),o(Error("Request aborted"))):n&&n.addEventListener("abort",h),a.send()})}({url:t}),r=null,s=null;if(oC.isCompressed(a)&&(a=oC.decompress(a)),oC.isNIFTI(a))r=oC.readHeader(a),s=oC.readImage(r,a);else{let e="The provided buffer is not a valid NIFTI file.";throw console.warn(e),Error(e)}let{scalarData:d}=function(e,t){let n,i,{datatypeCode:o,scl_slope:a,scl_inter:r}=e,l=a,s=r;(!a||0===a||Number.isNaN(a))&&(l=1),(!r||Number.isNaN(r))&&(s=0);let d=s<0||l<0,c=s%1!=0||l%1!=0,u=1;switch(o){case oA.NIFTI_TYPE_UINT8:n=new Uint8Array(t),c?i=oD("Float32Array",n):d?i=oD("Int16Array",n):(u=0,i=oD("Uint8Array",n));break;case oA.NIFTI_TYPE_INT16:n=new Int16Array(t),i=c?oD("Float32Array",n):oD("Int16Array",n);break;case oA.NIFTI_TYPE_INT32:i=oD("Float32Array",n=new Int32Array(t));break;case oA.NIFTI_TYPE_FLOAT32:i=oD("Float32Array",n=new Float32Array(t));break;case oA.NIFTI_TYPE_INT8:n=new Int8Array(t),i=c?oD("Float32Array",n):oD("Int8Array",n);break;case oA.NIFTI_TYPE_UINT16:n=new Uint16Array(t),c||d?i=oD("Float32Array",n):(u=0,i=oD("Uint16Array",n));break;case oA.NIFTI_TYPE_UINT32:i=oD("Float32Array",n=new Uint32Array(t));break;case oA.NIFTI_TYPE_FLOAT64:i=oD("Float64Array",n=new Float64Array(t));break;default:throw Error("NIFTI datatypeCode ".concat(o," is not yet supported"))}let h=i.length;if(1!==l&&0!==s)for(let e=0;e<h;e++){var g;i[e]=(g=i[e],g*l+s)}return e.numBitsPerVoxel=i.byteLength/i.length*8,{scalarData:i,pixelRepresentation:u}}(r,s);return oO.set(t,{status:"fetched",scalarData:d}),oR(e,n,i,o,d)}function oR(e,t,n,i,o){let{rows:a,columns:l}=i,s=a*l,d=s*t,c=new o.constructor(s);c.set(o.subarray(d,d+s));let u=r.utilities.VoxelManager.createImageVoxelManager({width:l,height:a,numberOfComponents:1,scalarData:c}),h=c[0],g=c[0];for(let e=1;e<c.length;e++){let t=c[e];t<h&&(h=t),t>g&&(g=t)}return{imageId:e,dataType:o.constructor.name,columnPixelSpacing:i.columnPixelSpacing,columns:i.columns,height:i.rows,invert:"MONOCHROME1"===n.photometricInterpretation,rowPixelSpacing:i.rowPixelSpacing,rows:i.rows,sizeInBytes:a*l*o.BYTES_PER_ELEMENT,width:i.columns,getPixelData:()=>u.getScalarData(),getCanvas:void 0,numberOfComponents:void 0,voxelManager:u,minPixelValue:h,maxPixelValue:g}}},41668,e=>{"use strict";let t,n;e.s(["initCornerstone",()=>nb],41668);var i=e.i(467418),o=e.i(184300),a=e.i(504019),r=e.i(581632),l=e.i(512761),s=e.i(378588),d=e.i(883035),c=e.i(344962),u=e.i(783224),h=e.i(513336),g=e.i(736260),f=e.i(823467);function m(e,t){var n,i;let o=t||e.currentTarget,{viewport:a}=(0,h.getEnabledElement)(o)||{};if(!a)return;let r=[(n=e).clientX,n.clientY],l=[(i=e).pageX,i.pageY],s=function(e,t){let n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(o,l),d=a.canvasToWorld(s);return{page:l,client:r,canvas:s,world:d}}let v=function(e){let t=e.currentTarget,{viewportId:n,renderingEngineId:i}=(0,h.getEnabledElement)(t),o=m(e,t),a={event:e,eventName:f.default.MOUSE_DOUBLE_CLICK,viewportId:n,renderingEngineId:i,camera:{},element:t,startPoints:o,lastPoints:o,currentPoints:o,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};(0,g.triggerEvent)(t,f.default.MOUSE_DOUBLE_CLICK,a)||(e.stopImmediatePropagation(),e.preventDefault())},p=f.default.MOUSE_MOVE,I=function(e){let t=e.currentTarget,n=(0,h.getEnabledElement)(t);if(!n)return;let{renderingEngineId:i,viewportId:o}=n,a=m(e);(0,g.triggerEvent)(t,p,{renderingEngineId:i,viewportId:o,camera:{},element:t,currentPoints:a,eventName:p,event:e})||(e.stopImmediatePropagation(),e.preventDefault())},{MOUSE_DOWN:E,MOUSE_DOWN_ACTIVATE:w,MOUSE_CLICK:_,MOUSE_UP:S,MOUSE_DRAG:y}=f.default,T={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},C={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},b={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function A(e){let t=(0,h.getEnabledElement)(C.element);if(!(null==t?void 0:t.viewport))return;let n=m(e,C.element),i=U(C.element,C.lastPoints),o=k(n,i);if(b.doubleClickTimeout)if(!M(o.canvas))return;else P();let a={event:e,eventName:y,mouseButton:C.mouseButton,renderingEngineId:C.renderingEngineId,viewportId:C.viewportId,camera:{},element:C.element,startPoints:L(C.startPoints),lastPoints:L(i),currentPoints:n,deltaPoints:o};(0,g.triggerEvent)(C.element,y,a)||(e.stopImmediatePropagation(),e.preventDefault()),C.lastPoints=L(n)}function x(e){if(clearTimeout(C.preventClickTimeout),b.doubleClickTimeout)b.mouseUpEvent?R():(b.mouseUpEvent=e,C.element.addEventListener("mousemove",D));else{let t=C.isClickEvent?_:S,n=m(e,C.element),i=k(n,C.lastPoints),o={event:e,eventName:t,mouseButton:C.mouseButton,element:C.element,renderingEngineId:C.renderingEngineId,viewportId:C.viewportId,camera:{},startPoints:L(C.startPoints),lastPoints:L(C.lastPoints),currentPoints:n,deltaPoints:i};(0,g.triggerEvent)(o.element,t,o),R()}document.removeEventListener("mousemove",A)}function D(e){M(k(m(e,C.element),U(C.element,C.lastPoints)).canvas)&&(P(),I(e))}function M(e){return Math.abs(e[0])+Math.abs(e[1])>3}function O(){C.isClickEvent=!1}function P(){b.ignoreDoubleClick=!0;let e=b.mouseDownEvent,t=b.mouseUpEvent;N();let n=k(C.startPoints,C.startPoints),i={event:e,eventName:E,element:C.element,mouseButton:C.mouseButton,renderingEngineId:C.renderingEngineId,viewportId:C.viewportId,camera:{},startPoints:C.startPoints,lastPoints:C.startPoints,currentPoints:C.startPoints,deltaPoints:n};C.lastPoints=L(i.lastPoints),(0,g.triggerEvent)(i.element,E,i)&&(0,g.triggerEvent)(i.element,w,i),t&&x(t)}function N(){b.doubleClickTimeout&&(clearTimeout(b.doubleClickTimeout),b.doubleClickTimeout=null),b.mouseDownEvent=null,b.mouseUpEvent=null}function R(){var e,t;document.removeEventListener("mouseup",x),null==(e=C.element)||e.removeEventListener("mousemove",D),null==(t=C.element)||t.addEventListener("mousemove",I),N(),C=JSON.parse(JSON.stringify(T))}function L(e){return JSON.parse(JSON.stringify(e))}function U(e,t){let{viewport:n}=(0,h.getEnabledElement)(e)||{};if(!n)return t;let i=n.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:i}}function k(e,t){var n,i;return e&&t?{page:V(e.page,t.page),client:V(e.client,t.client),canvas:V(e.canvas,t.canvas),world:(n=e.world,i=t.world,[n[0]-i[0],n[1]-i[1],n[2]-i[2]])}:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}}function V(e,t){return[e[0]-t[0],e[1]-t[1]]}function F(e){b.ignoreDoubleClick?(b.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):R()}let B=function(e){if(b.doubleClickTimeout){if(e.buttons===b.mouseDownEvent.buttons)return;b.mouseDownEvent=e,P();return}b.doubleClickTimeout=setTimeout(P,1===e.buttons?400:150),b.mouseDownEvent=e,b.ignoreDoubleClick=!1,C.element=e.currentTarget,C.mouseButton=e.buttons;let{renderingEngineId:t,viewportId:n}=(0,h.getEnabledElement)(C.element);C.renderingEngineId=t,C.viewportId=n,C.preventClickTimeout=setTimeout(O,C.clickDelay),C.element.removeEventListener("mousemove",I);let i=m(e,C.element);C.startPoints=L(i),C.lastPoints=L(i),document.addEventListener("mouseup",x),document.addEventListener("mousemove",A)};function G(e){e.removeEventListener("dblclick",v),e.removeEventListener("mousedown",B),e.removeEventListener("mousemove",I),e.removeEventListener("dblclick",F,{capture:!0})}let W={enable:function(e){G(e),e.addEventListener("dblclick",v),e.addEventListener("mousedown",B),e.addEventListener("mousemove",I),e.addEventListener("dblclick",F,{capture:!0})},disable:G},z=function(e){let t,n,i,o,a=e.currentTarget,{renderingEngineId:r,viewportId:l}=(0,h.getEnabledElement)(a);if(e.deltaY>-1&&e.deltaY<1)return;e.preventDefault();let{spinX:s,spinY:d,pixelX:c,pixelY:u}=(t=0,n=0,i=0,o=0,"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),i=10*t,o=10*n,"deltaY"in e&&(o=e.deltaY),"deltaX"in e&&(i=e.deltaX),(i||o)&&e.deltaMode&&(1===e.deltaMode?(i*=40,o*=40):(i*=800,o*=800)),i&&!t&&(t=i<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:i,pixelY:o}),v={event:e,eventName:f.default.MOUSE_WHEEL,renderingEngineId:r,viewportId:l,element:a,camera:{},detail:e,wheel:{spinX:s,spinY:d,pixelX:c,pixelY:u,direction:d<0?-1:1},points:m(e)};(0,g.triggerEvent)(a,f.default.MOUSE_WHEEL,v)};function q(e){e.removeEventListener("wheel",z)}let H={enable:function(e){q(e),e.addEventListener("wheel",z,{passive:!1})},disable:q},j={mouse:0,touch:1};function K(e,i){let o=Date.now();if(e!==t){if(o-n<=2e3)return i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),!1;t=e}n=o}let Y=K.bind(null,j.mouse),X=K.bind(null,j.touch);function Z(e,t,n){let i=n?Y:X;t.forEach(function(t){e.addEventListener(t,i,{passive:!1})})}function J(e,t,n){let i=n?Y:X;t.forEach(function(t){e.removeEventListener(t,i)})}let Q=["mousedown","mouseup","mousemove"],$=["touchstart","touchend"];function ee(e){J(e,Q,j.mouse),J(e,$,j.touch)}let et={enable:function(e){ee(e),Z(e,Q,j.mouse),Z(e,$,j.touch)},disable:ee};var en=e.i(854246);function ei(e,t){let n=t||e.currentTarget,i="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(i).map(e=>{var t,o;let a=[(t=i[e]).clientX,t.clientY],r=[(o=i[e]).pageX,o.pageY],l=function(e,t){let n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,r),{viewport:s}=(0,h.getEnabledElement)(n),d=s.canvasToWorld(l);return{page:r,client:a,canvas:l,world:d,touch:{identifier:e,radiusX:i[e].radiusX,radiusY:i[e].radiusY,force:i[e].force,rotationAngle:i[e].rotationAngle}}})}var eo=e.i(240634);e.i(470254).Settings.getRuntimeSettings();let{TOUCH_START:ea,TOUCH_START_ACTIVATE:er,TOUCH_PRESS:el,TOUCH_DRAG:es,TOUCH_END:ed,TOUCH_TAP:ec,TOUCH_SWIPE:eu}=f.default,eh={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},eg={page:0,client:0,canvas:0,world:0},ef={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...eh,touch:null}],lastPointsList:[{...eh,touch:null}],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:eg,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},em={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...eh,touch:null}],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300},ev=JSON.parse(JSON.stringify(ef)),ep=JSON.parse(JSON.stringify(em));function eI(e,t,n){return(0,g.triggerEvent)(e,t,n)}function eE(e){let t=ei(e,ev.element),n=e_(ev.element,ev.lastPointsList),i=t.length===n.length?(0,eo.getDeltaPoints)(t,n):eh,o=t.length===n.length?(0,eo.getDeltaDistanceBetweenIPoints)(t,n):eg,a=t.length===n.length?(0,eo.getDeltaDistance)(t,ev.lastPointsList):eg;ev.accumulatedDistance={page:ev.accumulatedDistance.page+a.page,client:ev.accumulatedDistance.client+a.client,canvas:ev.accumulatedDistance.canvas+a.canvas,world:ev.accumulatedDistance.world+a.world};let r={event:e,eventName:es,renderingEngineId:ev.renderingEngineId,viewportId:ev.viewportId,camera:{},element:ev.element,startPoints:(0,eo.getMeanTouchPoints)(ev.startPointsList),lastPoints:(0,eo.getMeanTouchPoints)(n),currentPoints:(0,eo.getMeanTouchPoints)(t),startPointsList:(0,eo.copyPointsList)(ev.startPointsList),lastPointsList:(0,eo.copyPointsList)(n),currentPointsList:t,deltaPoints:i,deltaDistance:o};eI(ev.element,es,r),function(e,t){let n=new Date().getTime(),i=ev.startTime.getTime();if(ev.swiped||n-i>ev.swipeToleranceMs)return;let[o,a]=t.canvas,r={event:e,eventName:eu,renderingEngineId:ev.renderingEngineId,viewportId:ev.viewportId,camera:{},element:ev.element,swipe:null};Math.abs(o)>ev.swipeDistanceThreshold&&(r.swipe=o>0?en.Swipe.RIGHT:en.Swipe.LEFT,eI(r.element,eu,r),ev.swiped=!0),Math.abs(a)>ev.swipeDistanceThreshold&&(r.swipe=a>0?en.Swipe.DOWN:en.Swipe.UP,eI(r.element,eu,r),ev.swiped=!0)}(e,i),ev.lastPointsList=(0,eo.copyPointsList)(t)}function ew(e){clearTimeout(ev.pressTimeout);let t=ei(e,ev.element),n=e_(ev.element,ev.lastPointsList),i=t.length===n.length?(0,eo.getDeltaPoints)(t,n):(0,eo.getDeltaPoints)(t,t),o=t.length===n.length?(0,eo.getDeltaDistanceBetweenIPoints)(t,n):(0,eo.getDeltaDistanceBetweenIPoints)(t,t),a={event:e,eventName:ed,element:ev.element,renderingEngineId:ev.renderingEngineId,viewportId:ev.viewportId,camera:{},startPointsList:(0,eo.copyPointsList)(ev.startPointsList),lastPointsList:(0,eo.copyPointsList)(n),currentPointsList:t,startPoints:(0,eo.getMeanTouchPoints)(ev.startPointsList),lastPoints:(0,eo.getMeanTouchPoints)(n),currentPoints:(0,eo.getMeanTouchPoints)(t),deltaPoints:i,deltaDistance:o};eI(a.element,ed,a),function(e){if(new Date().getTime()-ev.startTime.getTime()>ep.tapToleranceMs||(0===ep.taps&&(ep.element=ev.element,ep.renderingEngineId=ev.renderingEngineId,ep.viewportId=ev.viewportId,ep.startPointsList=ev.startPointsList),ep.taps>0&&(ep.element!=ev.element||ep.renderingEngineId!=ev.renderingEngineId||ep.viewportId!=ev.viewportId)))return;let t=ei(e,ep.element);(0,eo.getDeltaDistance)(t,ep.startPointsList).canvas>ep.tapMaxDistance||(clearTimeout(ep.tapTimeout),ep.taps+=1,ep.tapTimeout=setTimeout(()=>{let n={event:e,eventName:ec,element:ep.element,renderingEngineId:ep.renderingEngineId,viewportId:ep.viewportId,camera:{},currentPointsList:t,currentPoints:(0,eo.getMeanTouchPoints)(t),taps:ep.taps};eI(n.element,ec,n),ep=JSON.parse(JSON.stringify(em))},ep.tapToleranceMs))}(e),ev=JSON.parse(JSON.stringify(ef)),document.removeEventListener("touchmove",eE),document.removeEventListener("touchend",ew)}function e_(e,t){let{viewport:n}=(0,h.getEnabledElement)(e);return t.map(e=>{let t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}})}let eS=function(e){ev.element=e.currentTarget;let{renderingEngineId:t,viewportId:n}=(0,h.getEnabledElement)(ev.element);ev.renderingEngineId=t,ev.viewportId=n,ev.isTouchStart||(clearTimeout(ev.pressTimeout),ev.pressTimeout=setTimeout(()=>(function(e){if(ev.accumulatedDistance.canvas>ev.pressMaxDistance)return;let t={event:e,eventName:el,renderingEngineId:ev.renderingEngineId,viewportId:ev.viewportId,camera:{},element:ev.element,startPointsList:(0,eo.copyPointsList)(ev.startPointsList),lastPointsList:(0,eo.copyPointsList)(ev.lastPointsList),startPoints:(0,eo.copyPoints)((0,eo.getMeanTouchPoints)(ev.startPointsList)),lastPoints:(0,eo.copyPoints)((0,eo.getMeanTouchPoints)(ev.lastPointsList))};eI(t.element,el,t)})(e),ev.pressDelay),function(e){ev.isTouchStart=!0,ev.startTime=new Date;let t=ei(e,ev.element),n=(0,eo.getMeanTouchPoints)(t),i={event:e,eventName:ea,element:ev.element,renderingEngineId:ev.renderingEngineId,viewportId:ev.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:eh,deltaDistance:eg};ev.startPointsList=(0,eo.copyPointsList)(i.startPointsList),ev.lastPointsList=(0,eo.copyPointsList)(i.lastPointsList),eI(i.element,ea,i)&&eI(i.element,er,i)}(e),document.addEventListener("touchmove",eE),document.addEventListener("touchend",ew))};function ey(e){et.disable(e),e.removeEventListener("touchstart",eS)}let eT={enable:function(e){ey(e),et.enable(e),e.addEventListener("touchstart",eS,{passive:!1})},disable:ey},eC={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null},eb={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function eA(e){eb.element=e.currentTarget;let{renderingEngineId:t,viewportId:n}=(0,h.getEnabledElement)(eb.element);eb.renderingEngineId=t,eb.viewportId=n,eb.key=e.key,eb.keyCode=e.keyCode,e.preventDefault();let i={renderingEngineId:eb.renderingEngineId,viewportId:eb.viewportId,element:eb.element,key:eb.key,keyCode:eb.keyCode};(0,g.triggerEvent)(i.element,f.default.KEY_DOWN,i),document.addEventListener("keyup",eD),document.addEventListener("visibilitychange",ex),eb.element.removeEventListener("keydown",eA)}function ex(){document.removeEventListener("visibilitychange",ex),"hidden"===document.visibilityState&&eM()}function eD(e){let t={renderingEngineId:eb.renderingEngineId,viewportId:eb.viewportId,element:eb.element,key:eb.key,keyCode:eb.keyCode};document.removeEventListener("keyup",eD),document.removeEventListener("visibilitychange",ex),eb.element.addEventListener("keydown",eA),eb=structuredClone(eC),(0,g.triggerEvent)(t.element,f.default.KEY_UP,t)}function eM(){eb.keyCode=void 0}function eO(e){e.removeEventListener("keydown",eA)}let eP={enable:function(e){eO(e),e.addEventListener("keydown",eA)},disable:eO,getModifierKey:function(){return eb.keyCode}};var eN=e.i(985235),eR=e.i(610232),eL=e.i(731937),eU=e.i(573855),ek=e.i(560031),eV=e.i(665034),eF=e.i(629814),eB=e.i(13564),eG=e.i(992831),eW=e.i(413612),ez=e.i(16297);function eq(e){let{viewportId:t,renderingEngineId:n}=e.detail,{viewport:i}=(0,eU.getEnabledElementByIds)(t,n),o=(0,ez.getSegmentationRepresentations)(t);if(!(null==o?void 0:o.length))return;let a=o.filter(e=>e.type===eG.SegmentationRepresentations.Labelmap),l=i.getActors();a.forEach(e=>{let{segmentationId:n}=e;eF.defaultSegmentationStateManager.updateLabelmapSegmentationImageReferences(t,n)});let s=a.flatMap(e=>(0,eW.getLabelmapActorEntries)(t,e.segmentationId)).filter(e=>void 0!==e);s.length&&(s.forEach(e=>{a.find(n=>{let i=(0,eB.getCurrentLabelmapImageIdsForViewport)(t,n.segmentationId);return null==i?void 0:i.includes(e.referencedId)})||i.removeActors([e.uid])}),a.forEach(n=>{let{segmentationId:o}=n,a=i.getCurrentImageId(),s=(0,eB.getCurrentLabelmapImageIdsForViewport)(t,o);if(!s)return;let c=!1;s.forEach(e=>{let t=ek.cache.getImage(e);if(!t)return void console.warn("No derived image found in the cache for segmentation representation",n);let s=l.find(t=>t.referencedId===e);if(s){let e=s.actor.getMapper().getInputData();e.setDerivedImage?e.setDerivedImage(t):r.utilities.updateVTKImageDataWithCornerstoneImage(e,t)}else{let{dimensions:n,spacing:r,direction:l}=i.getImageDataMetadata(t),s=ek.cache.getImage(a)||{imageId:a},{origin:d}=i.getImageDataMetadata(s),u=t.voxelManager.getConstructor(),h=t.voxelManager.getScalarData(),g=eN.default.newInstance({name:"Pixels",numberOfComponents:1,values:new u(h)}),f=eR.default.newInstance();f.setDimensions(n[0],n[1],1),f.setSpacing(r),f.setDirection(l),f.setOrigin(d),f.getPointData().setScalars(g),f.modified(),i.addImages([{imageId:e,representationUID:"".concat(o,"-").concat(eG.SegmentationRepresentations.Labelmap,"-").concat(t.imageId),callback:e=>{let{imageActor:t}=e;t.getMapper().setInputData(f)}}]),c=!0;return}}),c&&(0,eV.triggerSegmentationRender)(t),i.render(),e.type===d.Enums.Events.IMAGE_RENDERED&&i.element.removeEventListener(d.Enums.Events.IMAGE_RENDERED,eq)}))}let eH={enable:function(e){if(!e)return;let t=(0,h.getEnabledElement)(e);if(!t)return;let{viewport:n}=t;n instanceof eL.BaseVolumeViewport||(e.addEventListener(d.Enums.Events.PRE_STACK_NEW_IMAGE,eq),e.addEventListener(d.Enums.Events.IMAGE_RENDERED,eq))},disable:function(e){e.removeEventListener(d.Enums.Events.PRE_STACK_NEW_IMAGE,eq),e.removeEventListener(d.Enums.Events.IMAGE_RENDERED,eq)}};var ej=e.i(238064);let eK=function(e){(0,ej.default)(e.detail.element)},eY={enable:function(e){e.addEventListener(d.Enums.Events.IMAGE_RENDERED,eK)},disable:function(e){e.removeEventListener(d.Enums.Events.IMAGE_RENDERED,eK)}};var eX=e.i(273965),eZ=e.i(650658);function eJ(e,t,n){let{renderingEngineId:i,viewportId:o}=e.detail,a=(0,eZ.getToolGroupForViewport)(o,i);if(!a)return[];let r=[],l=Object.keys(a.toolOptions);for(let e=0;e<l.length;e++){let i=l[e],o=a.toolOptions[i],s=null!=n&&o.bindings.length&&o.bindings.some(e=>e.mouseButton===n);if(t.includes(o.mode)&&(!n||s)){let e=a.getToolInstance(i);r.push(e)}}return r}let{Active:eQ,Passive:e$,Enabled:e0}=eX.ToolModes,e1=function(e){eJ(e,[eQ,e$,e0]).forEach(t=>{t.onCameraModified&&t.onCameraModified(e)})},e2={enable:function(e){e.addEventListener(d.Enums.Events.CAMERA_MODIFIED,e1)},disable:function(e){e.removeEventListener(d.Enums.Events.CAMERA_MODIFIED,e1)}};var e3=e.i(518792),e5=e.i(412974);let{Active:e4}=e5.default;function e8(e,t,n){let i;if(e3.state.isInteractingWithTool)return!1;let{renderingEngineId:o,viewportId:a}=n.detail,r=(0,eZ.getToolGroupForViewport)(a,o);if(!r)return!1;let l=Object.keys(r.toolOptions);for(let e=0;e<l.length;e++){let n=l[e],o=r.toolOptions[n],a=r.getToolInstance(n);if(o.mode===e4&&"function"==typeof a[t]){i=r.getToolInstance(n);break}}i&&i[t](n)}let e6=e8.bind(null,"Mouse","mouseClickCallback");var e7=e.i(433460),e9=e.i(10122),te=e.i(72340);function tt(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse",o="touch"===i?36:6,a=[];return t.forEach(t=>{let{tool:i,annotations:r}=t;for(let t of r){if(t.isLocked||!t.isVisible)continue;let r=i.getHandleNearImagePoint(e,t,n,o);if(r){a.push({tool:i,annotation:t,handle:r});break}}}),a}function tn(e,t){let n=[];for(let i=0;i<t.length;i++){let o=t[i];if(!o){console.warn("undefined tool in filterToolsWithAnnotationsForElement");continue}let a=(0,c.getAnnotations)(o.constructor.toolName,e);(null==a?void 0:a.length)&&("function"==typeof o.filterInteractableAnnotationsForElement&&(a=o.filterInteractableAnnotationsForElement(e,a)),(null==a?void 0:a.length)>0&&n.push({tool:o,annotations:a}))}return n}function ti(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse",o="touch"===i?36:6,a=[];return t.forEach(t=>{let{tool:r,annotations:l}=t;for(let t of l)if(!t.isLocked&&t.isVisible&&r.isPointNearTool(e,t,n,o,i)){a.push({tool:r,annotation:t});break}}),a}var to=e.i(822659);let{Active:ta}=eX.ToolModes;function tr(e){var t,n;let{renderingEngineId:i,viewportId:o,event:a}=e.detail,r=(0,to.default)(a)||eP.getModifierKey(),l=(0,eZ.getToolGroupForViewport)(o,i);if(!l)return null;let s=Object.keys(l.toolOptions),d=l.getDefaultMousePrimary(),c=null!=(n=null!=(t=e.detail.buttons)?t:null==a?void 0:a.buttons)?n:d;for(let e=0;e<s.length;e++){let t=s[e],n=l.toolOptions[t],i=n.bindings.length&&n.bindings.some(e=>e.mouseButton===c&&e.modifierKey===r);if(n.mode===ta&&i)return l.getToolInstance(t)}}let{Active:tl,Passive:ts}=eX.ToolModes,{Active:td,Passive:tc}=eX.ToolModes;function tu(e){if(e3.state.isInteractingWithTool)return;let t=tr(e);if(t&&"function"==typeof t.preMouseDownCallback&&t.preMouseDownCallback(e))return;let n=1===e.detail.event.buttons,i=[...eJ(e,[td],e.detail.event.buttons)||[],...(n?eJ(e,[tc]):void 0)||[]];if(function(e){if(e3.state.isInteractingWithTool)return!1;let t=e.detail,{element:n}=t,i=(0,h.getEnabledElement)(n),{canvas:o}=t.currentPoints;if(!i)return!1;let a=function(e,t){var n,i,o;let a=new Map,{renderingEngineId:r,viewportId:l}=e.detail,s=(0,eZ.getToolGroupForViewport)(l,r);if(!s)return a;let d=Object.keys(s.toolOptions),c=s.getDefaultMousePrimary(),u=e.detail.event,h=null!=(n=null==u?void 0:u.buttons)?n:c,g=(0,to.default)(u)||eP.getModifierKey();for(let e=0;e<d.length;e++){let n=d[e],r=s.getToolInstance(n),l=Object.values(null!=(o=null==(i=r.configuration)?void 0:i.actions)?o:{});if(!(null==l?void 0:l.length)||!t.includes(r.mode))continue;let c=l.find(e=>{var t;return(null==(t=e.bindings)?void 0:t.length)&&e.bindings.some(e=>e.mouseButton===h&&e.modifierKey===g)});c&&a.set(r,c)}return a}(e,[tl,ts]),r=tn(n,Array.from(a.keys())),l=ti(n,r,o);if(l.length>0){let{tool:t,annotation:n}=l[0],i=a.get(t);return("string"==typeof i.method?t[i.method]:i.method).call(t,e,n),!0}return!1}(e))return;let o=e.detail,{element:a}=o,r=tn(a,i),l=o.currentPoints.canvas,s=tt(a,r,l,"mouse"),d=!!e.detail.event.shiftKey;if(s.length>0){let{tool:t,annotation:n,handle:i}=th(s);tg(n.annotationUID,d),t.handleSelectedCallback(e,n,i,"Mouse");return}let c=ti(a,r,l,"mouse");if(c.length>0){let{tool:t,annotation:n}=th(c);tg(n.annotationUID,d),t.toolSelectedCallback(e,n,"Mouse",l);return}if(t&&"function"==typeof t.postMouseDownCallback&&t.postMouseDownCallback(e))return}function th(e){if(e.length>1){let t=e.find(e=>{let t=!(0,e9.isAnnotationLocked)(e.annotation.annotationUID),n=(0,te.isAnnotationVisible)(e.annotation.annotationUID);return t&&n});if(t)return t}return e[0]}function tg(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t?(0,e7.isAnnotationSelected)(e)?(0,e7.setAnnotationSelected)(e,!1):(0,e7.setAnnotationSelected)(e,!0,!0):(0,e7.setAnnotationSelected)(e,!0,!1)}function tf(e){if(e3.state.isInteractingWithTool)return;let t=tr(e);if(t&&!e3.state.isMultiPartToolActive&&t.addNewAnnotation){let n=t.addNewAnnotation(e,"mouse");(0,e7.setAnnotationSelected)(n.annotationUID)}}let tm=e8.bind(null,"Mouse","doubleClickCallback");function tv(e){if(e3.state.isInteractingWithTool)return;let t=tr(e);t&&"function"==typeof t.mouseDragCallback&&t.mouseDragCallback(e)}let{Active:tp,Passive:tI}=eX.ToolModes;function tE(e){if(e3.state.isInteractingWithTool||e3.state.isMultiPartToolActive)return;let t=eJ(e,[tp,tI]),{element:n}=e.detail,i=tn(n,t),o=t.filter(e=>!i.some(t=>t.tool.getToolName()===e.getToolName())),a=!1;for(let{tool:t,annotations:n}of i)"function"==typeof t.mouseMoveCallback&&(a=t.mouseMoveCallback(e,n)||a);o.forEach(t=>{"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)}),!0===a&&(0,ej.default)(n)}let tw=e8.bind(null,"Mouse","mouseUpCallback");var t_=e.i(49119);let tS=function(e){if(e3.state.isInteractingWithTool)return;e.detail.buttons=t_.MouseBindings.Wheel|(e.detail.event.buttons||0);let t=tr(e);if(t)return t.mouseWheelCallback(e)},ty={enable:function(e){e.addEventListener(f.default.MOUSE_CLICK,e6),e.addEventListener(f.default.MOUSE_DOWN,tu),e.addEventListener(f.default.MOUSE_DOWN_ACTIVATE,tf),e.addEventListener(f.default.MOUSE_DOUBLE_CLICK,tm),e.addEventListener(f.default.MOUSE_DRAG,tv),e.addEventListener(f.default.MOUSE_MOVE,tE),e.addEventListener(f.default.MOUSE_UP,tw),e.addEventListener(f.default.MOUSE_WHEEL,tS)},disable:function(e){e.removeEventListener(f.default.MOUSE_CLICK,e6),e.removeEventListener(f.default.MOUSE_DOWN,tu),e.removeEventListener(f.default.MOUSE_DOWN_ACTIVATE,tf),e.removeEventListener(f.default.MOUSE_DOUBLE_CLICK,tm),e.removeEventListener(f.default.MOUSE_DRAG,tv),e.removeEventListener(f.default.MOUSE_MOVE,tE),e.removeEventListener(f.default.MOUSE_UP,tw),e.removeEventListener(f.default.MOUSE_WHEEL,tS)}},{Active:tT}=eX.ToolModes;function tC(e){let{renderingEngineId:t,viewportId:n}=e.detail,i=e.detail.event,o=(0,eZ.getToolGroupForViewport)(n,t);if(!o)return null;let a=Object.keys(o.toolOptions),r=Object.keys(i.touches).length,l=(0,to.default)(i)||eP.getModifierKey(),s=o.getDefaultMousePrimary();for(let e=0;e<a.length;e++){let t=a[e],n=o.toolOptions[t],i=n.bindings.length&&n.bindings.some(e=>(e.numTouchPoints===r||1===r&&e.mouseButton===s)&&e.modifierKey===l);if(n.mode===tT&&i)return o.getToolInstance(t)}}function tb(e,t,n){let{renderingEngineId:i,viewportId:o}=e.detail,a=(0,eZ.getToolGroupForViewport)(o,i);if(!a)return[];let r=[],l=Object.keys(a.toolOptions);for(let e=0;e<l.length;e++){let i=l[e],o=a.toolOptions[i],s=null!=n&&o.bindings.length&&o.bindings.some(e=>e.numTouchPoints===n);if(t.includes(o.mode)&&(!n||s)){let e=a.getToolInstance(i);r.push(e)}}return r}let{Active:tA,Passive:tx}=eX.ToolModes;function tD(e){if(e3.state.isInteractingWithTool)return;let t=tC(e);if(t&&"function"==typeof t.preTouchStartCallback&&t.preTouchStartCallback(e))return;let n=1===Object.keys(e.detail.event.touches).length,i=[...tb(e,[tA],Object.keys(e.detail.event.touches).length)||[],...(n?tb(e,[tx]):void 0)||[],t],o=e.detail,{element:a}=o,r=tn(a,i),l=o.currentPoints.canvas,s=tt(a,r,l,"touch");if(s.length>0){let{tool:t,annotation:n,handle:i}=tM(s);tO(n.annotationUID,!1),t.handleSelectedCallback(e,n,i,"Touch");return}let d=ti(a,r,l,"touch");if(d.length>0){let{tool:t,annotation:n}=tM(d);tO(n.annotationUID,!1),t.toolSelectedCallback(e,n,"Touch",l);return}if(t&&"function"==typeof t.postTouchStartCallback&&t.postTouchStartCallback(e))return}function tM(e){return e.length>1&&e.find(e=>!(0,e9.isAnnotationLocked)(e.annotation.annotationUID)&&(0,te.isAnnotationVisible)(e.annotation.annotationUID))||e[0]}function tO(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t?(0,e7.isAnnotationSelected)(e)?(0,e7.setAnnotationSelected)(e,!1):(0,e7.setAnnotationSelected)(e,!0,!0):(0,e7.setAnnotationSelected)(e,!0,!1)}function tP(e){if(e3.state.isInteractingWithTool)return;let t=tC(e);if(t&&!e3.state.isMultiPartToolActive&&t.addNewAnnotation){let n=t.addNewAnnotation(e,"touch");(0,e7.setAnnotationSelected)(n.annotationUID)}}function tN(e){if(e3.state.isInteractingWithTool)return;let t=tC(e);t&&"function"==typeof t.touchDragCallback&&t.touchDragCallback(e)}let tR=e8.bind(null,"Touch","touchEndCallback"),tL=e8.bind(null,"Touch","touchTapCallback"),tU=e8.bind(null,"Touch","touchPressCallback"),tk={enable:function(e){e.addEventListener(f.default.TOUCH_START,tD),e.addEventListener(f.default.TOUCH_START_ACTIVATE,tP),e.addEventListener(f.default.TOUCH_DRAG,tN),e.addEventListener(f.default.TOUCH_END,tR),e.addEventListener(f.default.TOUCH_TAP,tL),e.addEventListener(f.default.TOUCH_PRESS,tU)},disable:function(e){e.removeEventListener(f.default.TOUCH_START,tD),e.removeEventListener(f.default.TOUCH_START_ACTIVATE,tP),e.removeEventListener(f.default.TOUCH_DRAG,tN),e.removeEventListener(f.default.TOUCH_END,tR),e.removeEventListener(f.default.TOUCH_PRESS,tU)}},{Active:tV}=eX.ToolModes;function tF(e){let{renderingEngineId:t,viewportId:n}=e.detail,i=C.mouseButton,o=eP.getModifierKey(),a=(0,eZ.getToolGroupForViewport)(n,t);if(!a)return null;let r=Object.keys(a.toolOptions),l=a.getDefaultMousePrimary();for(let e=0;e<r.length;e++){let t=r[e],n=a.toolOptions[t];if(n.mode===tV&&n.bindings.length&&n.bindings.some(e=>e.mouseButton===(null!=i?i:l)&&e.modifierKey===o))return a.getToolInstance(t)}}function tB(e){let t=tF(e);if(t){let{renderingEngineId:n,viewportId:i}=e.detail,o=(0,eZ.getToolGroupForViewport)(i,n),a=t.getToolName();Object.keys(o.toolOptions).includes(a)&&o.setViewportsCursorByToolName(a)}let n=function(e,t){let n=new Map,{renderingEngineId:i,viewportId:o}=e.detail,a=(0,eZ.getToolGroupForViewport)(o,i);if(!a)return n;let r=Object.keys(a.toolOptions),l=e.detail.key;for(let e=0;e<r.length;e++){var s;let i=r[e],o=a.getToolInstance(i),d=null==(s=o.configuration)?void 0:s.actions;if(!d)continue;let c=Object.values(d);if(!(null==c?void 0:c.length)||!t.includes(o.mode))continue;let u=c.find(e=>{var t;return null==(t=e.bindings)?void 0:t.some(e=>e.key===l)});u&&n.set(o,u)}return n}(e,[e5.default.Active]);if(null==n?void 0:n.size){let{element:t}=e.detail;for(let[i,o]of[...n.entries()])("function"==typeof o.method?o.method:i[o.method]).call(i,t,o,e)}}function tG(e){let t=tF(e);if(!t)return;let{renderingEngineId:n,viewportId:i}=e.detail,o=(0,eZ.getToolGroupForViewport)(i,n);eM();let a=t.getToolName();Object.keys(o.toolOptions).includes(a)&&o.setViewportsCursorByToolName(a)}let tW={enable:function(e){e.addEventListener(f.default.KEY_DOWN,tB),e.addEventListener(f.default.KEY_UP,tG)},disable:function(e){e.removeEventListener(f.default.KEY_DOWN,tB),e.removeEventListener(f.default.KEY_UP,tG)}},{Active:tz,Passive:tq,Enabled:tH}=eX.ToolModes,tj=function(e){eJ(e,[tz,tq,tH]).forEach(t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)})},tK={enable:function(e){e.addEventListener(d.Enums.Events.IMAGE_SPACING_CALIBRATED,tj)},disable:function(e){e.removeEventListener(d.Enums.Events.IMAGE_SPACING_CALIBRATED,tj)}},{Active:tY,Passive:tX,Enabled:tZ}=eX.ToolModes,tJ=function(e){eJ(e,[tY,tX,tZ]).forEach(t=>{t.onResetCamera&&t.onResetCamera(e)})},tQ={enable:function(e){e.addEventListener(d.Enums.Events.CAMERA_RESET,tJ)},disable:function(e){e.removeEventListener(d.Enums.Events.CAMERA_RESET,tJ)}};var t$=e.i(150761);function t0(e){var t;let{element:n,viewportId:i}=e.detail,o=function(e){let t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),i="svg-layer-".concat(e);n.classList.add("svg-layer"),n.setAttribute("id",i),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";let o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),r=document.createElementNS(t,"feOffset"),l=document.createElementNS(t,"feColorMatrix"),s=document.createElementNS(t,"feBlend");return a.setAttribute("id","shadow-".concat(i)),a.setAttribute("filterUnits","userSpaceOnUse"),r.setAttribute("result","offOut"),r.setAttribute("in","SourceGraphic"),r.setAttribute("dx","0.5"),r.setAttribute("dy","0.5"),l.setAttribute("result","matrixOut"),l.setAttribute("in","offOut"),l.setAttribute("in2","matrix"),l.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),s.setAttribute("in","SourceGraphic"),s.setAttribute("in2","matrixOut"),s.setAttribute("mode","normal"),a.appendChild(r),a.appendChild(l),a.appendChild(s),o.appendChild(a),n.appendChild(o),n}(i);(function(e){let{viewportUid:t,renderingEngineUid:n}=e.dataset,i="".concat(t,":").concat(n);e3.state.svgNodeCache[i]={}})(n),t=o,n.querySelector("div.viewport-element").appendChild(t),t$.annotationRenderingEngine.addViewportElement(i,n),W.enable(n),H.enable(n),eT.enable(n),eP.enable(n),eH.enable(n),eY.enable(n),e2.enable(n),tK.enable(n),tQ.enable(n),ty.enable(n),tW.enable(n),tk.enable(n),e3.state.enabledElements.push(n)}e.i(265526);let t1=function(e,t){let n=[];if(!t&&!e)throw Error("At least one of renderingEngineId or viewportId should be given");for(let i=0;i<e3.state.synchronizers.length;i++){let o=e3.state.synchronizers[i],a=!o.isDisabled(),r=o.hasSourceViewport(t,e),l=o.hasTargetViewport(t,e);a&&(r||l)&&n.push(o)}return n};var t2=e.i(916821);let t3=function(e){let t=e3.state.enabledElements.findIndex(t=>t===e);t>-1&&e3.state.enabledElements.splice(t,1)},t5=function(e){let{element:t,viewportId:n}=e.detail;(function(e){let{viewportUid:t,renderingEngineUid:n}=e.dataset,i="".concat(t,":").concat(n);delete e3.state.svgNodeCache[i]})(t),function(e){let t=e.querySelector("div.".concat("viewport-element")),n=t.querySelector("svg");n&&t.removeChild(n)}(t),t$.annotationRenderingEngine.removeViewportElement(n,t),W.disable(t),H.disable(t),eT.disable(t),eP.disable(t),eH.disable(t),eY.disable(t),e2.disable(t),tK.disable(t),tQ.disable(t),ty.disable(t),tW.disable(t),tk.disable(t),(e=>{let t=(0,h.getEnabledElement)(e);t&&t1(t.viewportId,t.renderingEngineId).forEach(e=>{e.remove(t)})})(t),(e=>{let t=(0,h.getEnabledElement)(e);if(!t)return;let{renderingEngineId:n,viewportId:i}=t,o=(0,t2.default)(i,n);o&&o.removeViewports(n,i)})(t),t3(t)};var t4=e.i(530070),t4=t4,t8=e.i(950004),t6=e.i(299511),t6=t6,t4=t4,t7=e.i(832876),t9=e.i(704063),ne=e.i(144730);async function nt(e){let t=e.detail.annotation;if(!(0,t4.default)(t))return;let n=function(e){let t=(0,t8.default)(e),n=t.find(e=>(function(e){let t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i="PlanarFreehandContourSegmentationTool",o=(0,eZ.getToolGroupForViewport)(e.id,e.renderingEngineId);return o?o.hasTool(i)?o.getToolOptions(i)||(t="Tool ".concat(i," must be in active/passive state in ").concat(o.id," toolGroup")):t="Tool ".concat(i," not added to ").concat(o.id," toolGroup"):t="ToolGroup not found for viewport ".concat(e.id),t&&!n&&console.warn(t),!t})(e,!0));return null!=n?n:t[0]}(t),i=function(e,t){let{annotationUID:n}=t;return(0,c.getAllAnnotations)().filter(i=>i.annotationUID&&i.annotationUID!==n&&(0,t4.default)(i)&&(0,t6.default)(i,t)&&e.isReferenceViewable(i.metadata))}(n,t);if(!i.length)return void(0,g.triggerEvent)(s.eventTarget,u.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,{element:n.element,sourceAnnotation:t});let o=(0,ne.convertContourPolylineToCanvasSpace)(t.data.contour.polyline,n),a=(0,t7.findAllIntersectingContours)(n,o,i);if(!a.length)return void(0,g.triggerEvent)(s.eventTarget,u.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,{element:n.element,sourceAnnotation:t});if(a.length>1)return void(0,t9.processMultipleIntersections)(n,t,o,a);let{targetAnnotation:r,targetPolyline:l,isContourHole:d}=a[0];if(d){let{contourHoleProcessingEnabled:i=!1}=e.detail;if(!i)return;(0,ne.createPolylineHole)(n,r,t)}else(0,ne.combinePolylines)(n,r,l,t,o)}function nn(e){let t=e.detail.annotation;t4.default(t)&&nt(e)}var t4=t4,ni=e.i(668441);function no(e){let t=e.detail.annotation;t4.default(t)&&function(e){let t=e.detail.annotation;(0,ni.removeContourSegmentationAnnotation)(t)}(e)}var na=e.i(23529),nr=e.i(815926);let nl=function(e){e.detail.removed.length&&(0,na.getRenderingEngines)().forEach(e=>{let t=e.getViewports().map(e=>e.id);(0,nr.triggerAnnotationRenderForViewportIds)(t)})},ns=function(e){let{viewportId:t}=e.detail;(0,nr.default)([t])};var nd=e.i(802939),nc=e.i(209501),nu=e.i(819485),nh=e.i(455165);let ng=function(e){let{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:i}=(0,nu.getSegmentation)(t),o=(0,nh.getViewportIdsWithSegmentation)(t),a=o.some(e=>{let{viewport:t}=(0,eU.getEnabledElementByViewportId)(e);return t instanceof nd.VolumeViewport}),l=o.some(e=>{let{viewport:t}=(0,eU.getEnabledElementByViewportId)(e);return t instanceof nc.StackViewport}),s=a&&l;o.forEach(e=>{let{viewport:a}=(0,eU.getEnabledElementByViewportId)(e);a instanceof nd.VolumeViewport&&function(e){let{modifiedSlicesToUse:t,representationData:n,type:i}=e,o=ek.cache.getVolume(n[i].volumeId);if(!o)return console.warn("segmentation not found in cache");let{imageData:a,vtkOpenGLTexture:r}=o;((null==t?void 0:t.length)>0?t:[...Array(a.getDimensions()[2]).keys()]).forEach(e=>{r.setUpdatedFrame(e)}),a.modified()}({modifiedSlicesToUse:s?[]:n,representationData:i,type:eG.SegmentationRepresentations.Labelmap}),a instanceof nc.StackViewport&&function(e){let{viewportIds:t,segmentationId:n}=e;t.forEach(e=>{let t=(0,ez.getSegmentationRepresentations)(e,{segmentationId:n});(t=t.filter(e=>e.type===eG.SegmentationRepresentations.Labelmap)).forEach(t=>{if(t.segmentationId!==n)return;let i=(0,eU.getEnabledElementByViewportId)(e);if(!i)return;let{viewport:o}=i;if(o instanceof nd.VolumeViewport)return;let a=(0,eW.getLabelmapActorEntries)(e,n);(null==a?void 0:a.length)&&a.forEach((t,i)=>{let o=t.actor.getMapper().getInputData(),a=(0,eB.getCurrentLabelmapImageIdsForViewport)(e,n),l=ek.cache.getImage(a[i]);o.modified(),r.utilities.updateVTKImageDataWithCornerstoneImage(o,l)})})})}({viewportIds:o,segmentationId:t})})},nf=function(e){let{segmentationId:t}=e.detail,{representationData:n}=(0,nu.getSegmentation)(t);n.Labelmap&&ng(e),(0,eV.triggerSegmentationRenderBySegmentationId)(t)},nm=function(e){let{segmentationId:t}=e.detail;(0,eV.triggerSegmentationRenderBySegmentationId)(t)};var nv=e.i(567483);let np={enable:function(){s.eventTarget.addEventListener(f.default.ANNOTATION_COMPLETED,nv.default.handleAnnotationCompleted),s.eventTarget.addEventListener(f.default.ANNOTATION_MODIFIED,nv.default.handleAnnotationUpdate),s.eventTarget.addEventListener(f.default.ANNOTATION_REMOVED,nv.default.handleAnnotationDelete)},disable:function(){s.eventTarget.removeEventListener(f.default.ANNOTATION_COMPLETED,nv.default.handleAnnotationCompleted),s.eventTarget.removeEventListener(f.default.ANNOTATION_MODIFIED,nv.default.handleAnnotationUpdate),s.eventTarget.removeEventListener(f.default.ANNOTATION_REMOVED,nv.default.handleAnnotationDelete)}};e.i(365800);let nI=function(e){let{viewportId:t}=e.detail;(0,eV.triggerSegmentationRender)(t)};var nE=e.i(340354);let nw=!1;var n_=e.i(985704),nS=e.i(605509),ny=e.i(989663),nT=e.i(419930),nC=e.i(554911);let nb=(0,e.i(657588).default)(()=>{(0,i.init)(),function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};nw||((0,nE.setConfig)(e),function(){let e=d.Enums.Events.ELEMENT_ENABLED,t=d.Enums.Events.ELEMENT_DISABLED;s.eventTarget.removeEventListener(e,t0),s.eventTarget.removeEventListener(t,t5),np.disable();let n=d.Enums.Events.ELEMENT_ENABLED,i=d.Enums.Events.ELEMENT_DISABLED;s.eventTarget.addEventListener(n,t0),s.eventTarget.addEventListener(i,t5),np.enable()}(),s.eventTarget.removeEventListener(u.Events.ANNOTATION_COMPLETED,nn),s.eventTarget.removeEventListener(u.Events.ANNOTATION_MODIFIED,ns),s.eventTarget.removeEventListener(u.Events.ANNOTATION_SELECTION_CHANGE,nl),s.eventTarget.removeEventListener(u.Events.ANNOTATION_SELECTION_CHANGE,nl),s.eventTarget.removeEventListener(u.Events.SEGMENTATION_MODIFIED,nm),s.eventTarget.removeEventListener(u.Events.SEGMENTATION_DATA_MODIFIED,nf),s.eventTarget.removeEventListener(u.Events.SEGMENTATION_REPRESENTATION_MODIFIED,nI),s.eventTarget.removeEventListener(u.Events.SEGMENTATION_REPRESENTATION_ADDED,nI),s.eventTarget.addEventListener(u.Events.ANNOTATION_COMPLETED,nn),s.eventTarget.addEventListener(u.Events.ANNOTATION_MODIFIED,ns),s.eventTarget.addEventListener(u.Events.ANNOTATION_SELECTION_CHANGE,nl),s.eventTarget.addEventListener(u.Events.ANNOTATION_SELECTION_CHANGE,nl),s.eventTarget.addEventListener(u.Events.ANNOTATION_REMOVED,no),s.eventTarget.addEventListener(u.Events.SEGMENTATION_MODIFIED,nm),s.eventTarget.addEventListener(u.Events.SEGMENTATION_DATA_MODIFIED,nf),s.eventTarget.addEventListener(u.Events.SEGMENTATION_REPRESENTATION_MODIFIED,nI),s.eventTarget.addEventListener(u.Events.SEGMENTATION_REPRESENTATION_ADDED,nI),nw=!0)}(),n_.annotation.config.style.setDefaultToolStyles({[ny.CircleROITool.toolName]:{color:"rgb(96, 165, 250)",colorHighlighted:"rgb(96, 165, 250)",colorSelected:"rgb(96, 165, 250)",colorLocked:"rgb(96, 165, 250)"}}),a.metaData.addProvider(r.utilities.calibratedPixelSpacingMetadataProvider.get.bind(r.utilities.calibratedPixelSpacingMetadataProvider));try{(0,nS.addTool)(ny.CircleROITool)}catch(e){}try{(0,nS.addTool)(nT.PanTool)}catch(e){}try{(0,nS.addTool)(nC.ZoomTool)}catch(e){}o.imageLoader.registerImageLoader("nifti",l.cornerstoneNiftiImageLoader)})},628333,e=>{"use strict";e.s(["getSquareViewportClampedPosition",()=>a,"getStackWorldBounds",()=>i,"getVolumeWorldBounds",()=>o]);var t=e.i(504019),n=e.i(163370);let i=e=>{if(!e.length)return null;let i=[e[0]];e.length>1&&i.push(e[e.length-1]);let o=1/0,a=-1/0,r=1/0,l=-1/0,s=1/0,d=-1/0,c=!1;return(i.forEach(e=>{let i=t.metaData.get("imagePlaneModule",e);if(!i)return;let{rows:u,columns:h}=i;[[0,0],[h,0],[0,u],[h,u]].forEach(t=>{let[i,u]=t,h=(0,n.imageToWorldCoords)(e,[i,u]);h&&(o=Math.min(o,h[0]),a=Math.max(a,h[0]),r=Math.min(r,h[1]),l=Math.max(l,h[1]),s=Math.min(s,h[2]),d=Math.max(d,h[2]),c=!0)})}),c)?{minX:o,maxX:a,minY:r,maxY:l,minZ:s,maxZ:d}:null},o=e=>{let{dimensions:t,spacing:n,origin:i,direction:o}=e;if(!t||!n||!i||!o)return null;let a=(e,t,a)=>{let r=[e*n[0],t*n[1],a*n[2]];return[i[0]+(o[0]*r[0]+o[3]*r[1]+o[6]*r[2]),i[1]+(o[1]*r[0]+o[4]*r[1]+o[7]*r[2]),i[2]+(o[2]*r[0]+o[5]*r[1]+o[8]*r[2])]},r=[];for(let e of[-.5,t[2]-.5])for(let n of[-.5,t[1]-.5])for(let i of[-.5,t[0]-.5])r.push(a(i,n,e));let l=r.map(e=>e[0]),s=r.map(e=>e[1]),d=r.map(e=>e[2]);return{minX:Math.min(...l),maxX:Math.max(...l),minY:Math.min(...s),maxY:Math.max(...s),minZ:Math.min(...d),maxZ:Math.max(...d)}};function a(e,t,n,i){let{parallelScale:o,position:a,focalPoint:r,viewPlaneNormal:l}=e;if(!o||!a||!r||!l)return null;let s=t.getCanvas(),d=s.width/s.height,c=[[n.minX,n.maxX],[n.minY,n.maxY],[n.minZ,n.maxZ]],u=[n.maxX-n.minX,n.maxY-n.minY,n.maxZ-n.minZ],h=[Math.abs(l[0]),Math.abs(l[1]),Math.abs(l[2])],g=h.indexOf(Math.max(...h)),f=[0,1,2].filter(e=>e!==g),m=f[0],v=f[1];0===g?(m=1,v=2):1===g&&(m=0,v=2);let p=[...i],I=(e,t)=>{let n=u[e],o=c[e][0],a=c[e][1];n>2*t?p[e]=Math.min(Math.max(i[e],o+t),a-t):p[e]=(o+a)/2};I(m,o*d),I(v,o);let E=[p[0]-r[0],p[1]-r[1],p[2]-r[2]];return{position:[a[0]+E[0],a[1]+E[1],a[2]+E[2]],focalPoint:[r[0]+E[0],r[1]+E[1],r[2]+E[2]]}}}]);

//# sourceMappingURL=eda3d4ee137abad7.js.map
//# debugId=26f25445-4f0e-5c4e-b88c-455db4b87ddd
