
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="d6ff52bb-9968-597d-a13f-a93598d7b230")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,629801,(e,t,r)=>{"use strict";t.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;if(Array.isArray(t)){if((n=t.length)!=r.length)return!1;for(i=n;0!=i--;)if(!e(t[i],r[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((n=(o=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(i=n;0!=i--;)if(!Object.prototype.hasOwnProperty.call(r,o[i]))return!1;for(i=n;0!=i--;){var n,i,o,l=o[i];if(!e(t[l],r[l]))return!1}return!0}return t!=t&&r!=r}},816021,e=>{e.v("/_next/static/media/computeWorker.10d3e54f.js")},156040,e=>{"use strict";e.s(["CornerstoneNiftiViewer",()=>V],156040);var t=e.i(843476),r=e.i(165981),n=e.i(95482),i=e.i(717014),o=e.i(647163),l=e.i(883035),a=e.i(23529),c=e.i(184300),u=e.i(504019),s=e.i(98276),d=e.i(581632),f=e.i(485434),f=f,g=e.i(163370),p=e.i(356202),m=e.i(476112),v=e.i(985704),h=e.i(989663),E=e.i(419930),I=e.i(97428),S=e.i(14807),x=e.i(554911),A=e.i(374009),T=e.i(629873),P=e.i(385658),b=e.i(271645),w=e.i(297675);function R(e){if("R"===e||"L"===e)return"RL";if("A"===e||"P"===e)return"AP";if("I"===e||"S"===e)return"IS";throw Error("Invalid axis: ".concat(e))}function C(e){switch(e){case"R":return"L";case"L":return"R";case"A":return"P";case"P":return"A";case"I":return"S";case"S":return"I";default:throw Error("Invalid axis: ".concat(e))}}var O=e.i(41668),L=e.i(628333);let y=O.initCornerstone,M="sharedMriRenderingEngine",N=()=>{let e=(0,a.getRenderingEngine)(M);return e||(e=new s.RenderingEngine(M)),e},k={[r.MriOrientation.AXIAL]:l.Enums.OrientationAxis.AXIAL,[r.MriOrientation.CORONAL]:l.Enums.OrientationAxis.CORONAL,[r.MriOrientation.SAGITTAL]:l.Enums.OrientationAxis.SAGITTAL},D=async(e,t)=>{let r=await c.imageLoader.loadAndCacheImage(t);if(r&&r.getPixelData){let t=(e=>{let t=Array.from(e).filter(e=>e>0);if(0===t.length)return null;t.sort((e,t)=>e-t);let r=Math.floor(.01*t.length),n=Math.floor(.995*t.length);return{lower:t[r],upper:t[n]}})(r.getPixelData());t&&(e.setProperties({voiRange:t}),e.render())}},j=(0,A.default)(D,500),G=e=>{try{if(!e||!e.element)return!1;let t=N();if(!t)return!1;return!!t.getViewport(e.id)}catch(e){return!1}},z=(e,t,r,n)=>{let i=v.annotation.state.getAnnotation(t);if(!i)return;let o=3>Math.abs(r-n);i.isVisible!==o&&(i.isVisible=o,e.render())};function B(e){let{imageUrl:n,poi:a,volumeData:c,viewerOptions:s,sourceFileKey:A}=e,O=(0,b.useRef)(null),[M,D]=(0,b.useState)([]),[B,V]=(0,b.useState)(null),[_,F]=(0,b.useState)(null),U=(0,b.useRef)(null),[W,H]=(0,b.useState)(0),[X,K]=(0,b.useState)(!0),[q,J]=(0,b.useState)(!1),[Z,Q]=(0,b.useState)("RAS"),[Y,$]=(0,b.useState)(null),[ee,et]=(0,b.useState)(0),er=(0,b.useRef)(void 0),en=(0,b.useRef)(void 0),ei=(0,b.useRef)(void 0),{orientation:eo}=null!=c?c:{},{sliceInfo:el,setSliceInfo:ea,getSliceInfo:ec,setZoomLevel:eu,getZoomLevel:es,getViewportControls:ed,panDisabled:ef}=(0,i.useMRIControls)();(0,b.useEffect)(()=>{n&&(async()=>{try{var e,t;y();let r=await (0,p.createNiftiImageIdsAndCacheMetadata)({url:n,isCompressed:!0});D(r);let i=null!=(e=null==a?void 0:a.z)?e:Math.floor(r.length/2);if(H(i),A&&ea(A,{currentSlice:i,totalSlices:r.length,poiSliceIndex:(null==a?void 0:a.z)||0}),r.length>0)try{let e=f.default.get("niftiHeader",r[0]).header;if(e){$(e);let r=(t=e,{orientationCode:function(e){if(!e||e.length<3)return"RAS";let t=["","",""];for(let r=0;r<3;r++){let n=[e[0][r],e[1][r],e[2][r]],i=n.map(Math.abs).indexOf(Math.max(...n.map(Math.abs))),o=n[i]>0?1:-1;0===i?t[r]=o>0?"R":"L":1===i?t[r]=o>0?"A":"P":t[r]=o>0?"S":"I"}return t.join("")}(t.affine),voxelSpacing:[t.pixDims[1],t.pixDims[2],t.pixDims[3]]});Q(r.orientationCode)}}catch(e){console.warn("Could not extract NIFTI header, using default orientation:",e)}}catch(e){console.error("Error loading NIFTI:",e),V("Failed to load MRI data")}})()},[n,a,eo,A,ea]);let eg=(0,b.useCallback)(()=>{let e=U.current;if(!e||!a||!M.length)return;let t=((e,t,r)=>{if(!t||(0,T.default)(t.x)||(0,T.default)(t.y)||!r.length||!G(e))return null;let n=r[0],i=t.x,o=t.y,l=(0,g.imageToWorldCoords)(n,[i,o]);if(!l)return null;let a="poi-marker-".concat(t.x,"-").concat(t.y,"-").concat(t.z||0,"-").concat((0,P.default)());if(!G(e))return null;try{v.annotation.config.style.setAnnotationStyles(a,{color:"rgb(96, 165, 250)",lineWidth:2,lineDash:""});let t=20/Math.sqrt(3),r=[l[0]+t,l[1]+t,l[2]+t],n={annotationUID:a,data:{handles:{points:[[...l],r,r,r,r],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[...l],worldBoundingBox:{topLeft:[...l],topRight:[...l],bottomLeft:[...l],bottomRight:[...l]}}},label:"",cachedStats:{}},metadata:{toolName:h.CircleROITool.toolName,viewPlaneNormal:[0,0,1],viewUp:[0,-1,0],FrameOfReferenceUID:e.getFrameOfReferenceUID(),referencedImageId:e.getCurrentImageId()},highlighted:!1,invalidated:!1,isLocked:!0,isVisible:!0};if(!G(e))return null;v.annotation.state.addAnnotation(n,e.element);let i=v.annotation.state.getAnnotation(a);if(i){var c,u;i.isLocked=!0,null==(u=v.annotation.locking)||null==(c=u.setAnnotationLocked)||c.call(u,a,!0)}return m.utilities.triggerAnnotationRenderForViewportIds([e.id]),a}catch(e){return console.warn("Error adding POI annotation:",e),null}})(e,a,M);F(t),t&&void 0!==a.z&&null!==a.z&&z(e,t,a.z,W)},[a,M,W]),ep=(0,b.useCallback)(()=>{var e;if(!M.length||!O.current)return;K(!0),J(!1);let t=O.current,{viewport:r}=((e,t,r,n,i)=>{let o=((e,t,r,n,i)=>{let o=(0,P.default)("viewport-"),a={viewportId:o,type:l.Enums.ViewportType.STACK,element:e,defaultOptions:{background:[0,0,0],orientation:t&&k[t]||l.Enums.OrientationAxis.ACQUISITION}};r.enableElement(a);let c=r.getViewport(o);return c.setStack(n),c.setImageIdIndex(i),c.render(),c})(e,t,N(),r,n);return((e,t)=>{let r=S.ToolGroupManager.getToolGroup(e);if(r||(r=S.ToolGroupManager.createToolGroup(e)),!r)throw Error("Tool group error");return r.addTool(h.CircleROITool.toolName),r.addTool(E.PanTool.toolName),r.addTool(x.ZoomTool.toolName),r.setToolConfiguration(h.CircleROITool.toolName,{getTextLines:()=>[],calculateStats:!1,preventHandleOutsideImage:!0,simplified:!0}),r.setToolConfiguration(E.PanTool.toolName,{displayNativeCursor:!0}),r.setToolEnabled(h.CircleROITool.toolName),t?r.setToolDisabled(E.PanTool.toolName):r.setToolActive(E.PanTool.toolName,{bindings:[{mouseButton:I.Enums.MouseBindings.Primary}]}),r.setToolEnabled(x.ZoomTool.toolName),r.addViewport(e)})(o.id,i),{viewport:o}})(t,eo||null,M,null!=(e=null==a?void 0:a.z)?e:Math.floor(M.length/2),ef);U.current=r;let n=null,i=null,o=()=>{var e;return null!=(e=U.current)&&!!e.getImageData()&&(n&&(clearInterval(n),n=null),i=()=>{J(!0),i&&(t.removeEventListener(l.Enums.Events.IMAGE_RENDERED,i),i=null)},t.addEventListener(l.Enums.Events.IMAGE_RENDERED,i),r.render(),!0)};return o()||(n=setInterval(o,100)),()=>{n&&clearInterval(n),i&&t.removeEventListener(l.Enums.Events.IMAGE_RENDERED,i)}},[M,a,eo,ef]);(0,b.useEffect)(()=>{ep()},[ep]),(0,b.useEffect)(()=>()=>{if(U.current){let e=U.current;try{N().disableElement(e.id);let t=S.ToolGroupManager.getToolGroup(e.id);t&&(t.removeViewports(e.id),S.ToolGroupManager.destroyToolGroup(e.id))}catch(e){console.warn("Error during viewport cleanup:",e)}}},[A]),(0,b.useEffect)(()=>{if(q&&U.current){let e=U.current;if(K(!1),Z){let t=((e,t,n)=>{let i=[1,1,1];n&&n.pixDims&&(i=[n.pixDims[1]||1,n.pixDims[2]||1,n.pixDims[3]||1]);try{let n=function(e,t,n){let i,o,l,a,c;if(3!==e.length)throw Error("Invalid orientation code: ".concat(e,". Expected 3 characters."));let u=e.split(""),s=u[0],d=u[1],f=u[2];switch(t){case r.MriOrientation.AXIAL:"I"===f||"S"===f?(i=2,o=[s,d],l=[0,1]):"I"===d||"S"===d?(i=1,o=[s,f],l=[0,2]):(i=0,o=[d,f],l=[1,2]);break;case r.MriOrientation.CORONAL:"A"===f||"P"===f?(i=2,o=[s,d],l=[0,1]):"A"===d||"P"===d?(i=1,o=[s,f],l=[0,2]):(i=0,o=[d,f],l=[1,2]);break;case r.MriOrientation.SAGITTAL:"R"===f||"L"===f?(i=2,o=[s,d],l=[0,1]):"R"===d||"L"===d?(i=1,o=[s,f],l=[0,2]):(i=0,o=[d,f],l=[1,2]);break;default:throw Error("Invalid view plane: ".concat(t))}let g=!1,p=0,m=!1,v=!1;switch(t){case r.MriOrientation.AXIAL:a="L",c="P";break;case r.MriOrientation.CORONAL:a="L",c="S";break;case r.MriOrientation.SAGITTAL:a="P",c="I";break;default:throw Error("Invalid view plane: ".concat(t))}let[h,E]=o,I=R(h),S=R(E),x=R(a),A=R(c);return I===A&&S===x?(g=!0,E!==a&&E!==C(a)?p=2:(E!==a&&(m=!0),h!==c&&(v=!0))):I===x&&S===A?(h!==a&&(m=!0),E!==c&&(v=!0)):I===A&&S===R(C(a))?p=1:I===R(C(c))&&S===x?p=-1:(h!==a&&h!==C(a)&&(p=1),h===C(a)&&(m=!0)),{sliceDimension:i,needsTranspose:g,needsRot90:p,needsFlipLR:m,needsFlipUD:v,aspectRatio:n[l[1]]/n[l[0]]}}(e,t,i);return{rotation:90*n.needsRot90,flipHorizontal:n.needsFlipLR,flipVertical:n.needsFlipUD,viewTransform:n,voxelSpacing:i}}catch(e){return console.warn("Error calculating viewport presentation:",e),{rotation:0,flipHorizontal:!1,flipVertical:!1,viewTransform:null,voxelSpacing:[1,1,1]}}})(Z,eo||r.MriOrientation.AXIAL,Y);e.setViewPresentation(t),t.viewTransform&&t.voxelSpacing&&((e,t,r,n)=>{if(!r.aspectRatio)return;let{sliceDimension:i}=r,o=[0,1,2].filter(e=>e!==i),a=n[o[1]],c=n[o[0]],s=a/c;if(s>2||s<.5){let e=Math.min(a,c);a=e,c=e}t.forEach(e=>{let t=u.metaData.get("imagePlaneModule",e);t&&(t.pixelSpacing=[c,a],t.rowPixelSpacing=a,t.columnPixelSpacing=c),d.utilities.calibratedPixelSpacingMetadataProvider.add(e,{rowPixelSpacing:a,columnPixelSpacing:c,type:l.Enums.CalibrationTypes.USER})});let f=e.getCurrentImageId();f&&e.calibrateSpacing(f)})(e,M,t.viewTransform,t.voxelSpacing),e.render()}e.setImageIdIndex(W),j(e,M[W]),((e,t,r,n,i,o)=>{let l,a=e.getCamera();if(!t||(0,T.default)(t.x)||(0,T.default)(t.y)||!r.length||!a.focalPoint||!a.position){n.current=a.parallelScale,i.current=a.focalPoint,o.current=a.position;return}let c=r[0],u=t.x,s=t.y,d=(0,g.imageToWorldCoords)(c,[u,s]);if(!d){n.current=a.parallelScale,i.current=a.focalPoint,o.current=a.position;return}let f=e.getCanvas(),p=f.width/f.height;l=p>=1?120:240/(2*p);let m=d[0]-a.focalPoint[0],v=d[1]-a.focalPoint[1],h=d[2]-a.focalPoint[2],E=[a.position[0]+m,a.position[1]+v,a.position[2]+h],I={...a,focalPoint:d,position:E,parallelScale:l},S=(0,L.getStackWorldBounds)(r),x={position:E,focalPoint:d};if(S)try{let t=(0,L.getSquareViewportClampedPosition)(I,e,S,d);t&&(x={position:t.position,focalPoint:t.focalPoint})}catch(e){console.warn("Error clamping camera position:",e)}e.setCamera({...a,focalPoint:x.focalPoint,position:x.position,parallelScale:l});let A=e.getCamera();n.current=A.parallelScale,i.current=A.focalPoint,o.current=A.position,e.render()})(e,a,M,er,en,ei),eg()}},[q]),(0,b.useEffect)(()=>{if(A&&U.current&&M.length>0){let e=ec(A);e&&e.currentSlice!==W&&(H(e.currentSlice),U.current.setImageIdIndex(e.currentSlice),M[e.currentSlice]&&j(U.current,M[e.currentSlice]),_&&(null==a?void 0:a.z)!==void 0&&null!==a.z&&z(U.current,_,a.z,e.currentSlice))}},[A,ec,el,W,M,_,a]),(0,b.useEffect)(()=>()=>{if(_)try{v.annotation.state.removeAnnotation(_)}catch(e){}},[_]);let em=(0,b.useCallback)((e,t)=>{if(void 0===er.current)return;let r=e.getCamera(),n=er.current/t;r.parallelScale!==n&&(e.setCamera({...r,parallelScale:n}),e.render())},[]);return((0,b.useEffect)(()=>{if(U.current&&q&&M.length>0){let e=U.current,t=e.element,r=()=>{if(void 0===er.current||void 0===en.current||void 0===ei.current){let t=e.getCamera();void 0===er.current&&(er.current=t.parallelScale),void 0===en.current&&(en.current=t.focalPoint),void 0===ei.current&&(ei.current=t.position)}let t=e.getCamera();if(!e.element.dataset.initialParallelScale){var r,n,i;e.element.dataset.initialParallelScale=String(null!=(r=er.current)?r:t.parallelScale),e.element.dataset.initialFocalPoint=JSON.stringify(null!=(n=en.current)?n:t.focalPoint),e.element.dataset.initialPosition=JSON.stringify(null!=(i=ei.current)?i:t.position),A&&(eu(A,1),em(e,es(A)))}},n=!!e.element.dataset.initialParallelScale,i=!1,o=()=>{i||n||setTimeout(()=>{i||n||(r(),n=!0)},100)},a=()=>{i=!0,n||(r(),n=!0)};return t.addEventListener(l.Enums.Events.IMAGE_SPACING_CALIBRATED,a),t.addEventListener(l.Enums.Events.IMAGE_RENDERED,o),()=>{t.removeEventListener(l.Enums.Events.IMAGE_SPACING_CALIBRATED,a),t.removeEventListener(l.Enums.Events.IMAGE_RENDERED,o)}}},[q,M.length,A,eu,es,em]),(0,b.useEffect)(()=>{if(A&&U.current&&q){let e=es(A);em(U.current,e)}},[A,es,q,em]),(0,b.useEffect)(()=>{if(U.current&&q){let e=U.current,t=S.ToolGroupManager.getToolGroup(e.id);t&&(ef?t.setToolDisabled(E.PanTool.toolName):t.setToolActive(E.PanTool.toolName,{bindings:[{mouseButton:I.Enums.MouseBindings.Primary}]}),e.render())}},[ef,q]),(0,b.useEffect)(()=>{let e=O.current;if(!e||!U.current||!q)return;let t=new ResizeObserver(()=>{let e=U.current;if(!e)return;let t=N();if(t)try{t.resize(!0),e.render()}catch(e){console.warn("Error resizing viewport:",e)}});return t.observe(e),()=>{t.disconnect()}},[q,eg]),(0,b.useEffect)(()=>{if(A&&U.current&&q){let e=ed(A),t=(null==e?void 0:e.resetTrigger)||0;if(t>ee){et(t);let e=U.current,r={...e.getCamera()};void 0!==er.current&&(r.parallelScale=er.current),void 0!==en.current&&(r.focalPoint=en.current),void 0!==ei.current&&(r.position=ei.current),e.setCamera(r),e.render()}}},[A,ed,q,ee]),B)?(0,t.jsx)("div",{className:"flex h-[400px] w-full items-center justify-center bg-black text-red-500",children:B}):(0,t.jsxs)("div",{className:(0,o.cn)("group relative flex w-full grow touch-none flex-col gap-2 bg-black",null==s?void 0:s.className),children:[(0,t.jsx)("div",{className:(0,o.cn)("absolute inset-0 z-20 flex h-full w-full flex-col bg-black",{hidden:!X}),children:(0,t.jsx)(w.MriLoading,{})}),(0,t.jsx)("div",{ref:e=>{O.current=e},className:(0,o.cn)("cornerstone-viewport h-full w-full bg-black",ef&&"pan-disabled"),"data-testid":"dicom-viewer-container"})]})}function V(e){return(0,t.jsx)(n.ErrorBoundary,{fallback:(0,t.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-black",children:(0,t.jsx)("svg",{className:"h-12 w-12 text-blue-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),children:(0,t.jsx)(B,{...e})})}}]);

//# sourceMappingURL=1ea939b74106aa70.js.map
//# debugId=d6ff52bb-9968-597d-a13f-a93598d7b230
